<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="description" content="Astro description"><meta name="viewport" content="width=device-width"><link rel="icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Astro v5.16.6"><title>Are your optimizations making any improvement? A simple setup to benchmark two branches</title><style>.container[data-astro-cid-4oxc2zqz]{max-width:800px;margin:0 auto;padding:0 1rem}article[data-astro-cid-lvjzyg5v]{max-width:100%}.post-content[data-astro-cid-lvjzyg5v]{margin:2rem 0;line-height:1.6}
.footer-style[data-astro-cid-k2f5zb5c]{margin-top:4rem}.footer-link[data-astro-cid-k2f5zb5c]{margin:.5rem}body{font-family:Helvetica,Arial,sans-serif;background-color:Canvas;color:CanvasText;color-scheme:light dark;overflow-wrap:break-word}img{max-width:100%}pre{max-width:100%;overflow:auto}li+li{margin-top:10px}pre{padding:10px;border-radius:5px}
</style></head> <body> <div class="mb-8"> <a href="/">Misc scribbles</a> </div>  <div class="container" data-astro-cid-4oxc2zqz>  <article data-astro-cid-lvjzyg5v> <div data-astro-cid-lvjzyg5v> <h1 data-astro-cid-lvjzyg5v>Are your optimizations making any improvement? A simple setup to benchmark two branches</h1> <h4 data-astro-cid-lvjzyg5v>2025-11-25</h4> </div> <div class="post-content" data-astro-cid-lvjzyg5v> <p><img src="/media/doggo3.png" alt=""></p>
<h2 id="background">Background</h2>
<p>So, you spend all day making “performance improvements” to make your code go
faster</p>
<p>But are you really making a difference? You might ‘feel like it’ but how can you
really tell? Ultimately systematically measuring the difference using a
benchmark is needed [3]. When you are doing optimization work, it is a level of
proof that is nearly as important as proving correctness of your code with
tests.</p>
<p>And, just like tests, you can have different levels of benchmarks</p>
<ul>
<li>unit benchmarks</li>
<li>end-to-end benchmarks</li>
</ul>
<p>Let’s evaluate both of these scenarios. We are going to use javascript for
practical purposes, but you should find a way to take this lesson to any
language or scenario</p>
<h2 id="part-1-creating-unit-benchmarks-using-vitest-bench">Part 1. Creating ‘unit benchmarks’ using <code>vitest bench</code></h2>
<p>If you are already using vitest (it is a very popular test library), you might
be happy to know that there is a subtool called <code>vitest bench</code> that is built-in.</p>
<p>Simply make a file like <code>file.bench.ts</code> and it will be invoked by
<code>vitest bench</code>. API ref <a href="https://vitest.dev/api/#bench">https://vitest.dev/api/#bench</a></p>
<p>But how do you create a <code>vitest bench</code> setup to compare two branches?</p>
<h3 id="a-simple-bash-script-to-help">A simple bash script to help</h3>
<p>We can create a script to run the build process on two branches, defaulting to
current branch and main branch. I used bash, and it assumes that <code>yarn build</code>
outputs to a folder called “dist” [1] [2].</p>
<p>Then it renames the built output to <code>dist_branch1</code> and <code>dist_branch2</code> for each
branch. Then we can add these folders to our .gitignore easily.</p>
<p>It also puts the actual branchname in a .txt file in each folder, allowing the
benchmark itself to report the branchname in the report output.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#6A737D">#!/bin/bash</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF">set</span><span style="color:#79B8FF"> -e</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">CURRENT_BRANCH</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">git</span><span style="color:#9ECBFF"> branch</span><span style="color:#79B8FF"> --show-current</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">BRANCH1</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"</span><span style="color:#79B8FF">${1</span><span style="color:#F97583">:-</span><span style="color:#E1E4E8">master</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">BRANCH2</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"</span><span style="color:#79B8FF">${2</span><span style="color:#F97583">:-</span><span style="color:#E1E4E8">$CURRENT_BRANCH</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">if</span><span style="color:#F97583"> !</span><span style="color:#B392F0"> git</span><span style="color:#9ECBFF"> diff</span><span style="color:#79B8FF"> --quiet</span><span style="color:#F97583"> ||</span><span style="color:#F97583"> !</span><span style="color:#B392F0"> git</span><span style="color:#9ECBFF"> diff</span><span style="color:#79B8FF"> --cached</span><span style="color:#79B8FF"> --quiet</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#79B8FF">  echo</span><span style="color:#9ECBFF"> "Error: Uncommitted changes detected. Please commit or stash your changes first."</span></span>
<span class="line"><span style="color:#79B8FF">  exit</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#F97583">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">rm</span><span style="color:#79B8FF"> -rf</span><span style="color:#9ECBFF"> dist_branch1</span><span style="color:#9ECBFF"> dist_branch2</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "Building </span><span style="color:#E1E4E8">$BRANCH1</span><span style="color:#9ECBFF"> branch..."</span></span>
<span class="line"><span style="color:#B392F0">git</span><span style="color:#9ECBFF"> checkout</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$BRANCH1</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#B392F0">yarn</span></span>
<span class="line"><span style="color:#B392F0">yarn</span><span style="color:#9ECBFF"> build</span></span>
<span class="line"><span style="color:#B392F0">mv</span><span style="color:#9ECBFF"> dist</span><span style="color:#9ECBFF"> dist_branch1</span></span>
<span class="line"><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$BRANCH1</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ></span><span style="color:#9ECBFF">dist_branch1/branchname.txt</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "Building </span><span style="color:#E1E4E8">$BRANCH2</span><span style="color:#9ECBFF"> branch..."</span></span>
<span class="line"><span style="color:#B392F0">git</span><span style="color:#9ECBFF"> checkout</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$BRANCH2</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#B392F0">yarn</span></span>
<span class="line"><span style="color:#B392F0">yarn</span><span style="color:#9ECBFF"> build</span></span>
<span class="line"><span style="color:#B392F0">mv</span><span style="color:#9ECBFF"> dist</span><span style="color:#9ECBFF"> dist_branch2</span></span>
<span class="line"><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$BRANCH2</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ></span><span style="color:#9ECBFF">dist_branch2/branchname.txt</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "Build complete!"</span></span>
<span class="line"><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$BRANCH1</span><span style="color:#9ECBFF"> build: dist_branch1/index.js"</span></span>
<span class="line"><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$BRANCH2</span><span style="color:#9ECBFF"> build: dist_branch2/index.js"</span></span></code></pre>
<p>Then in your package.json you can have</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="json"><code><span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#79B8FF">  "name"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"yourpackage"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">  "version"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"0.0.0"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">  "scripts"</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#79B8FF">    "build"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"yourbuild that outputs to a folder named dist"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">    "prebench"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"./scripts/build-both-branches.sh $BRANCH1 $BRANCH2"</span></span>
<span class="line"><span style="color:#9ECBFF">    "bench"</span><span style="color:#FDAEB7;font-style:italic">:</span><span style="color:#9ECBFF"> "vitest bench"</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Finally, you can run your benchmark like this:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="sh"><code><span class="line"><span style="color:#6A737D"># default: compare current branch against main</span></span>
<span class="line"><span style="color:#B392F0">yarn</span><span style="color:#9ECBFF"> bench</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># or, set custom env variables to compare two arbitrary branches, branch1 and branch2</span></span>
<span class="line"><span style="color:#E1E4E8">BRANCH1</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">branch1</span><span style="color:#E1E4E8"> BRANCH2</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">branch2</span><span style="color:#B392F0"> yarn</span><span style="color:#9ECBFF"> bench</span></span></code></pre>
<p>Then if you have a function in your code that you want to optimize, like this…</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#6A737D">// src/index.ts</span></span>
<span class="line"><span style="color:#F97583">export</span><span style="color:#F97583"> function</span><span style="color:#B392F0"> pow</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">n</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">exp</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">  return</span><span style="color:#E1E4E8"> Math.</span><span style="color:#B392F0">pow</span><span style="color:#E1E4E8">(n, exp)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Then you can make a new branch with a genius idea that plain multiplying in a
loop would be better</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#6A737D">// src/index.ts</span></span>
<span class="line"><span style="color:#F97583">export</span><span style="color:#F97583"> function</span><span style="color:#B392F0"> pow</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">n</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">exp</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">  let</span><span style="color:#E1E4E8"> total </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> n</span></span>
<span class="line"><span style="color:#F97583">  for</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">; i </span><span style="color:#F97583">&#x3C;</span><span style="color:#E1E4E8"> exp; i</span><span style="color:#F97583">++</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">    total </span><span style="color:#F97583">*=</span><span style="color:#E1E4E8"> n</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Then you can make a benchmark like this</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> { readFileSync } </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> 'fs'</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> { bench, describe } </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> 'vitest'</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> { pow </span><span style="color:#F97583">as</span><span style="color:#E1E4E8"> pow1 } </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> '../dist_branch1/index.js'</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> { pow </span><span style="color:#F97583">as</span><span style="color:#E1E4E8"> pow2 } </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> '../dist_branch2/index.js'</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> branch1Name</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> readFileSync</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'dist_branch1/branchname.txt'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'utf8'</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">trim</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> branch2Name</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> readFileSync</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'dist_branch2/branchname.txt'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'utf8'</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">trim</span><span style="color:#E1E4E8">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">function</span><span style="color:#B392F0"> benchPow</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#FFAB70">  n</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#FFAB70">  exp</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#FFAB70">  name</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#FFAB70">  opts</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">}</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#FFAB70">  n</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span></span>
<span class="line"><span style="color:#FFAB70">  exp</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span></span>
<span class="line"><span style="color:#FFAB70">  name</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span></span>
<span class="line"><span style="color:#FFAB70">  opts</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#FFAB70">    iterations</span><span style="color:#F97583">?:</span><span style="color:#79B8FF"> number</span></span>
<span class="line"><span style="color:#FFAB70">    warmupIterations</span><span style="color:#F97583">?:</span><span style="color:#79B8FF"> number</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}) {</span></span>
<span class="line"><span style="color:#B392F0">  describe</span><span style="color:#E1E4E8">(name, () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">    bench</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">      branch1Name,</span></span>
<span class="line"><span style="color:#E1E4E8">      () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">        pow1</span><span style="color:#E1E4E8">(n, exp)</span></span>
<span class="line"><span style="color:#E1E4E8">      },</span></span>
<span class="line"><span style="color:#E1E4E8">      opts,</span></span>
<span class="line"><span style="color:#E1E4E8">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    bench</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">      branch2Name,</span></span>
<span class="line"><span style="color:#E1E4E8">      () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">        pow2</span><span style="color:#E1E4E8">(n, exp)</span></span>
<span class="line"><span style="color:#E1E4E8">      },</span></span>
<span class="line"><span style="color:#E1E4E8">      opts,</span></span>
<span class="line"><span style="color:#E1E4E8">    )</span></span>
<span class="line"><span style="color:#E1E4E8">  })</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">benchPow</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">  name: </span><span style="color:#9ECBFF">'pow'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">  n: </span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">  exp: </span><span style="color:#79B8FF">10</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">  opts: {</span></span>
<span class="line"><span style="color:#E1E4E8">    warmupIterations: </span><span style="color:#79B8FF">100</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    iterations: </span><span style="color:#79B8FF">1000</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">  },</span></span>
<span class="line"><span style="color:#E1E4E8">})</span></span></code></pre>
<p>That benchmark code is a little more verbose than it needs to be, but it is
quite re-usable across projects</p>
<p>The resulting benchmark report clearly prints the branchname that is the fastest
with some nice statistics</p>
<p>An example of this is here <a href="https://github.com/cmdcolin/simple_benchmark_example">https://github.com/cmdcolin/simple_benchmark_example</a></p>
<h2 id="part-2-creating-end-to-end-benchmarks-using-puppeteer">Part 2. Creating ‘end-to-end’ benchmarks using Puppeteer</h2>
<p>Creating end-to-end benchmarks are really IMO where the rubber hits the road.
You have spent all day making microoptimizations, now it’s time to confirm it
makes an impact.</p>
<p>With puppeteer, you can test against live real builds of your webapp. I
recommend using production builds (not a dev server) and using localhost only
stuff to avoid network variability. Note that I also said ‘simple’ but this
setup is a little more involved generally</p>
<p>Here is an example setup I have used:</p>
<ul>
<li>You create multiple builds of your (web-) app</li>
<li>Store each build in a separate sub-directory in the <code>builds/</code> folder</li>
<li>Create this bash script, which runs hyperfine to measure the total time taken
by the puppeteer script</li>
</ul>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#6A737D">#!/bin/bash</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">BASE_PORT</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">8000</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">rm</span><span style="color:#79B8FF"> -rf</span><span style="color:#9ECBFF"> results</span></span>
<span class="line"><span style="color:#B392F0">mkdir</span><span style="color:#79B8FF"> -p</span><span style="color:#9ECBFF"> results</span></span>
<span class="line"><span style="color:#B392F0">mkdir</span><span style="color:#79B8FF"> -p</span><span style="color:#9ECBFF"> screenshots</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">## kill background scripts after finished</span></span>
<span class="line"><span style="color:#6A737D">## https://spin.atomicobject.com/2017/08/24/start-stop-bash-background-process/</span></span>
<span class="line"><span style="color:#79B8FF">trap</span><span style="color:#9ECBFF"> "exit"</span><span style="color:#9ECBFF"> INT</span><span style="color:#9ECBFF"> TERM</span></span>
<span class="line"><span style="color:#79B8FF">trap</span><span style="color:#9ECBFF"> "kill 0"</span><span style="color:#9ECBFF"> EXIT</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">X</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$BASE_PORT</span></span>
<span class="line"><span style="color:#F97583">for</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">in</span><span style="color:#9ECBFF"> builds/*</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">do</span></span>
<span class="line"><span style="color:#B392F0">  npx</span><span style="color:#9ECBFF"> http-server</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$i</span><span style="color:#9ECBFF">"</span><span style="color:#79B8FF"> -p</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$X</span><span style="color:#9ECBFF">"</span><span style="color:#79B8FF"> -s</span><span style="color:#E1E4E8"> &#x26;</span></span>
<span class="line"><span style="color:#79B8FF">  echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$X</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$i</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">  X</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$((</span><span style="color:#B392F0">X</span><span style="color:#9ECBFF"> +</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">))</span></span>
<span class="line"><span style="color:#F97583">done</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">declare</span><span style="color:#79B8FF"> -a</span><span style="color:#E1E4E8"> commands</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">declare</span><span style="color:#79B8FF"> -a</span><span style="color:#E1E4E8"> names</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">X</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$BASE_PORT</span></span>
<span class="line"><span style="color:#F97583">for</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">in</span><span style="color:#9ECBFF"> builds/*</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">do</span></span>
<span class="line"><span style="color:#E1E4E8">  build_name</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">basename</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$i</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">  screenshot_path</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"screenshots/</span><span style="color:#E1E4E8">$build_name</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">  commands</span><span style="color:#F97583">+=</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"node scripts/profile_app.ts </span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">http://localhost:</span><span style="color:#E1E4E8">$X</span><span style="color:#9ECBFF">/</span><span style="color:#79B8FF">\"</span><span style="color:#79B8FF"> \"</span><span style="color:#E1E4E8">$screenshot_path</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">  names</span><span style="color:#F97583">+=</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"-n"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$build_name</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">  X</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$((</span><span style="color:#B392F0">X</span><span style="color:#9ECBFF"> +</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">))</span></span>
<span class="line"><span style="color:#F97583">done</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "Running hyperfine with the following commands:"</span></span>
<span class="line"><span style="color:#F97583">for</span><span style="color:#E1E4E8"> cmd </span><span style="color:#F97583">in</span><span style="color:#9ECBFF"> "${</span><span style="color:#E1E4E8">commands</span><span style="color:#9ECBFF">[</span><span style="color:#F97583">@</span><span style="color:#9ECBFF">]}"</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">do</span></span>
<span class="line"><span style="color:#79B8FF">  echo</span><span style="color:#9ECBFF"> "  - </span><span style="color:#E1E4E8">$cmd</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#F97583">done</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">hyperfine</span><span style="color:#79B8FF"> -i</span><span style="color:#79B8FF"> --export-json</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$output_json</span><span style="color:#9ECBFF">.json"</span><span style="color:#79B8FF"> --warmup</span><span style="color:#79B8FF"> 1</span><span style="color:#79B8FF"> --runs</span><span style="color:#79B8FF"> 8</span><span style="color:#9ECBFF"> "${</span><span style="color:#E1E4E8">names</span><span style="color:#9ECBFF">[</span><span style="color:#F97583">@</span><span style="color:#9ECBFF">]}"</span><span style="color:#9ECBFF"> "${</span><span style="color:#E1E4E8">commands</span><span style="color:#9ECBFF">[</span><span style="color:#F97583">@</span><span style="color:#9ECBFF">]}"</span></span>
<span class="line"><span style="color:#79B8FF">echo</span><span style="color:#79B8FF"> -e</span><span style="color:#9ECBFF"> "\n"</span></span>
<span class="line"></span></code></pre>
<p>Then you can have your puppeteer script</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#6A737D">// profile_app.ts</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> puppeteer </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> 'puppeteer'</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> WAIT_TIMEOUT</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 30_000</span><span style="color:#6A737D"> // 30 seconds</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> url</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> process.argv[</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">]</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> screenshotPath</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> process.argv[</span><span style="color:#79B8FF">3</span><span style="color:#E1E4E8">]</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> browser</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#E1E4E8"> puppeteer.</span><span style="color:#B392F0">launch</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">  args: [</span><span style="color:#9ECBFF">'--no-sandbox'</span><span style="color:#E1E4E8">], </span><span style="color:#6A737D">// needed on my linux setup, not ideal probably</span></span>
<span class="line"><span style="color:#E1E4E8">})</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> page</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#E1E4E8"> browser.</span><span style="color:#B392F0">newPage</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">goto</span><span style="color:#E1E4E8">(url)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> params</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> URL</span><span style="color:#E1E4E8">(url).searchParams</span></span>
<span class="line"><span style="color:#F97583">await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">waitForFunction</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">  () </span><span style="color:#F97583">=></span></span>
<span class="line"><span style="color:#E1E4E8">    document.</span><span style="color:#B392F0">querySelectorAll</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'[data-testid="thing_to_wait_for"]'</span><span style="color:#E1E4E8">).</span><span style="color:#79B8FF">length</span><span style="color:#F97583"> ===</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">  {</span></span>
<span class="line"><span style="color:#E1E4E8">    timeout: </span><span style="color:#79B8FF">WAIT_TIMEOUT</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">  },</span></span>
<span class="line"><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#6A737D">// create screenshots to confirm visually</span></span>
<span class="line"><span style="color:#F97583">await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">screenshot</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">  path: screenshotPath </span><span style="color:#F97583">+</span><span style="color:#9ECBFF"> '.png'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">await</span><span style="color:#E1E4E8"> browser.</span><span style="color:#B392F0">close</span><span style="color:#E1E4E8">()</span></span></code></pre>
<p>This can be invoked directly as a .ts file with <code>node file.ts</code> (since node.js
automatically strips types now)! Optionally you can make puppeteer do user
actions like click around, etc. to test realistic scenarios. It is good to
confirm that you are visually testing the right thing by checking the outputted
screenshots.</p>
<h2 id="sidenote-agentically-optimizing-your-code">Sidenote: Agentically optimizing your code</h2>
<p>Formulating tests and benchmarks like this can allow AI to start automatically
or agentically iterating to find faster solutions.</p>
<p>You can just ask Claude code to “find optimizations”, and see if it comes up
with anything that actually works. It’s not always that good at finding very
impactful optimizations, but with a human in the loop you can guide it towards
some interesting solutions.</p>
<p>You can even tell Claude to look at a screenshot of a flamegraph or analyze
.cpuprofile files that are generated from <code>node --cpu-prof script.ts</code>. See
footnote here
<a href="https://github.com/cmdcolin/simple_benchmark_example?tab=readme-ov-file#analyze-cpuprofile">https://github.com/cmdcolin/simple_benchmark_example?tab=readme-ov-file#analyze-cpuprofile</a></p>
<h2 id="happy-thanksgiving">Happy thanksgiving</h2>
<p><img src="/media/turkey.jpg" alt=""></p>
<p>Wild turkeys can run up to 25 miles per hour</p>
<p>[1] It is probably not absolutely required to use the compiled artifacts to run
the benchmarks. The benchmarks by default for example can just read from the
‘src’ folder. However, using the compiled artifacts is a fairly ‘simple’ way to
avoid collisions otherwise encountered from checking out the code from each
branch.</p>
<p>[2] You might get errors if different sets of e.g. package.json libraries are
used on the branch and main. In that case, you can install the union of the
libraries on your branch temporarily (should only be needed on your “BRANCH2”)</p>
<p>[3] I say this as someone that has superstitiously implemented hundreds of
microptimizations for it to have absolutely zero effect in a end-to-end
benchmark. Conversely, these branch comparison tests have allowed me to ratchet
back-to-back 5-10% improvements to achieve significant gains</p>
<p>[4] This is not strictly related but some good ideas here by some people who are
smarter than me <a href="https://abseil.io/fast/hints.html">https://abseil.io/fast/hints.html</a></p> </div> <div id="giscus"></div> <script>
  const script = document.createElement('script');
  script.src = 'https://giscus.app/client.js';
  script.setAttribute('data-repo', 'cmdcolin/cmdcolin.github.io');
  script.setAttribute('data-repo-id', 'MDEwOlJlcG9zaXRvcnkyNjE0OTY3Nw==');
  script.setAttribute('data-category', 'General');
  script.setAttribute('data-category-id', 'DIC_kwDOAY8DLc4CO-L9');
  script.setAttribute('data-mapping', 'pathname');
  script.setAttribute('data-strict', '0');
  script.setAttribute('data-reactions-enabled', '1');
  script.setAttribute('data-emit-metadata', '0');
  script.setAttribute('data-input-position', 'bottom');
  script.setAttribute('data-theme', 'light');
  script.setAttribute('data-lang', 'en');
  script.setAttribute('crossorigin', 'anonymous');
  script.async = true;
  document.getElementById('giscus').appendChild(script);
</script> </article>  </div>   <footer class="footer-style" data-astro-cid-k2f5zb5c> <a class="footer-link" href="/" data-astro-cid-k2f5zb5c>Home</a> <a class="footer-link" href="/archive" data-astro-cid-k2f5zb5c>Blog archive</a> <a class="footer-link" href="https://github.com/cmdcolin/" data-astro-cid-k2f5zb5c>Github</a> <a class="footer-link" href="/projects" data-astro-cid-k2f5zb5c>Projects</a> <a class="footer-link" href="/about" data-astro-cid-k2f5zb5c>About</a> </footer> </body></html> 