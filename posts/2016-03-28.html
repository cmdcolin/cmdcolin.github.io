<!DOCTYPE html><html lang="en"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="shortcut icon" href="favicon.ico"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><meta name="description" content="Blogging for the future"/><title>Running nginx on containerised travis-CI pt 2</title><meta name="next-head-count" content="6"/><link rel="preload" href="/_next/static/css/895e0128ed383e47.css" as="style"/><link rel="stylesheet" href="/_next/static/css/895e0128ed383e47.css" data-n-g=""/><link rel="preload" href="/_next/static/css/e1f6961df2961232.css" as="style"/><link rel="stylesheet" href="/_next/static/css/e1f6961df2961232.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-514908bffb652963.js" defer=""></script><script src="/_next/static/chunks/framework-91d7f78b5b4003c8.js" defer=""></script><script src="/_next/static/chunks/main-7c3bf82eed00c281.js" defer=""></script><script src="/_next/static/chunks/pages/_app-76cd57bf65f05d70.js" defer=""></script><script src="/_next/static/chunks/162-34cdd443a23a768b.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-2c663bbcac870718.js" defer=""></script><script src="/_next/static/wRE5shyr7ZdzrAZY-3qqN/_buildManifest.js" defer=""></script><script src="/_next/static/wRE5shyr7ZdzrAZY-3qqN/_ssgManifest.js" defer=""></script><script src="/_next/static/wRE5shyr7ZdzrAZY-3qqN/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="min-h-screen"><main><div class="container mx-auto px-5"><div class="text-2xl md:text-4xl font-bold py-14 border-b border-accent-2 flex flex-col lg:flex-row items-center"><a class="hover:underline" href="/">Misc scribbles</a></div><article class="mb-32"><h1 class="text-2xl md:text-2xl lg:text-2xl font-bold tracking-tighter leading-tight md:leading-none mb-12 text-center md:text-left">Running nginx on containerised travis-CI pt 2<!-- --> - <!-- -->2016-03-28</h1><div class="max-w-1xl mx-auto"><div class="markdown-styles_markdown__h_8de"><p>There are several guides out there about how to setup nginx on travis-CI
but I still found it to be a challenge, especially finding a modern one
that works with the containerized builds. I was frustrated that things
like <code>SimpleHTTPServer</code> from python and http-server from npm did not have
fully enough features to run our app either (a complex "static-site
generator" type thing you might say), and I was also too lazy to setup
"sauce labs" (which I have not used, but presume has some better ability
to run functional/browser tests).</p>
<p>Essentially, the problem with running nginx under the containerized
build is that it "likes to be sudo", with many logfiles by default going
to different places that only sudo has access to.</p>
<p>This link is probably the most similar to the technique I use here, but
it is now gone (?) and must be accessed through the internet archive!</p>
<p><a href="http://www.doublesignal.com/running-nginx-on-containerised-travis-ci"></a><a href="https://web.archive.org/web/20150919050719/http://www.doublesignal.com/running-nginx-on-containerised-travis-ci">https://web.archive.org/web/20150919050719/http://www.doublesignal.com/running-nginx-on-containerised-travis-ci</a></p>
<p>My technique is very similar, however I use an extra trick to set the
file root to the current directory (instead of /tmp/nowhere as in the
link) by using "envsubst" to replace variables in the nginx config file.</p>
<p>Without further ado, the .travis.yml can look like this</p>
<pre><code>    sudo: false
    addons:
      apt:
        packages:
        - nginx
    install:
      - cat tests/travis.conf | envsubst > tests/travis-envsubst.conf
      - nginx -c `pwd`/tests/travis-envsubst.conf
    script:
      - wget http://localhost:9000/yourfiles
</code></pre>
<p>Then your nginx config file can look like this</p>
<pre><code>    worker_processes 10;
    pid /tmp/nginx.pid;

    error_log /tmp/error.log;

    events {
        worker_connections 768;
    }

    http {
        client_body_temp_path /tmp/nginx_client_body;
        fastcgi_temp_path     /tmp/nginx_fastcgi_temp;
        proxy_temp_path       /tmp/nginx_proxy_temp;
        scgi_temp_path        /tmp/nginx_scgi_temp;
        uwsgi_temp_path       /tmp/nginx_uwsgi_temp;

        server {
            listen 9000 default_server;

            server_name localhost;
            location / {
                root $TRAVIS_BUILD_DIR;
                index  index.html index.htm;
            }
            error_log /tmp/error.log;
            access_log /tmp/access.log;
        }
    }

</code></pre>
<p>Then, when travis-CI is run, it uses envsubst to replace
<code>$TRAVIS_BUILD_DIR</code> in the tests/travis.conf file, and then boots up
nginx</p>
</div></div></article></div></main></div><footer class="bg-accent-1 border-t border-accent-2"><div class="container mx-auto px-5"><div class="py-14 flex flex-col lg:flex-row items-center"><div class="m-4"><a class="hover:underline" href="/">Home</a></div><div class="m-4"><a class="hover:underline" href="https://github.com/cmdcolin">Github</a></div><div class="m-4"><a class="hover:underline" href="https://twitter.com/cmdcolin">Twitter</a></div><div class="m-4"><a class="hover:underline" href="/projects">Projects</a></div><div class="m-4"><a class="hover:underline" href="/rss.xml">RSS</a></div></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"Running nginx on containerised travis-CI pt 2","date":"2016-03-28","slug":"2016-03-28","content":"\u003cp\u003eThere are several guides out there about how to setup nginx on travis-CI\nbut I still found it to be a challenge, especially finding a modern one\nthat works with the containerized builds. I was frustrated that things\nlike \u003ccode\u003eSimpleHTTPServer\u003c/code\u003e from python and http-server from npm did not have\nfully enough features to run our app either (a complex \"static-site\ngenerator\" type thing you might say), and I was also too lazy to setup\n\"sauce labs\" (which I have not used, but presume has some better ability\nto run functional/browser tests).\u003c/p\u003e\n\u003cp\u003eEssentially, the problem with running nginx under the containerized\nbuild is that it \"likes to be sudo\", with many logfiles by default going\nto different places that only sudo has access to.\u003c/p\u003e\n\u003cp\u003eThis link is probably the most similar to the technique I use here, but\nit is now gone (?) and must be accessed through the internet archive!\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"http://www.doublesignal.com/running-nginx-on-containerised-travis-ci\"\u003e\u003c/a\u003e\u003ca href=\"https://web.archive.org/web/20150919050719/http://www.doublesignal.com/running-nginx-on-containerised-travis-ci\"\u003ehttps://web.archive.org/web/20150919050719/http://www.doublesignal.com/running-nginx-on-containerised-travis-ci\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eMy technique is very similar, however I use an extra trick to set the\nfile root to the current directory (instead of /tmp/nowhere as in the\nlink) by using \"envsubst\" to replace variables in the nginx config file.\u003c/p\u003e\n\u003cp\u003eWithout further ado, the .travis.yml can look like this\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e    sudo: false\n    addons:\n      apt:\n        packages:\n        - nginx\n    install:\n      - cat tests/travis.conf | envsubst \u003e tests/travis-envsubst.conf\n      - nginx -c `pwd`/tests/travis-envsubst.conf\n    script:\n      - wget http://localhost:9000/yourfiles\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThen your nginx config file can look like this\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e    worker_processes 10;\n    pid /tmp/nginx.pid;\n\n    error_log /tmp/error.log;\n\n    events {\n        worker_connections 768;\n    }\n\n    http {\n        client_body_temp_path /tmp/nginx_client_body;\n        fastcgi_temp_path     /tmp/nginx_fastcgi_temp;\n        proxy_temp_path       /tmp/nginx_proxy_temp;\n        scgi_temp_path        /tmp/nginx_scgi_temp;\n        uwsgi_temp_path       /tmp/nginx_uwsgi_temp;\n\n        server {\n            listen 9000 default_server;\n\n            server_name localhost;\n            location / {\n                root $TRAVIS_BUILD_DIR;\n                index  index.html index.htm;\n            }\n            error_log /tmp/error.log;\n            access_log /tmp/access.log;\n        }\n    }\n\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThen, when travis-CI is run, it uses envsubst to replace\n\u003ccode\u003e$TRAVIS_BUILD_DIR\u003c/code\u003e in the tests/travis.conf file, and then boots up\nnginx\u003c/p\u003e\n"}},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"2016-03-28"},"buildId":"wRE5shyr7ZdzrAZY-3qqN","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>