<!DOCTYPE html><html lang="en"><head><link rel="shortcut icon" href="favicon.ico"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><meta name="description" content="Blogging for the future"/><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/prism.min.js" integrity="sha512-hpZ5pDCF2bRCweL5WoA0/N1elet1KYL5mx3LP555Eg/0ZguaHawxNvEjF6O3rufAChs16HVNhEc6blF/rZoowQ==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Running nginx on containerised travis-CI pt 2</title><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/fd6c173fc46e1e45.css" as="style"/><link rel="stylesheet" href="/_next/static/css/fd6c173fc46e1e45.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-514908bffb652963.js" defer=""></script><script src="/_next/static/chunks/framework-91d7f78b5b4003c8.js" defer=""></script><script src="/_next/static/chunks/main-7c3bf82eed00c281.js" defer=""></script><script src="/_next/static/chunks/pages/_app-76cd57bf65f05d70.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-3f0808b29fe77886.js" defer=""></script><script src="/_next/static/9HO2PYZa3JB4R_X5N0UEm/_buildManifest.js" defer=""></script><script src="/_next/static/9HO2PYZa3JB4R_X5N0UEm/_ssgManifest.js" defer=""></script><script src="/_next/static/9HO2PYZa3JB4R_X5N0UEm/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div><main><div><div><a href="/">Misc scribbles</a></div><article><h1>Running nginx on containerised travis-CI pt 2<!-- --> - <!-- -->2016-03-28</h1><p>There are several guides out there about how to setup nginx on travis-CI
but I still found it to be a challenge, especially finding a modern one
that works with the containerized builds. I was frustrated that things
like <code>SimpleHTTPServer</code> from python and http-server from npm did not have
fully enough features to run our app either (a complex &quot;static-site
generator&quot; type thing you might say), and I was also too lazy to setup
&quot;sauce labs&quot; (which I have not used, but presume has some better ability
to run functional/browser tests).</p><p>Essentially, the problem with running nginx under the containerized
build is that it &quot;likes to be sudo&quot;, with many logfiles by default going
to different places that only sudo has access to.</p><p>This link is probably the most similar to the technique I use here, but
it is now gone (?) and must be accessed through the internet archive!</p><p><a href="http://www.doublesignal.com/running-nginx-on-containerised-travis-ci"></a><a href="https://web.archive.org/web/20150919050719/http://www.doublesignal.com/running-nginx-on-containerised-travis-ci">https://web.archive.org/web/20150919050719/http://www.doublesignal.com/running-nginx-on-containerised-travis-ci</a></p><p>My technique is very similar, however I use an extra trick to set the
file root to the current directory (instead of /tmp/nowhere as in the
link) by using &quot;envsubst&quot; to replace variables in the nginx config file.</p><p>Without further ado, the .travis.yml can look like this</p><pre><code>    sudo: false
    addons:
      apt:
        packages:
        - nginx
    install:
      - cat tests/travis.conf | envsubst &gt; tests/travis-envsubst.conf
      - nginx -c `pwd`/tests/travis-envsubst.conf
    script:
      - wget http://localhost:9000/yourfiles
</code></pre><p>Then your nginx config file can look like this</p><pre><code>    worker_processes 10;
    pid /tmp/nginx.pid;

    error_log /tmp/error.log;

    events {
        worker_connections 768;
    }

    http {
        client_body_temp_path /tmp/nginx_client_body;
        fastcgi_temp_path     /tmp/nginx_fastcgi_temp;
        proxy_temp_path       /tmp/nginx_proxy_temp;
        scgi_temp_path        /tmp/nginx_scgi_temp;
        uwsgi_temp_path       /tmp/nginx_uwsgi_temp;

        server {
            listen 9000 default_server;

            server_name localhost;
            location / {
                root $TRAVIS_BUILD_DIR;
                index  index.html index.htm;
            }
            error_log /tmp/error.log;
            access_log /tmp/access.log;
        }
    }

</code></pre><p>Then, when travis-CI is run, it uses envsubst to replace
<code>$TRAVIS_BUILD_DIR</code> in the tests/travis.conf file, and then boots up
nginx</p></article></div></main></div><footer style="margin-top:20px"><a href="/">Home</a> <a href="/archive">Blog archive</a> <a href="https://github.com/cmdcolin">Github</a> <a href="https://twitter.com/cmdcolin">Twitter</a> <a href="/projects">Projects</a> <a href="/photos">Photos</a> <a href="/rss.xml">RSS</a></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"Running nginx on containerised travis-CI pt 2","date":"2016-03-28","slug":"2016-03-28","mdxSource":{"compiledSource":"var c=Object.defineProperty,u=Object.defineProperties;var g=Object.getOwnPropertyDescriptors;var s=Object.getOwnPropertySymbols;var r=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable;var p=(e,t,n)=\u003et in e?c(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,o=(e,t)=\u003e{for(var n in t||(t={}))r.call(t,n)\u0026\u0026p(e,n,t[n]);if(s)for(var n of s(t))a.call(t,n)\u0026\u0026p(e,n,t[n]);return e},l=(e,t)=\u003eu(e,g(t));var h=(e,t)=\u003e{var n={};for(var i in e)r.call(e,i)\u0026\u0026t.indexOf(i)\u003c0\u0026\u0026(n[i]=e[i]);if(e!=null\u0026\u0026s)for(var i of s(e))t.indexOf(i)\u003c0\u0026\u0026a.call(e,i)\u0026\u0026(n[i]=e[i]);return n};const layoutProps={},MDXLayout=\"wrapper\";function MDXContent(n){var i=n,{components:e}=i,t=h(i,[\"components\"]);return mdx(MDXLayout,l(o(o({},layoutProps),t),{components:e,mdxType:\"MDXLayout\"}),mdx(\"p\",null,`There are several guides out there about how to setup nginx on travis-CI\nbut I still found it to be a challenge, especially finding a modern one\nthat works with the containerized builds. I was frustrated that things\nlike `,mdx(\"inlineCode\",{parentName:\"p\"},\"SimpleHTTPServer\"),` from python and http-server from npm did not have\nfully enough features to run our app either (a complex \"static-site\ngenerator\" type thing you might say), and I was also too lazy to setup\n\"sauce labs\" (which I have not used, but presume has some better ability\nto run functional/browser tests).`),mdx(\"p\",null,`Essentially, the problem with running nginx under the containerized\nbuild is that it \"likes to be sudo\", with many logfiles by default going\nto different places that only sudo has access to.`),mdx(\"p\",null,`This link is probably the most similar to the technique I use here, but\nit is now gone (?) and must be accessed through the internet archive!`),mdx(\"p\",null,mdx(\"a\",o({parentName:\"p\"},{href:\"http://www.doublesignal.com/running-nginx-on-containerised-travis-ci\"})),mdx(\"a\",o({parentName:\"p\"},{href:\"https://web.archive.org/web/20150919050719/http://www.doublesignal.com/running-nginx-on-containerised-travis-ci\"}),\"https://web.archive.org/web/20150919050719/http://www.doublesignal.com/running-nginx-on-containerised-travis-ci\")),mdx(\"p\",null,`My technique is very similar, however I use an extra trick to set the\nfile root to the current directory (instead of /tmp/nowhere as in the\nlink) by using \"envsubst\" to replace variables in the nginx config file.`),mdx(\"p\",null,\"Without further ado, the .travis.yml can look like this\"),mdx(\"pre\",null,mdx(\"code\",o({parentName:\"pre\"},{}),`    sudo: false\n    addons:\n      apt:\n        packages:\n        - nginx\n    install:\n      - cat tests/travis.conf | envsubst \u003e tests/travis-envsubst.conf\n      - nginx -c \\`pwd\\`/tests/travis-envsubst.conf\n    script:\n      - wget http://localhost:9000/yourfiles\n`)),mdx(\"p\",null,\"Then your nginx config file can look like this\"),mdx(\"pre\",null,mdx(\"code\",o({parentName:\"pre\"},{}),`    worker_processes 10;\n    pid /tmp/nginx.pid;\n\n    error_log /tmp/error.log;\n\n    events {\n        worker_connections 768;\n    }\n\n    http {\n        client_body_temp_path /tmp/nginx_client_body;\n        fastcgi_temp_path     /tmp/nginx_fastcgi_temp;\n        proxy_temp_path       /tmp/nginx_proxy_temp;\n        scgi_temp_path        /tmp/nginx_scgi_temp;\n        uwsgi_temp_path       /tmp/nginx_uwsgi_temp;\n\n        server {\n            listen 9000 default_server;\n\n            server_name localhost;\n            location / {\n                root $TRAVIS_BUILD_DIR;\n                index  index.html index.htm;\n            }\n            error_log /tmp/error.log;\n            access_log /tmp/access.log;\n        }\n    }\n\n`)),mdx(\"p\",null,`Then, when travis-CI is run, it uses envsubst to replace\n`,mdx(\"inlineCode\",{parentName:\"p\"},\"$TRAVIS_BUILD_DIR\"),` in the tests/travis.conf file, and then boots up\nnginx`))}MDXContent.isMDXComponent=!0;\n","scope":{}}}},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"2016-03-28"},"buildId":"9HO2PYZa3JB4R_X5N0UEm","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>