<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>Running nginx on containerised travis-CI pt 2</title><meta name="next-head-count" content="3"/><link rel="shortcut icon" href="favicon.ico"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><meta name="description" content="Blogging for the future"/><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/prism.min.js" integrity="sha512-hpZ5pDCF2bRCweL5WoA0/N1elet1KYL5mx3LP555Eg/0ZguaHawxNvEjF6O3rufAChs16HVNhEc6blF/rZoowQ==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="preload" href="/_next/static/css/9d066bf523979bbf.css" as="style"/><link rel="stylesheet" href="/_next/static/css/9d066bf523979bbf.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-8b306f51a35d80a9.js" defer=""></script><script src="/_next/static/chunks/framework-c0d8f0fd2eea5ac1.js" defer=""></script><script src="/_next/static/chunks/main-4ce9603599af9a95.js" defer=""></script><script src="/_next/static/chunks/pages/_app-d9139de5c3de3b6b.js" defer=""></script><script src="/_next/static/chunks/996-3d2a4318c0ac6f1a.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-a48b13f8f13172f9.js" defer=""></script><script src="/_next/static/BP58I9e7t-NbLop5aihnd/_buildManifest.js" defer=""></script><script src="/_next/static/BP58I9e7t-NbLop5aihnd/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div><main><div><div style="margin-bottom:100px"><a href="/">Misc scribbles</a></div><article><div><h1>Running nginx on containerised travis-CI pt 2</h1><h4>2016-03-28</h4></div><p>There are several guides out there about how to setup nginx on travis-CI
but I still found it to be a challenge, especially finding a modern one
that works with the containerized builds. I was frustrated that things
like <code>SimpleHTTPServer</code> from python and http-server from npm did not have
fully enough features to run our app either (a complex &quot;static-site
generator&quot; type thing you might say), and I was also too lazy to setup
&quot;sauce labs&quot; (which I have not used, but presume has some better ability
to run functional/browser tests).</p>
<p>Essentially, the problem with running nginx under the containerized
build is that it &quot;likes to be sudo&quot;, with many logfiles by default going
to different places that only sudo has access to.</p>
<p>This link is probably the most similar to the technique I use here, but
it is now gone (?) and must be accessed through the internet archive!</p>
<p><a href="https://web.archive.org/web/20150919050719/http://www.doublesignal.com/running-nginx-on-containerised-travis-ci">http://www.doublesignal.com/running-nginx-on-containerised-travis-ci</a></p>
<p>My technique is very similar, however I use an extra trick to set the
file root to the current directory (instead of /tmp/nowhere as in the
link) by using &quot;envsubst&quot; to replace variables in the nginx config file.</p>
<p>Without further ado, the .travis.yml can look like this</p>
<pre><code>    sudo: false
    addons:
      apt:
        packages:
        - nginx
    install:
      - cat tests/travis.conf | envsubst &gt; tests/travis-envsubst.conf
      - nginx -c `pwd`/tests/travis-envsubst.conf
    script:
      - wget http://localhost:9000/yourfiles
</code></pre>
<p>Then your nginx config file can look like this</p>
<pre><code>    worker_processes 10;
    pid /tmp/nginx.pid;

    error_log /tmp/error.log;

    events {
        worker_connections 768;
    }

    http {
        client_body_temp_path /tmp/nginx_client_body;
        fastcgi_temp_path     /tmp/nginx_fastcgi_temp;
        proxy_temp_path       /tmp/nginx_proxy_temp;
        scgi_temp_path        /tmp/nginx_scgi_temp;
        uwsgi_temp_path       /tmp/nginx_uwsgi_temp;

        server {
            listen 9000 default_server;

            server_name localhost;
            location / {
                root $TRAVIS_BUILD_DIR;
                index  index.html index.htm;
            }
            error_log /tmp/error.log;
            access_log /tmp/access.log;
        }
    }

</code></pre>
<p>Then, when travis-CI is run, it uses envsubst to replace
<code>$TRAVIS_BUILD_DIR</code> in the tests/travis.conf file, and then boots up
nginx</p><div style="margin-top:200px"></div></article></div></main></div><footer style="margin-top:100px"><a href="/">Home</a> <a href="/archive">Blog archive</a> <a href="https://github.com/cmdcolin/">Github</a> <a href="https://twitter.com/cmdcolin">Twitter</a> <a href="/projects">Projects</a> <a href="/photos">Photos</a> <a href="/rss.xml">RSS</a><a href="/about">About</a> </footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"Running nginx on containerised travis-CI pt 2","date":"2016-03-28","slug":"2016-03-28","mdxSource":{"compiledSource":"/*@jsxRuntime automatic @jsxImportSource react*/\nconst {Fragment: _Fragment, jsx: _jsx, jsxs: _jsxs} = arguments[0];\nconst {useMDXComponents: _provideComponents} = arguments[0];\nfunction _createMdxContent(props) {\n  const _components = Object.assign({\n    p: \"p\",\n    code: \"code\",\n    a: \"a\",\n    pre: \"pre\"\n  }, _provideComponents(), props.components);\n  return _jsxs(_Fragment, {\n    children: [_jsxs(_components.p, {\n      children: [\"There are several guides out there about how to setup nginx on travis-CI\\nbut I still found it to be a challenge, especially finding a modern one\\nthat works with the containerized builds. I was frustrated that things\\nlike \", _jsx(_components.code, {\n        children: \"SimpleHTTPServer\"\n      }), \" from python and http-server from npm did not have\\nfully enough features to run our app either (a complex \\\"static-site\\ngenerator\\\" type thing you might say), and I was also too lazy to setup\\n\\\"sauce labs\\\" (which I have not used, but presume has some better ability\\nto run functional/browser tests).\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Essentially, the problem with running nginx under the containerized\\nbuild is that it \\\"likes to be sudo\\\", with many logfiles by default going\\nto different places that only sudo has access to.\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"This link is probably the most similar to the technique I use here, but\\nit is now gone (?) and must be accessed through the internet archive!\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.a, {\n        href: \"https://web.archive.org/web/20150919050719/http://www.doublesignal.com/running-nginx-on-containerised-travis-ci\",\n        children: \"http://www.doublesignal.com/running-nginx-on-containerised-travis-ci\"\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"My technique is very similar, however I use an extra trick to set the\\nfile root to the current directory (instead of /tmp/nowhere as in the\\nlink) by using \\\"envsubst\\\" to replace variables in the nginx config file.\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Without further ado, the .travis.yml can look like this\"\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        children: \"    sudo: false\\n    addons:\\n      apt:\\n        packages:\\n        - nginx\\n    install:\\n      - cat tests/travis.conf | envsubst \u003e tests/travis-envsubst.conf\\n      - nginx -c `pwd`/tests/travis-envsubst.conf\\n    script:\\n      - wget http://localhost:9000/yourfiles\\n\"\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Then your nginx config file can look like this\"\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        children: \"    worker_processes 10;\\n    pid /tmp/nginx.pid;\\n\\n    error_log /tmp/error.log;\\n\\n    events {\\n        worker_connections 768;\\n    }\\n\\n    http {\\n        client_body_temp_path /tmp/nginx_client_body;\\n        fastcgi_temp_path     /tmp/nginx_fastcgi_temp;\\n        proxy_temp_path       /tmp/nginx_proxy_temp;\\n        scgi_temp_path        /tmp/nginx_scgi_temp;\\n        uwsgi_temp_path       /tmp/nginx_uwsgi_temp;\\n\\n        server {\\n            listen 9000 default_server;\\n\\n            server_name localhost;\\n            location / {\\n                root $TRAVIS_BUILD_DIR;\\n                index  index.html index.htm;\\n            }\\n            error_log /tmp/error.log;\\n            access_log /tmp/access.log;\\n        }\\n    }\\n\\n\"\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Then, when travis-CI is run, it uses envsubst to replace\\n\", _jsx(_components.code, {\n        children: \"$TRAVIS_BUILD_DIR\"\n      }), \" in the tests/travis.conf file, and then boots up\\nnginx\"]\n    })]\n  });\n}\nfunction MDXContent(props = {}) {\n  const {wrapper: MDXLayout} = Object.assign({}, _provideComponents(), props.components);\n  return MDXLayout ? _jsx(MDXLayout, Object.assign({}, props, {\n    children: _jsx(_createMdxContent, props)\n  })) : _createMdxContent(props);\n}\nreturn {\n  default: MDXContent\n};\n","frontmatter":{},"scope":{}}}},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"2016-03-28"},"buildId":"BP58I9e7t-NbLop5aihnd","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>