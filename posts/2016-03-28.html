<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><link rel="stylesheet" href="/_next/static/css/97dc5fe527f5d592.css" data-precedence="next.js"/><title>Running nginx on containerised travis-CI pt 2</title><meta name="description" content="A blog"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="icon" href="/favicon.ico" type="image/x-icon" sizes="any"/><script src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js" noModule=""></script></head><body><div style="margin-bottom:100px"><a href="/">Misc scribbles</a></div><article><div><h1>Running nginx on containerised travis-CI pt 2</h1><h4>2016-03-28</h4></div><div><p>There are several guides out there about how to setup nginx on travis-CI but I
still found it to be a challenge, especially finding a modern one that works
with the containerized builds. I was frustrated that things like
<code>SimpleHTTPServer</code> from python and http-server from npm did not have fully
enough features to run our app either (a complex "static-site generator" type
thing you might say), and I was also too lazy to setup "sauce labs" (which I
have not used, but presume has some better ability to run functional/browser
tests).</p>
<p>Essentially, the problem with running nginx under the containerized build is
that it "likes to be sudo", with many logfiles by default going to different
places that only sudo has access to.</p>
<p>This link is probably the most similar to the technique I use here, but it is
now gone (?) and must be accessed through the internet archive!</p>
<p><a href="https://web.archive.org/web/20150919050719/http://www.doublesignal.com/running-nginx-on-containerised-travis-ci">http://www.doublesignal.com/running-nginx-on-containerised-travis-ci</a></p>
<p>My technique is very similar, however I use an extra trick to set the file root
to the current directory (instead of /tmp/nowhere as in the link) by using
"envsubst" to replace variables in the nginx config file.</p>
<p>Without further ado, the .travis.yml can look like this</p>
<pre class="shiki poimandres" style="background-color: #1b1e28" tabindex="0"><code><span class="line"><span style="color: #5DE4C7">sudo</span><span style="color: #A6ACCD">: </span><span style="color: #5DE4C7">false</span></span>
<span class="line"><span style="color: #5DE4C7">addons</span><span style="color: #A6ACCD">:</span></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #5DE4C7">apt</span><span style="color: #A6ACCD">:</span></span>
<span class="line"><span style="color: #A6ACCD">    </span><span style="color: #5DE4C7">packages</span><span style="color: #A6ACCD">:</span></span>
<span class="line"><span style="color: #A6ACCD">      - </span><span style="color: #ADD7FF">nginx</span></span>
<span class="line"><span style="color: #5DE4C7">install</span><span style="color: #A6ACCD">:</span></span>
<span class="line"><span style="color: #A6ACCD">  - </span><span style="color: #ADD7FF">cat tests/travis.conf | envsubst > tests/travis-envsubst.conf</span></span>
<span class="line"><span style="color: #A6ACCD">  - </span><span style="color: #ADD7FF">nginx -c `pwd`/tests/travis-envsubst.conf</span></span>
<span class="line"><span style="color: #5DE4C7">script</span><span style="color: #A6ACCD">:</span></span>
<span class="line"><span style="color: #A6ACCD">  - </span><span style="color: #ADD7FF">wget http://localhost:9000/yourfiles</span></span></code></pre>
<p>Then your nginx config file can look like this</p>
<pre><code>    worker_processes 10;
    pid /tmp/nginx.pid;

    error_log /tmp/error.log;

    events {
        worker_connections 768;
    }

    http {
        client_body_temp_path /tmp/nginx_client_body;
        fastcgi_temp_path     /tmp/nginx_fastcgi_temp;
        proxy_temp_path       /tmp/nginx_proxy_temp;
        scgi_temp_path        /tmp/nginx_scgi_temp;
        uwsgi_temp_path       /tmp/nginx_uwsgi_temp;

        server {
            listen 9000 default_server;

            server_name localhost;
            location / {
                root $TRAVIS_BUILD_DIR;
                index  index.html index.htm;
            }
            error_log /tmp/error.log;
            access_log /tmp/access.log;
        }
    }

</code></pre>
<p>Then, when travis-CI is run, it uses envsubst to replace <code>$TRAVIS_BUILD_DIR</code> in
the <code>tests/travis.conf</code> file, and then boots up nginx</p></div><div style="margin-top:200px"></div></article><footer style="margin-top:100px"><a href="/">Home</a> <a href="/archive">Blog archive</a> <a href="https://github.com/cmdcolin/">Github</a> <a href="https://twitter.com/cmdcolin">Twitter</a> <a href="/projects">Projects</a> <a href="/photos">Photos</a> <a href="/about">About</a></footer><script src="/_next/static/chunks/webpack-3224743bbfce757e.js" async=""></script><script src="/_next/static/chunks/2443530c-6156b7f4e8f5b2c4.js" async=""></script><script src="/_next/static/chunks/139-f487b95f332b70cd.js" async=""></script><script src="/_next/static/chunks/main-app-a6dbbaaf1ec67e34.js" async=""></script></body></html><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"0:\"$L1\"\n"])</script><script>self.__next_f.push([1,"2:I{\"id\":\"7858\",\"chunks\":[\"272:static/chunks/webpack-3224743bbfce757e.js\",\"667:static/chunks/2443530c-6156b7f4e8f5b2c4.js\",\"139:static/chunks/139-f487b95f332b70cd.js\"],\"name\":\"\",\"async\":false}\n4:I{\"id\":\"3055\",\"chunks\":[\"272:static/chunks/webpack-3224743bbfce757e.js\",\"667:static/chunks/2443530c-6156b7f4e8f5b2c4.js\",\"139:static/chunks/139-f487b95f332b70cd.js\"],\"name\":\"\",\"async\":false}\n5:I{\"id\":\"414\",\"chunks\":[\"414:static/chunks/414-67273665b1a3d6a7.js\",\"931:static/chunks/app/page-dc06b9eb7e80dd25.js\"],\"name\":"])</script><script>self.__next_f.push([1,"\"\",\"async\":false}\n6:I{\"id\":\"9544\",\"chunks\":[\"272:static/chunks/webpack-3224743bbfce757e.js\",\"667:static/chunks/2443530c-6156b7f4e8f5b2c4.js\",\"139:static/chunks/139-f487b95f332b70cd.js\"],\"name\":\"\",\"async\":false}\n7:I{\"id\":\"99\",\"chunks\":[\"272:static/chunks/webpack-3224743bbfce757e.js\",\"667:static/chunks/2443530c-6156b7f4e8f5b2c4.js\",\"139:static/chunks/139-f487b95f332b70cd.js\"],\"name\":\"\",\"async\":false}\n"])</script><script>self.__next_f.push([1,"1:[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/97dc5fe527f5d592.css\",\"precedence\":\"next.js\"}]],[\"$\",\"$L2\",null,{\"assetPrefix\":\"\",\"initialCanonicalUrl\":\"/posts/2016-03-28\",\"initialTree\":[\"\",{\"children\":[\"posts\",{\"children\":[[\"id\",\"2016-03-28\",\"d\"],{\"children\":[\"__PAGE__?{\\\"id\\\":\\\"2016-03-28\\\"}\",{}]}]}]},\"$undefined\",\"$undefined\",true],\"initialHead\":\"$L3\",\"globalErrorComponent\":\"$4\",\"notFound\":[\"$\",\"html\",null,{\"lang\":\"en\",\"children\":[\"$\",\"body\",null,{\"children\":[[\"$\",\"div\",null,{\"style\":{\"marginBottom\":100},\"children\":[\"$\",\"$L5\",null,{\"href\":\"/\",\"children\":\"Misc scribbles\"}]}],[\"$undefined\",[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":\"404\"}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]]],[\"$\",\"footer\",null,{\"style\":{\"marginTop\":100},\"children\":[[\"$\",\"$L5\",null,{\"href\":\"/\",\"children\":\"Home\"}],\" \",[\"$\",\"$L5\",null,{\"href\":\"/archive\",\"children\":\"Blog archive\"}],\" \",[\"$\",\"$L5\",null,{\"href\":\"https://github.com/cmdcolin/\",\"children\":\"Github\"}],\" \",[\"$\",\"$L5\",null,{\"href\":\"https://twitter.com/cmdcolin\",\"children\":\"Twitter\"}],\" \",[\"$\",\"$L5\",null,{\"href\":\"/projects\",\"children\":\"Projects\"}],\" \",[\"$\",\"$L5\",null,{\"href\":\"/photos\",\"children\":\"Photos\"}],\" \",[\"$\",\"$L5\",null,{\"href\":\"/about\",\"children\":\"About\"}]]}]]}]}],\"asNotFound\":false,\"children\":[[\"$\",\"html\",null,{\"lang\":\"en\",\"children\":[\"$\",\"body\",null,{\"children\":[[\"$\",\"div\",null,{\"style\":{\"marginBottom\":100},\"children\":[\"$\",\"$L5\",null,{\"href\":\"/\",\"children\":\"Misc scribbles\"}]}],[\"$\",\"$L6\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"template\":[\"$\",\"$L7\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"asNotFound\":false,\"childProp\":{\"current\":[\"$\",\"$L6\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"posts\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"template\":[\"$\",\"$L7\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"asNotFound\":false,\"childProp\":{\"current\":[\"$\",\"$L6\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"posts\",\"children\",[\"id\",\"2016-03-28\",\"d\"],\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"template\":[\"$\",\"$L7\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"asNotFound\":false,\"childProp\":{\"current\":[\"$L8\",[null,null]],\"segment\":\"__PAGE__?{\\\"id\\\":\\\"2016-03-28\\\"}\"},\"styles\":[]}],\"segment\":[\"id\",\"2016-03-28\",\"d\"]},\"styles\":[]}],\"segment\":\"posts\"},\"styles\":[]}],[\"$\",\"footer\",null,{\"style\":{\"marginTop\":100},\"children\":[[\"$\",\"$L5\",null,{\"href\":\"/\",\"children\":\"Home\"}],\" \",[\"$\",\"$L5\",null,{\"href\":\"/archive\",\"children\":\"Blog archive\"}],\" \",[\"$\",\"$L5\",null,{\"href\":\"https://github.com/cmdcolin/\",\"children\":\"Github\"}],\" \",[\"$\",\"$L5\",null,{\"href\":\"https://twitter.com/cmdcolin\",\"children\":\"Twitter\"}],\" \",[\"$\",\"$L5\",null,{\"href\":\"/projects\",\"children\":\"Projects\"}],\" \",[\"$\",\"$L5\",null,{\"href\":\"/photos\",\"children\":\"Photos\"}],\" \",[\"$\",\"$L5\",null,{\"href\":\"/about\",\"children\":\"About\"}]]}]]}]}],[null,null]]}]]\n"])</script><script>self.__next_f.push([1,"9:I{\"id\":\"6677\",\"chunks\":[\"722:static/chunks/app/posts/[id]/page-433af8cd6c54ad7f.js\"],\"name\":\"\",\"async\":false}\n"])</script><script>self.__next_f.push([1,"8:[\"$\",\"article\",null,{\"children\":[[\"$\",\"div\",null,{\"children\":[[\"$\",\"h1\",null,{\"children\":\"Running nginx on containerised travis-CI pt 2\"}],[\"$\",\"h4\",null,{\"children\":\"2016-03-28\"}]]}],[\"$\",\"div\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"\u003cp\u003eThere are several guides out there about how to setup nginx on travis-CI but I\\nstill found it to be a challenge, especially finding a modern one that works\\nwith the containerized builds. I was frustrated that things like\\n\u003ccode\u003eSimpleHTTPServer\u003c/code\u003e from python and http-server from npm did not have fully\\nenough features to run our app either (a complex \\\"static-site generator\\\" type\\nthing you might say), and I was also too lazy to setup \\\"sauce labs\\\" (which I\\nhave not used, but presume has some better ability to run functional/browser\\ntests).\u003c/p\u003e\\n\u003cp\u003eEssentially, the problem with running nginx under the containerized build is\\nthat it \\\"likes to be sudo\\\", with many logfiles by default going to different\\nplaces that only sudo has access to.\u003c/p\u003e\\n\u003cp\u003eThis link is probably the most similar to the technique I use here, but it is\\nnow gone (?) and must be accessed through the internet archive!\u003c/p\u003e\\n\u003cp\u003e\u003ca href=\\\"https://web.archive.org/web/20150919050719/http://www.doublesignal.com/running-nginx-on-containerised-travis-ci\\\"\u003ehttp://www.doublesignal.com/running-nginx-on-containerised-travis-ci\u003c/a\u003e\u003c/p\u003e\\n\u003cp\u003eMy technique is very similar, however I use an extra trick to set the file root\\nto the current directory (instead of /tmp/nowhere as in the link) by using\\n\\\"envsubst\\\" to replace variables in the nginx config file.\u003c/p\u003e\\n\u003cp\u003eWithout further ado, the .travis.yml can look like this\u003c/p\u003e\\n\u003cpre class=\\\"shiki poimandres\\\" style=\\\"background-color: #1b1e28\\\" tabindex=\\\"0\\\"\u003e\u003ccode\u003e\u003cspan class=\\\"line\\\"\u003e\u003cspan style=\\\"color: #5DE4C7\\\"\u003esudo\u003c/span\u003e\u003cspan style=\\\"color: #A6ACCD\\\"\u003e: \u003c/span\u003e\u003cspan style=\\\"color: #5DE4C7\\\"\u003efalse\u003c/span\u003e\u003c/span\u003e\\n\u003cspan class=\\\"line\\\"\u003e\u003cspan style=\\\"color: #5DE4C7\\\"\u003eaddons\u003c/span\u003e\u003cspan style=\\\"color: #A6ACCD\\\"\u003e:\u003c/span\u003e\u003c/span\u003e\\n\u003cspan class=\\\"line\\\"\u003e\u003cspan style=\\\"color: #A6ACCD\\\"\u003e  \u003c/span\u003e\u003cspan style=\\\"color: #5DE4C7\\\"\u003eapt\u003c/span\u003e\u003cspan style=\\\"color: #A6ACCD\\\"\u003e:\u003c/span\u003e\u003c/span\u003e\\n\u003cspan class=\\\"line\\\"\u003e\u003cspan style=\\\"color: #A6ACCD\\\"\u003e    \u003c/span\u003e\u003cspan style=\\\"color: #5DE4C7\\\"\u003epackages\u003c/span\u003e\u003cspan style=\\\"color: #A6ACCD\\\"\u003e:\u003c/span\u003e\u003c/span\u003e\\n\u003cspan class=\\\"line\\\"\u003e\u003cspan style=\\\"color: #A6ACCD\\\"\u003e      - \u003c/span\u003e\u003cspan style=\\\"color: #ADD7FF\\\"\u003enginx\u003c/span\u003e\u003c/span\u003e\\n\u003cspan class=\\\"line\\\"\u003e\u003cspan style=\\\"color: #5DE4C7\\\"\u003einstall\u003c/span\u003e\u003cspan style=\\\"color: #A6ACCD\\\"\u003e:\u003c/span\u003e\u003c/span\u003e\\n\u003cspan class=\\\"line\\\"\u003e\u003cspan style=\\\"color: #A6ACCD\\\"\u003e  - \u003c/span\u003e\u003cspan style=\\\"color: #ADD7FF\\\"\u003ecat tests/travis.conf | envsubst \u003e tests/travis-envsubst.conf\u003c/span\u003e\u003c/span\u003e\\n\u003cspan class=\\\"line\\\"\u003e\u003cspan style=\\\"color: #A6ACCD\\\"\u003e  - \u003c/span\u003e\u003cspan style=\\\"color: #ADD7FF\\\"\u003enginx -c `pwd`/tests/travis-envsubst.conf\u003c/span\u003e\u003c/span\u003e\\n\u003cspan class=\\\"line\\\"\u003e\u003cspan style=\\\"color: #5DE4C7\\\"\u003escript\u003c/span\u003e\u003cspan style=\\\"color: #A6ACCD\\\"\u003e:\u003c/span\u003e\u003c/span\u003e\\n\u003cspan class=\\\"line\\\"\u003e\u003cspan style=\\\"color: #A6ACCD\\\"\u003e  - \u003c/span\u003e\u003cspan style=\\\"color: #ADD7FF\\\"\u003ewget http://localhost:9000/yourfiles\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\\n\u003cp\u003eThen your nginx config file can look like this\u003c/p\u003e\\n\u003cpre\u003e\u003ccode\u003e    worker_processes 10;\\n    pid /tmp/nginx.pid;\\n\\n    error_log /tmp/error.log;\\n\\n    events {\\n        worker_connections 768;\\n    }\\n\\n    http {\\n        client_body_temp_path /tmp/nginx_client_body;\\n        fastcgi_temp_path     /tmp/nginx_fastcgi_temp;\\n        proxy_temp_path       /tmp/nginx_proxy_temp;\\n        scgi_temp_path        /tmp/nginx_scgi_temp;\\n        uwsgi_temp_path       /tmp/nginx_uwsgi_temp;\\n\\n        server {\\n            listen 9000 default_server;\\n\\n            server_name localhost;\\n            location / {\\n                root $TRAVIS_BUILD_DIR;\\n                index  index.html index.htm;\\n            }\\n            error_log /tmp/error.log;\\n            access_log /tmp/access.log;\\n        }\\n    }\\n\\n\u003c/code\u003e\u003c/pre\u003e\\n\u003cp\u003eThen, when travis-CI is run, it uses envsubst to replace \u003ccode\u003e$TRAVIS_BUILD_DIR\u003c/code\u003e in\\nthe \u003ccode\u003etests/travis.conf\u003c/code\u003e file, and then boots up nginx\u003c/p\u003e\"}}],[\"$\",\"$L9\",null,{}]]}]\n"])</script><script>self.__next_f.push([1,"3:[[[\"$\",\"meta\",null,{\"charSet\":\"utf-8\"}],[\"$\",\"title\",null,{\"children\":\"Running nginx on containerised travis-CI pt 2\"}],[\"$\",\"meta\",null,{\"name\":\"description\",\"content\":\"A blog\"}],null,null,null,null,null,null,null,null,[\"$\",\"meta\",null,{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],null,null,null,null,null,null,null,null,null,null,[]],[null,null,null,null],null,null,[null,null,null,null,null],null,null,null,null,[null,[[\"$\",\"link\",null,{\"rel\":\"icon\",\"href\":\"/favicon.ico\",\"type\":\"image/x-icon\",\"sizes\":\"any\"}]],[],null]]\n"])</script>