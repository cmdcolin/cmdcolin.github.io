<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="/_next/static/css/97dc5fe527f5d592.css" crossorigin="" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-19ac6e418b88dab7.js" crossorigin=""/><script src="/_next/static/chunks/fd9d1056-4f3ded6b28b5a2e1.js" async="" crossorigin=""></script><script src="/_next/static/chunks/472-4cc56711664dd41c.js" async="" crossorigin=""></script><script src="/_next/static/chunks/main-app-f0c90f8f86464e49.js" async="" crossorigin=""></script><script src="/_next/static/chunks/326-f70436363102ecf4.js" async=""></script><script src="/_next/static/chunks/app/page-0c1302a539e2db94.js" async=""></script><script src="/_next/static/chunks/app/posts/%5Bid%5D/page-64ff32a4d1c61109.js" async=""></script><title>Decrease your idle CPU usage when developing typescript apps with this one weird environment variable</title><meta name="description" content="A blog"/><link rel="icon" href="/favicon.ico" type="image/x-icon" sizes="128x128"/><script src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js" crossorigin="" noModule=""></script></head><body><div style="margin-bottom:100px"><a href="/">Misc scribbles</a></div><article><div><h1>Decrease your idle CPU usage when developing typescript apps with this one weird environment variable</h1><h4>2021-09-05</h4></div><div><p>TL;DR:</p>
<p>add this to your bashrc</p>
<pre class="shiki poimandres" style="background-color: #1b1e28" tabindex="0"><code><span class="line"><span style="color: #5DE4C7">export</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">TSC_WATCHFILE</span><span style="color: #91B4D5">=</span><span style="color: #ADD7FF">UseFsEventsWithFallbackDynamicPolling</span></span></code></pre>
<p>By default, the typescript watcher configuration e.g. tsc --watch or whatever is
run internally to a create-react-app typescript app (I see it in the process
manager as fork-ts-checker-webpack-plugin cpu usage) can have high idling (doing
nothing...) CPU usage</p>
<p>This is because the default configuration polls for file changes (constantly
asks the computer if there are changes every 250ms or so). There is an
alternative configuration for this to change it to a file watcher so it receives
file system notifications on file change. There is discussion here on this.</p>
<p>The main summary is that a env variable set to
TSC_WATCHFILE=UseFsEventsWithFallbackDynamicPolling allows this</p>
<p><a href="https://github.com/microsoft/TypeScript/issues/31048">https://github.com/microsoft/TypeScript/issues/31048</a></p>
<p>The issue thread shows that it can go from roughly ~7% idle CPU usage to 0.2%.
This corresponds with what I see too after applying this! Detailed docs for
typescript discuss some of the reasoning being not making this the default</p>
<p><a href="https://github.com/microsoft/TypeScript-Handbook/blob/master/pages/Configuring%20Watch.md#background">https://github.com/microsoft/TypeScript-Handbook/blob/master/pages/Configuring%20Watch.md#background</a></p>
<p>It claims that some OS specific behaviors of file watching could be harmful to
making it the default. For example, that (maybe?) on linux, it may use a large
number of file watchers which can exceed notify handles (this is a setting I
commonly have to increase in linux, guide here
<a href="https://dev.to/rubiin/ubuntu-increase-inotify-watcher-file-watch-limit-kf4">https://dev.to/rubiin/ubuntu-increase-inotify-watcher-file-watch-limit-kf4</a>)</p>
<p>PS: if you have a package.json of a <code>create-react-app --template typescript</code> or
something like this then you can edit the package.json to apply this
automatically</p>
<pre><code>-"start": "react-scripts start"
+"start": "cross-env TSC_WATCHFILE=UseFsEventsWithFallbackDynamicPolling react-scripts start"
</code></pre>
<p>Phew. I can already feel my laptop running cooler...or at least I can sleep more
soundly knowing that my readers adopt this and save some CPU cycles for planet
earth...and hopefully don't run into any of the caveats</p>
<p>Edit: It may be worth it to note, the 'UseFsEvents' part of this uses the
node.js fs.watch API and the polling based API is based on fs.watchFile</p>
<p>Fun table of how the watchers are implemented on different OSs
[<a href="https://github.com/microsoft/TypeScript/issues/31048#issuecomment-495483957">1</a>]</p>
<pre><code>On Linux systems, this uses inotify(7).
On BSD systems, this uses kqueue(2).
On macOS, this uses kqueue(2) for files and FSEvents for directories.
On SunOS systems (including Solaris and SmartOS), this uses event ports.
On Windows systems, this feature depends on ReadDirectoryChangesW.
On Aix systems, this feature depends on AHAFS, which must be enabled.
</code></pre>
<p>And in general, these should all respond more or less the same, but there are
small corner cases that are discussed
<a href="https://nodejs.org/docs/latest/api/fs.html#fs_availability">https://nodejs.org/docs/latest/api/fs.html#fs_availability</a></p>
<p>Disclaimer: it may be worth reading the reasons that typescript does not have
this enabled by default before pushing this into your dev environment and all
your teammates, but as far as I could tell, it seems ok!</p></div><div style="margin-top:200px"></div></article><footer style="margin-top:100px"><a href="/">Home</a><a href="/archive">Blog archive</a><a href="https://github.com/cmdcolin/">Github</a><a href="https://twitter.com/cmdcolin">Twitter</a><a href="/projects">Projects</a> <a href="/photos">Photos</a><a href="/books">Books</a><a href="/about">About</a></footer><script src="/_next/static/chunks/webpack-19ac6e418b88dab7.js" crossorigin="" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0]);self.__next_f.push([2,null])</script><script>self.__next_f.push([1,"1:HL[\"/_next/static/css/97dc5fe527f5d592.css\",\"style\",{\"crossOrigin\":\"\"}]\n0:\"$L2\"\n"])</script><script>self.__next_f.push([1,"3:I[3728,[],\"\"]\n5:I[9928,[],\"\"]\n6:I[8326,[\"326\",\"static/chunks/326-f70436363102ecf4.js\",\"931\",\"static/chunks/app/page-0c1302a539e2db94.js\"],\"\"]\n7:I[6954,[],\"\"]\n8:I[7264,[],\"\"]\n"])</script><script>self.__next_f.push([1,"2:[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/97dc5fe527f5d592.css\",\"precedence\":\"next\",\"crossOrigin\":\"\"}]],[\"$\",\"$L3\",null,{\"buildId\":\"RoIQc495aggcEzC7RQ-t2\",\"assetPrefix\":\"\",\"initialCanonicalUrl\":\"/posts/2021-09-05-typescript\",\"initialTree\":[\"\",{\"children\":[\"posts\",{\"children\":[[\"id\",\"2021-09-05-typescript\",\"d\"],{\"children\":[\"__PAGE__?{\\\"id\\\":\\\"2021-09-05-typescript\\\"}\",{}]}]}]},\"$undefined\",\"$undefined\",true],\"initialHead\":[false,\"$L4\"],\"globalErrorComponent\":\"$5\",\"children\":[null,[\"$\",\"html\",null,{\"lang\":\"en\",\"children\":[\"$\",\"body\",null,{\"children\":[[\"$\",\"div\",null,{\"style\":{\"marginBottom\":100},\"children\":[\"$\",\"$L6\",null,{\"href\":\"/\",\"children\":\"Misc scribbles\"}]}],[\"$\",\"$L7\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"loadingScripts\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L8\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":\"404\"}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],\"notFoundStyles\":[],\"childProp\":{\"current\":[\"$\",\"$L7\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"posts\",\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"loadingScripts\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L8\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"childProp\":{\"current\":[\"$\",\"$L7\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"posts\",\"children\",[\"id\",\"2021-09-05-typescript\",\"d\"],\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"loadingScripts\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L8\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"childProp\":{\"current\":[\"$L9\",\"$La\",null],\"segment\":\"__PAGE__?{\\\"id\\\":\\\"2021-09-05-typescript\\\"}\"},\"styles\":null}],\"segment\":[\"id\",\"2021-09-05-typescript\",\"d\"]},\"styles\":null}],\"segment\":\"posts\"},\"styles\":null}],[\"$\",\"footer\",null,{\"style\":{\"marginTop\":100},\"children\":[[\"$\",\"$L6\",null,{\"href\":\"/\",\"children\":\"Home\"}],[\"$\",\"$L6\",null,{\"href\":\"/archive\",\"children\":\"Blog archive\"}],[\"$\",\"$L6\",null,{\"href\":\"https://github.com/cmdcolin/\",\"children\":\"Github\"}],[\"$\",\"$L6\",null,{\"href\":\"https://twitter.com/cmdcolin\",\"children\":\"Twitter\"}],[\"$\",\"$L6\",null,{\"href\":\"/projects\",\"children\":\"Projects\"}],\" \",[\"$\",\"$L6\",null,{\"href\":\"/photos\",\"children\":\"Photos\"}],[\"$\",\"$L6\",null,{\"href\":\"/books\",\"children\":\"Books\"}],[\"$\",\"$L6\",null,{\"href\":\"/about\",\"children\":\"About\"}]]}]]}]}],null]}]]\n"])</script><script>self.__next_f.push([1,"c:I[5854,[\"722\",\"static/chunks/app/posts/%5Bid%5D/page-64ff32a4d1c61109.js\"],\"\"]\nb:Tf21,"])</script><script>self.__next_f.push([1,"\u003cp\u003eTL;DR:\u003c/p\u003e\n\u003cp\u003eadd this to your bashrc\u003c/p\u003e\n\u003cpre class=\"shiki poimandres\" style=\"background-color: #1b1e28\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #5DE4C7\"\u003eexport\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003eTSC_WATCHFILE\u003c/span\u003e\u003cspan style=\"color: #91B4D5\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #ADD7FF\"\u003eUseFsEventsWithFallbackDynamicPolling\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eBy default, the typescript watcher configuration e.g. tsc --watch or whatever is\nrun internally to a create-react-app typescript app (I see it in the process\nmanager as fork-ts-checker-webpack-plugin cpu usage) can have high idling (doing\nnothing...) CPU usage\u003c/p\u003e\n\u003cp\u003eThis is because the default configuration polls for file changes (constantly\nasks the computer if there are changes every 250ms or so). There is an\nalternative configuration for this to change it to a file watcher so it receives\nfile system notifications on file change. There is discussion here on this.\u003c/p\u003e\n\u003cp\u003eThe main summary is that a env variable set to\nTSC_WATCHFILE=UseFsEventsWithFallbackDynamicPolling allows this\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/microsoft/TypeScript/issues/31048\"\u003ehttps://github.com/microsoft/TypeScript/issues/31048\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eThe issue thread shows that it can go from roughly ~7% idle CPU usage to 0.2%.\nThis corresponds with what I see too after applying this! Detailed docs for\ntypescript discuss some of the reasoning being not making this the default\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/microsoft/TypeScript-Handbook/blob/master/pages/Configuring%20Watch.md#background\"\u003ehttps://github.com/microsoft/TypeScript-Handbook/blob/master/pages/Configuring%20Watch.md#background\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eIt claims that some OS specific behaviors of file watching could be harmful to\nmaking it the default. For example, that (maybe?) on linux, it may use a large\nnumber of file watchers which can exceed notify handles (this is a setting I\ncommonly have to increase in linux, guide here\n\u003ca href=\"https://dev.to/rubiin/ubuntu-increase-inotify-watcher-file-watch-limit-kf4\"\u003ehttps://dev.to/rubiin/ubuntu-increase-inotify-watcher-file-watch-limit-kf4\u003c/a\u003e)\u003c/p\u003e\n\u003cp\u003ePS: if you have a package.json of a \u003ccode\u003ecreate-react-app --template typescript\u003c/code\u003e or\nsomething like this then you can edit the package.json to apply this\nautomatically\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e-\"start\": \"react-scripts start\"\n+\"start\": \"cross-env TSC_WATCHFILE=UseFsEventsWithFallbackDynamicPolling react-scripts start\"\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003ePhew. I can already feel my laptop running cooler...or at least I can sleep more\nsoundly knowing that my readers adopt this and save some CPU cycles for planet\nearth...and hopefully don't run into any of the caveats\u003c/p\u003e\n\u003cp\u003eEdit: It may be worth it to note, the 'UseFsEvents' part of this uses the\nnode.js fs.watch API and the polling based API is based on fs.watchFile\u003c/p\u003e\n\u003cp\u003eFun table of how the watchers are implemented on different OSs\n[\u003ca href=\"https://github.com/microsoft/TypeScript/issues/31048#issuecomment-495483957\"\u003e1\u003c/a\u003e]\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eOn Linux systems, this uses inotify(7).\nOn BSD systems, this uses kqueue(2).\nOn macOS, this uses kqueue(2) for files and FSEvents for directories.\nOn SunOS systems (including Solaris and SmartOS), this uses event ports.\nOn Windows systems, this feature depends on ReadDirectoryChangesW.\nOn Aix systems, this feature depends on AHAFS, which must be enabled.\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAnd in general, these should all respond more or less the same, but there are\nsmall corner cases that are discussed\n\u003ca href=\"https://nodejs.org/docs/latest/api/fs.html#fs_availability\"\u003ehttps://nodejs.org/docs/latest/api/fs.html#fs_availability\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eDisclaimer: it may be worth reading the reasons that typescript does not have\nthis enabled by default before pushing this into your dev environment and all\nyour teammates, but as far as I could tell, it seems ok!\u003c/p\u003e"])</script><script>self.__next_f.push([1,"a:[\"$\",\"article\",null,{\"children\":[[\"$\",\"div\",null,{\"children\":[[\"$\",\"h1\",null,{\"children\":\"Decrease your idle CPU usage when developing typescript apps with this one weird environment variable\"}],[\"$\",\"h4\",null,{\"children\":\"2021-09-05\"}]]}],[\"$\",\"div\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"$b\"}}],[\"$\",\"$Lc\",null,{}]]}]\n"])</script><script>self.__next_f.push([1,"4:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"meta\",\"1\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"2\",{\"children\":\"Decrease your idle CPU usage when developing typescript apps with this one weird environment variable\"}],[\"$\",\"meta\",\"3\",{\"name\":\"description\",\"content\":\"A blog\"}],[\"$\",\"link\",\"4\",{\"rel\":\"icon\",\"href\":\"/favicon.ico\",\"type\":\"image/x-icon\",\"sizes\":\"128x128\"}]]\n9:null\n"])</script><script>self.__next_f.push([1,""])</script></body></html>