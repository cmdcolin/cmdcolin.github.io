<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>Making a serverless website for photo upload pt. 1</title><meta name="next-head-count" content="3"/><link rel="shortcut icon" href="favicon.ico"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><meta name="description" content="Blogging for the future"/><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/prism.min.js" integrity="sha512-hpZ5pDCF2bRCweL5WoA0/N1elet1KYL5mx3LP555Eg/0ZguaHawxNvEjF6O3rufAChs16HVNhEc6blF/rZoowQ==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="preload" href="/_next/static/css/50853c3f2e0364c3.css" as="style"/><link rel="stylesheet" href="/_next/static/css/50853c3f2e0364c3.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-44bf98a9893a0a43.js" defer=""></script><script src="/_next/static/chunks/framework-654b6047e3d0e6e1.js" defer=""></script><script src="/_next/static/chunks/main-7b5a0c24ba528217.js" defer=""></script><script src="/_next/static/chunks/pages/_app-7749755fef3ce988.js" defer=""></script><script src="/_next/static/chunks/996-19d9cfbc73bc924b.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-8fde5d21e1028772.js" defer=""></script><script src="/_next/static/CE44Z5AKa5Qjfcw_hHSvR/_buildManifest.js" defer=""></script><script src="/_next/static/CE44Z5AKa5Qjfcw_hHSvR/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div><main><div><div style="margin-bottom:100px"><a href="/"><a>Misc scribbles</a></a></div><article><div><h1>Making a serverless website for photo upload pt. 1</h1><h4>2020-12-24</h4></div><div><p>I set out to make a serverless website for photo uploads. Our dearly
departed dixie dog needed a place to have photo uploads.</p>
<p>I didn't want to get charged dollars per month for a running ec2
instance, so I wanted something that was lightweight e.g. serverless,
and easy</p>
<p>I decided to follow this tutorial</p>
<p><a href="https://aws.amazon.com/blogs/compute/uploading-to-amazon-s3-directly-from-a-web-or-mobile-application/">https://aws.amazon.com/blogs/compute/uploading-to-amazon-s3-directly-from-a-web-or-mobile-application/</a></p>
<p>I really liked the command line deployment (aws-sam) because fiddling
around with the AWS web based control panel is ridiculously complicated</p>
<p>For example I also tried following this tutorial which uses the web
based UI (<a href="https://www.youtube.com/watch?v=mw_-0iCVpUc">https://www.youtube.com/watch?v=mw_-0iCVpUc</a>) and it just did
not work for me....I couldn't stay focused (blame ADHD or just my CLI
obsession?) and certain things like "Execution role" that they say to
modify are not there in the web UI anymore, so I just gave up (I did try
though!)</p>
<p>To install aws-sam I used homebrew</p>
<pre class="shiki" style="background-color: #1b1e28"><code><span class="line"><span style="color: #A6ACCD">brew tap aws/tap</span></span>
<span class="line"><span style="color: #A6ACCD">brew install aws-sam-cli</span></span>
<span class="line"><span style="color: #A6ACCD">brew install aws-sam-cli </span><span style="color: #767C9DB0"># I had to run the install command twice ref https://github.com/aws/aws-sam-cli/issues/2320#issuecomment-721414971</span></span>
<span class="line"></span>
<span class="line"><span style="color: #A6ACCD">git clone https://github.com/aws-samples/amazon-s3-presigned-urls-aws-sam</span></span>
<span class="line"><span style="color: #A6ACCD">cd amazon-s3-presigned-urls-aws-sam</span></span>
<span class="line"><span style="color: #A6ACCD">sam deploy --guided</span></span>
<span class="line"></span>
<span class="line"><span style="color: #767C9DB0"># proceeeds with a guided installation, I used all defaults except I</span></span>
<span class="line"><span style="color: #767C9DB0"># made "UploadRequestFunction may not have authorization definedIs</span></span>
<span class="line"><span style="color: #A6ACCD">Is this okay</span><span style="color: #91B4D5">?</span><span style="color: #A6ACCD"> [y/N]: y</span><span style="color: #A6ACCD">"</span></span></code></pre>
<p><img src="/media/638408397901987840_0.png" alt=""></p>
<p>They then in the tutorial describe trying to use postman to test</p>
<p>I test with <code>curl</code> instead</p>
<pre class="shiki" style="background-color: #1b1e28"><code><span class="line"><span style="color: #A6ACCD">curl </span><span style="color: #A6ACCD">'</span><span style="color: #5DE4C7">https://fjgbqj5436.execute-api.us-east-2.amazonaws.com/uploads</span><span style="color: #A6ACCD">'</span></span>
<span class="line"></span></code></pre>
<pre class="shiki" style="background-color: #1b1e28"><code><span class="line"><span style="color: #A6ACCD">{</span></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #A6ACCD">"</span><span style="color: #E4F0FB">uploadURL</span><span style="color: #A6ACCD">"</span><span style="color: #A6ACCD">: </span><span style="color: #A6ACCD">"</span><span style="color: #5DE4C7">https://sam-app-s3uploadbucket-1653634.s3.us-east-2.amazonaws.com/112162.jpg?Content-Type=image%2Fjpeg&#x26;X-Amz-Algorithm=AWS4-HMAC-SHA256&#x26;X-Amz-Credential=xxx&#x26;X-Amz-Date=20201224T174804Z&#x26;X-Amz-Expires=300&#x26;X-Amz-Security-Token=yyy&#x26;X-Amz-SignedHeaders=host</span><span style="color: #A6ACCD">"</span><span style="color: #A6ACCD">,</span></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #A6ACCD">"</span><span style="color: #E4F0FB">Key</span><span style="color: #A6ACCD">"</span><span style="color: #A6ACCD">: </span><span style="color: #A6ACCD">"</span><span style="color: #5DE4C7">112162.jpg</span><span style="color: #A6ACCD">"</span></span>
<span class="line"><span style="color: #A6ACCD">}</span></span></code></pre>
<p>The premise of this is you make a request, and then the response from
the API is a pre-signed URL that then allows you to upload directly to
S3. You can use <code>curl &#x3C;url> --upload-file yourfile.jpg</code>. This
automatically does a PUT request to the s3 bucket (yes, this is talking
directly to s3 now, not the lambda! the lambda is just for generating
the "pre-signed URL" to let you upload). Careful to copy it exactly as
is</p>
<pre class="shiki" style="background-color: #1b1e28"><code><span class="line"><span style="color: #A6ACCD">curl </span><span style="color: #A6ACCD">"</span><span style="color: #5DE4C7">https://sam-app-s3uploadbucket-1653634.s3.us-east-2.amazonaws.com/112162.jpg?Content-Type=image%2Fjpeg&#x26;X-Amz-Algorithm=AWS4-HMAC-SHA256&#x26;X-Amz-Credential=xxx&#x26;X-Amz-Date=20201224T174804Z&#x26;X-Amz-Expires=300&#x26;X-Amz-Security-Token=yyy&#x26;X-Amz-SignedHeaders=host</span><span style="color: #A6ACCD">"</span><span style="color: #A6ACCD"> --upload-file test.jpg</span></span></code></pre>
<p>There is no response, but I can then check the s3 console and see the
file upload is successful (all files are renamed)</p>
<p><img src="/media/638408397901987840_1.png" alt=""></p>
<p>Figure shows that the file upload is successful :)</p>
<p>Then we can edit the file frontend/index.html from the repo we cloned to
contain the lambda with the /uploads/ suffix</p>
<p>Then we manually upload this file to another s3 bucket or test it
locally</p>
<pre class="shiki" style="background-color: #1b1e28"><code><span class="line"><span style="color: #A6ACCD">aws s3 cp index.html s3://mybucket/</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color: #767C9DB0"># then ...visit that in the browser</span></span></code></pre>
<p>At this point the files are getting uploaded but not publically
accessible. To make them publically accessible we uncomment the
ACL: 'public-read' in the getSignedURL/app.js folder in the github repo</p>
<p><img src="/media/638408397901987840_3.png" alt=""></p>
<p>Figure showing the public-read uncommented</p>
<p><img src="/media/638408397901987840_4.png" alt=""></p>
<p>Figure showing the lines that need uncommenting in template.yaml in the
root of the github repo that allows putObject in s3 with the public-read
ACL</p>
<p>Re-run <code>sam deploy --guided</code>, same thing as at the start</p>
<p>Now the objects are publicly accessible!</p></div><div style="margin-top:200px"></div></article></div></main></div><footer style="margin-top:100px"><a href="/"><a>Home</a></a> <a href="/archive"><a>Blog archive</a></a> <a href="https://github.com/cmdcolin/"><a>Github</a></a> <a href="https://twitter.com/cmdcolin"><a>Twitter</a></a> <a href="/projects"><a>Projects</a></a> <a href="/photos"><a>Photos</a></a> <a href="/rss.xml"><a>RSS</a></a><a href="/about"><a>About</a></a> </footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"Making a serverless website for photo upload pt. 1","date":"2020-12-24","slug":"2020-12-24","html":"\u003cp\u003eI set out to make a serverless website for photo uploads. Our dearly\ndeparted dixie dog needed a place to have photo uploads.\u003c/p\u003e\n\u003cp\u003eI didn't want to get charged dollars per month for a running ec2\ninstance, so I wanted something that was lightweight e.g. serverless,\nand easy\u003c/p\u003e\n\u003cp\u003eI decided to follow this tutorial\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://aws.amazon.com/blogs/compute/uploading-to-amazon-s3-directly-from-a-web-or-mobile-application/\"\u003ehttps://aws.amazon.com/blogs/compute/uploading-to-amazon-s3-directly-from-a-web-or-mobile-application/\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eI really liked the command line deployment (aws-sam) because fiddling\naround with the AWS web based control panel is ridiculously complicated\u003c/p\u003e\n\u003cp\u003eFor example I also tried following this tutorial which uses the web\nbased UI (\u003ca href=\"https://www.youtube.com/watch?v=mw_-0iCVpUc\"\u003ehttps://www.youtube.com/watch?v=mw_-0iCVpUc\u003c/a\u003e) and it just did\nnot work for me....I couldn't stay focused (blame ADHD or just my CLI\nobsession?) and certain things like \"Execution role\" that they say to\nmodify are not there in the web UI anymore, so I just gave up (I did try\nthough!)\u003c/p\u003e\n\u003cp\u003eTo install aws-sam I used homebrew\u003c/p\u003e\n\u003cpre class=\"shiki\" style=\"background-color: #1b1e28\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003ebrew tap aws/tap\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003ebrew install aws-sam-cli\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003ebrew install aws-sam-cli \u003c/span\u003e\u003cspan style=\"color: #767C9DB0\"\u003e# I had to run the install command twice ref https://github.com/aws/aws-sam-cli/issues/2320#issuecomment-721414971\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003egit clone https://github.com/aws-samples/amazon-s3-presigned-urls-aws-sam\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003ecd amazon-s3-presigned-urls-aws-sam\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003esam deploy --guided\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #767C9DB0\"\u003e# proceeeds with a guided installation, I used all defaults except I\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #767C9DB0\"\u003e# made \"UploadRequestFunction may not have authorization definedIs\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003eIs this okay\u003c/span\u003e\u003cspan style=\"color: #91B4D5\"\u003e?\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e [y/N]: y\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e\"\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cimg src=\"/media/638408397901987840_0.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003eThey then in the tutorial describe trying to use postman to test\u003c/p\u003e\n\u003cp\u003eI test with \u003ccode\u003ecurl\u003c/code\u003e instead\u003c/p\u003e\n\u003cpre class=\"shiki\" style=\"background-color: #1b1e28\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003ecurl \u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e'\u003c/span\u003e\u003cspan style=\"color: #5DE4C7\"\u003ehttps://fjgbqj5436.execute-api.us-east-2.amazonaws.com/uploads\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e'\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cpre class=\"shiki\" style=\"background-color: #1b1e28\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e{\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e\"\u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003euploadURL\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e\"\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e\"\u003c/span\u003e\u003cspan style=\"color: #5DE4C7\"\u003ehttps://sam-app-s3uploadbucket-1653634.s3.us-east-2.amazonaws.com/112162.jpg?Content-Type=image%2Fjpeg\u0026#x26;X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026#x26;X-Amz-Credential=xxx\u0026#x26;X-Amz-Date=20201224T174804Z\u0026#x26;X-Amz-Expires=300\u0026#x26;X-Amz-Security-Token=yyy\u0026#x26;X-Amz-SignedHeaders=host\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e\"\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e\"\u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003eKey\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e\"\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e\"\u003c/span\u003e\u003cspan style=\"color: #5DE4C7\"\u003e112162.jpg\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe premise of this is you make a request, and then the response from\nthe API is a pre-signed URL that then allows you to upload directly to\nS3. You can use \u003ccode\u003ecurl \u0026#x3C;url\u003e --upload-file yourfile.jpg\u003c/code\u003e. This\nautomatically does a PUT request to the s3 bucket (yes, this is talking\ndirectly to s3 now, not the lambda! the lambda is just for generating\nthe \"pre-signed URL\" to let you upload). Careful to copy it exactly as\nis\u003c/p\u003e\n\u003cpre class=\"shiki\" style=\"background-color: #1b1e28\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003ecurl \u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e\"\u003c/span\u003e\u003cspan style=\"color: #5DE4C7\"\u003ehttps://sam-app-s3uploadbucket-1653634.s3.us-east-2.amazonaws.com/112162.jpg?Content-Type=image%2Fjpeg\u0026#x26;X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026#x26;X-Amz-Credential=xxx\u0026#x26;X-Amz-Date=20201224T174804Z\u0026#x26;X-Amz-Expires=300\u0026#x26;X-Amz-Security-Token=yyy\u0026#x26;X-Amz-SignedHeaders=host\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e\"\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e --upload-file test.jpg\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThere is no response, but I can then check the s3 console and see the\nfile upload is successful (all files are renamed)\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/media/638408397901987840_1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003eFigure shows that the file upload is successful :)\u003c/p\u003e\n\u003cp\u003eThen we can edit the file frontend/index.html from the repo we cloned to\ncontain the lambda with the /uploads/ suffix\u003c/p\u003e\n\u003cp\u003eThen we manually upload this file to another s3 bucket or test it\nlocally\u003c/p\u003e\n\u003cpre class=\"shiki\" style=\"background-color: #1b1e28\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003eaws s3 cp index.html s3://mybucket/\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #767C9DB0\"\u003e# then ...visit that in the browser\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAt this point the files are getting uploaded but not publically\naccessible. To make them publically accessible we uncomment the\nACL: 'public-read' in the getSignedURL/app.js folder in the github repo\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/media/638408397901987840_3.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003eFigure showing the public-read uncommented\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/media/638408397901987840_4.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003eFigure showing the lines that need uncommenting in template.yaml in the\nroot of the github repo that allows putObject in s3 with the public-read\nACL\u003c/p\u003e\n\u003cp\u003eRe-run \u003ccode\u003esam deploy --guided\u003c/code\u003e, same thing as at the start\u003c/p\u003e\n\u003cp\u003eNow the objects are publicly accessible!\u003c/p\u003e"}},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"2020-12-24"},"buildId":"CE44Z5AKa5Qjfcw_hHSvR","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>