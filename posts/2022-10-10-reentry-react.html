<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>Handling async errors with React</title><meta name="next-head-count" content="3"/><link rel="shortcut icon" href="favicon.ico"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><meta name="description" content="Blogging for the future"/><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/prism.min.js" integrity="sha512-hpZ5pDCF2bRCweL5WoA0/N1elet1KYL5mx3LP555Eg/0ZguaHawxNvEjF6O3rufAChs16HVNhEc6blF/rZoowQ==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="preload" href="/_next/static/css/50853c3f2e0364c3.css" as="style"/><link rel="stylesheet" href="/_next/static/css/50853c3f2e0364c3.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-93aa87d657ed1852.js" defer=""></script><script src="/_next/static/chunks/framework-c0d8f0fd2eea5ac1.js" defer=""></script><script src="/_next/static/chunks/main-ae0707941214d030.js" defer=""></script><script src="/_next/static/chunks/pages/_app-d9139de5c3de3b6b.js" defer=""></script><script src="/_next/static/chunks/996-06f747e212688e27.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-b6f09b4db8bfc341.js" defer=""></script><script src="/_next/static/UkgBUPKmZiPBQOIXB7iKW/_buildManifest.js" defer=""></script><script src="/_next/static/UkgBUPKmZiPBQOIXB7iKW/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div><main><div><div style="margin-bottom:100px"><a href="/">Misc scribbles</a></div><article><div><h1>Handling async errors with React</h1><h4>2022-10-10</h4></div><div><p>If you make a React component that has, say, a prop for a item id, and an async
action in a useEffect to fetch data for that item from an API, then you will
likely implement error handling on it most likely. That error handling may be a
useState. It is important to note that the itemId may change</p>
<p><a href="https://codesandbox.io/s/practical-rubin-l2d5el?file=/src/App.tsx">https://codesandbox.io/s/practical-rubin-l2d5el?file=/src/App.tsx</a></p>
<div class="highlight highlight-text-xml"><pre>interface ItemInfo {
  price: string
  name: string
}

async function myfetch(url, opts) {
  const response = await fetch(url, opts)
  if (!response.ok) {
    throw new Error(
      `Error fetching ${url}: HTTP ${response.status} ${await response.text()}`,
    )
  }
  return response.json()
}

function Error({ error }: { error: unknown }) {
  return &#x3C;<span class="pl-ent">div</span> <span class="pl-e">style</span>={{ background: <span class="pl-s"><span class="pl-pds">'</span>red<span class="pl-pds">'</span></span> }}>{`${error}`}&#x3C;/<span class="pl-ent">div</span>>
}

function MyComponent({ pokemonName }: { pokemonName: string }) {
  const [error, setError] = useState&#x3C;<span class="pl-ent">unknown</span>>()
  const [pokemonInfo, setItemInfo] = useState&#x3C;<span class="pl-ent">ItemInfo</span>>()
  useEffect(() => {
    ;(async () => {
      try {
        // important to reset the error state of the // app. iteminfo will
        // always be reset so not as important, but error very can be easily
        // forgotten
        setError(undefined)

        const data = await myfetch(`https://pokeapi.co/api/v2/${pokemon}`)
        if (!cancelled) {
          setItemInfo(pokemonInfo)
        }
      } catch (e) {
        console.error(e)
        if (!cancelled) {
          setError(e)
        }
      }
    })()

    return () => {
      cancelled = true
    }
  }, [itemId])

  return (
    &#x3C;<span class="pl-ent">div</span>>
      {error ? (
        &#x3C;<span class="pl-ent">Error</span> <span class="pl-e">error</span>={error} />
      ) : pokemonInfo ? (
        &#x3C;<span class="pl-ent">div</span>>
          {pokemonInfo.name} costs {itemInfo.price}
        &#x3C;/<span class="pl-ent">div</span>>
      ) : (
        &#x3C;<span class="pl-ent">div</span>>Loading...&#x3C;/<span class="pl-ent">div</span>>
      )}
    &#x3C;/<span class="pl-ent">div</span>>
  )
}
</pre></div>
<p>Can we make a hook to make this easier? Hooks are claimed to allow lots of re-usable code but the amount of instances I actually take advantage of this are low. Here, let's try</p>
<div class="highlight highlight-text-xml"><pre>function useRequest(url) {
  const [error, setError] = useState&#x3C;<span class="pl-ent">unknown</span>>()
  const [pokemonInfo, setItemInfo] = useState&#x3C;<span class="pl-ent">ItemInfo</span>>()
  useEffect(() => {
    ;(async () => {
      try {
        setItemInfo(undefined) // &#x3C;<span class="pl-ent">--</span> important to reset the state of the app
        setError(undefined) // &#x3C;-- important to reset the state of the app
        const data = await myfetch(`/v1/myapi/getItem?id=${itemId}`)
        if (!cancelled) {
          setItemInfo(pokemonInfo)
        }
      } catch (e) {
        console.error(e)
        if (!cancelled) {
          setError(e)
        }
      }
    })()

    return () => {
      cancelled = true
    }
  }, [itemId])
}
</pre></div></div><div style="margin-top:200px"></div></article></div></main></div><footer style="margin-top:100px"><a href="/">Home</a> <a href="/archive">Blog archive</a> <a href="https://github.com/cmdcolin/">Github</a> <a href="https://twitter.com/cmdcolin">Twitter</a> <a href="/projects">Projects</a> <a href="/photos">Photos</a> <a href="/rss.xml">RSS</a><a href="/about">About</a> </footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"Handling async errors with React","date":"2022-10-10","slug":"2022-10-10-reentry-react","html":"\u003cp\u003eIf you make a React component that has, say, a prop for a item id, and an async\naction in a useEffect to fetch data for that item from an API, then you will\nlikely implement error handling on it most likely. That error handling may be a\nuseState. It is important to note that the itemId may change\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://codesandbox.io/s/practical-rubin-l2d5el?file=/src/App.tsx\"\u003ehttps://codesandbox.io/s/practical-rubin-l2d5el?file=/src/App.tsx\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-text-xml\"\u003e\u003cpre\u003einterface ItemInfo {\n  price: string\n  name: string\n}\n\nasync function myfetch(url, opts) {\n  const response = await fetch(url, opts)\n  if (!response.ok) {\n    throw new Error(\n      `Error fetching ${url}: HTTP ${response.status} ${await response.text()}`,\n    )\n  }\n  return response.json()\n}\n\nfunction Error({ error }: { error: unknown }) {\n  return \u0026#x3C;\u003cspan class=\"pl-ent\"\u003ediv\u003c/span\u003e \u003cspan class=\"pl-e\"\u003estyle\u003c/span\u003e={{ background: \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003ered\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003e\u003c/span\u003e }}\u003e{`${error}`}\u0026#x3C;/\u003cspan class=\"pl-ent\"\u003ediv\u003c/span\u003e\u003e\n}\n\nfunction MyComponent({ pokemonName }: { pokemonName: string }) {\n  const [error, setError] = useState\u0026#x3C;\u003cspan class=\"pl-ent\"\u003eunknown\u003c/span\u003e\u003e()\n  const [pokemonInfo, setItemInfo] = useState\u0026#x3C;\u003cspan class=\"pl-ent\"\u003eItemInfo\u003c/span\u003e\u003e()\n  useEffect(() =\u003e {\n    ;(async () =\u003e {\n      try {\n        // important to reset the error state of the // app. iteminfo will\n        // always be reset so not as important, but error very can be easily\n        // forgotten\n        setError(undefined)\n\n        const data = await myfetch(`https://pokeapi.co/api/v2/${pokemon}`)\n        if (!cancelled) {\n          setItemInfo(pokemonInfo)\n        }\n      } catch (e) {\n        console.error(e)\n        if (!cancelled) {\n          setError(e)\n        }\n      }\n    })()\n\n    return () =\u003e {\n      cancelled = true\n    }\n  }, [itemId])\n\n  return (\n    \u0026#x3C;\u003cspan class=\"pl-ent\"\u003ediv\u003c/span\u003e\u003e\n      {error ? (\n        \u0026#x3C;\u003cspan class=\"pl-ent\"\u003eError\u003c/span\u003e \u003cspan class=\"pl-e\"\u003eerror\u003c/span\u003e={error} /\u003e\n      ) : pokemonInfo ? (\n        \u0026#x3C;\u003cspan class=\"pl-ent\"\u003ediv\u003c/span\u003e\u003e\n          {pokemonInfo.name} costs {itemInfo.price}\n        \u0026#x3C;/\u003cspan class=\"pl-ent\"\u003ediv\u003c/span\u003e\u003e\n      ) : (\n        \u0026#x3C;\u003cspan class=\"pl-ent\"\u003ediv\u003c/span\u003e\u003eLoading...\u0026#x3C;/\u003cspan class=\"pl-ent\"\u003ediv\u003c/span\u003e\u003e\n      )}\n    \u0026#x3C;/\u003cspan class=\"pl-ent\"\u003ediv\u003c/span\u003e\u003e\n  )\n}\n\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eCan we make a hook to make this easier? Hooks are claimed to allow lots of re-usable code but the amount of instances I actually take advantage of this are low. Here, let's try\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-text-xml\"\u003e\u003cpre\u003efunction useRequest(url) {\n  const [error, setError] = useState\u0026#x3C;\u003cspan class=\"pl-ent\"\u003eunknown\u003c/span\u003e\u003e()\n  const [pokemonInfo, setItemInfo] = useState\u0026#x3C;\u003cspan class=\"pl-ent\"\u003eItemInfo\u003c/span\u003e\u003e()\n  useEffect(() =\u003e {\n    ;(async () =\u003e {\n      try {\n        setItemInfo(undefined) // \u0026#x3C;\u003cspan class=\"pl-ent\"\u003e--\u003c/span\u003e important to reset the state of the app\n        setError(undefined) // \u0026#x3C;-- important to reset the state of the app\n        const data = await myfetch(`/v1/myapi/getItem?id=${itemId}`)\n        if (!cancelled) {\n          setItemInfo(pokemonInfo)\n        }\n      } catch (e) {\n        console.error(e)\n        if (!cancelled) {\n          setError(e)\n        }\n      }\n    })()\n\n    return () =\u003e {\n      cancelled = true\n    }\n  }, [itemId])\n}\n\u003c/pre\u003e\u003c/div\u003e"}},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"2022-10-10-reentry-react"},"buildId":"UkgBUPKmZiPBQOIXB7iKW","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>