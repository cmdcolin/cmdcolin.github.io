<!DOCTYPE html><html lang="en"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="shortcut icon" href="favicon.ico"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><meta name="description" content="Blogging for the future"/><title>Making a HTTPS accessible S3 powered static site with CloudFront+route 53</title><meta name="next-head-count" content="6"/><link rel="preload" href="/_next/static/css/ddb86c7b4e1045c6.css" as="style"/><link rel="stylesheet" href="/_next/static/css/ddb86c7b4e1045c6.css" data-n-g=""/><link rel="preload" href="/_next/static/css/e1f6961df2961232.css" as="style"/><link rel="stylesheet" href="/_next/static/css/e1f6961df2961232.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-514908bffb652963.js" defer=""></script><script src="/_next/static/chunks/framework-91d7f78b5b4003c8.js" defer=""></script><script src="/_next/static/chunks/main-7c3bf82eed00c281.js" defer=""></script><script src="/_next/static/chunks/pages/_app-76cd57bf65f05d70.js" defer=""></script><script src="/_next/static/chunks/162-1be62df9fbed0df5.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-2c663bbcac870718.js" defer=""></script><script src="/_next/static/pp9mRqc6res1HnVJ1xnx6/_buildManifest.js" defer=""></script><script src="/_next/static/pp9mRqc6res1HnVJ1xnx6/_ssgManifest.js" defer=""></script><script src="/_next/static/pp9mRqc6res1HnVJ1xnx6/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="min-h-screen"><main><div class="container mx-auto px-5"><div class="text-2xl md:text-4xl font-bold py-14 border-b border-accent-2 flex flex-col lg:flex-row items-center"><a class="header" href="/">Misc scribbles</a></div><article class="mb-32"><h1 class="text-2xl md:text-2xl lg:text-2xl font-bold tracking-tighter leading-tight md:leading-none mb-12 text-center md:text-left">Making a HTTPS accessible S3 powered static site with CloudFront+route 53<!-- --> - <!-- -->2020-12-26</h1><div class="max-w-1xl mx-auto"><div class="markdown-styles_markdown__h_8de"><p>This is not a very authoritative post because I stumbled though this but
I think I got it working now on my website :)</p>
<h2>Setup your S3 bucket</h2>
<p>First setup your S3 bucket, your bucket must be named yourdomain.com
e.g. named after your domain</p>
<p>Then if you have a create-react-app setup I add a script in package.json
that runs</p>
<pre><code> "predeploy": "npm run build",
 "deploy": "aws sync --delete build s3://yourdomain.com"
</code></pre>
<p>Then we can run "yarn deploy" and it will automatically upload our
create-react-app website to our S3 static site bucket.</p>
<p>Then make sure your bucket has public permissions enabled
<a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/example-bucket-policies.html#example-bucket-policies-use-case-2">https://docs.aws.amazon.com/AmazonS3/latest/dev/example-bucket-policies.html#example-bucket-policies-use-case-2</a>Then
make sure your bucket has "static site hosting" enabled too</p>
<h2>Setup route 53, and make your NS entries in domains.google.com</h2>
<p>I bought a domain with domains.google.com</p>
<p>Google then emailed me to validate my ownership</p>
<p>Then I went to aws.amazon.com route 53 and I created a hosted zone</p>
<p>This generated 4 name server entries and I added those to the
domains.google.com site</p>
<p><img src="/media/638618421776515072_0.png" alt=""></p>
<p>Screenshot shows copying the NS values from route 53 to the name servers
area of domains.google.com</p>
<h2>Setup your Amazon certificate for making SSL work on CloudFront</h2>
<p>To properly setup However, this does not work so you need to go to
Amazon Certificates->Provision certificates</p>
<p>We request the certificate for</p>
<p><a href="http://www.yourdomain.com">www.yourdomain.com</a>
yourdomain.com</p>
<p>Then it generates some codes for a CNAME value for each of those two
entries, and has a button to autoimport those CNAME values to route53</p>
<p>Then it will say "Pending validation"...I waited like an hour and then
it changed to "Success".</p>
<p><img src="/media/638618421776515072_1.png" alt=""></p>
<p>Screenshot shows the now successful Amazon Certificate. After you get
this, you can proceed to finishing your cloudfront</p>
<h2>Create a CloudFront distribution and add "Alternative CNAME" entries for your domain</h2>
<p>Then we can update our CloudFront distribution and add these to
the "Alternative CNAME" input box</p>
<p>yourdomain.com
<a href="http://www.yourdomain.com">www.yourdomain.com</a></p>
<p>Note also that I first generated my certificate in us-east-2 but the
"Import certificate form" in cloudfront said I had to create it in
us-east-1</p>
<p><img src="/media/638618421776515072_2.png" alt=""></p>
<h2>Add a default object index.html to the CloudFront setting</h2>
<p>Make your CloudFront "default object" is index.html</p>
<p>You have to manually type this in :)</p>
<h2>Add the CloudFront distribution to your Route 53</h2>
<p>Add a Route 53 "A" record that points to the CloudFront domain name e.g.
d897d897d87d98dd.cloudfront.net</p>
<h2>Summary of steps needed</h2>
<p>The general hindsight 20/20 procedure is</p>
<ol>
<li>Upload your static content to an S3 bucket called yoursite.com (must
be your domain name)</li>
<li>Make your S3 bucket have the "static website" setting on in the
properties menu and add a permissions policy that supports getObject
e.g. <a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/example-bucket-policies.html#example-bucket-policies-use-case-2">https://docs.aws.amazon.com/AmazonS3/latest/dev/example-bucket-policies.html#example-bucket-policies-use-case-2</a></li>
<li>Create a CloudFront distribution for your website</li>
<li>Make the CloudFront default object index.html</li>
<li>Create your domain with domains.google.com or similar</li>
<li>Point the google domain's name server to Route 53 NS list from AWS</li>
<li>Add Route 53 A records that point to the CloudFront domain name e.g.
d897d897d87d98dd.cloudfront.net</li>
<li>Create Amazon issued certificate for yourdomain.com, which can
auto-import a validation CNAME to your Route 53</li>
<li>Make your CloudFront domain support your Alternative CNAME's e.g.
yourdomain.com which requires importing (e.g. selecting from a list
that they auto-populate) your Amazon-issued-certificate</li>
</ol>
<h2>Troubleshooting and notes</h2>
<p>Problem: Your website gives 403 CloudFlare error
Solution: You have to get the Alternateive CNAME configuration setup
(pre-step involves the certificate request and validation)</p>
<p>Problem: Your website gives an object not found error
Solution: Set the CloudFront "default object" to index.html</p>
<h2>Random comment</h2>
<p>This is one of those processes (creating the cloudfront/route 53) that
probably could have done with the aws-sam CLI and it would have possibly
been easier, it is quite fiddly doing all these steps in the web
interface</p>
</div></div></article></div></main></div><footer class="bg-accent-1 border-t border-accent-2"><div class="container mx-auto px-5"><div class="py-14 flex flex-col lg:flex-row items-center"><div class="m-4"><a class="hover:underline" href="/">Home</a></div><div class="m-4"><a class="hover:underline" href="https://github.com/cmdcolin">Github</a></div><div class="m-4"><a class="hover:underline" href="https://twitter.com/cmdcolin">Twitter</a></div><div class="m-4"><a class="hover:underline" href="/projects">Projects</a></div><div class="m-4"><a class="hover:underline" href="/photos">Photos</a></div><div class="m-4"><a class="hover:underline" href="/rss.xml">RSS</a></div></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"Making a HTTPS accessible S3 powered static site with CloudFront+route 53","date":"2020-12-26","slug":"2020-12-26-pt2","content":"\u003cp\u003eThis is not a very authoritative post because I stumbled though this but\nI think I got it working now on my website :)\u003c/p\u003e\n\u003ch2\u003eSetup your S3 bucket\u003c/h2\u003e\n\u003cp\u003eFirst setup your S3 bucket, your bucket must be named yourdomain.com\ne.g. named after your domain\u003c/p\u003e\n\u003cp\u003eThen if you have a create-react-app setup I add a script in package.json\nthat runs\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e \"predeploy\": \"npm run build\",\n \"deploy\": \"aws sync --delete build s3://yourdomain.com\"\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThen we can run \"yarn deploy\" and it will automatically upload our\ncreate-react-app website to our S3 static site bucket.\u003c/p\u003e\n\u003cp\u003eThen make sure your bucket has public permissions enabled\n\u003ca href=\"https://docs.aws.amazon.com/AmazonS3/latest/dev/example-bucket-policies.html#example-bucket-policies-use-case-2\"\u003ehttps://docs.aws.amazon.com/AmazonS3/latest/dev/example-bucket-policies.html#example-bucket-policies-use-case-2\u003c/a\u003eThen\nmake sure your bucket has \"static site hosting\" enabled too\u003c/p\u003e\n\u003ch2\u003eSetup route 53, and make your NS entries in domains.google.com\u003c/h2\u003e\n\u003cp\u003eI bought a domain with domains.google.com\u003c/p\u003e\n\u003cp\u003eGoogle then emailed me to validate my ownership\u003c/p\u003e\n\u003cp\u003eThen I went to aws.amazon.com route 53 and I created a hosted zone\u003c/p\u003e\n\u003cp\u003eThis generated 4 name server entries and I added those to the\ndomains.google.com site\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/media/638618421776515072_0.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003eScreenshot shows copying the NS values from route 53 to the name servers\narea of domains.google.com\u003c/p\u003e\n\u003ch2\u003eSetup your Amazon certificate for making SSL work on CloudFront\u003c/h2\u003e\n\u003cp\u003eTo properly setup However, this does not work so you need to go to\nAmazon Certificates-\u003eProvision certificates\u003c/p\u003e\n\u003cp\u003eWe request the certificate for\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"http://www.yourdomain.com\"\u003ewww.yourdomain.com\u003c/a\u003e\nyourdomain.com\u003c/p\u003e\n\u003cp\u003eThen it generates some codes for a CNAME value for each of those two\nentries, and has a button to autoimport those CNAME values to route53\u003c/p\u003e\n\u003cp\u003eThen it will say \"Pending validation\"...I waited like an hour and then\nit changed to \"Success\".\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/media/638618421776515072_1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003eScreenshot shows the now successful Amazon Certificate. After you get\nthis, you can proceed to finishing your cloudfront\u003c/p\u003e\n\u003ch2\u003eCreate a CloudFront distribution and add \"Alternative CNAME\" entries for your domain\u003c/h2\u003e\n\u003cp\u003eThen we can update our CloudFront distribution and add these to\nthe \"Alternative CNAME\" input box\u003c/p\u003e\n\u003cp\u003eyourdomain.com\n\u003ca href=\"http://www.yourdomain.com\"\u003ewww.yourdomain.com\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eNote also that I first generated my certificate in us-east-2 but the\n\"Import certificate form\" in cloudfront said I had to create it in\nus-east-1\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/media/638618421776515072_2.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch2\u003eAdd a default object index.html to the CloudFront setting\u003c/h2\u003e\n\u003cp\u003eMake your CloudFront \"default object\" is index.html\u003c/p\u003e\n\u003cp\u003eYou have to manually type this in :)\u003c/p\u003e\n\u003ch2\u003eAdd the CloudFront distribution to your Route 53\u003c/h2\u003e\n\u003cp\u003eAdd a Route 53 \"A\" record that points to the CloudFront domain name e.g.\nd897d897d87d98dd.cloudfront.net\u003c/p\u003e\n\u003ch2\u003eSummary of steps needed\u003c/h2\u003e\n\u003cp\u003eThe general hindsight 20/20 procedure is\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eUpload your static content to an S3 bucket called yoursite.com (must\nbe your domain name)\u003c/li\u003e\n\u003cli\u003eMake your S3 bucket have the \"static website\" setting on in the\nproperties menu and add a permissions policy that supports getObject\ne.g. \u003ca href=\"https://docs.aws.amazon.com/AmazonS3/latest/dev/example-bucket-policies.html#example-bucket-policies-use-case-2\"\u003ehttps://docs.aws.amazon.com/AmazonS3/latest/dev/example-bucket-policies.html#example-bucket-policies-use-case-2\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eCreate a CloudFront distribution for your website\u003c/li\u003e\n\u003cli\u003eMake the CloudFront default object index.html\u003c/li\u003e\n\u003cli\u003eCreate your domain with domains.google.com or similar\u003c/li\u003e\n\u003cli\u003ePoint the google domain's name server to Route 53 NS list from AWS\u003c/li\u003e\n\u003cli\u003eAdd Route 53 A records that point to the CloudFront domain name e.g.\nd897d897d87d98dd.cloudfront.net\u003c/li\u003e\n\u003cli\u003eCreate Amazon issued certificate for yourdomain.com, which can\nauto-import a validation CNAME to your Route 53\u003c/li\u003e\n\u003cli\u003eMake your CloudFront domain support your Alternative CNAME's e.g.\nyourdomain.com which requires importing (e.g. selecting from a list\nthat they auto-populate) your Amazon-issued-certificate\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2\u003eTroubleshooting and notes\u003c/h2\u003e\n\u003cp\u003eProblem: Your website gives 403 CloudFlare error\nSolution: You have to get the Alternateive CNAME configuration setup\n(pre-step involves the certificate request and validation)\u003c/p\u003e\n\u003cp\u003eProblem: Your website gives an object not found error\nSolution: Set the CloudFront \"default object\" to index.html\u003c/p\u003e\n\u003ch2\u003eRandom comment\u003c/h2\u003e\n\u003cp\u003eThis is one of those processes (creating the cloudfront/route 53) that\nprobably could have done with the aws-sam CLI and it would have possibly\nbeen easier, it is quite fiddly doing all these steps in the web\ninterface\u003c/p\u003e\n"}},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"2020-12-26-pt2"},"buildId":"pp9mRqc6res1HnVJ1xnx6","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>