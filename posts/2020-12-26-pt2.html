<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>Making a HTTPS accessible S3 powered static site with CloudFront+route 53</title><meta name="next-head-count" content="3"/><link rel="shortcut icon" href="favicon.ico"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><meta name="description" content="Blogging for the future"/><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/prism.min.js" integrity="sha512-hpZ5pDCF2bRCweL5WoA0/N1elet1KYL5mx3LP555Eg/0ZguaHawxNvEjF6O3rufAChs16HVNhEc6blF/rZoowQ==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="preload" href="/_next/static/css/50853c3f2e0364c3.css" as="style"/><link rel="stylesheet" href="/_next/static/css/50853c3f2e0364c3.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-93aa87d657ed1852.js" defer=""></script><script src="/_next/static/chunks/framework-c0d8f0fd2eea5ac1.js" defer=""></script><script src="/_next/static/chunks/main-ae0707941214d030.js" defer=""></script><script src="/_next/static/chunks/pages/_app-d9139de5c3de3b6b.js" defer=""></script><script src="/_next/static/chunks/996-06f747e212688e27.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-b6f09b4db8bfc341.js" defer=""></script><script src="/_next/static/CRFBY2d1dU6OqpMSFuX_o/_buildManifest.js" defer=""></script><script src="/_next/static/CRFBY2d1dU6OqpMSFuX_o/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div><main><div><div style="margin-bottom:100px"><a href="/">Misc scribbles</a></div><article><div><h1>Making a HTTPS accessible S3 powered static site with CloudFront+route 53</h1><h4>2020-12-26</h4></div><div><p>This is not a very authoritative post because I stumbled though this but
I think I got it working now on my website :)</p>
<h2 id="setup-your-s3-bucket"><a aria-hidden="true" tabindex="-1" href="#setup-your-s3-bucket"><a href="#setup-your-s3-bucket" style="margin-right: 10px">#</a></a>Setup your S3 bucket</h2>
<p>First setup your S3 bucket, your bucket must be named yourdomain.com
e.g. named after your domain</p>
<p>Then if you have a create-react-app setup I add a script in package.json
that runs</p>
<div class="highlight highlight-json"><pre>{
  <span class="pl-ent">"scripts"</span>: {
    <span class="pl-ent">"predeploy"</span>: <span class="pl-s"><span class="pl-pds">"</span>npm run build<span class="pl-pds">"</span></span>,
    <span class="pl-ent">"deploy"</span>: <span class="pl-s"><span class="pl-pds">"</span>aws sync --delete build s3://yourdomain.com<span class="pl-pds">"</span></span>
  }
}
</pre></div>
<p>Then we can run "yarn deploy" and it will automatically upload our
create-react-app website to our S3 static site bucket.</p>
<p>Then make sure your bucket has public permissions enabled
<a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/example-bucket-policies.html#example-bucket-policies-use-case-2">https://docs.aws.amazon.com/AmazonS3/latest/dev/example-bucket-policies.html#example-bucket-policies-use-case-2</a>.
Then make sure your bucket has "static site hosting" enabled too</p>
<h2 id="setup-route-53-and-make-your-ns-entries-in-domainsgooglecom"><a aria-hidden="true" tabindex="-1" href="#setup-route-53-and-make-your-ns-entries-in-domainsgooglecom"><a href="#setup-route-53-and-make-your-ns-entries-in-domainsgooglecom" style="margin-right: 10px">#</a></a>Setup route 53, and make your NS entries in domains.google.com</h2>
<p>I bought a domain with domains.google.com</p>
<p>Google then emailed me to validate my ownership</p>
<p>Then I went to aws.amazon.com route 53 and I created a hosted zone</p>
<p>This generated 4 name server entries and I added those to the
domains.google.com site</p>
<p><img src="/media/638618421776515072_0.png" alt=""></p>
<p>Screenshot shows copying the NS values from route 53 to the name servers
area of domains.google.com</p>
<h2 id="setup-your-amazon-certificate-for-making-ssl-work-on-cloudfront"><a aria-hidden="true" tabindex="-1" href="#setup-your-amazon-certificate-for-making-ssl-work-on-cloudfront"><a href="#setup-your-amazon-certificate-for-making-ssl-work-on-cloudfront" style="margin-right: 10px">#</a></a>Setup your Amazon certificate for making SSL work on CloudFront</h2>
<p>To properly setup However, this does not work so you need to go to
Amazon Certificates->Provision certificates</p>
<p>We request the certificate for</p>
<p><a href="http://www.yourdomain.com">www.yourdomain.com</a>
yourdomain.com</p>
<p>Then it generates some codes for a CNAME value for each of those two
entries, and has a button to autoimport those CNAME values to route53</p>
<p>Then it will say "Pending validation"...I waited like an hour and then
it changed to "Success".</p>
<p><img src="/media/638618421776515072_1.png" alt=""></p>
<p>Screenshot shows the now successful Amazon Certificate. After you get
this, you can proceed to finishing your cloudfront</p>
<h2 id="create-a-cloudfront-distribution-and-add-alternative-cname-entries-for-your-domain"><a aria-hidden="true" tabindex="-1" href="#create-a-cloudfront-distribution-and-add-alternative-cname-entries-for-your-domain"><a href="#create-a-cloudfront-distribution-and-add-alternative-cname-entries-for-your-domain" style="margin-right: 10px">#</a></a>Create a CloudFront distribution and add "Alternative CNAME" entries for your domain</h2>
<p>Then we can update our CloudFront distribution and add these to
the "Alternative CNAME" input box</p>
<p>yourdomain.com
<a href="http://www.yourdomain.com">www.yourdomain.com</a></p>
<p>Note also that I first generated my certificate in us-east-2 but the
"Import certificate form" in cloudfront said I had to create it in
us-east-1</p>
<p><img src="/media/638618421776515072_2.png" alt=""></p>
<h2 id="add-a-default-object-indexhtml-to-the-cloudfront-setting"><a aria-hidden="true" tabindex="-1" href="#add-a-default-object-indexhtml-to-the-cloudfront-setting"><a href="#add-a-default-object-indexhtml-to-the-cloudfront-setting" style="margin-right: 10px">#</a></a>Add a default object index.html to the CloudFront setting</h2>
<p>Make your CloudFront "default object" is index.html</p>
<p>You have to manually type this in :)</p>
<h2 id="add-the-cloudfront-distribution-to-your-route-53"><a aria-hidden="true" tabindex="-1" href="#add-the-cloudfront-distribution-to-your-route-53"><a href="#add-the-cloudfront-distribution-to-your-route-53" style="margin-right: 10px">#</a></a>Add the CloudFront distribution to your Route 53</h2>
<p>Add a Route 53 "A" record that points to the CloudFront domain name e.g.
d897d897d87d98dd.cloudfront.net</p>
<h2 id="summary-of-steps-needed"><a aria-hidden="true" tabindex="-1" href="#summary-of-steps-needed"><a href="#summary-of-steps-needed" style="margin-right: 10px">#</a></a>Summary of steps needed</h2>
<p>The general hindsight 20/20 procedure is</p>
<ol>
<li>Upload your static content to an S3 bucket called yoursite.com (must
be your domain name)</li>
<li>Make your S3 bucket have the "static website" setting on in the
properties menu and add a permissions policy that supports getObject
e.g. <a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/example-bucket-policies.html#example-bucket-policies-use-case-2">https://docs.aws.amazon.com/AmazonS3/latest/dev/example-bucket-policies.html#example-bucket-policies-use-case-2</a></li>
<li>Create a CloudFront distribution for your website</li>
<li>Make the CloudFront default object index.html</li>
<li>Create your domain with domains.google.com or similar</li>
<li>Point the google domain's name server to Route 53 NS list from AWS</li>
<li>Add Route 53 A records that point to the CloudFront domain name e.g.
d897d897d87d98dd.cloudfront.net</li>
<li>Create Amazon issued certificate for yourdomain.com, which can
auto-import a validation CNAME to your Route 53</li>
<li>Make your CloudFront domain support your Alternative CNAME's e.g.
yourdomain.com which requires importing (e.g. selecting from a list
that they auto-populate) your Amazon-issued-certificate</li>
</ol>
<h2 id="troubleshooting-and-notes"><a aria-hidden="true" tabindex="-1" href="#troubleshooting-and-notes"><a href="#troubleshooting-and-notes" style="margin-right: 10px">#</a></a>Troubleshooting and notes</h2>
<p>Problem: Your website gives 403 CloudFlare error
Solution: You have to get the Alternateive CNAME configuration setup
(pre-step involves the certificate request and validation)</p>
<p>Problem: Your website gives an object not found error
Solution: Set the CloudFront "default object" to index.html</p>
<h2 id="random-comment"><a aria-hidden="true" tabindex="-1" href="#random-comment"><a href="#random-comment" style="margin-right: 10px">#</a></a>Random comment</h2>
<p>This is one of those processes (creating the cloudfront/route 53) that
probably could have done with the aws-sam CLI and it would have possibly
been easier, it is quite fiddly doing all these steps in the web
interface</p></div><div style="margin-top:200px"></div></article></div></main></div><footer style="margin-top:100px"><a href="/">Home</a> <a href="/archive">Blog archive</a> <a href="https://github.com/cmdcolin/">Github</a> <a href="https://twitter.com/cmdcolin">Twitter</a> <a href="/projects">Projects</a> <a href="/photos">Photos</a> <a href="/rss.xml">RSS</a><a href="/about">About</a> </footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"Making a HTTPS accessible S3 powered static site with CloudFront+route 53","date":"2020-12-26","slug":"2020-12-26-pt2","html":"\u003cp\u003eThis is not a very authoritative post because I stumbled though this but\nI think I got it working now on my website :)\u003c/p\u003e\n\u003ch2 id=\"setup-your-s3-bucket\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#setup-your-s3-bucket\"\u003e\u003ca href=\"#setup-your-s3-bucket\" style=\"margin-right: 10px\"\u003e#\u003c/a\u003e\u003c/a\u003eSetup your S3 bucket\u003c/h2\u003e\n\u003cp\u003eFirst setup your S3 bucket, your bucket must be named yourdomain.com\ne.g. named after your domain\u003c/p\u003e\n\u003cp\u003eThen if you have a create-react-app setup I add a script in package.json\nthat runs\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-json\"\u003e\u003cpre\u003e{\n  \u003cspan class=\"pl-ent\"\u003e\"scripts\"\u003c/span\u003e: {\n    \u003cspan class=\"pl-ent\"\u003e\"predeploy\"\u003c/span\u003e: \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003enpm run build\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e,\n    \u003cspan class=\"pl-ent\"\u003e\"deploy\"\u003c/span\u003e: \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eaws sync --delete build s3://yourdomain.com\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e\n  }\n}\n\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThen we can run \"yarn deploy\" and it will automatically upload our\ncreate-react-app website to our S3 static site bucket.\u003c/p\u003e\n\u003cp\u003eThen make sure your bucket has public permissions enabled\n\u003ca href=\"https://docs.aws.amazon.com/AmazonS3/latest/dev/example-bucket-policies.html#example-bucket-policies-use-case-2\"\u003ehttps://docs.aws.amazon.com/AmazonS3/latest/dev/example-bucket-policies.html#example-bucket-policies-use-case-2\u003c/a\u003e.\nThen make sure your bucket has \"static site hosting\" enabled too\u003c/p\u003e\n\u003ch2 id=\"setup-route-53-and-make-your-ns-entries-in-domainsgooglecom\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#setup-route-53-and-make-your-ns-entries-in-domainsgooglecom\"\u003e\u003ca href=\"#setup-route-53-and-make-your-ns-entries-in-domainsgooglecom\" style=\"margin-right: 10px\"\u003e#\u003c/a\u003e\u003c/a\u003eSetup route 53, and make your NS entries in domains.google.com\u003c/h2\u003e\n\u003cp\u003eI bought a domain with domains.google.com\u003c/p\u003e\n\u003cp\u003eGoogle then emailed me to validate my ownership\u003c/p\u003e\n\u003cp\u003eThen I went to aws.amazon.com route 53 and I created a hosted zone\u003c/p\u003e\n\u003cp\u003eThis generated 4 name server entries and I added those to the\ndomains.google.com site\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/media/638618421776515072_0.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003eScreenshot shows copying the NS values from route 53 to the name servers\narea of domains.google.com\u003c/p\u003e\n\u003ch2 id=\"setup-your-amazon-certificate-for-making-ssl-work-on-cloudfront\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#setup-your-amazon-certificate-for-making-ssl-work-on-cloudfront\"\u003e\u003ca href=\"#setup-your-amazon-certificate-for-making-ssl-work-on-cloudfront\" style=\"margin-right: 10px\"\u003e#\u003c/a\u003e\u003c/a\u003eSetup your Amazon certificate for making SSL work on CloudFront\u003c/h2\u003e\n\u003cp\u003eTo properly setup However, this does not work so you need to go to\nAmazon Certificates-\u003eProvision certificates\u003c/p\u003e\n\u003cp\u003eWe request the certificate for\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"http://www.yourdomain.com\"\u003ewww.yourdomain.com\u003c/a\u003e\nyourdomain.com\u003c/p\u003e\n\u003cp\u003eThen it generates some codes for a CNAME value for each of those two\nentries, and has a button to autoimport those CNAME values to route53\u003c/p\u003e\n\u003cp\u003eThen it will say \"Pending validation\"...I waited like an hour and then\nit changed to \"Success\".\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/media/638618421776515072_1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003eScreenshot shows the now successful Amazon Certificate. After you get\nthis, you can proceed to finishing your cloudfront\u003c/p\u003e\n\u003ch2 id=\"create-a-cloudfront-distribution-and-add-alternative-cname-entries-for-your-domain\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#create-a-cloudfront-distribution-and-add-alternative-cname-entries-for-your-domain\"\u003e\u003ca href=\"#create-a-cloudfront-distribution-and-add-alternative-cname-entries-for-your-domain\" style=\"margin-right: 10px\"\u003e#\u003c/a\u003e\u003c/a\u003eCreate a CloudFront distribution and add \"Alternative CNAME\" entries for your domain\u003c/h2\u003e\n\u003cp\u003eThen we can update our CloudFront distribution and add these to\nthe \"Alternative CNAME\" input box\u003c/p\u003e\n\u003cp\u003eyourdomain.com\n\u003ca href=\"http://www.yourdomain.com\"\u003ewww.yourdomain.com\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eNote also that I first generated my certificate in us-east-2 but the\n\"Import certificate form\" in cloudfront said I had to create it in\nus-east-1\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/media/638618421776515072_2.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch2 id=\"add-a-default-object-indexhtml-to-the-cloudfront-setting\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#add-a-default-object-indexhtml-to-the-cloudfront-setting\"\u003e\u003ca href=\"#add-a-default-object-indexhtml-to-the-cloudfront-setting\" style=\"margin-right: 10px\"\u003e#\u003c/a\u003e\u003c/a\u003eAdd a default object index.html to the CloudFront setting\u003c/h2\u003e\n\u003cp\u003eMake your CloudFront \"default object\" is index.html\u003c/p\u003e\n\u003cp\u003eYou have to manually type this in :)\u003c/p\u003e\n\u003ch2 id=\"add-the-cloudfront-distribution-to-your-route-53\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#add-the-cloudfront-distribution-to-your-route-53\"\u003e\u003ca href=\"#add-the-cloudfront-distribution-to-your-route-53\" style=\"margin-right: 10px\"\u003e#\u003c/a\u003e\u003c/a\u003eAdd the CloudFront distribution to your Route 53\u003c/h2\u003e\n\u003cp\u003eAdd a Route 53 \"A\" record that points to the CloudFront domain name e.g.\nd897d897d87d98dd.cloudfront.net\u003c/p\u003e\n\u003ch2 id=\"summary-of-steps-needed\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#summary-of-steps-needed\"\u003e\u003ca href=\"#summary-of-steps-needed\" style=\"margin-right: 10px\"\u003e#\u003c/a\u003e\u003c/a\u003eSummary of steps needed\u003c/h2\u003e\n\u003cp\u003eThe general hindsight 20/20 procedure is\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eUpload your static content to an S3 bucket called yoursite.com (must\nbe your domain name)\u003c/li\u003e\n\u003cli\u003eMake your S3 bucket have the \"static website\" setting on in the\nproperties menu and add a permissions policy that supports getObject\ne.g. \u003ca href=\"https://docs.aws.amazon.com/AmazonS3/latest/dev/example-bucket-policies.html#example-bucket-policies-use-case-2\"\u003ehttps://docs.aws.amazon.com/AmazonS3/latest/dev/example-bucket-policies.html#example-bucket-policies-use-case-2\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eCreate a CloudFront distribution for your website\u003c/li\u003e\n\u003cli\u003eMake the CloudFront default object index.html\u003c/li\u003e\n\u003cli\u003eCreate your domain with domains.google.com or similar\u003c/li\u003e\n\u003cli\u003ePoint the google domain's name server to Route 53 NS list from AWS\u003c/li\u003e\n\u003cli\u003eAdd Route 53 A records that point to the CloudFront domain name e.g.\nd897d897d87d98dd.cloudfront.net\u003c/li\u003e\n\u003cli\u003eCreate Amazon issued certificate for yourdomain.com, which can\nauto-import a validation CNAME to your Route 53\u003c/li\u003e\n\u003cli\u003eMake your CloudFront domain support your Alternative CNAME's e.g.\nyourdomain.com which requires importing (e.g. selecting from a list\nthat they auto-populate) your Amazon-issued-certificate\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"troubleshooting-and-notes\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#troubleshooting-and-notes\"\u003e\u003ca href=\"#troubleshooting-and-notes\" style=\"margin-right: 10px\"\u003e#\u003c/a\u003e\u003c/a\u003eTroubleshooting and notes\u003c/h2\u003e\n\u003cp\u003eProblem: Your website gives 403 CloudFlare error\nSolution: You have to get the Alternateive CNAME configuration setup\n(pre-step involves the certificate request and validation)\u003c/p\u003e\n\u003cp\u003eProblem: Your website gives an object not found error\nSolution: Set the CloudFront \"default object\" to index.html\u003c/p\u003e\n\u003ch2 id=\"random-comment\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#random-comment\"\u003e\u003ca href=\"#random-comment\" style=\"margin-right: 10px\"\u003e#\u003c/a\u003e\u003c/a\u003eRandom comment\u003c/h2\u003e\n\u003cp\u003eThis is one of those processes (creating the cloudfront/route 53) that\nprobably could have done with the aws-sam CLI and it would have possibly\nbeen easier, it is quite fiddly doing all these steps in the web\ninterface\u003c/p\u003e"}},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"2020-12-26-pt2"},"buildId":"CRFBY2d1dU6OqpMSFuX_o","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>