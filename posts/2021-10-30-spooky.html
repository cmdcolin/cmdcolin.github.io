<!DOCTYPE html><html lang="en"><head><link rel="shortcut icon" href="favicon.ico"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><meta name="description" content="Blogging for the future"/><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/prism.min.js" integrity="sha512-hpZ5pDCF2bRCweL5WoA0/N1elet1KYL5mx3LP555Eg/0ZguaHawxNvEjF6O3rufAChs16HVNhEc6blF/rZoowQ==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>A spooky error when you have a string bigger than 512MB in Chrome</title><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/f0ab904b10cea2d1.css" as="style"/><link rel="stylesheet" href="/_next/static/css/f0ab904b10cea2d1.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-514908bffb652963.js" defer=""></script><script src="/_next/static/chunks/framework-91d7f78b5b4003c8.js" defer=""></script><script src="/_next/static/chunks/main-d98b4a7f39fdfc80.js" defer=""></script><script src="/_next/static/chunks/pages/_app-76cd57bf65f05d70.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-190681eac4fd5da5.js" defer=""></script><script src="/_next/static/bLgI00SlHDOeqgCVQU_mw/_buildManifest.js" defer=""></script><script src="/_next/static/bLgI00SlHDOeqgCVQU_mw/_ssgManifest.js" defer=""></script><script src="/_next/static/bLgI00SlHDOeqgCVQU_mw/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div><main><div><div><a href="/">Misc scribbles</a></div><article><div><h1>A spooky error when you have a string bigger than 512MB in Chrome</h1><h4>2021-10-30</h4></div><p>Now gather round for a spooky story</p><p>Late one night... in the haunted office space castle (hindenbugs cackling in
the background amongst the dusty technical books) the midnight candles were
burning bright and we entered data for a user file</p><p>A simple 52MB gzipped datafile that we want to process in the browser. We unzip
it, decode it, and ...an error</p><p>ERROR: data not found</p><p><img src="/media/pumpkin-dark.jpg"/></p><p>But... our code is so simple (we of course abide by the religion of writing &quot;simple code&quot; you know)...what could be happening?</p><p>The code looks like this</p><pre><code class="language-js">const buf = unzip(file)
const str = new TextDecoder().decode(buf)
</code></pre><p>We trace it back and run a console.log(str)</p><p>It looks empty. We try running console.log(str.length) ... it prints out 0</p><p>But if we console.log(buffer.length) we get 546,483,710 bytes...</p><p>What could be happening?</p><p>We see in the TextDecoder documentation that it has a note called &quot;fatal&quot;. We try</p><pre><code class="language-js">const buf = unzip(file)
const str = new TextDecoder(&#x27;utf8&#x27;, { fatal: true }).decode(buf)
</code></pre><p>This doesn&#x27;t change the results though</p><p>Then it dawns on us while the lightning hits and the thunderclap booms and the
wind blows through the rattly windows</p><p>We have hit...the maximum string length in Chrome</p><p>BWAHAHAHAHA</p><p>The maximum string length!!! Nooooooo</p><p>It is 512MB on the dot... 536,870,888 bytes. We test this to be sure</p><pre><code class="language-js">const len = 536_870_888
const buf = new Uint8Array(len)
for (let i = 0; i &lt; len; i++) {
  buf[i] = &#x27;a&#x27;.charCodeAt(0)
}
const str = new TextDecoder().decode(buf)
console.log(str.length)
</code></pre><p>This is correct, outputs 536,870,888</p><p>With anything, even one byte more, it fails and outputs 0</p><p>happy halloween!!</p><p>pumpkin photo source: <a href="http://mountainbikerak.blogspot.com/2010/11/google-chrome-pumpkin.html">http://mountainbikerak.blogspot.com/2010/11/google-chrome-pumpkin.html</a></p><p>chrome 95 tested</p><p>nodejs 15 - at 512MB+1 bytes it prints an error message <code>Error: Cannot create a string longer than 0x1fffffe8 characters</code> for significantly greater than 512MB
e.g. 600MB it actually prints a different error <code>TypeError [ERR_ENCODING_INVALID_ENCODED_DATA]: The encoded data was not valid for encoding utf-8</code>)</p><p>firefox 93 - goes up to ~1GB but then gives Exception { name: &quot;NS_ERROR_OUT_OF_MEMORY&quot;, message: &quot;&quot;, result: 2147942414</p><p>midori 6 (safari-alike/webkit) - goes up to ~2GB fine! will have to test more</p></article></div></main></div><footer style="margin-top:20px"><a href="/">Home</a> <a href="/archive">Blog archive</a> <a href="https://github.com/cmdcolin">Github</a> <a href="https://twitter.com/cmdcolin">Twitter</a> <a href="/projects">Projects</a> <a href="/photos">Photos</a> <a href="/rss.xml">RSS</a></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"A spooky error when you have a string bigger than 512MB in Chrome","date":"2021-10-30","slug":"2021-10-30-spooky","mdxSource":{"compiledSource":"var h=Object.defineProperty,d=Object.defineProperties;var u=Object.getOwnPropertyDescriptors;var p=Object.getOwnPropertySymbols;var r=Object.prototype.hasOwnProperty,i=Object.prototype.propertyIsEnumerable;var s=(e,t,o)=\u003et in e?h(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,a=(e,t)=\u003e{for(var o in t||(t={}))r.call(t,o)\u0026\u0026s(e,o,t[o]);if(p)for(var o of p(t))i.call(t,o)\u0026\u0026s(e,o,t[o]);return e},l=(e,t)=\u003ed(e,u(t));var c=(e,t)=\u003e{var o={};for(var n in e)r.call(e,n)\u0026\u0026t.indexOf(n)\u003c0\u0026\u0026(o[n]=e[n]);if(e!=null\u0026\u0026p)for(var n of p(e))t.indexOf(n)\u003c0\u0026\u0026i.call(e,n)\u0026\u0026(o[n]=e[n]);return o};const layoutProps={},MDXLayout=\"wrapper\";function MDXContent(o){var n=o,{components:e}=n,t=c(n,[\"components\"]);return mdx(MDXLayout,l(a(a({},layoutProps),t),{components:e,mdxType:\"MDXLayout\"}),mdx(\"p\",null,\"Now gather round for a spooky story\"),mdx(\"p\",null,`Late one night... in the haunted office space castle (hindenbugs cackling in\nthe background amongst the dusty technical books) the midnight candles were\nburning bright and we entered data for a user file`),mdx(\"p\",null,`A simple 52MB gzipped datafile that we want to process in the browser. We unzip\nit, decode it, and ...an error`),mdx(\"p\",null,\"ERROR: data not found\"),mdx(\"p\",null,mdx(\"img\",a({parentName:\"p\"},{src:\"/media/pumpkin-dark.jpg\",alt:null}))),mdx(\"p\",null,'But... our code is so simple (we of course abide by the religion of writing \"simple code\" you know)...what could be happening?'),mdx(\"p\",null,\"The code looks like this\"),mdx(\"pre\",null,mdx(\"code\",a({parentName:\"pre\"},{className:\"language-js\"}),`const buf = unzip(file)\nconst str = new TextDecoder().decode(buf)\n`)),mdx(\"p\",null,\"We trace it back and run a console.log(str)\"),mdx(\"p\",null,\"It looks empty. We try running console.log(str.length) ... it prints out 0\"),mdx(\"p\",null,\"But if we console.log(buffer.length) we get 546,483,710 bytes...\"),mdx(\"p\",null,\"What could be happening?\"),mdx(\"p\",null,'We see in the TextDecoder documentation that it has a note called \"fatal\". We try'),mdx(\"pre\",null,mdx(\"code\",a({parentName:\"pre\"},{className:\"language-js\"}),`const buf = unzip(file)\nconst str = new TextDecoder('utf8', { fatal: true }).decode(buf)\n`)),mdx(\"p\",null,\"This doesn't change the results though\"),mdx(\"p\",null,`Then it dawns on us while the lightning hits and the thunderclap booms and the\nwind blows through the rattly windows`),mdx(\"p\",null,\"We have hit...the maximum string length in Chrome\"),mdx(\"p\",null,\"BWAHAHAHAHA\"),mdx(\"p\",null,\"The maximum string length!!! Nooooooo\"),mdx(\"p\",null,\"It is 512MB on the dot... 536,870,888 bytes. We test this to be sure\"),mdx(\"pre\",null,mdx(\"code\",a({parentName:\"pre\"},{className:\"language-js\"}),`const len = 536_870_888\nconst buf = new Uint8Array(len)\nfor (let i = 0; i \u003c len; i++) {\n  buf[i] = 'a'.charCodeAt(0)\n}\nconst str = new TextDecoder().decode(buf)\nconsole.log(str.length)\n`)),mdx(\"p\",null,\"This is correct, outputs 536,870,888\"),mdx(\"p\",null,\"With anything, even one byte more, it fails and outputs 0\"),mdx(\"p\",null,\"happy halloween!!\"),mdx(\"p\",null,\"pumpkin photo source: \",mdx(\"a\",a({parentName:\"p\"},{href:\"http://mountainbikerak.blogspot.com/2010/11/google-chrome-pumpkin.html\"}),\"http://mountainbikerak.blogspot.com/2010/11/google-chrome-pumpkin.html\")),mdx(\"p\",null,\"chrome 95 tested\"),mdx(\"p\",null,\"nodejs 15 - at 512MB+1 bytes it prints an error message \",mdx(\"inlineCode\",{parentName:\"p\"},\"Error: Cannot create a string longer than 0x1fffffe8 characters\"),` for significantly greater than 512MB\ne.g. 600MB it actually prints a different error `,mdx(\"inlineCode\",{parentName:\"p\"},\"TypeError [ERR_ENCODING_INVALID_ENCODED_DATA]: The encoded data was not valid for encoding utf-8\"),\")\"),mdx(\"p\",null,'firefox 93 - goes up to ~1GB but then gives Exception { name: \"NS_ERROR_OUT_OF_MEMORY\", message: \"\", result: 2147942414'),mdx(\"p\",null,\"midori 6 (safari-alike/webkit) - goes up to ~2GB fine! will have to test more\"))}MDXContent.isMDXComponent=!0;\n","scope":{}}}},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"2021-10-30-spooky"},"buildId":"bLgI00SlHDOeqgCVQU_mw","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>