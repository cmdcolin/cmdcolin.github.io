<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>A spooky error when you have a string bigger than 512MB in Chrome</title><meta name="next-head-count" content="3"/><link rel="shortcut icon" href="favicon.ico"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><meta name="description" content="Blogging for the future"/><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/prism.min.js" integrity="sha512-hpZ5pDCF2bRCweL5WoA0/N1elet1KYL5mx3LP555Eg/0ZguaHawxNvEjF6O3rufAChs16HVNhEc6blF/rZoowQ==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="preload" href="/_next/static/css/50853c3f2e0364c3.css" as="style"/><link rel="stylesheet" href="/_next/static/css/50853c3f2e0364c3.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-93aa87d657ed1852.js" defer=""></script><script src="/_next/static/chunks/framework-c0d8f0fd2eea5ac1.js" defer=""></script><script src="/_next/static/chunks/main-ae0707941214d030.js" defer=""></script><script src="/_next/static/chunks/pages/_app-d9139de5c3de3b6b.js" defer=""></script><script src="/_next/static/chunks/996-06f747e212688e27.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-b6f09b4db8bfc341.js" defer=""></script><script src="/_next/static/VNs4osprFX-hk-MwN5NzY/_buildManifest.js" defer=""></script><script src="/_next/static/VNs4osprFX-hk-MwN5NzY/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div><main><div><div style="margin-bottom:100px"><a href="/">Misc scribbles</a></div><article><div><h1>A spooky error when you have a string bigger than 512MB in Chrome</h1><h4>2021-10-30</h4></div><div><p>Now gather round for a spooky story</p>
<p>Late one night... in the haunted office/castle the midnight candles
were burning bright and we entered data for a user file....</p>
<p>(hindenbugs cackling in the background, dusty technical books line the dark
shelves)</p>
<p>A simple 52MB gzipped datafile that we want to process in the browser. We unzip
it, decode it, and ... we see an error!!! <strong>LIGHTNING CRACKS</strong></p>
<p><img src="/media/pumpkin-dark.jpg" alt=""></p>
<p>But... our code is so simple (we of course abide by the religion of writing
"simple code" you know)...what could be happening?</p>
<p>The code looks like this</p>
<div class="highlight highlight-js"><pre><span class="pl-k">const</span> <span class="pl-c1">buf</span> <span class="pl-k">=</span> <span class="pl-en">unzip</span>(file)
<span class="pl-k">const</span> <span class="pl-c1">str</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">TextDecoder</span>().<span class="pl-en">decode</span>(buf)
</pre></div>
<p>We trace it back and run a <code>console.log(str)</code></p>
<p>It looks empty. We try running <code>console.log(str.length)</code> ... it prints out 0</p>
<p>But if we look at <code>console.log(buffer.length)</code> we get 546,483,710 bytes...</p>
<p>What could be happening?</p>
<p>We see in the <code>TextDecoder</code> documentation that it has a note called "fatal". We
try</p>
<div class="highlight highlight-js"><pre><span class="pl-k">const</span> <span class="pl-c1">buf</span> <span class="pl-k">=</span> <span class="pl-en">unzip</span>(file)
<span class="pl-k">const</span> <span class="pl-c1">str</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">TextDecoder</span>(<span class="pl-s"><span class="pl-pds">'</span>utf8<span class="pl-pds">'</span></span>, { fatal<span class="pl-k">:</span> <span class="pl-c1">true</span> }).<span class="pl-en">decode</span>(buf)
</pre></div>
<p>This doesn't change the results though</p>
<p>Then it dawns on us while the lightning hits and the thunderclap booms and the
wind blows through the rattly windows</p>
<p>We have hit...the maximum string length in Chrome</p>
<p>BWAHAHAHAHA</p>
<p>The maximum string length!!! Nooooooo</p>
<p>It is 512MB on the dot... 536,870,888 bytes. We test this to be sure</p>
<div class="highlight highlight-js"><pre><span class="pl-k">const</span> <span class="pl-c1">len</span> <span class="pl-k">=</span> <span class="pl-c1">536_870_888</span>
<span class="pl-k">const</span> <span class="pl-c1">buf</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">Uint8Array</span>(len)
<span class="pl-k">for</span> (<span class="pl-k">let</span> i <span class="pl-k">=</span> <span class="pl-c1">0</span>; i <span class="pl-k">&#x3C;</span> len; i<span class="pl-k">++</span>) {
  buf[i] <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>a<span class="pl-pds">'</span></span>.<span class="pl-c1">charCodeAt</span>(<span class="pl-c1">0</span>)
}
<span class="pl-k">const</span> <span class="pl-c1">str</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">TextDecoder</span>().<span class="pl-en">decode</span>(buf)
<span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-smi">str</span>.<span class="pl-c1">length</span>)
</pre></div>
<p>This is correct, outputs 536,870,888</p>
<p>With anything, even one byte more, it fails and outputs 0</p>
<p>happy halloween!!</p>
<p>pumpkin photo source:
<a href="http://mountainbikerak.blogspot.com/2010/11/google-chrome-pumpkin.html">http://mountainbikerak.blogspot.com/2010/11/google-chrome-pumpkin.html</a></p>
<ul>
<li>
<p>chrome 95 tested</p>
</li>
<li>
<p>nodejs 15 - at 512MB+1 bytes it prints an error message <code>Error: Cannot create a string longer than 0x1fffffe8 characters</code> for significantly greater than 512MB
e.g. 600MB it actually prints a different error <code>TypeError [ERR_ENCODING_INVALID_ENCODED_DATA]: The encoded data was not valid for encoding utf-8</code>)</p>
</li>
<li>
<p>firefox 93 - goes up to ~1GB but then gives Exception <code>{ name: "NS_ERROR_OUT_OF_MEMORY", message: "", result: 2147942414 }</code></p>
</li>
<li>
<p>midori 6 (safari-alike/webkit) - goes up to ~2GB fine! will have to test more</p>
</li>
</ul></div><div style="margin-top:200px"></div></article></div></main></div><footer style="margin-top:100px"><a href="/">Home</a> <a href="/archive">Blog archive</a> <a href="https://github.com/cmdcolin/">Github</a> <a href="https://twitter.com/cmdcolin">Twitter</a> <a href="/projects">Projects</a> <a href="/photos">Photos</a> <a href="/rss.xml">RSS</a><a href="/about">About</a> </footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"A spooky error when you have a string bigger than 512MB in Chrome","date":"2021-10-30","slug":"2021-10-30-spooky","html":"\u003cp\u003eNow gather round for a spooky story\u003c/p\u003e\n\u003cp\u003eLate one night... in the haunted office/castle the midnight candles\nwere burning bright and we entered data for a user file....\u003c/p\u003e\n\u003cp\u003e(hindenbugs cackling in the background, dusty technical books line the dark\nshelves)\u003c/p\u003e\n\u003cp\u003eA simple 52MB gzipped datafile that we want to process in the browser. We unzip\nit, decode it, and ... we see an error!!! \u003cstrong\u003eLIGHTNING CRACKS\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/media/pumpkin-dark.jpg\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003eBut... our code is so simple (we of course abide by the religion of writing\n\"simple code\" you know)...what could be happening?\u003c/p\u003e\n\u003cp\u003eThe code looks like this\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-js\"\u003e\u003cpre\u003e\u003cspan class=\"pl-k\"\u003econst\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003ebuf\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-en\"\u003eunzip\u003c/span\u003e(file)\n\u003cspan class=\"pl-k\"\u003econst\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003estr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-k\"\u003enew\u003c/span\u003e \u003cspan class=\"pl-en\"\u003eTextDecoder\u003c/span\u003e().\u003cspan class=\"pl-en\"\u003edecode\u003c/span\u003e(buf)\n\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eWe trace it back and run a \u003ccode\u003econsole.log(str)\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eIt looks empty. We try running \u003ccode\u003econsole.log(str.length)\u003c/code\u003e ... it prints out 0\u003c/p\u003e\n\u003cp\u003eBut if we look at \u003ccode\u003econsole.log(buffer.length)\u003c/code\u003e we get 546,483,710 bytes...\u003c/p\u003e\n\u003cp\u003eWhat could be happening?\u003c/p\u003e\n\u003cp\u003eWe see in the \u003ccode\u003eTextDecoder\u003c/code\u003e documentation that it has a note called \"fatal\". We\ntry\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-js\"\u003e\u003cpre\u003e\u003cspan class=\"pl-k\"\u003econst\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003ebuf\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-en\"\u003eunzip\u003c/span\u003e(file)\n\u003cspan class=\"pl-k\"\u003econst\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003estr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-k\"\u003enew\u003c/span\u003e \u003cspan class=\"pl-en\"\u003eTextDecoder\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003eutf8\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003e\u003c/span\u003e, { fatal\u003cspan class=\"pl-k\"\u003e:\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003etrue\u003c/span\u003e }).\u003cspan class=\"pl-en\"\u003edecode\u003c/span\u003e(buf)\n\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThis doesn't change the results though\u003c/p\u003e\n\u003cp\u003eThen it dawns on us while the lightning hits and the thunderclap booms and the\nwind blows through the rattly windows\u003c/p\u003e\n\u003cp\u003eWe have hit...the maximum string length in Chrome\u003c/p\u003e\n\u003cp\u003eBWAHAHAHAHA\u003c/p\u003e\n\u003cp\u003eThe maximum string length!!! Nooooooo\u003c/p\u003e\n\u003cp\u003eIt is 512MB on the dot... 536,870,888 bytes. We test this to be sure\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-js\"\u003e\u003cpre\u003e\u003cspan class=\"pl-k\"\u003econst\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003elen\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e536_870_888\u003c/span\u003e\n\u003cspan class=\"pl-k\"\u003econst\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003ebuf\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-k\"\u003enew\u003c/span\u003e \u003cspan class=\"pl-en\"\u003eUint8Array\u003c/span\u003e(len)\n\u003cspan class=\"pl-k\"\u003efor\u003c/span\u003e (\u003cspan class=\"pl-k\"\u003elet\u003c/span\u003e i \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e0\u003c/span\u003e; i \u003cspan class=\"pl-k\"\u003e\u0026#x3C;\u003c/span\u003e len; i\u003cspan class=\"pl-k\"\u003e++\u003c/span\u003e) {\n  buf[i] \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003ea\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003e\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003echarCodeAt\u003c/span\u003e(\u003cspan class=\"pl-c1\"\u003e0\u003c/span\u003e)\n}\n\u003cspan class=\"pl-k\"\u003econst\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003estr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-k\"\u003enew\u003c/span\u003e \u003cspan class=\"pl-en\"\u003eTextDecoder\u003c/span\u003e().\u003cspan class=\"pl-en\"\u003edecode\u003c/span\u003e(buf)\n\u003cspan class=\"pl-en\"\u003econsole\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003elog\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003estr\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003elength\u003c/span\u003e)\n\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThis is correct, outputs 536,870,888\u003c/p\u003e\n\u003cp\u003eWith anything, even one byte more, it fails and outputs 0\u003c/p\u003e\n\u003cp\u003ehappy halloween!!\u003c/p\u003e\n\u003cp\u003epumpkin photo source:\n\u003ca href=\"http://mountainbikerak.blogspot.com/2010/11/google-chrome-pumpkin.html\"\u003ehttp://mountainbikerak.blogspot.com/2010/11/google-chrome-pumpkin.html\u003c/a\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003echrome 95 tested\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003enodejs 15 - at 512MB+1 bytes it prints an error message \u003ccode\u003eError: Cannot create a string longer than 0x1fffffe8 characters\u003c/code\u003e for significantly greater than 512MB\ne.g. 600MB it actually prints a different error \u003ccode\u003eTypeError [ERR_ENCODING_INVALID_ENCODED_DATA]: The encoded data was not valid for encoding utf-8\u003c/code\u003e)\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003efirefox 93 - goes up to ~1GB but then gives Exception \u003ccode\u003e{ name: \"NS_ERROR_OUT_OF_MEMORY\", message: \"\", result: 2147942414 }\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003emidori 6 (safari-alike/webkit) - goes up to ~2GB fine! will have to test more\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e"}},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"2021-10-30-spooky"},"buildId":"VNs4osprFX-hk-MwN5NzY","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>