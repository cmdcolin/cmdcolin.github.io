<!DOCTYPE html><html lang="en"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>A spooky error when you have a string bigger than 512MB in Chrome</title><meta name="next-head-count" content="3"/><link rel="shortcut icon" href="favicon.ico"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><meta name="description" content="Blogging for the future"/><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/prism.min.js" integrity="sha512-hpZ5pDCF2bRCweL5WoA0/N1elet1KYL5mx3LP555Eg/0ZguaHawxNvEjF6O3rufAChs16HVNhEc6blF/rZoowQ==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="preload" href="/_next/static/css/9d066bf523979bbf.css" as="style"/><link rel="stylesheet" href="/_next/static/css/9d066bf523979bbf.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-4c70eeb4cef5b69f.js" defer=""></script><script src="/_next/static/chunks/framework-c0d8f0fd2eea5ac1.js" defer=""></script><script src="/_next/static/chunks/main-33a474ca00e371b8.js" defer=""></script><script src="/_next/static/chunks/pages/_app-13ca9a07b898f6f6.js" defer=""></script><script src="/_next/static/chunks/996-9c91d1eae613ddeb.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-a9b8dd170d83e486.js" defer=""></script><script src="/_next/static/L4OF08ZNQeY7A5f4T6zYq/_buildManifest.js" defer=""></script><script src="/_next/static/L4OF08ZNQeY7A5f4T6zYq/_ssgManifest.js" defer=""></script><script src="/_next/static/L4OF08ZNQeY7A5f4T6zYq/_middlewareManifest.js" defer=""></script></head><body><div id="__next"><div><main><div><div style="margin-bottom:100px"><a href="/">Misc scribbles</a></div><article><div><h1>A spooky error when you have a string bigger than 512MB in Chrome</h1><h4>2021-10-30</h4></div><p>Now gather round for a spooky story</p>
<p>Late one night... in the haunted office space castle (hindenbugs cackling in
the background amongst the dusty technical books) the midnight candles were
burning bright and we entered data for a user file</p>
<p>A simple 52MB gzipped datafile that we want to process in the browser. We unzip
it, decode it, and ...an error</p>
<p>ERROR: data not found</p>
<p><img src="/media/pumpkin-dark.jpg" alt=""/></p>
<p>But... our code is so simple (we of course abide by the religion of writing
&quot;simple code&quot; you know)...what could be happening?</p>
<p>The code looks like this</p>
<pre><code class="language-js">const buf = unzip(file)
const str = new TextDecoder().decode(buf)
</code></pre>
<p>We trace it back and run a console.log(str)</p>
<p>It looks empty. We try running console.log(str.length) ... it prints out 0</p>
<p>But if we console.log(buffer.length) we get 546,483,710 bytes...</p>
<p>What could be happening?</p>
<p>We see in the TextDecoder documentation that it has a note called &quot;fatal&quot;. We
try</p>
<pre><code class="language-js">const buf = unzip(file)
const str = new TextDecoder(&#x27;utf8&#x27;, { fatal: true }).decode(buf)
</code></pre>
<p>This doesn&#x27;t change the results though</p>
<p>Then it dawns on us while the lightning hits and the thunderclap booms and the
wind blows through the rattly windows</p>
<p>We have hit...the maximum string length in Chrome</p>
<p>BWAHAHAHAHA</p>
<p>The maximum string length!!! Nooooooo</p>
<p>It is 512MB on the dot... 536,870,888 bytes. We test this to be sure</p>
<pre><code class="language-js">const len = 536_870_888
const buf = new Uint8Array(len)
for (let i = 0; i &lt; len; i++) {
  buf[i] = &#x27;a&#x27;.charCodeAt(0)
}
const str = new TextDecoder().decode(buf)
console.log(str.length)
</code></pre>
<p>This is correct, outputs 536,870,888</p>
<p>With anything, even one byte more, it fails and outputs 0</p>
<p>happy halloween!!</p>
<p>pumpkin photo source:
http://mountainbikerak.blogspot.com/2010/11/google-chrome-pumpkin.html</p>
<p>chrome 95 tested</p>
<p>nodejs 15 - at 512MB+1 bytes it prints an error message <code>Error: Cannot create a string longer than 0x1fffffe8 characters</code> for significantly greater than 512MB
e.g. 600MB it actually prints a different error <code>TypeError [ERR_ENCODING_INVALID_ENCODED_DATA]: The encoded data was not valid for encoding utf-8</code>)</p>
<p>firefox 93 - goes up to ~1GB but then gives Exception <code>{ name: &quot;NS_ERROR_OUT_OF_MEMORY&quot;, message: &quot;&quot;, result: 2147942414 }</code></p>
<p>midori 6 (safari-alike/webkit) - goes up to ~2GB fine! will have to test more</p><div style="margin-top:200px"></div></article></div></main></div><footer style="margin-top:100px"><a href="/">Home</a> <a href="/archive">Blog archive</a> <a href="https://github.com/cmdcolin/">Github</a> <a href="https://twitter.com/cmdcolin">Twitter</a> <a href="/projects">Projects</a> <a href="/photos">Photos</a> <a href="/rss.xml">RSS</a><a href="/about">About</a> </footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"A spooky error when you have a string bigger than 512MB in Chrome","date":"2021-10-30","slug":"2021-10-30-spooky","mdxSource":{"compiledSource":"/*@jsxRuntime automatic @jsxImportSource react*/\nconst {Fragment: _Fragment, jsx: _jsx, jsxs: _jsxs} = arguments[0];\nconst {useMDXComponents: _provideComponents} = arguments[0];\nfunction MDXContent(props = {}) {\n  const {wrapper: MDXLayout} = Object.assign({}, _provideComponents(), props.components);\n  return MDXLayout ? _jsx(MDXLayout, Object.assign({}, props, {\n    children: _jsx(_createMdxContent, {})\n  })) : _createMdxContent();\n  function _createMdxContent() {\n    const _components = Object.assign({\n      p: \"p\",\n      img: \"img\",\n      pre: \"pre\",\n      code: \"code\"\n    }, _provideComponents(), props.components);\n    return _jsxs(_Fragment, {\n      children: [_jsx(_components.p, {\n        children: \"Now gather round for a spooky story\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"Late one night... in the haunted office space castle (hindenbugs cackling in\\nthe background amongst the dusty technical books) the midnight candles were\\nburning bright and we entered data for a user file\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"A simple 52MB gzipped datafile that we want to process in the browser. We unzip\\nit, decode it, and ...an error\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"ERROR: data not found\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: _jsx(_components.img, {\n          src: \"/media/pumpkin-dark.jpg\",\n          alt: \"\"\n        })\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"But... our code is so simple (we of course abide by the religion of writing\\n\\\"simple code\\\" you know)...what could be happening?\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"The code looks like this\"\n      }), \"\\n\", _jsx(_components.pre, {\n        children: _jsx(_components.code, {\n          className: \"language-js\",\n          children: \"const buf = unzip(file)\\nconst str = new TextDecoder().decode(buf)\\n\"\n        })\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"We trace it back and run a console.log(str)\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"It looks empty. We try running console.log(str.length) ... it prints out 0\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"But if we console.log(buffer.length) we get 546,483,710 bytes...\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"What could be happening?\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"We see in the TextDecoder documentation that it has a note called \\\"fatal\\\". We\\ntry\"\n      }), \"\\n\", _jsx(_components.pre, {\n        children: _jsx(_components.code, {\n          className: \"language-js\",\n          children: \"const buf = unzip(file)\\nconst str = new TextDecoder('utf8', { fatal: true }).decode(buf)\\n\"\n        })\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"This doesn't change the results though\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"Then it dawns on us while the lightning hits and the thunderclap booms and the\\nwind blows through the rattly windows\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"We have hit...the maximum string length in Chrome\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"BWAHAHAHAHA\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"The maximum string length!!! Nooooooo\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"It is 512MB on the dot... 536,870,888 bytes. We test this to be sure\"\n      }), \"\\n\", _jsx(_components.pre, {\n        children: _jsx(_components.code, {\n          className: \"language-js\",\n          children: \"const len = 536_870_888\\nconst buf = new Uint8Array(len)\\nfor (let i = 0; i \u003c len; i++) {\\n  buf[i] = 'a'.charCodeAt(0)\\n}\\nconst str = new TextDecoder().decode(buf)\\nconsole.log(str.length)\\n\"\n        })\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"This is correct, outputs 536,870,888\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"With anything, even one byte more, it fails and outputs 0\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"happy halloween!!\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"pumpkin photo source:\\nhttp://mountainbikerak.blogspot.com/2010/11/google-chrome-pumpkin.html\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"chrome 95 tested\"\n      }), \"\\n\", _jsxs(_components.p, {\n        children: [\"nodejs 15 - at 512MB+1 bytes it prints an error message \", _jsx(_components.code, {\n          children: \"Error: Cannot create a string longer than 0x1fffffe8 characters\"\n        }), \" for significantly greater than 512MB\\ne.g. 600MB it actually prints a different error \", _jsx(_components.code, {\n          children: \"TypeError [ERR_ENCODING_INVALID_ENCODED_DATA]: The encoded data was not valid for encoding utf-8\"\n        }), \")\"]\n      }), \"\\n\", _jsxs(_components.p, {\n        children: [\"firefox 93 - goes up to ~1GB but then gives Exception \", _jsx(_components.code, {\n          children: \"{ name: \\\"NS_ERROR_OUT_OF_MEMORY\\\", message: \\\"\\\", result: 2147942414 }\"\n        })]\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"midori 6 (safari-alike/webkit) - goes up to ~2GB fine! will have to test more\"\n      })]\n    });\n  }\n}\nreturn {\n  default: MDXContent\n};\n","frontmatter":{},"scope":{}}}},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"2021-10-30-spooky"},"buildId":"L4OF08ZNQeY7A5f4T6zYq","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>