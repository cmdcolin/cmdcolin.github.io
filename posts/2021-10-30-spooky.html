<!DOCTYPE html><html lang="en"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="shortcut icon" href="favicon.ico"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><meta name="description" content="Blogging for the future"/><title>A spooky error when you have a string bigger than 512MB in Chrome</title><meta name="next-head-count" content="6"/><link rel="preload" href="/_next/static/css/ddb86c7b4e1045c6.css" as="style"/><link rel="stylesheet" href="/_next/static/css/ddb86c7b4e1045c6.css" data-n-g=""/><link rel="preload" href="/_next/static/css/e1f6961df2961232.css" as="style"/><link rel="stylesheet" href="/_next/static/css/e1f6961df2961232.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-514908bffb652963.js" defer=""></script><script src="/_next/static/chunks/framework-91d7f78b5b4003c8.js" defer=""></script><script src="/_next/static/chunks/main-7c3bf82eed00c281.js" defer=""></script><script src="/_next/static/chunks/pages/_app-76cd57bf65f05d70.js" defer=""></script><script src="/_next/static/chunks/162-1be62df9fbed0df5.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-2c663bbcac870718.js" defer=""></script><script src="/_next/static/w5gAN4c59KlVbPsb5aBxt/_buildManifest.js" defer=""></script><script src="/_next/static/w5gAN4c59KlVbPsb5aBxt/_ssgManifest.js" defer=""></script><script src="/_next/static/w5gAN4c59KlVbPsb5aBxt/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="min-h-screen"><main><div class="container mx-auto px-5"><div class="text-2xl md:text-4xl font-bold py-14 border-b border-accent-2 flex flex-col lg:flex-row items-center"><a class="header" href="/">Misc scribbles</a></div><article class="mb-32"><h1 class="text-2xl md:text-2xl lg:text-2xl font-bold tracking-tighter leading-tight md:leading-none mb-12 text-center md:text-left">A spooky error when you have a string bigger than 512MB in Chrome<!-- --> - <!-- -->2021-10-30</h1><div class="max-w-1xl mx-auto"><div class="markdown-styles_markdown__h_8de"><p>Now gather round for a spooky story</p>
<p>Late one night... in the haunted office space castle (hindenbugs cackling in
the background amongst the dusty technical books) the midnight candles were
burning bright and we entered data for a user file</p>
<p>A simple 52MB gzipped datafile that we want to process in the browser. We unzip
it, decode it, and ...an error</p>
<p>ERROR: data not found</p>
<p><img src="/media/pumpkin-dark.jpg" alt=""></p>
<p>But... our code is so simple (we of course abide by the religion of writing "simple code" you know)...what could be happening?</p>
<p>The code looks like this</p>
<pre><code>const buf = unzip(file)
const str = new TextDecoder().decode(buf)
</code></pre>
<p>We trace it back and run a console.log(str)</p>
<p>It looks empty. We try running console.log(str.length) ... it prints out 0</p>
<p>But if we console.log(buffer.length) we get 546,483,710 bytes...</p>
<p>What could be happening?</p>
<p>We see in the TextDecoder documentation that it has a note called "fatal". We try</p>
<pre><code>const buf = unzip(file)
const str = new TextDecoder('utf8', { fatal: true }).decode(buf)
</code></pre>
<p>This doesn't change the results though</p>
<p>Then it dawns on us while the lightning hits and the thunderclap booms and the
wind blows through the rattly windows</p>
<p>We have hit...the maximum string length in Chrome</p>
<p>BWAHAHAHAHA</p>
<p>The maximum string length!!! Nooooooo</p>
<p>It is 512MB on the dot... 536,870,888 bytes. We test this to be sure</p>
<pre><code>const len = 536_870_888;
const buf = new Uint8Array(len);
for (let i = 0; i &#x3C; len; i++) {
  buf[i] = "a".charCodeAt(0);
}
const str = new TextDecoder().decode(buf);
console.log(str.length);

</code></pre>
<p>This is correct, outputs 536,870,888</p>
<p>With anything, even one byte more, it fails and outputs 0</p>
<p>happy halloween!!</p>
<p>pumpkin photo source: http://mountainbikerak.blogspot.com/2010/11/google-chrome-pumpkin.html</p>
<p>chrome 95 tested</p>
<p>nodejs 15 - at 512MB+1 bytes it prints an error message <code>Error: Cannot create a string longer than 0x1fffffe8 characters</code> for significantly greater than 512MB
e.g. 600MB it actually prints a different error <code>TypeError [ERR_ENCODING_INVALID_ENCODED_DATA]: The encoded data was not valid for encoding utf-8</code>)</p>
<p>firefox 93 - goes up to ~1GB but then gives Exception { name: "NS_ERROR_OUT_OF_MEMORY", message: "", result: 2147942414</p>
<p>midori 6 (safari-alike/webkit) - goes up to ~2GB fine! will have to test more</p>
</div></div></article></div></main></div><footer class="bg-accent-1 border-t border-accent-2"><div class="container mx-auto px-5"><div class="py-14 flex flex-col lg:flex-row items-center"><div class="m-4"><a class="hover:underline" href="/">Home</a></div><div class="m-4"><a class="hover:underline" href="https://github.com/cmdcolin">Github</a></div><div class="m-4"><a class="hover:underline" href="https://twitter.com/cmdcolin">Twitter</a></div><div class="m-4"><a class="hover:underline" href="/projects">Projects</a></div><div class="m-4"><a class="hover:underline" href="/photos">Photos</a></div><div class="m-4"><a class="hover:underline" href="/rss.xml">RSS</a></div></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"A spooky error when you have a string bigger than 512MB in Chrome","date":"2021-10-30","slug":"2021-10-30-spooky","content":"\u003cp\u003eNow gather round for a spooky story\u003c/p\u003e\n\u003cp\u003eLate one night... in the haunted office space castle (hindenbugs cackling in\nthe background amongst the dusty technical books) the midnight candles were\nburning bright and we entered data for a user file\u003c/p\u003e\n\u003cp\u003eA simple 52MB gzipped datafile that we want to process in the browser. We unzip\nit, decode it, and ...an error\u003c/p\u003e\n\u003cp\u003eERROR: data not found\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/media/pumpkin-dark.jpg\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003eBut... our code is so simple (we of course abide by the religion of writing \"simple code\" you know)...what could be happening?\u003c/p\u003e\n\u003cp\u003eThe code looks like this\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003econst buf = unzip(file)\nconst str = new TextDecoder().decode(buf)\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWe trace it back and run a console.log(str)\u003c/p\u003e\n\u003cp\u003eIt looks empty. We try running console.log(str.length) ... it prints out 0\u003c/p\u003e\n\u003cp\u003eBut if we console.log(buffer.length) we get 546,483,710 bytes...\u003c/p\u003e\n\u003cp\u003eWhat could be happening?\u003c/p\u003e\n\u003cp\u003eWe see in the TextDecoder documentation that it has a note called \"fatal\". We try\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003econst buf = unzip(file)\nconst str = new TextDecoder('utf8', { fatal: true }).decode(buf)\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis doesn't change the results though\u003c/p\u003e\n\u003cp\u003eThen it dawns on us while the lightning hits and the thunderclap booms and the\nwind blows through the rattly windows\u003c/p\u003e\n\u003cp\u003eWe have hit...the maximum string length in Chrome\u003c/p\u003e\n\u003cp\u003eBWAHAHAHAHA\u003c/p\u003e\n\u003cp\u003eThe maximum string length!!! Nooooooo\u003c/p\u003e\n\u003cp\u003eIt is 512MB on the dot... 536,870,888 bytes. We test this to be sure\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003econst len = 536_870_888;\nconst buf = new Uint8Array(len);\nfor (let i = 0; i \u0026#x3C; len; i++) {\n  buf[i] = \"a\".charCodeAt(0);\n}\nconst str = new TextDecoder().decode(buf);\nconsole.log(str.length);\n\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis is correct, outputs 536,870,888\u003c/p\u003e\n\u003cp\u003eWith anything, even one byte more, it fails and outputs 0\u003c/p\u003e\n\u003cp\u003ehappy halloween!!\u003c/p\u003e\n\u003cp\u003epumpkin photo source: http://mountainbikerak.blogspot.com/2010/11/google-chrome-pumpkin.html\u003c/p\u003e\n\u003cp\u003echrome 95 tested\u003c/p\u003e\n\u003cp\u003enodejs 15 - at 512MB+1 bytes it prints an error message \u003ccode\u003eError: Cannot create a string longer than 0x1fffffe8 characters\u003c/code\u003e for significantly greater than 512MB\ne.g. 600MB it actually prints a different error \u003ccode\u003eTypeError [ERR_ENCODING_INVALID_ENCODED_DATA]: The encoded data was not valid for encoding utf-8\u003c/code\u003e)\u003c/p\u003e\n\u003cp\u003efirefox 93 - goes up to ~1GB but then gives Exception { name: \"NS_ERROR_OUT_OF_MEMORY\", message: \"\", result: 2147942414\u003c/p\u003e\n\u003cp\u003emidori 6 (safari-alike/webkit) - goes up to ~2GB fine! will have to test more\u003c/p\u003e\n"}},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"2021-10-30-spooky"},"buildId":"w5gAN4c59KlVbPsb5aBxt","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>