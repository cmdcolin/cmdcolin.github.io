<!DOCTYPE html><html lang="en"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="shortcut icon" href="favicon.ico"/><link rel="alternate" type="application/rss+xml" href="/feed.xml"/><meta name="description" content="Blogging for the future"/><title>An amazing error message if you put more than 2^24 items in a JS Map object</title><meta name="next-head-count" content="6"/><link rel="preload" href="/_next/static/css/895e0128ed383e47.css" as="style"/><link rel="stylesheet" href="/_next/static/css/895e0128ed383e47.css" data-n-g=""/><link rel="preload" href="/_next/static/css/e1f6961df2961232.css" as="style"/><link rel="stylesheet" href="/_next/static/css/e1f6961df2961232.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-514908bffb652963.js" defer=""></script><script src="/_next/static/chunks/framework-91d7f78b5b4003c8.js" defer=""></script><script src="/_next/static/chunks/main-7c3bf82eed00c281.js" defer=""></script><script src="/_next/static/chunks/pages/_app-76cd57bf65f05d70.js" defer=""></script><script src="/_next/static/chunks/162-afcc9fe4184ebd89.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-2c663bbcac870718.js" defer=""></script><script src="/_next/static/WF_y7-b-w3MSgywciVzlf/_buildManifest.js" defer=""></script><script src="/_next/static/WF_y7-b-w3MSgywciVzlf/_ssgManifest.js" defer=""></script><script src="/_next/static/WF_y7-b-w3MSgywciVzlf/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="min-h-screen"><main><div class="container mx-auto px-5"><div class="text-2xl md:text-4xl font-bold py-14 border-b border-accent-2 flex flex-col lg:flex-row items-center"><a class="hover:underline" href="/">Misc scribbles</a></div><article class="mb-32"><h1 class="text-2xl md:text-2xl lg:text-2xl font-bold tracking-tighter leading-tight md:leading-none mb-12 text-center md:text-left">An amazing error message if you put more than 2^24 items in a JS Map object<!-- --> - <!-- -->2021-08-15</h1><div class="max-w-1xl mx-auto"><div class="markdown-styles_markdown__h_8de"><p>One of the fun things about working with big data is that you can often hit
weird limits with a system.</p>
<p>I was personally trying to load every 'common' single nucleotide polymorphism
for the human genome into memory (dbSNP), of which there are over 37 million
entries (there are many more uncommon ones) for the purposes of making a custom
search index for them [1].</p>
<p>Turns out, you may run into some hard limits. Note that these are all V8-isms
and may not apply to all browsers or engines (I was using node.js for this)</p>
<pre><code>const myObject = new Map();
for (let i = 0; i &#x3C;= 50_000_000; i++) {
  myObject.set(i,i);
  if(i%100000==0) { console.log(i) }
}
</code></pre>
<p>This will crash after adding approx 16.7M elements and say</p>
<pre><code>0
100000
200000
...
16400000
16500000
16600000
16700000

Uncaught RangeError: Value undefined out of range for undefined options
property undefined
</code></pre>
<p>That is a very weird error message. It says “undefined” three times! Much
better than your usual “TypeError: Can’t find property ‘lol’ of undefined”. See
https://bugs.chromium.org/p/v8/issues/detail?id=11852 for a bug filed to help
improve the error message perhaps.</p>
<p>Now, also interestingly enough, if you use an Object instead of a Map</p>
<pre><code>const myObject = {};
for (let i = 0; i &#x3C;= 50_000_000; i++) {
  myObject['myobj_’+i]=i;
  if(i%100000==0) { console.log(i) }
}
</code></pre>
<p>Then it will print….</p>
<pre><code>0
100000
200000
...
8000000
8100000
8200000
8300000
</code></pre>
<p>And it will actually just hang there…frozen…no error message though! And it is
failing at ~8.3M elements. Weird right? This is roughly half the amount of
elements as the 16.7M case</p>
<p>Turns out there is a precise hard limit for the Map case</p>
<p>For the Map: 2^24=16,777,216</p>
<p>For the Object it is around 2^23=8,388,608 HOWEVER, I can actually add more
than this, e.g. I can add 8,388,609 or 8,388,610 or even more, but the
operations start taking forever to run, e.g. 8,388,999 was taking many minutes</p>
<p>Very weird stuff! If you expected me to dig into this and explain it in deep
technical detail, well, you’d be wrong. I am lazy. However, this helpful post
on stackoverflow by a V8 js engine developer clarifies the Map case!!
https://stackoverflow.com/questions/54452896/maximum-number-of-entries-in-node-js-map</p>
<pre><code>V8 developer here. I can confirm that 2^24 is the maximum number of entries in
a Map. That’s not a bug, it’s just the implementation-defined limit.

The limit is determined by:

The FixedArray backing store of the Map has a maximum size of 1GB (independent
of the overall heap size limit) On a 64-bit system that means 1GB / 8B = 2^30 /
2^3 = 2^27 ~= 134M maximum elements per FixedArray A Map needs 3 elements per
entry (key, value, next bucket link), and has a maximum load factor of 50% (to
avoid the slowdown caused by many bucket collisions), and its capacity must be
a power of 2. 2^27 / (3 * 2) rounded down to the next power of 2 is 2^24, which
is the limit you observe.  FWIW, there are limits to everything: besides the
maximum heap size, there’s a maximum String length, a maximum Array length, a
maximum ArrayBuffer length, a maximum BigInt size, a maximum stack size, etc.
Any one of those limits is potentially debatable, and sometimes it makes sense
to raise them, but the limits as such will remain. Off the top of my head I
don’t know what it would take to bump this particular limit by, say, a factor
of two – and I also don’t know whether a factor of two would be enough to
satisfy your expectations.

</code></pre>
<p>Great details there. It would also be good to know what the behavior is for the
Object, which has those 100% CPU stalls after ~8.3M, but not the same error
message...</p>
<p>Another fun note: if I modify the Object code to use only “integer IDs” the
code actually works fine, does not hit any errors, and is “blazingly fast” as
the kids call it</p>
<pre><code>const myObject = {}
for (let i = 0; i &#x3C;= 50_000_000; i++) {
  myObject[i] = i
  if (i % 100000 == 0) {
    console.log(i)
  }
}
</code></pre>
<p>I presume that this code works because it detects that I’m using it like an
array and it decides to transform how it is working internally and not use a
hash-map-style data structure, so does not hit a limit. There is a slightly
higher limit though, e.g. 1 billion elements gives “Uncaught RangeError:
Invalid array length”</p>
<pre><code>const myObject = {}
for (let i = 0; i &#x3C;= 1_000_000_000; i++) {
  myObject[i] = i
  if (i % 100000 == 0) {
    console.log(i)
  }
}
</code></pre>
<p>This has been another episode of ....the twilight zone (other episodes
catalogued here) https://github.com/cmdcolin/technical_oddities/</p>
<p>[1] The final product of this adventure was this, to create a search index for
a large number of elements https://github.com/GMOD/ixixx-js</p>
</div></div></article></div></main></div><footer class="bg-accent-1 border-t border-accent-2"><div class="container mx-auto px-5"><div class="py-14 flex flex-col lg:flex-row items-center"><div class="m-4"><a class="hover:underline" href="/">Home</a></div><div class="m-4"><a class="hover:underline" href="https://github.com/cmdcolin">Github</a></div><div class="m-4"><a class="hover:underline" href="https://twitter.com/cmdcolin">Twitter</a></div><div class="m-4"><a class="hover:underline" href="/projects">Projects</a></div><div class="m-4"><a class="hover:underline" href="/rss.xml">RSS</a></div></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"An amazing error message if you put more than 2^24 items in a JS Map object","date":"2021-08-15","slug":"2021-08-15-map-limit","content":"\u003cp\u003eOne of the fun things about working with big data is that you can often hit\nweird limits with a system.\u003c/p\u003e\n\u003cp\u003eI was personally trying to load every 'common' single nucleotide polymorphism\nfor the human genome into memory (dbSNP), of which there are over 37 million\nentries (there are many more uncommon ones) for the purposes of making a custom\nsearch index for them [1].\u003c/p\u003e\n\u003cp\u003eTurns out, you may run into some hard limits. Note that these are all V8-isms\nand may not apply to all browsers or engines (I was using node.js for this)\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003econst myObject = new Map();\nfor (let i = 0; i \u0026#x3C;= 50_000_000; i++) {\n  myObject.set(i,i);\n  if(i%100000==0) { console.log(i) }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis will crash after adding approx 16.7M elements and say\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e0\n100000\n200000\n...\n16400000\n16500000\n16600000\n16700000\n\nUncaught RangeError: Value undefined out of range for undefined options\nproperty undefined\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThat is a very weird error message. It says “undefined” three times! Much\nbetter than your usual “TypeError: Can’t find property ‘lol’ of undefined”. See\nhttps://bugs.chromium.org/p/v8/issues/detail?id=11852 for a bug filed to help\nimprove the error message perhaps.\u003c/p\u003e\n\u003cp\u003eNow, also interestingly enough, if you use an Object instead of a Map\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003econst myObject = {};\nfor (let i = 0; i \u0026#x3C;= 50_000_000; i++) {\n  myObject['myobj_’+i]=i;\n  if(i%100000==0) { console.log(i) }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThen it will print….\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e0\n100000\n200000\n...\n8000000\n8100000\n8200000\n8300000\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAnd it will actually just hang there…frozen…no error message though! And it is\nfailing at ~8.3M elements. Weird right? This is roughly half the amount of\nelements as the 16.7M case\u003c/p\u003e\n\u003cp\u003eTurns out there is a precise hard limit for the Map case\u003c/p\u003e\n\u003cp\u003eFor the Map: 2^24=16,777,216\u003c/p\u003e\n\u003cp\u003eFor the Object it is around 2^23=8,388,608 HOWEVER, I can actually add more\nthan this, e.g. I can add 8,388,609 or 8,388,610 or even more, but the\noperations start taking forever to run, e.g. 8,388,999 was taking many minutes\u003c/p\u003e\n\u003cp\u003eVery weird stuff! If you expected me to dig into this and explain it in deep\ntechnical detail, well, you’d be wrong. I am lazy. However, this helpful post\non stackoverflow by a V8 js engine developer clarifies the Map case!!\nhttps://stackoverflow.com/questions/54452896/maximum-number-of-entries-in-node-js-map\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eV8 developer here. I can confirm that 2^24 is the maximum number of entries in\na Map. That’s not a bug, it’s just the implementation-defined limit.\n\nThe limit is determined by:\n\nThe FixedArray backing store of the Map has a maximum size of 1GB (independent\nof the overall heap size limit) On a 64-bit system that means 1GB / 8B = 2^30 /\n2^3 = 2^27 ~= 134M maximum elements per FixedArray A Map needs 3 elements per\nentry (key, value, next bucket link), and has a maximum load factor of 50% (to\navoid the slowdown caused by many bucket collisions), and its capacity must be\na power of 2. 2^27 / (3 * 2) rounded down to the next power of 2 is 2^24, which\nis the limit you observe.  FWIW, there are limits to everything: besides the\nmaximum heap size, there’s a maximum String length, a maximum Array length, a\nmaximum ArrayBuffer length, a maximum BigInt size, a maximum stack size, etc.\nAny one of those limits is potentially debatable, and sometimes it makes sense\nto raise them, but the limits as such will remain. Off the top of my head I\ndon’t know what it would take to bump this particular limit by, say, a factor\nof two – and I also don’t know whether a factor of two would be enough to\nsatisfy your expectations.\n\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eGreat details there. It would also be good to know what the behavior is for the\nObject, which has those 100% CPU stalls after ~8.3M, but not the same error\nmessage...\u003c/p\u003e\n\u003cp\u003eAnother fun note: if I modify the Object code to use only “integer IDs” the\ncode actually works fine, does not hit any errors, and is “blazingly fast” as\nthe kids call it\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003econst myObject = {}\nfor (let i = 0; i \u0026#x3C;= 50_000_000; i++) {\n  myObject[i] = i\n  if (i % 100000 == 0) {\n    console.log(i)\n  }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eI presume that this code works because it detects that I’m using it like an\narray and it decides to transform how it is working internally and not use a\nhash-map-style data structure, so does not hit a limit. There is a slightly\nhigher limit though, e.g. 1 billion elements gives “Uncaught RangeError:\nInvalid array length”\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003econst myObject = {}\nfor (let i = 0; i \u0026#x3C;= 1_000_000_000; i++) {\n  myObject[i] = i\n  if (i % 100000 == 0) {\n    console.log(i)\n  }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis has been another episode of ....the twilight zone (other episodes\ncatalogued here) https://github.com/cmdcolin/technical_oddities/\u003c/p\u003e\n\u003cp\u003e[1] The final product of this adventure was this, to create a search index for\na large number of elements https://github.com/GMOD/ixixx-js\u003c/p\u003e\n"}},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"2021-08-15-map-limit"},"buildId":"WF_y7-b-w3MSgywciVzlf","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>