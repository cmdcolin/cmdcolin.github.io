<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="description" content="Astro description"><meta name="viewport" content="width=device-width"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v5.16.0"><title>Making a pure-ESM package using `tsc`</title><style>.container[data-astro-cid-4oxc2zqz]{max-width:800px;margin:0 auto;padding:0 1rem}article[data-astro-cid-lvjzyg5v]{max-width:100%}.post-content[data-astro-cid-lvjzyg5v]{margin:2rem 0;line-height:1.6}
.footer-style[data-astro-cid-k2f5zb5c]{margin-top:4rem}.footer-link[data-astro-cid-k2f5zb5c]{margin:.5rem}body{font-family:Helvetica,Arial,sans-serif;background-color:Canvas;color:CanvasText;color-scheme:light dark}img{max-width:100%}pre{max-width:100%;overflow:auto}li+li{margin-top:10px}pre{padding:10px;border-radius:5px}
</style></head> <body> <div class="mb-8"> <a href="/">Misc scribbles</a> </div>  <div class="container" data-astro-cid-4oxc2zqz>  <article data-astro-cid-lvjzyg5v> <div data-astro-cid-lvjzyg5v> <h1 data-astro-cid-lvjzyg5v>Making a pure-ESM package using `tsc`</h1> <h4 data-astro-cid-lvjzyg5v>2025-01-12</h4> </div> <div class="post-content" data-astro-cid-lvjzyg5v> <p>In the past, I have written about making NPM packages with just the typescript
compiler (<a href="https://cmdcolin.github.io/posts/2022-05-27-youmaynotneedabundler">https://cmdcolin.github.io/posts/2022-05-27-youmaynotneedabundler</a>).
There, I focused on “CJS” build because it was arguably simpler</p>
<p>Now, I am addressing the “ESM” case</p>
<p>TLDR: here is the minimal github repo for this post
<a href="https://github.com/cmdcolin/minimalpackage">https://github.com/cmdcolin/minimalpackage</a></p>
<h2 id="why-pure-esm-now">Why pure-ESM now?</h2>
<p>As my previous article mentions, I like taking a ‘bundler-less’ approach to
library distribution. That means that multiple files might end up in the <code>dist</code>
folder which reference each other. However, using “pure ESM” requires these
files that reference each other to import the actual path, with the file
extensions</p>
<p>Which was awkward before…but now</p>
<h2 id="we-have-some-new-tsconfigjson-settings-to-help">We have some new tsconfig.json settings to help</h2>
<p>The recent addition of the <code>tsc</code> settings
<a href="https://www.typescriptlang.org/tsconfig/allowImportingTsExtensions.html"><code>allowImportingTsExtensions</code></a>
and
<a href="https://devblogs.microsoft.com/typescript/announcing-typescript-5-7/#path-rewriting-for-relative-paths"><code>rewriteRelativeImportExtensions</code></a>
have now allow us to import from the .ts file extension in the src folder, and
it automatically rewrites to use the .js file extension in the dist folder</p>
<p>For example we can have</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#6A737D">// src/index.ts</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> { bar } </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> './bar.ts'</span></span>
<span class="line"><span style="color:#F97583">export</span><span style="color:#F97583"> function</span><span style="color:#B392F0"> foo</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#B392F0">  bar</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#6A737D">// src/bar.ts</span></span>
<span class="line"><span style="color:#F97583">export</span><span style="color:#F97583"> function</span><span style="color:#B392F0"> bar</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">  console.</span><span style="color:#B392F0">log</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'bar in bar.ts'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>then running tsc over these files will produce</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span> ❯❯❯ ll dist</span></span>
<span class="line"><span>total 24K</span></span>
<span class="line"><span>-rw-rw-r-- 1 cdiesh cdiesh  37 Jan 14 06:07 bar.d.ts</span></span>
<span class="line"><span>-rw-rw-r-- 1 cdiesh cdiesh  91 Jan 14 06:07 bar.js</span></span>
<span class="line"><span>-rw-rw-r-- 1 cdiesh cdiesh  43 Jan 14 06:07 index.d.ts</span></span>
<span class="line"><span>-rw-rw-r-- 1 cdiesh cdiesh 116 Jan 14 06:07 index.js</span></span>
<span class="line"><span></span></span></code></pre>
<p>where dist/index.js now contains an import with the .js extension</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> { foo } </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> './bar.js'</span></span>
<span class="line"><span style="color:#B392F0">foo</span><span style="color:#E1E4E8">()</span></span></code></pre>
<p>and dist/bar.js says</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> { bar } </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> './bar.js'</span></span>
<span class="line"><span style="color:#F97583">export</span><span style="color:#F97583"> function</span><span style="color:#B392F0"> foo</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#B392F0">  bar</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Previously you had to write <code>import {foo} from './bar.js'</code> in the src folder to
have this behavior, but now you can reference the actual file, bar.ts</p>
<h2 id="the-packagejson">The package.json</h2>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="json"><code><span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#79B8FF">  "name"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"minimalpackage"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">  "version"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"1.0.0"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">  "description"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"simple pure-esm package compatible with tsc"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">  "license"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"MIT"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">  "type"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"module"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">  "exports"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"./dist/index.js"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">  "main"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"./dist/index.js"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">  "scripts"</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#79B8FF">    "build"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"tsc"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">    "clean"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"rimraf dist"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">    "prebuild"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"yarn clean"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">    "preversion"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"yarn build"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">    "postversion"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"git push --follow-tags"</span></span>
<span class="line"><span style="color:#E1E4E8">  },</span></span>
<span class="line"><span style="color:#79B8FF">  "devDependencies"</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#79B8FF">    "rimraf"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"^6.0.1"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">    "typescript"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"^5.7.3"</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Some things you can observe</p>
<ul>
<li>
<p>I specify main and exports. Exports is sufficient for some but requires
consumers use moduleResolution with nodenext which is rare</p>
</li>
<li>
<p>You can see from the above, I did not need to specify the location of “types”</p>
</li>
<li>
<p>Lots of usages of “exports” have a complex object but it can simply be a
string that points to a file</p>
</li>
<li>
<p>I use rimraf to clear the dist folder before building. I can use “yarn build
—watch” for a tsc watcher</p>
</li>
<li>
<p>You can run <code>yarn publish</code> to publish to NPM, and it will automatically run
the clean and build via the preversion script, and then will automatically
push the updated version and tag to github once it is finished via the
postversion script</p>
</li>
</ul>
<h2 id="the-tsconfigjson">The tsconfig.json</h2>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="json"><code><span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#79B8FF">  "include"</span><span style="color:#E1E4E8">: [</span><span style="color:#9ECBFF">"src"</span><span style="color:#E1E4E8">],</span></span>
<span class="line"><span style="color:#79B8FF">  "compilerOptions"</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#79B8FF">    "outDir"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"dist"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">    "target"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"es2020"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">    "declaration"</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">    "strict"</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">    "allowImportingTsExtensions"</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">    "rewriteRelativeImportExtensions"</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">true</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<h2 id="using-minimalpackage">Using minimalpackage</h2>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> { foo } </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> 'minimalpackage'</span></span>
<span class="line"><span style="color:#B392F0">foo</span><span style="color:#E1E4E8">()</span></span></code></pre>
<h2 id="conclusion">Conclusion</h2>
<p>This article proposes a bundler-less approach to distributing typescript
packages on NPM. It was possible before, but I think the addition of the
<code>allowImportingTsExtensions</code> and <code>rewriteRelativeImportExtensions</code> made it more
sane.</p>
<h2 id="footnote-1---publishing-dual-esmcjs-using-this-technique">Footnote 1 - Publishing dual ESM/CJS using this technique</h2>
<p>I don’t even know if I fully stand behind doing a dual publish this way, but for
reference, here is a potential way to dual ESM/CJS publish with this method
<a href="https://gist.github.com/cmdcolin/c3089a4b37f2ff8c8eabce5ebd3b4082">https://gist.github.com/cmdcolin/c3089a4b37f2ff8c8eabce5ebd3b4082</a></p>
<p>The ‘quick start kit’ tshy is also a pretty good minimal approach to publishing.
You might consider trying it</p>
<h2 id="footnote-2---add-the-eslint-plugin-import-with-rule-requiring-file-extension-imports">Footnote 2 - Add the eslint-plugin-import with rule requiring file extension imports</h2>
<p>Add this to your eslint config</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>'import/extensions': ['error', 'ignorePackages'],</span></span></code></pre>
<p>It will enforce importing from specific files, except for package names e.g. you
need to import from ‘yourfile.ts’ for your code, but can import from packages
like normal like <code>import {useState} from 'react'</code></p> </div> <div id="giscus"></div> <script>
  const script = document.createElement('script');
  script.src = 'https://giscus.app/client.js';
  script.setAttribute('data-repo', 'cmdcolin/cmdcolin.github.io');
  script.setAttribute('data-repo-id', 'MDEwOlJlcG9zaXRvcnkyNjE0OTY3Nw==');
  script.setAttribute('data-category', 'General');
  script.setAttribute('data-category-id', 'DIC_kwDOAY8DLc4CO-L9');
  script.setAttribute('data-mapping', 'pathname');
  script.setAttribute('data-strict', '0');
  script.setAttribute('data-reactions-enabled', '1');
  script.setAttribute('data-emit-metadata', '0');
  script.setAttribute('data-input-position', 'bottom');
  script.setAttribute('data-theme', 'light');
  script.setAttribute('data-lang', 'en');
  script.setAttribute('crossorigin', 'anonymous');
  script.async = true;
  document.getElementById('giscus').appendChild(script);
</script> </article>  </div>   <footer class="footer-style" data-astro-cid-k2f5zb5c> <a class="footer-link" href="/" data-astro-cid-k2f5zb5c>Home</a> <a class="footer-link" href="/archive" data-astro-cid-k2f5zb5c>Blog archive</a> <a class="footer-link" href="https://github.com/cmdcolin/" data-astro-cid-k2f5zb5c>Github</a> <a class="footer-link" href="/projects" data-astro-cid-k2f5zb5c>Projects</a> <a class="footer-link" href="/about" data-astro-cid-k2f5zb5c>About</a> </footer> </body></html> 