<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>Killing postgres the hard way</title><meta name="next-head-count" content="3"/><link rel="shortcut icon" href="favicon.ico"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><meta name="description" content="Blogging for the future"/><link rel="preload" href="/_next/static/css/97dc5fe527f5d592.css" as="style"/><link rel="stylesheet" href="/_next/static/css/97dc5fe527f5d592.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-8c0202d61bc61a66.js" defer=""></script><script src="/_next/static/chunks/framework-654b6047e3d0e6e1.js" defer=""></script><script src="/_next/static/chunks/main-701f566d2893c77f.js" defer=""></script><script src="/_next/static/chunks/pages/_app-577aa7b9aa74ad1d.js" defer=""></script><script src="/_next/static/chunks/996-671cdcc64ad16425.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-9dff07cb71c26117.js" defer=""></script><script src="/_next/static/evxt-4YBP3Od8y1D7y3ZV/_buildManifest.js" defer=""></script><script src="/_next/static/evxt-4YBP3Od8y1D7y3ZV/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div><main><div><div style="margin-bottom:100px"><a href="/">Misc scribbles</a></div><article><div><h1>Killing postgres the hard way</h1><h4>2015-10-22</h4></div><div><p>So today, I finally decided to do something about a query that we saw
had been running for 25 DAYS on our server</p>
<p>Note: If you find this post and you need to follow the hard way, backup
your data first if possible.</p>
<p>First I could obviously see the culprit: each postgress query runs it's
own process so I could see in "htop" that there was this process that
had been running for 600 hours, or about 25 days</p>
<p>Next, I opened a psql console and ran this query:</p>
<pre class="shiki" style="background-color: #1b1e28"><code><span class="line"><span style="color: #5DE4C7">SELECT</span><span style="color: #A6ACCD"> datname,procpid,current_query </span><span style="color: #5DE4C7">FROM</span><span style="color: #A6ACCD"> pg_stat_activity </span><span style="color: #5DE4C7">WHERE</span><span style="color: #A6ACCD"> datname</span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD">'</span><span style="color: #5DE4C7">database_name</span><span style="color: #A6ACCD">'</span><span style="color: #A6ACCD"> </span><span style="color: #5DE4C7">ORDER BY</span><span style="color: #A6ACCD"> procpid ;</span></span></code></pre>
<p>This returns which actual queries are being run on the database at any
given time. I could easily see the one problematic query being run,
which was a badly constructed intermine template query that resulted in
a weird "recursion" essentially.</p>
<p>I wanted to try just terminating this query itself, so I ran this</p>
<pre><code>SELECT pg_cancel_backend(29033);
</code></pre>
<p>Each time I ran it, it would say it returned one result but it did
nothing.</p>
<p>I also read that you can try to nicely "kill" it from the command line
(no kill -9) so I ran</p>
<pre class="shiki" style="background-color: #1b1e28"><code><span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> kill 29033</span></span></code></pre>
<p>This also did not work!</p>
<p>I thought perhaps all these problems were because tomcat was still
active, so we shut down tomcat, and retried killing the specific query,
but to no avail</p>
<p>At this point, I just wanted to restart the whole database server. Kind
of a risky move... but I am sort of a risky kind of guy...(that is not a
good thing with databases). If you are doing this, make backups! I
didn't. Luckily I suffered no data loss but what follows is kind of
intense.</p>
<p>So first, I try and stop the database service</p>
<pre class="shiki" style="background-color: #1b1e28"><code><span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> service postgresql-9.1 stop</span></span></code></pre>
<p>Unfortunately, this <code>[FAILED]</code> ! And of course, even though it failed,
the database is now unusable. No logging into it anymore, we have to go
with the hard way now...</p>
<p>Looking at /etc/init.d/postgres-9.1 told me that the service stop
command was effectively using something like this:</p>
<pre class="shiki" style="background-color: #1b1e28"><code><span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> pg_ctl -D /db/postgres/data -m fast stop</span></span></code></pre>
<p>After some reading, I learned that you can try using a slightly
different flag to restart it</p>
<pre class="shiki" style="background-color: #1b1e28"><code><span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> pg_ctl -D /db/postgres/data -m immediate  stop</span></span></code></pre>
<p>I ran this and to my horror/surprise, it actually worked! At this point
I decided to start postgresql back up again!</p>
<pre class="shiki" style="background-color: #1b1e28"><code><span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> service postgresql-9.1 start</span></span></code></pre>
<p>The service start quickly returned a SUCCESS, which was great, but then
I tried to start a psql console and the console froze on me! I could not
even ctrl+c it!</p>
<p>I got really worried at this point and I looked at the process manager,
and saw that there was one postmaster process running but it was not
clear what it was doing. I actually tried to shutdown the server again
in a panic mode but at this point it said</p>
<pre class="shiki" style="background-color: #1b1e28"><code><span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> /usr/pgsql-9.1/bin/pg_ctl stop -D /db/postgres/data/ -m immediate</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> waiting for server to shut</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> down...............................................................</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> failed</span></span></code></pre>
<p>It was probably good that it didn't shut down, because I would quickly
find out that it was in recovery mode. I looked at the postgresql logs
and I saw this, reproduced here for full detail (from before the
shutdown to the restart)</p>
<pre class="shiki" style="background-color: #1b1e28"><code><span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> WARNING:  pgstat wait timeout</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> WARNING:  pgstat wait timeout</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> WARNING:  pgstat wait timeout</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> WARNING:  pgstat wait timeout</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> WARNING:  pgstat wait timeout</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> WARNING:  pgstat wait timeout</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> WARNING:  pgstat wait timeout</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> WARNING:  pgstat wait timeout</span></span>
<span class="line"><span style="color: #91B4D5">></span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> ERROR:  canceling statement due to user request</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> STATEMENT:  CREATE TABLE precomp_90519 AS SELECT DISTINCT a1_.id AS</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> a1_id, a2_.id AS a2_id, a3_.id AS a3_id, a4_.id AS a4_id,</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> a5_.id AS a5_id, a6_.id AS a6_id, a12_.id AS a12_id, a10_.id AS</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> a10_id, a1_.id AS a13_, a1_.primaryIdentifier AS a14_,</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> a1_.secondaryIdentifier AS a15_, a2_.type AS a16_, a3_.name AS</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> a17_, a4_.primaryIdentifier AS a18_, a5_.primaryIdentifier AS</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> a19_, a6_.shortName AS a20_, a12_.identifier AS a21_, a10_.code</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> AS a22_ FROM Gene AS a1_, Homologue AS a2_, Organism AS a3_, Gene</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> AS a4_, Gene AS a5_, Organism AS a6_, GOAnnotation AS a7_,</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> GOEvidence AS a8_, OntologyTerm AS a9_, GOEvidenceCode AS a10_,</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> OntologyAnnotation AS a11_, OntologyTerm AS a12_, GeneGoAnnotation</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> AS indirect0, EvidenceGOAnnotation AS indirect1 WHERE a1_.id =</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> a2_.geneId AND a1_.organismId = a3_.id AND a2_.geneId = a4_.id</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> AND a2_.homologueId = a5_.id AND a5_.organismId = a6_.id AND</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> a1_.id = indirect0.Gene AND indirect0.GoAnnotation = a7_.id AND</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> a7_.id = indirect1.GOAnnotation AND indirect1.Evidence = a8_.id AND</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> a7_.ontologyTermId = a9_.id AND a8_.codeId = a10_.id AND a9_.id =</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> a11_.ontologyTermId AND a11_.ontologyTermId = a12_.id ORDER BY</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> a1_.primaryIdentifier, a1_.secondaryIdentifier, a2_.type,</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> a3_.name, a4_.primaryIdentifier, a5_.primaryIdentifier,</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> a6_.shortName, a12_.identifier, a10_.code, a1_.id, a2_.id,</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> a3_.id, a4_.id, a5_.id, a6_.id, a12_.id, a10_.id</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> LOG:  could not send data to client: Broken pipe</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> STATEMENT:  CREATE TABLE precomp_90519 AS SELECT DISTINCT a1_.id AS</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> a1_id, a2_.id AS a2_id, a3_.id AS a3_id, a4_.id AS a4_id,</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> a5_.id AS a5_id, a6_.id AS a6_id, a12_.id AS a12_id, a10_.id AS</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> a10_id, a1_.id AS a13_, a1_.primaryIdentifier AS a14_,</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> a1_.secondaryIdentifier AS a15_, a2_.type AS a16_, a3_.name AS</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> a17_, a4_.primaryIdentifier AS a18_, a5_.primaryIdentifier AS</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> a19_, a6_.shortName AS a20_, a12_.identifier AS a21_, a10_.code</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> AS a22_ FROM Gene AS a1_, Homologue AS a2_, Organism AS a3_, Gene</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> AS a4_, Gene AS a5_, Organism AS a6_, GOAnnotation AS a7_,</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> GOEvidence AS a8_, OntologyTerm AS a9_, GOEvidenceCode AS a10_,</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> OntologyAnnotation AS a11_, OntologyTerm AS a12_, GeneGoAnnotation</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> AS indirect0, EvidenceGOAnnotation AS indirect1 WHERE a1_.id =</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> a2_.geneId AND a1_.organismId = a3_.id AND a2_.geneId = a4_.id</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> AND a2_.homologueId = a5_.id AND a5_.organismId = a6_.id AND</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> a1_.id = indirect0.Gene AND indirect0.GoAnnotation = a7_.id AND</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> a7_.id = indirect1.GOAnnotation AND indirect1.Evidence = a8_.id AND</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> a7_.ontologyTermId = a9_.id AND a8_.codeId = a10_.id AND a9_.id =</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> a11_.ontologyTermId AND a11_.ontologyTermId = a12_.id ORDER BY</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> a1_.primaryIdentifier, a1_.secondaryIdentifier, a2_.type,</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> a3_.name, a4_.primaryIdentifier, a5_.primaryIdentifier,</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> a6_.shortName, a12_.identifier, a10_.code, a1_.id, a2_.id,</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> a3_.id, a4_.id, a5_.id, a6_.id, a12_.id, a10_.id</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> LOG:  unexpected EOF on client connection</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> LOG:  unexpected EOF on client connection</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> LOG:  unexpected EOF on client connection</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> LOG:  unexpected EOF on client connection</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> LOG:  received fast shutdown request</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> LOG:  aborting any active transactions</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> LOG:  autovacuum launcher shutting down</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> FATAL:  the database system is shutting down</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> FATAL:  the database system is shutting down</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> FATAL:  the database system is shutting down</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> FATAL:  the database system is shutting down</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> FATAL:  the database system is shutting down</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> FATAL:  the database system is shutting down</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> FATAL:  the database system is shutting down</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> FATAL:  the database system is shutting down</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> FATAL:  the database system is shutting down</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> FATAL:  the database system is shutting down</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> FATAL:  the database system is shutting down</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> FATAL:  the database system is shutting down</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> FATAL:  the database system is shutting down</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> FATAL:  the database system is shutting down</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> FATAL:  the database system is shutting down</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> FATAL:  the database system is shutting down</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> FATAL:  the database system is shutting down</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> FATAL:  the database system is shutting down</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> FATAL:  the database system is shutting down</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> FATAL:  the database system is shutting down</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> FATAL:  the database system is shutting down</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> FATAL:  the database system is shutting down</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> FATAL:  the database system is shutting down</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> FATAL:  the database system is shutting down</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> FATAL:  the database system is shutting down</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> FATAL:  the database system is shutting down</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> LOG:  received immediate shutdown request</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> WARNING:  terminating connection because of crash of another server</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> process</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> DETAIL:  The postmaster has commanded this server process to roll back</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> the current transaction and exit, because another server process</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> exited abnormally and possibly corrupted shared memory.</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> HINT:  In a moment you should be able to reconnect to the database and</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> repeat your command.</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> LOG:  received fast shutdown request</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> LOG:  database system was interrupted</span><span style="color: #91B4D5">;</span><span style="color: #A6ACCD"> last known up at 2015-10-22</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> 15:47:43 CDT</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> LOG:  received immediate shutdown request</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> LOG:  database system was interrupted</span><span style="color: #91B4D5">;</span><span style="color: #A6ACCD"> last known up at 2015-10-22</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> 15:47:43 CDT</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> LOG:  database system was not properly shut down</span><span style="color: #91B4D5">;</span><span style="color: #A6ACCD"> automatic recovery</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> in progress</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> LOG:  record with zero length at BBD/1CC2F0C0</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> ...</span></span></code></pre>
<p>You can see all the weird activity that was done here</p>
<ul>
<li>first the attempt to "canceling statement due to user request" did not work</li>
<li>then the database stop using -m fast</li>
<li>then the database stop using -m immediate</li>
<li>the restart (with the HINT, should be ready soon)</li>
<li>the panic mode where i tried to shut it again anyways</li>
</ul>
<p>During the recovery period, I was still very concerned about the
database was doing, so I used "strace" to look at the main postmaster
process.</p>
<p>I was pleasantly surprised to see that the postmaster process was just
cleaning up files in /db/postgres/data/base/pgsql_tmp/, I could see the
file system "unlink" command with successful status codes.</p>
<p>There were about 150 large files in /db/postgres/data/base/pgsql_tmp/,
and I waited about an hour for them to be deleted, and after that, the
postgresql log file said it was ready, and indeed, it was perfect :)</p>
<pre class="shiki" style="background-color: #1b1e28"><code><span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> LOG:  redo is not required</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> LOG:  database system is ready to accept connections</span></span>
<span class="line"><span style="color: #91B4D5">></span><span style="color: #A6ACCD"> LOG:  autovacuum launcher started</span></span></code></pre>
<p>What a relief!</p>
<p>I hope this might help any wayward stragglers to see how the postgresql
restart process works. Sometimes things don't shut down cleanly, but I
think it is still good to know some alternative steps to kill -9</p></div><div style="margin-top:200px"></div></article></div></main></div><footer style="margin-top:100px"><a href="/">Home</a> <a href="/archive">Blog archive</a> <a href="https://github.com/cmdcolin/">Github</a> <a href="https://twitter.com/cmdcolin">Twitter</a> <a href="/projects">Projects</a><a href="/photos">Photos</a> <a href="/rss.xml">RSS</a><a href="/about">About</a></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"Killing postgres the hard way","date":"2015-10-22","slug":"2015-10-22","html":"\u003cp\u003eSo today, I finally decided to do something about a query that we saw\nhad been running for 25 DAYS on our server\u003c/p\u003e\n\u003cp\u003eNote: If you find this post and you need to follow the hard way, backup\nyour data first if possible.\u003c/p\u003e\n\u003cp\u003eFirst I could obviously see the culprit: each postgress query runs it's\nown process so I could see in \"htop\" that there was this process that\nhad been running for 600 hours, or about 25 days\u003c/p\u003e\n\u003cp\u003eNext, I opened a psql console and ran this query:\u003c/p\u003e\n\u003cpre class=\"shiki\" style=\"background-color: #1b1e28\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #5DE4C7\"\u003eSELECT\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e datname,procpid,current_query \u003c/span\u003e\u003cspan style=\"color: #5DE4C7\"\u003eFROM\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e pg_stat_activity \u003c/span\u003e\u003cspan style=\"color: #5DE4C7\"\u003eWHERE\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e datname\u003c/span\u003e\u003cspan style=\"color: #91B4D5\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e'\u003c/span\u003e\u003cspan style=\"color: #5DE4C7\"\u003edatabase_name\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e'\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #5DE4C7\"\u003eORDER BY\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e procpid ;\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis returns which actual queries are being run on the database at any\ngiven time. I could easily see the one problematic query being run,\nwhich was a badly constructed intermine template query that resulted in\na weird \"recursion\" essentially.\u003c/p\u003e\n\u003cp\u003eI wanted to try just terminating this query itself, so I ran this\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eSELECT pg_cancel_backend(29033);\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eEach time I ran it, it would say it returned one result but it did\nnothing.\u003c/p\u003e\n\u003cp\u003eI also read that you can try to nicely \"kill\" it from the command line\n(no kill -9) so I ran\u003c/p\u003e\n\u003cpre class=\"shiki\" style=\"background-color: #1b1e28\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e kill 29033\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis also did not work!\u003c/p\u003e\n\u003cp\u003eI thought perhaps all these problems were because tomcat was still\nactive, so we shut down tomcat, and retried killing the specific query,\nbut to no avail\u003c/p\u003e\n\u003cp\u003eAt this point, I just wanted to restart the whole database server. Kind\nof a risky move... but I am sort of a risky kind of guy...(that is not a\ngood thing with databases). If you are doing this, make backups! I\ndidn't. Luckily I suffered no data loss but what follows is kind of\nintense.\u003c/p\u003e\n\u003cp\u003eSo first, I try and stop the database service\u003c/p\u003e\n\u003cpre class=\"shiki\" style=\"background-color: #1b1e28\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e service postgresql-9.1 stop\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eUnfortunately, this \u003ccode\u003e[FAILED]\u003c/code\u003e ! And of course, even though it failed,\nthe database is now unusable. No logging into it anymore, we have to go\nwith the hard way now...\u003c/p\u003e\n\u003cp\u003eLooking at /etc/init.d/postgres-9.1 told me that the service stop\ncommand was effectively using something like this:\u003c/p\u003e\n\u003cpre class=\"shiki\" style=\"background-color: #1b1e28\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e pg_ctl -D /db/postgres/data -m fast stop\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAfter some reading, I learned that you can try using a slightly\ndifferent flag to restart it\u003c/p\u003e\n\u003cpre class=\"shiki\" style=\"background-color: #1b1e28\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e pg_ctl -D /db/postgres/data -m immediate  stop\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eI ran this and to my horror/surprise, it actually worked! At this point\nI decided to start postgresql back up again!\u003c/p\u003e\n\u003cpre class=\"shiki\" style=\"background-color: #1b1e28\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e service postgresql-9.1 start\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe service start quickly returned a SUCCESS, which was great, but then\nI tried to start a psql console and the console froze on me! I could not\neven ctrl+c it!\u003c/p\u003e\n\u003cp\u003eI got really worried at this point and I looked at the process manager,\nand saw that there was one postmaster process running but it was not\nclear what it was doing. I actually tried to shutdown the server again\nin a panic mode but at this point it said\u003c/p\u003e\n\u003cpre class=\"shiki\" style=\"background-color: #1b1e28\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e /usr/pgsql-9.1/bin/pg_ctl stop -D /db/postgres/data/ -m immediate\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e waiting for server to shut\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e down...............................................................\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e failed\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eIt was probably good that it didn't shut down, because I would quickly\nfind out that it was in recovery mode. I looked at the postgresql logs\nand I saw this, reproduced here for full detail (from before the\nshutdown to the restart)\u003c/p\u003e\n\u003cpre class=\"shiki\" style=\"background-color: #1b1e28\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e WARNING:  pgstat wait timeout\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e WARNING:  pgstat wait timeout\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e WARNING:  pgstat wait timeout\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e WARNING:  pgstat wait timeout\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e WARNING:  pgstat wait timeout\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e WARNING:  pgstat wait timeout\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e WARNING:  pgstat wait timeout\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e WARNING:  pgstat wait timeout\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e ERROR:  canceling statement due to user request\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e STATEMENT:  CREATE TABLE precomp_90519 AS SELECT DISTINCT a1_.id AS\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e a1_id, a2_.id AS a2_id, a3_.id AS a3_id, a4_.id AS a4_id,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e a5_.id AS a5_id, a6_.id AS a6_id, a12_.id AS a12_id, a10_.id AS\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e a10_id, a1_.id AS a13_, a1_.primaryIdentifier AS a14_,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e a1_.secondaryIdentifier AS a15_, a2_.type AS a16_, a3_.name AS\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e a17_, a4_.primaryIdentifier AS a18_, a5_.primaryIdentifier AS\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e a19_, a6_.shortName AS a20_, a12_.identifier AS a21_, a10_.code\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e AS a22_ FROM Gene AS a1_, Homologue AS a2_, Organism AS a3_, Gene\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e AS a4_, Gene AS a5_, Organism AS a6_, GOAnnotation AS a7_,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e GOEvidence AS a8_, OntologyTerm AS a9_, GOEvidenceCode AS a10_,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e OntologyAnnotation AS a11_, OntologyTerm AS a12_, GeneGoAnnotation\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e AS indirect0, EvidenceGOAnnotation AS indirect1 WHERE a1_.id =\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e a2_.geneId AND a1_.organismId = a3_.id AND a2_.geneId = a4_.id\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e AND a2_.homologueId = a5_.id AND a5_.organismId = a6_.id AND\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e a1_.id = indirect0.Gene AND indirect0.GoAnnotation = a7_.id AND\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e a7_.id = indirect1.GOAnnotation AND indirect1.Evidence = a8_.id AND\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e a7_.ontologyTermId = a9_.id AND a8_.codeId = a10_.id AND a9_.id =\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e a11_.ontologyTermId AND a11_.ontologyTermId = a12_.id ORDER BY\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e a1_.primaryIdentifier, a1_.secondaryIdentifier, a2_.type,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e a3_.name, a4_.primaryIdentifier, a5_.primaryIdentifier,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e a6_.shortName, a12_.identifier, a10_.code, a1_.id, a2_.id,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e a3_.id, a4_.id, a5_.id, a6_.id, a12_.id, a10_.id\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e LOG:  could not send data to client: Broken pipe\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e STATEMENT:  CREATE TABLE precomp_90519 AS SELECT DISTINCT a1_.id AS\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e a1_id, a2_.id AS a2_id, a3_.id AS a3_id, a4_.id AS a4_id,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e a5_.id AS a5_id, a6_.id AS a6_id, a12_.id AS a12_id, a10_.id AS\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e a10_id, a1_.id AS a13_, a1_.primaryIdentifier AS a14_,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e a1_.secondaryIdentifier AS a15_, a2_.type AS a16_, a3_.name AS\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e a17_, a4_.primaryIdentifier AS a18_, a5_.primaryIdentifier AS\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e a19_, a6_.shortName AS a20_, a12_.identifier AS a21_, a10_.code\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e AS a22_ FROM Gene AS a1_, Homologue AS a2_, Organism AS a3_, Gene\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e AS a4_, Gene AS a5_, Organism AS a6_, GOAnnotation AS a7_,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e GOEvidence AS a8_, OntologyTerm AS a9_, GOEvidenceCode AS a10_,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e OntologyAnnotation AS a11_, OntologyTerm AS a12_, GeneGoAnnotation\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e AS indirect0, EvidenceGOAnnotation AS indirect1 WHERE a1_.id =\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e a2_.geneId AND a1_.organismId = a3_.id AND a2_.geneId = a4_.id\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e AND a2_.homologueId = a5_.id AND a5_.organismId = a6_.id AND\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e a1_.id = indirect0.Gene AND indirect0.GoAnnotation = a7_.id AND\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e a7_.id = indirect1.GOAnnotation AND indirect1.Evidence = a8_.id AND\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e a7_.ontologyTermId = a9_.id AND a8_.codeId = a10_.id AND a9_.id =\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e a11_.ontologyTermId AND a11_.ontologyTermId = a12_.id ORDER BY\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e a1_.primaryIdentifier, a1_.secondaryIdentifier, a2_.type,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e a3_.name, a4_.primaryIdentifier, a5_.primaryIdentifier,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e a6_.shortName, a12_.identifier, a10_.code, a1_.id, a2_.id,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e a3_.id, a4_.id, a5_.id, a6_.id, a12_.id, a10_.id\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e LOG:  unexpected EOF on client connection\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e LOG:  unexpected EOF on client connection\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e LOG:  unexpected EOF on client connection\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e LOG:  unexpected EOF on client connection\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e LOG:  received fast shutdown request\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e LOG:  aborting any active transactions\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e LOG:  autovacuum launcher shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e LOG:  received immediate shutdown request\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e WARNING:  terminating connection because of crash of another server\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e process\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e DETAIL:  The postmaster has commanded this server process to roll back\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e the current transaction and exit, because another server process\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e exited abnormally and possibly corrupted shared memory.\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e HINT:  In a moment you should be able to reconnect to the database and\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e repeat your command.\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e LOG:  received fast shutdown request\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e LOG:  database system was interrupted\u003c/span\u003e\u003cspan style=\"color: #91B4D5\"\u003e;\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e last known up at 2015-10-22\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e 15:47:43 CDT\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e LOG:  received immediate shutdown request\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e LOG:  database system was interrupted\u003c/span\u003e\u003cspan style=\"color: #91B4D5\"\u003e;\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e last known up at 2015-10-22\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e 15:47:43 CDT\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e LOG:  database system was not properly shut down\u003c/span\u003e\u003cspan style=\"color: #91B4D5\"\u003e;\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e automatic recovery\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e in progress\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e LOG:  record with zero length at BBD/1CC2F0C0\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e ...\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eYou can see all the weird activity that was done here\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003efirst the attempt to \"canceling statement due to user request\" did not work\u003c/li\u003e\n\u003cli\u003ethen the database stop using -m fast\u003c/li\u003e\n\u003cli\u003ethen the database stop using -m immediate\u003c/li\u003e\n\u003cli\u003ethe restart (with the HINT, should be ready soon)\u003c/li\u003e\n\u003cli\u003ethe panic mode where i tried to shut it again anyways\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eDuring the recovery period, I was still very concerned about the\ndatabase was doing, so I used \"strace\" to look at the main postmaster\nprocess.\u003c/p\u003e\n\u003cp\u003eI was pleasantly surprised to see that the postmaster process was just\ncleaning up files in /db/postgres/data/base/pgsql_tmp/, I could see the\nfile system \"unlink\" command with successful status codes.\u003c/p\u003e\n\u003cp\u003eThere were about 150 large files in /db/postgres/data/base/pgsql_tmp/,\nand I waited about an hour for them to be deleted, and after that, the\npostgresql log file said it was ready, and indeed, it was perfect :)\u003c/p\u003e\n\u003cpre class=\"shiki\" style=\"background-color: #1b1e28\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e LOG:  redo is not required\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e LOG:  database system is ready to accept connections\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e LOG:  autovacuum launcher started\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWhat a relief!\u003c/p\u003e\n\u003cp\u003eI hope this might help any wayward stragglers to see how the postgresql\nrestart process works. Sometimes things don't shut down cleanly, but I\nthink it is still good to know some alternative steps to kill -9\u003c/p\u003e"}},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"2015-10-22"},"buildId":"evxt-4YBP3Od8y1D7y3ZV","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>