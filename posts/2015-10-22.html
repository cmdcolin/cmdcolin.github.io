<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="/_next/static/css/d19cfa26cd1ef694.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-dea5254e1907c5df.js"/><script src="/_next/static/chunks/4bd1b696-7cc559629682b47d.js" async=""></script><script src="/_next/static/chunks/215-0c2c111511fa65fd.js" async=""></script><script src="/_next/static/chunks/main-app-d92e72a2e865503d.js" async=""></script><script src="/_next/static/chunks/231-fc74e6e791c0837d.js" async=""></script><script src="/_next/static/chunks/app/page-95d4a906a5a795f0.js" async=""></script><script src="/_next/static/chunks/app/posts/%5Bid%5D/page-e50cd2f34f19f050.js" async=""></script><title>Killing postgres the hard way</title><meta name="description" content="A blog"/><script src="/_next/static/chunks/polyfills-42372ed130431b0a.js" noModule=""></script></head><body><div class="mb-8"><a href="/">Misc scribbles</a></div><div class="lg:w-1/2"><div><h1>Killing postgres the hard way</h1><h4>2015-10-22</h4></div><div><p>So today, I finally decided to do something about a query that we saw had been
running for 25 DAYS on our server</p>
<p>Note: If you find this post and you need to follow the hard way, backup your
data first if possible.</p>
<p>First I could obviously see the culprit: each postgresql query runs it's own
process so I could see in "htop" that there was this process that had been
running for 600 hours, or about 25 days</p>
<p>Next, I opened a psql console and ran this query:</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#282c34;color:#abb2bf" tabindex="0" data-language="sql" data-theme="one-dark-pro"><code data-language="sql" data-theme="one-dark-pro" style="display: grid;"><span data-line=""><span style="color:#C678DD">SELECT</span><span style="color:#ABB2BF"> datname,procpid,current_query </span><span style="color:#C678DD">FROM</span><span style="color:#ABB2BF"> pg_stat_activity </span><span style="color:#C678DD">WHERE</span><span style="color:#ABB2BF"> datname</span><span style="color:#56B6C2">=</span><span style="color:#98C379">'database_name'</span><span style="color:#C678DD"> ORDER BY</span><span style="color:#ABB2BF"> procpid ;</span></span></code></pre></figure>
<p>This returns which actual queries are being run on the database at any given
time. I could easily see the one problematic query being run, which was a badly
constructed intermine template query that resulted in a weird "recursion"
essentially.</p>
<p>I wanted to try just terminating this query itself, so I ran this</p>
<pre><code>SELECT pg_cancel_backend(29033);
</code></pre>
<p>Each time I ran it, it would say it returned one result but it did nothing.</p>
<p>I also read that you can try to nicely "kill" it from the command line (no kill
-9) so I ran</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#282c34;color:#abb2bf" tabindex="0" data-language="sh" data-theme="one-dark-pro"><code data-language="sh" data-theme="one-dark-pro" style="display: grid;"><span data-line=""><span style="color:#ABB2BF">> kill 29033</span></span></code></pre></figure>
<p>This also did not work!</p>
<p>I thought perhaps all these problems were because tomcat was still active, so we
shut down tomcat, and retried killing the specific query, but to no avail</p>
<p>At this point, I just wanted to restart the whole database server. Kind of a
risky move... but I am sort of a risky kind of guy...(that is not a good thing
with databases). If you are doing this, make backups! I didn't. Luckily I
suffered no data loss but what follows is kind of intense.</p>
<p>So first, I try and stop the database service</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#282c34;color:#abb2bf" tabindex="0" data-language="sh" data-theme="one-dark-pro"><code data-language="sh" data-theme="one-dark-pro" style="display: grid;"><span data-line=""><span style="color:#ABB2BF">> service postgresql-9.1 stop</span></span></code></pre></figure>
<p>Unfortunately, this <code>[FAILED]</code> ! And of course, even though it failed, the
database is now unusable. No logging into it anymore, we have to go with the
hard way now...</p>
<p>Looking at /etc/init.d/postgres-9.1 told me that the service stop command was
effectively using something like this:</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#282c34;color:#abb2bf" tabindex="0" data-language="sh" data-theme="one-dark-pro"><code data-language="sh" data-theme="one-dark-pro" style="display: grid;"><span data-line=""><span style="color:#ABB2BF">> pg_ctl -D /db/postgres/data -m fast stop</span></span></code></pre></figure>
<p>After some reading, I learned that you can try using a slightly different flag
to restart it</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#282c34;color:#abb2bf" tabindex="0" data-language="sh" data-theme="one-dark-pro"><code data-language="sh" data-theme="one-dark-pro" style="display: grid;"><span data-line=""><span style="color:#ABB2BF">> pg_ctl -D /db/postgres/data -m immediate  stop</span></span></code></pre></figure>
<p>I ran this and to my horror/surprise, it actually worked! At this point I
decided to start postgresql back up again!</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#282c34;color:#abb2bf" tabindex="0" data-language="sh" data-theme="one-dark-pro"><code data-language="sh" data-theme="one-dark-pro" style="display: grid;"><span data-line=""><span style="color:#ABB2BF">> service postgresql-9.1 start</span></span></code></pre></figure>
<p>The service start quickly returned a SUCCESS, which was great, but then I tried
to start a psql console and the console froze on me! I could not even ctrl+c it!</p>
<p>I got really worried at this point and I looked at the process manager, and saw
that there was one postmaster process running but it was not clear what it was
doing. I actually tried to shutdown the server again in a panic mode but at this
point it said</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#282c34;color:#abb2bf" tabindex="0" data-language="sh" data-theme="one-dark-pro"><code data-language="sh" data-theme="one-dark-pro" style="display: grid;"><span data-line=""><span style="color:#ABB2BF">> /usr/pgsql-9.1/bin/pg_ctl stop -D /db/postgres/data/ -m immediate</span></span>
<span data-line=""><span style="color:#ABB2BF">> waiting </span><span style="color:#C678DD">for</span><span style="color:#ABB2BF"> server to shut</span></span>
<span data-line=""><span style="color:#ABB2BF">> down...............................................................</span></span>
<span data-line=""><span style="color:#ABB2BF">> failed</span></span></code></pre></figure>
<p>It was probably good that it didn't shut down, because I would quickly find out
that it was in recovery mode. I looked at the postgresql logs and I saw this,
reproduced here for full detail (from before the shutdown to the restart)</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#282c34;color:#abb2bf" tabindex="0" data-language="sh" data-theme="one-dark-pro"><code data-language="sh" data-theme="one-dark-pro" style="display: grid;"><span data-line=""><span style="color:#ABB2BF">> WARNING:  pgstat wait timeout</span></span>
<span data-line=""><span style="color:#ABB2BF">> WARNING:  pgstat wait timeout</span></span>
<span data-line=""><span style="color:#ABB2BF">> WARNING:  pgstat wait timeout</span></span>
<span data-line=""><span style="color:#ABB2BF">> WARNING:  pgstat wait timeout</span></span>
<span data-line=""><span style="color:#ABB2BF">> WARNING:  pgstat wait timeout</span></span>
<span data-line=""><span style="color:#ABB2BF">> WARNING:  pgstat wait timeout</span></span>
<span data-line=""><span style="color:#ABB2BF">> WARNING:  pgstat wait timeout</span></span>
<span data-line=""><span style="color:#ABB2BF">> WARNING:  pgstat wait timeout</span></span>
<span data-line=""><span style="color:#ABB2BF">></span></span>
<span data-line=""><span style="color:#ABB2BF">> ERROR:  canceling statement due to user request</span></span>
<span data-line=""><span style="color:#ABB2BF">> STATEMENT:  CREATE TABLE precomp_90519 AS SELECT DISTINCT a1_.id AS</span></span>
<span data-line=""><span style="color:#ABB2BF">> a1_id, a2_.id AS a2_id, a3_.id AS a3_id, a4_.id AS a4_id,</span></span>
<span data-line=""><span style="color:#ABB2BF">> a5_.id AS a5_id, a6_.id AS a6_id, a12_.id AS a12_id, a10_.id AS</span></span>
<span data-line=""><span style="color:#ABB2BF">> a10_id, a1_.id AS a13_, a1_.primaryIdentifier AS a14_,</span></span>
<span data-line=""><span style="color:#ABB2BF">> a1_.secondaryIdentifier AS a15_, a2_.type AS a16_, a3_.name AS</span></span>
<span data-line=""><span style="color:#ABB2BF">> a17_, a4_.primaryIdentifier AS a18_, a5_.primaryIdentifier AS</span></span>
<span data-line=""><span style="color:#ABB2BF">> a19_, a6_.shortName AS a20_, a12_.identifier AS a21_, a10_.code</span></span>
<span data-line=""><span style="color:#ABB2BF">> AS a22_ FROM Gene AS a1_, Homologue AS a2_, Organism AS a3_, Gene</span></span>
<span data-line=""><span style="color:#ABB2BF">> AS a4_, Gene AS a5_, Organism AS a6_, GOAnnotation AS a7_,</span></span>
<span data-line=""><span style="color:#ABB2BF">> GOEvidence AS a8_, OntologyTerm AS a9_, GOEvidenceCode AS a10_,</span></span>
<span data-line=""><span style="color:#ABB2BF">> OntologyAnnotation AS a11_, OntologyTerm AS a12_, GeneGoAnnotation</span></span>
<span data-line=""><span style="color:#ABB2BF">> AS indirect0, EvidenceGOAnnotation AS indirect1 WHERE a1_.id =</span></span>
<span data-line=""><span style="color:#ABB2BF">> a2_.geneId AND a1_.organismId = a3_.id AND a2_.geneId = a4_.id</span></span>
<span data-line=""><span style="color:#ABB2BF">> AND a2_.homologueId = a5_.id AND a5_.organismId = a6_.id AND</span></span>
<span data-line=""><span style="color:#ABB2BF">> a1_.id = indirect0.Gene AND indirect0.GoAnnotation = a7_.id AND</span></span>
<span data-line=""><span style="color:#ABB2BF">> a7_.id = indirect1.GOAnnotation AND indirect1.Evidence = a8_.id AND</span></span>
<span data-line=""><span style="color:#ABB2BF">> a7_.ontologyTermId = a9_.id AND a8_.codeId = a10_.id AND a9_.id =</span></span>
<span data-line=""><span style="color:#ABB2BF">> a11_.ontologyTermId AND a11_.ontologyTermId = a12_.id ORDER BY</span></span>
<span data-line=""><span style="color:#ABB2BF">> a1_.primaryIdentifier, a1_.secondaryIdentifier, a2_.type,</span></span>
<span data-line=""><span style="color:#ABB2BF">> a3_.name, a4_.primaryIdentifier, a5_.primaryIdentifier,</span></span>
<span data-line=""><span style="color:#ABB2BF">> a6_.shortName, a12_.identifier, a10_.code, a1_.id, a2_.id,</span></span>
<span data-line=""><span style="color:#ABB2BF">> a3_.id, a4_.id, a5_.id, a6_.id, a12_.id, a10_.id</span></span>
<span data-line=""><span style="color:#ABB2BF">> LOG:  could not send data to client: Broken pipe</span></span>
<span data-line=""><span style="color:#ABB2BF">> STATEMENT:  CREATE TABLE precomp_90519 AS SELECT DISTINCT a1_.id AS</span></span>
<span data-line=""><span style="color:#ABB2BF">> a1_id, a2_.id AS a2_id, a3_.id AS a3_id, a4_.id AS a4_id,</span></span>
<span data-line=""><span style="color:#ABB2BF">> a5_.id AS a5_id, a6_.id AS a6_id, a12_.id AS a12_id, a10_.id AS</span></span>
<span data-line=""><span style="color:#ABB2BF">> a10_id, a1_.id AS a13_, a1_.primaryIdentifier AS a14_,</span></span>
<span data-line=""><span style="color:#ABB2BF">> a1_.secondaryIdentifier AS a15_, a2_.type AS a16_, a3_.name AS</span></span>
<span data-line=""><span style="color:#ABB2BF">> a17_, a4_.primaryIdentifier AS a18_, a5_.primaryIdentifier AS</span></span>
<span data-line=""><span style="color:#ABB2BF">> a19_, a6_.shortName AS a20_, a12_.identifier AS a21_, a10_.code</span></span>
<span data-line=""><span style="color:#ABB2BF">> AS a22_ FROM Gene AS a1_, Homologue AS a2_, Organism AS a3_, Gene</span></span>
<span data-line=""><span style="color:#ABB2BF">> AS a4_, Gene AS a5_, Organism AS a6_, GOAnnotation AS a7_,</span></span>
<span data-line=""><span style="color:#ABB2BF">> GOEvidence AS a8_, OntologyTerm AS a9_, GOEvidenceCode AS a10_,</span></span>
<span data-line=""><span style="color:#ABB2BF">> OntologyAnnotation AS a11_, OntologyTerm AS a12_, GeneGoAnnotation</span></span>
<span data-line=""><span style="color:#ABB2BF">> AS indirect0, EvidenceGOAnnotation AS indirect1 WHERE a1_.id =</span></span>
<span data-line=""><span style="color:#ABB2BF">> a2_.geneId AND a1_.organismId = a3_.id AND a2_.geneId = a4_.id</span></span>
<span data-line=""><span style="color:#ABB2BF">> AND a2_.homologueId = a5_.id AND a5_.organismId = a6_.id AND</span></span>
<span data-line=""><span style="color:#ABB2BF">> a1_.id = indirect0.Gene AND indirect0.GoAnnotation = a7_.id AND</span></span>
<span data-line=""><span style="color:#ABB2BF">> a7_.id = indirect1.GOAnnotation AND indirect1.Evidence = a8_.id AND</span></span>
<span data-line=""><span style="color:#ABB2BF">> a7_.ontologyTermId = a9_.id AND a8_.codeId = a10_.id AND a9_.id =</span></span>
<span data-line=""><span style="color:#ABB2BF">> a11_.ontologyTermId AND a11_.ontologyTermId = a12_.id ORDER BY</span></span>
<span data-line=""><span style="color:#ABB2BF">> a1_.primaryIdentifier, a1_.secondaryIdentifier, a2_.type,</span></span>
<span data-line=""><span style="color:#ABB2BF">> a3_.name, a4_.primaryIdentifier, a5_.primaryIdentifier,</span></span>
<span data-line=""><span style="color:#ABB2BF">> a6_.shortName, a12_.identifier, a10_.code, a1_.id, a2_.id,</span></span>
<span data-line=""><span style="color:#ABB2BF">> a3_.id, a4_.id, a5_.id, a6_.id, a12_.id, a10_.id</span></span>
<span data-line=""><span style="color:#ABB2BF">> LOG:  unexpected EOF on client connection</span></span>
<span data-line=""><span style="color:#ABB2BF">> LOG:  unexpected EOF on client connection</span></span>
<span data-line=""><span style="color:#ABB2BF">> LOG:  unexpected EOF on client connection</span></span>
<span data-line=""><span style="color:#ABB2BF">> LOG:  unexpected EOF on client connection</span></span>
<span data-line=""><span style="color:#ABB2BF">> LOG:  received fast shutdown request</span></span>
<span data-line=""><span style="color:#ABB2BF">> LOG:  aborting any active transactions</span></span>
<span data-line=""><span style="color:#ABB2BF">> LOG:  autovacuum launcher shutting down</span></span>
<span data-line=""><span style="color:#ABB2BF">> FATAL:  the database system is shutting down</span></span>
<span data-line=""><span style="color:#ABB2BF">> FATAL:  the database system is shutting down</span></span>
<span data-line=""><span style="color:#ABB2BF">> FATAL:  the database system is shutting down</span></span>
<span data-line=""><span style="color:#ABB2BF">> FATAL:  the database system is shutting down</span></span>
<span data-line=""><span style="color:#ABB2BF">> FATAL:  the database system is shutting down</span></span>
<span data-line=""><span style="color:#ABB2BF">> FATAL:  the database system is shutting down</span></span>
<span data-line=""><span style="color:#ABB2BF">> FATAL:  the database system is shutting down</span></span>
<span data-line=""><span style="color:#ABB2BF">> FATAL:  the database system is shutting down</span></span>
<span data-line=""><span style="color:#ABB2BF">> FATAL:  the database system is shutting down</span></span>
<span data-line=""><span style="color:#ABB2BF">> FATAL:  the database system is shutting down</span></span>
<span data-line=""><span style="color:#ABB2BF">> FATAL:  the database system is shutting down</span></span>
<span data-line=""><span style="color:#ABB2BF">> FATAL:  the database system is shutting down</span></span>
<span data-line=""><span style="color:#ABB2BF">> FATAL:  the database system is shutting down</span></span>
<span data-line=""><span style="color:#ABB2BF">> FATAL:  the database system is shutting down</span></span>
<span data-line=""><span style="color:#ABB2BF">> FATAL:  the database system is shutting down</span></span>
<span data-line=""><span style="color:#ABB2BF">> FATAL:  the database system is shutting down</span></span>
<span data-line=""><span style="color:#ABB2BF">> FATAL:  the database system is shutting down</span></span>
<span data-line=""><span style="color:#ABB2BF">> FATAL:  the database system is shutting down</span></span>
<span data-line=""><span style="color:#ABB2BF">> FATAL:  the database system is shutting down</span></span>
<span data-line=""><span style="color:#ABB2BF">> FATAL:  the database system is shutting down</span></span>
<span data-line=""><span style="color:#ABB2BF">> FATAL:  the database system is shutting down</span></span>
<span data-line=""><span style="color:#ABB2BF">> FATAL:  the database system is shutting down</span></span>
<span data-line=""><span style="color:#ABB2BF">> FATAL:  the database system is shutting down</span></span>
<span data-line=""><span style="color:#ABB2BF">> FATAL:  the database system is shutting down</span></span>
<span data-line=""><span style="color:#ABB2BF">> FATAL:  the database system is shutting down</span></span>
<span data-line=""><span style="color:#ABB2BF">> FATAL:  the database system is shutting down</span></span>
<span data-line=""><span style="color:#ABB2BF">> LOG:  received immediate shutdown request</span></span>
<span data-line=""><span style="color:#ABB2BF">> WARNING:  terminating connection because of crash of another server</span></span>
<span data-line=""><span style="color:#ABB2BF">> process</span></span>
<span data-line=""><span style="color:#ABB2BF">> DETAIL:  The postmaster has commanded this server process to roll back</span></span>
<span data-line=""><span style="color:#ABB2BF">> the current transaction and exit, because another server process</span></span>
<span data-line=""><span style="color:#ABB2BF">> exited abnormally and possibly corrupted shared memory.</span></span>
<span data-line=""><span style="color:#ABB2BF">> HINT:  In a moment you should be able to reconnect to the database and</span></span>
<span data-line=""><span style="color:#ABB2BF">> repeat your command.</span></span>
<span data-line=""><span style="color:#ABB2BF">> LOG:  received fast shutdown request</span></span>
<span data-line=""><span style="color:#ABB2BF">> LOG:  database system was interrupted; </span><span style="color:#61AFEF">last</span><span style="color:#98C379"> known</span><span style="color:#98C379"> up</span><span style="color:#98C379"> at</span><span style="color:#98C379"> 2015-10-22</span></span>
<span data-line=""><span style="color:#ABB2BF">> 15:47:43 CDT</span></span>
<span data-line=""><span style="color:#ABB2BF">> LOG:  received immediate shutdown request</span></span>
<span data-line=""><span style="color:#ABB2BF">> LOG:  database system was interrupted; </span><span style="color:#61AFEF">last</span><span style="color:#98C379"> known</span><span style="color:#98C379"> up</span><span style="color:#98C379"> at</span><span style="color:#98C379"> 2015-10-22</span></span>
<span data-line=""><span style="color:#ABB2BF">> 15:47:43 CDT</span></span>
<span data-line=""><span style="color:#ABB2BF">> LOG:  database system was not properly shut down; </span><span style="color:#61AFEF">automatic</span><span style="color:#98C379"> recovery</span></span>
<span data-line=""><span style="color:#ABB2BF">> in progress</span></span>
<span data-line=""><span style="color:#ABB2BF">> LOG:  record with zero length at BBD/1CC2F0C0</span></span>
<span data-line=""><span style="color:#ABB2BF">> ...</span></span></code></pre></figure>
<p>You can see all the weird activity that was done here</p>
<ul>
<li>first the attempt to "canceling statement due to user request" did not work</li>
<li>then the database stop using -m fast</li>
<li>then the database stop using -m immediate</li>
<li>the restart (with the HINT, should be ready soon)</li>
<li>the panic mode where i tried to shut it again anyways</li>
</ul>
<p>During the recovery period, I was still very concerned about the database was
doing, so I used "strace" to look at the main postmaster process.</p>
<p>I was pleasantly surprised to see that the postmaster process was just cleaning
up files in /db/postgres/data/base/pgsql_tmp/, I could see the file system
"unlink" command with successful status codes.</p>
<p>There were about 150 large files in /db/postgres/data/base/pgsql_tmp/, and I
waited about an hour for them to be deleted, and after that, the postgresql log
file said it was ready, and indeed, it was perfect :)</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#282c34;color:#abb2bf" tabindex="0" data-language="sh" data-theme="one-dark-pro"><code data-language="sh" data-theme="one-dark-pro" style="display: grid;"><span data-line=""><span style="color:#ABB2BF">> LOG:  redo is not required</span></span>
<span data-line=""><span style="color:#ABB2BF">> LOG:  database system is ready to accept connections</span></span>
<span data-line=""><span style="color:#ABB2BF">> LOG:  autovacuum launcher started</span></span></code></pre></figure>
<p>What a relief!</p>
<p>I hope this might help any wayward stragglers to see how the postgresql restart
process works. Sometimes things don't shut down cleanly, but I think it is still
good to know some alternative steps to kill -9</p>
<h2 id="footnote"><a aria-hidden="true" tabindex="-1" href="#footnote"><a href="#footnote" style="margin-right: 10px">#</a></a>Footnote</h2>
<p>This all happened right before the demo of our project to some stakeholders (it
was a small academic lab project, but still crucial!) so that made it extra
scary</p></div><div class="mt-5"></div></div><footer class="mt-16"><a class="m-2" href="/">Home</a><a class="m-2" href="/archive">Blog archive</a><a class="m-2" href="https://github.com/cmdcolin/">Github</a><a class="m-2" href="/projects">Projects</a><a class="m-2" href="/photos">Photos</a><a class="m-2" href="/books">Books</a><a class="m-2" href="/about">About</a></footer><script src="/_next/static/chunks/webpack-dea5254e1907c5df.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"2:\"$Sreact.fragment\"\n3:I[231,[\"231\",\"static/chunks/231-fc74e6e791c0837d.js\",\"931\",\"static/chunks/app/page-95d4a906a5a795f0.js\"],\"\"]\n4:I[9275,[],\"\"]\n5:I[1343,[],\"\"]\n7:I[3120,[],\"OutletBoundary\"]\n9:I[3120,[],\"MetadataBoundary\"]\nb:I[3120,[],\"ViewportBoundary\"]\nd:I[6130,[],\"\"]\n1:HL[\"/_next/static/css/d19cfa26cd1ef694.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"0:{\"P\":null,\"b\":\"eYPzzdznXkyRCVK3q_3uX\",\"p\":\"\",\"c\":[\"\",\"posts\",\"2015-10-22\"],\"i\":false,\"f\":[[[\"\",{\"children\":[\"posts\",{\"children\":[[\"id\",\"2015-10-22\",\"d\"],{\"children\":[\"__PAGE__?{\\\"id\\\":\\\"2015-10-22\\\"}\",{}]}]}]},\"$undefined\",\"$undefined\",true],[\"\",[\"$\",\"$2\",\"c\",{\"children\":[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/d19cfa26cd1ef694.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"html\",null,{\"lang\":\"en\",\"children\":[\"$\",\"body\",null,{\"children\":[[\"$\",\"div\",null,{\"className\":\"mb-8\",\"children\":[\"$\",\"$L3\",null,{\"href\":\"/\",\"children\":\"Misc scribbles\"}]}],[\"$\",\"$L4\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L5\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":\"404\"}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],\"notFoundStyles\":[]}],[\"$\",\"footer\",null,{\"className\":\"mt-16\",\"children\":[[\"$\",\"$L3\",null,{\"className\":\"m-2\",\"href\":\"/\",\"children\":\"Home\"}],[\"$\",\"$L3\",null,{\"className\":\"m-2\",\"href\":\"/archive\",\"children\":\"Blog archive\"}],[\"$\",\"$L3\",null,{\"className\":\"m-2\",\"href\":\"https://github.com/cmdcolin/\",\"children\":\"Github\"}],[\"$\",\"$L3\",null,{\"className\":\"m-2\",\"href\":\"/projects\",\"children\":\"Projects\"}],[\"$\",\"$L3\",null,{\"className\":\"m-2\",\"href\":\"/photos\",\"children\":\"Photos\"}],[\"$\",\"$L3\",null,{\"className\":\"m-2\",\"href\":\"/books\",\"children\":\"Books\"}],[\"$\",\"$L3\",null,{\"className\":\"m-2\",\"href\":\"/about\",\"children\":\"About\"}]]}]]}]}]]}],{\"children\":[\"posts\",[\"$\",\"$2\",\"c\",{\"children\":[null,[\"$\",\"$L4\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"posts\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L5\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\"}]]}],{\"children\":[[\"id\",\"2015-10-22\",\"d\"],[\"$\",\"$2\",\"c\",{\"children\":[null,[\"$\",\"$L4\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"posts\",\"children\",\"$0:f:0:1:2:children:2:children:0\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L5\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\"}]]}],{\"children\":[\"__PAGE__\",[\"$\",\"$2\",\"c\",{\"children\":[\"$L6\",null,[\"$\",\"$L7\",null,{\"children\":\"$L8\"}]]}],{},null]},null]},null]},null],[\"$\",\"$2\",\"h\",{\"children\":[null,[\"$\",\"$2\",\"1WSZrk8KYYBGdiBPlebIC\",{\"children\":[[\"$\",\"$L9\",null,{\"children\":\"$La\"}],[\"$\",\"$Lb\",null,{\"children\":\"$Lc\"}],null]}]]}]]],\"m\":\"$undefined\",\"G\":[\"$d\",\"$undefined\"],\"s\":false,\"S\":true}\n"])</script><script>self.__next_f.push([1,"c:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}]]\n"])</script><script>self.__next_f.push([1,"f:I[1458,[\"722\",\"static/chunks/app/posts/%5Bid%5D/page-e50cd2f34f19f050.js\"],\"default\"]\ne:T50b0,"])</script><script>self.__next_f.push([1,"\u003cp\u003eSo today, I finally decided to do something about a query that we saw had been\nrunning for 25 DAYS on our server\u003c/p\u003e\n\u003cp\u003eNote: If you find this post and you need to follow the hard way, backup your\ndata first if possible.\u003c/p\u003e\n\u003cp\u003eFirst I could obviously see the culprit: each postgresql query runs it's own\nprocess so I could see in \"htop\" that there was this process that had been\nrunning for 600 hours, or about 25 days\u003c/p\u003e\n\u003cp\u003eNext, I opened a psql console and ran this query:\u003c/p\u003e\n\u003cfigure data-rehype-pretty-code-figure=\"\"\u003e\u003cpre style=\"background-color:#282c34;color:#abb2bf\" tabindex=\"0\" data-language=\"sql\" data-theme=\"one-dark-pro\"\u003e\u003ccode data-language=\"sql\" data-theme=\"one-dark-pro\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#C678DD\"\u003eSELECT\u003c/span\u003e\u003cspan style=\"color:#ABB2BF\"\u003e datname,procpid,current_query \u003c/span\u003e\u003cspan style=\"color:#C678DD\"\u003eFROM\u003c/span\u003e\u003cspan style=\"color:#ABB2BF\"\u003e pg_stat_activity \u003c/span\u003e\u003cspan style=\"color:#C678DD\"\u003eWHERE\u003c/span\u003e\u003cspan style=\"color:#ABB2BF\"\u003e datname\u003c/span\u003e\u003cspan style=\"color:#56B6C2\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#98C379\"\u003e'database_name'\u003c/span\u003e\u003cspan style=\"color:#C678DD\"\u003e ORDER BY\u003c/span\u003e\u003cspan style=\"color:#ABB2BF\"\u003e procpid ;\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/figure\u003e\n\u003cp\u003eThis returns which actual queries are being run on the database at any given\ntime. I could easily see the one problematic query being run, which was a badly\nconstructed intermine template query that resulted in a weird \"recursion\"\nessentially.\u003c/p\u003e\n\u003cp\u003eI wanted to try just terminating this query itself, so I ran this\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eSELECT pg_cancel_backend(29033);\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eEach time I ran it, it would say it returned one result but it did nothing.\u003c/p\u003e\n\u003cp\u003eI also read that you can try to nicely \"kill\" it from the command line (no kill\n-9) so I ran\u003c/p\u003e\n\u003cfigure data-rehype-pretty-code-figure=\"\"\u003e\u003cpre style=\"background-color:#282c34;color:#abb2bf\" tabindex=\"0\" data-language=\"sh\" data-theme=\"one-dark-pro\"\u003e\u003ccode data-language=\"sh\" data-theme=\"one-dark-pro\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e kill 29033\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/figure\u003e\n\u003cp\u003eThis also did not work!\u003c/p\u003e\n\u003cp\u003eI thought perhaps all these problems were because tomcat was still active, so we\nshut down tomcat, and retried killing the specific query, but to no avail\u003c/p\u003e\n\u003cp\u003eAt this point, I just wanted to restart the whole database server. Kind of a\nrisky move... but I am sort of a risky kind of guy...(that is not a good thing\nwith databases). If you are doing this, make backups! I didn't. Luckily I\nsuffered no data loss but what follows is kind of intense.\u003c/p\u003e\n\u003cp\u003eSo first, I try and stop the database service\u003c/p\u003e\n\u003cfigure data-rehype-pretty-code-figure=\"\"\u003e\u003cpre style=\"background-color:#282c34;color:#abb2bf\" tabindex=\"0\" data-language=\"sh\" data-theme=\"one-dark-pro\"\u003e\u003ccode data-language=\"sh\" data-theme=\"one-dark-pro\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e service postgresql-9.1 stop\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/figure\u003e\n\u003cp\u003eUnfortunately, this \u003ccode\u003e[FAILED]\u003c/code\u003e ! And of course, even though it failed, the\ndatabase is now unusable. No logging into it anymore, we have to go with the\nhard way now...\u003c/p\u003e\n\u003cp\u003eLooking at /etc/init.d/postgres-9.1 told me that the service stop command was\neffectively using something like this:\u003c/p\u003e\n\u003cfigure data-rehype-pretty-code-figure=\"\"\u003e\u003cpre style=\"background-color:#282c34;color:#abb2bf\" tabindex=\"0\" data-language=\"sh\" data-theme=\"one-dark-pro\"\u003e\u003ccode data-language=\"sh\" data-theme=\"one-dark-pro\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e pg_ctl -D /db/postgres/data -m fast stop\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/figure\u003e\n\u003cp\u003eAfter some reading, I learned that you can try using a slightly different flag\nto restart it\u003c/p\u003e\n\u003cfigure data-rehype-pretty-code-figure=\"\"\u003e\u003cpre style=\"background-color:#282c34;color:#abb2bf\" tabindex=\"0\" data-language=\"sh\" data-theme=\"one-dark-pro\"\u003e\u003ccode data-language=\"sh\" data-theme=\"one-dark-pro\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e pg_ctl -D /db/postgres/data -m immediate  stop\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/figure\u003e\n\u003cp\u003eI ran this and to my horror/surprise, it actually worked! At this point I\ndecided to start postgresql back up again!\u003c/p\u003e\n\u003cfigure data-rehype-pretty-code-figure=\"\"\u003e\u003cpre style=\"background-color:#282c34;color:#abb2bf\" tabindex=\"0\" data-language=\"sh\" data-theme=\"one-dark-pro\"\u003e\u003ccode data-language=\"sh\" data-theme=\"one-dark-pro\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e service postgresql-9.1 start\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/figure\u003e\n\u003cp\u003eThe service start quickly returned a SUCCESS, which was great, but then I tried\nto start a psql console and the console froze on me! I could not even ctrl+c it!\u003c/p\u003e\n\u003cp\u003eI got really worried at this point and I looked at the process manager, and saw\nthat there was one postmaster process running but it was not clear what it was\ndoing. I actually tried to shutdown the server again in a panic mode but at this\npoint it said\u003c/p\u003e\n\u003cfigure data-rehype-pretty-code-figure=\"\"\u003e\u003cpre style=\"background-color:#282c34;color:#abb2bf\" tabindex=\"0\" data-language=\"sh\" data-theme=\"one-dark-pro\"\u003e\u003ccode data-language=\"sh\" data-theme=\"one-dark-pro\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e /usr/pgsql-9.1/bin/pg_ctl stop -D /db/postgres/data/ -m immediate\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e waiting \u003c/span\u003e\u003cspan style=\"color:#C678DD\"\u003efor\u003c/span\u003e\u003cspan style=\"color:#ABB2BF\"\u003e server to shut\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e down...............................................................\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e failed\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/figure\u003e\n\u003cp\u003eIt was probably good that it didn't shut down, because I would quickly find out\nthat it was in recovery mode. I looked at the postgresql logs and I saw this,\nreproduced here for full detail (from before the shutdown to the restart)\u003c/p\u003e\n\u003cfigure data-rehype-pretty-code-figure=\"\"\u003e\u003cpre style=\"background-color:#282c34;color:#abb2bf\" tabindex=\"0\" data-language=\"sh\" data-theme=\"one-dark-pro\"\u003e\u003ccode data-language=\"sh\" data-theme=\"one-dark-pro\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e WARNING:  pgstat wait timeout\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e WARNING:  pgstat wait timeout\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e WARNING:  pgstat wait timeout\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e WARNING:  pgstat wait timeout\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e WARNING:  pgstat wait timeout\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e WARNING:  pgstat wait timeout\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e WARNING:  pgstat wait timeout\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e WARNING:  pgstat wait timeout\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e ERROR:  canceling statement due to user request\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e STATEMENT:  CREATE TABLE precomp_90519 AS SELECT DISTINCT a1_.id AS\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e a1_id, a2_.id AS a2_id, a3_.id AS a3_id, a4_.id AS a4_id,\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e a5_.id AS a5_id, a6_.id AS a6_id, a12_.id AS a12_id, a10_.id AS\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e a10_id, a1_.id AS a13_, a1_.primaryIdentifier AS a14_,\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e a1_.secondaryIdentifier AS a15_, a2_.type AS a16_, a3_.name AS\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e a17_, a4_.primaryIdentifier AS a18_, a5_.primaryIdentifier AS\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e a19_, a6_.shortName AS a20_, a12_.identifier AS a21_, a10_.code\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e AS a22_ FROM Gene AS a1_, Homologue AS a2_, Organism AS a3_, Gene\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e AS a4_, Gene AS a5_, Organism AS a6_, GOAnnotation AS a7_,\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e GOEvidence AS a8_, OntologyTerm AS a9_, GOEvidenceCode AS a10_,\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e OntologyAnnotation AS a11_, OntologyTerm AS a12_, GeneGoAnnotation\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e AS indirect0, EvidenceGOAnnotation AS indirect1 WHERE a1_.id =\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e a2_.geneId AND a1_.organismId = a3_.id AND a2_.geneId = a4_.id\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e AND a2_.homologueId = a5_.id AND a5_.organismId = a6_.id AND\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e a1_.id = indirect0.Gene AND indirect0.GoAnnotation = a7_.id AND\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e a7_.id = indirect1.GOAnnotation AND indirect1.Evidence = a8_.id AND\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e a7_.ontologyTermId = a9_.id AND a8_.codeId = a10_.id AND a9_.id =\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e a11_.ontologyTermId AND a11_.ontologyTermId = a12_.id ORDER BY\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e a1_.primaryIdentifier, a1_.secondaryIdentifier, a2_.type,\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e a3_.name, a4_.primaryIdentifier, a5_.primaryIdentifier,\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e a6_.shortName, a12_.identifier, a10_.code, a1_.id, a2_.id,\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e a3_.id, a4_.id, a5_.id, a6_.id, a12_.id, a10_.id\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e LOG:  could not send data to client: Broken pipe\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e STATEMENT:  CREATE TABLE precomp_90519 AS SELECT DISTINCT a1_.id AS\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e a1_id, a2_.id AS a2_id, a3_.id AS a3_id, a4_.id AS a4_id,\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e a5_.id AS a5_id, a6_.id AS a6_id, a12_.id AS a12_id, a10_.id AS\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e a10_id, a1_.id AS a13_, a1_.primaryIdentifier AS a14_,\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e a1_.secondaryIdentifier AS a15_, a2_.type AS a16_, a3_.name AS\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e a17_, a4_.primaryIdentifier AS a18_, a5_.primaryIdentifier AS\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e a19_, a6_.shortName AS a20_, a12_.identifier AS a21_, a10_.code\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e AS a22_ FROM Gene AS a1_, Homologue AS a2_, Organism AS a3_, Gene\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e AS a4_, Gene AS a5_, Organism AS a6_, GOAnnotation AS a7_,\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e GOEvidence AS a8_, OntologyTerm AS a9_, GOEvidenceCode AS a10_,\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e OntologyAnnotation AS a11_, OntologyTerm AS a12_, GeneGoAnnotation\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e AS indirect0, EvidenceGOAnnotation AS indirect1 WHERE a1_.id =\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e a2_.geneId AND a1_.organismId = a3_.id AND a2_.geneId = a4_.id\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e AND a2_.homologueId = a5_.id AND a5_.organismId = a6_.id AND\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e a1_.id = indirect0.Gene AND indirect0.GoAnnotation = a7_.id AND\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e a7_.id = indirect1.GOAnnotation AND indirect1.Evidence = a8_.id AND\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e a7_.ontologyTermId = a9_.id AND a8_.codeId = a10_.id AND a9_.id =\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e a11_.ontologyTermId AND a11_.ontologyTermId = a12_.id ORDER BY\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e a1_.primaryIdentifier, a1_.secondaryIdentifier, a2_.type,\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e a3_.name, a4_.primaryIdentifier, a5_.primaryIdentifier,\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e a6_.shortName, a12_.identifier, a10_.code, a1_.id, a2_.id,\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e a3_.id, a4_.id, a5_.id, a6_.id, a12_.id, a10_.id\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e LOG:  unexpected EOF on client connection\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e LOG:  unexpected EOF on client connection\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e LOG:  unexpected EOF on client connection\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e LOG:  unexpected EOF on client connection\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e LOG:  received fast shutdown request\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e LOG:  aborting any active transactions\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e LOG:  autovacuum launcher shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e FATAL:  the database system is shutting down\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e LOG:  received immediate shutdown request\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e WARNING:  terminating connection because of crash of another server\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e process\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e DETAIL:  The postmaster has commanded this server process to roll back\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e the current transaction and exit, because another server process\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e exited abnormally and possibly corrupted shared memory.\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e HINT:  In a moment you should be able to reconnect to the database and\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e repeat your command.\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e LOG:  received fast shutdown request\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e LOG:  database system was interrupted; \u003c/span\u003e\u003cspan style=\"color:#61AFEF\"\u003elast\u003c/span\u003e\u003cspan style=\"color:#98C379\"\u003e known\u003c/span\u003e\u003cspan style=\"color:#98C379\"\u003e up\u003c/span\u003e\u003cspan style=\"color:#98C379\"\u003e at\u003c/span\u003e\u003cspan style=\"color:#98C379\"\u003e 2015-10-22\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e 15:47:43 CDT\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e LOG:  received immediate shutdown request\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e LOG:  database system was interrupted; \u003c/span\u003e\u003cspan style=\"color:#61AFEF\"\u003elast\u003c/span\u003e\u003cspan style=\"color:#98C379\"\u003e known\u003c/span\u003e\u003cspan style=\"color:#98C379\"\u003e up\u003c/span\u003e\u003cspan style=\"color:#98C379\"\u003e at\u003c/span\u003e\u003cspan style=\"color:#98C379\"\u003e 2015-10-22\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e 15:47:43 CDT\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e LOG:  database system was not properly shut down; \u003c/span\u003e\u003cspan style=\"color:#61AFEF\"\u003eautomatic\u003c/span\u003e\u003cspan style=\"color:#98C379\"\u003e recovery\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e in progress\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e LOG:  record with zero length at BBD/1CC2F0C0\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e ...\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/figure\u003e\n\u003cp\u003eYou can see all the weird activity that was done here\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003efirst the attempt to \"canceling statement due to user request\" did not work\u003c/li\u003e\n\u003cli\u003ethen the database stop using -m fast\u003c/li\u003e\n\u003cli\u003ethen the database stop using -m immediate\u003c/li\u003e\n\u003cli\u003ethe restart (with the HINT, should be ready soon)\u003c/li\u003e\n\u003cli\u003ethe panic mode where i tried to shut it again anyways\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eDuring the recovery period, I was still very concerned about the database was\ndoing, so I used \"strace\" to look at the main postmaster process.\u003c/p\u003e\n\u003cp\u003eI was pleasantly surprised to see that the postmaster process was just cleaning\nup files in /db/postgres/data/base/pgsql_tmp/, I could see the file system\n\"unlink\" command with successful status codes.\u003c/p\u003e\n\u003cp\u003eThere were about 150 large files in /db/postgres/data/base/pgsql_tmp/, and I\nwaited about an hour for them to be deleted, and after that, the postgresql log\nfile said it was ready, and indeed, it was perfect :)\u003c/p\u003e\n\u003cfigure data-rehype-pretty-code-figure=\"\"\u003e\u003cpre style=\"background-color:#282c34;color:#abb2bf\" tabindex=\"0\" data-language=\"sh\" data-theme=\"one-dark-pro\"\u003e\u003ccode data-language=\"sh\" data-theme=\"one-dark-pro\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e LOG:  redo is not required\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e LOG:  database system is ready to accept connections\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ABB2BF\"\u003e\u003e LOG:  autovacuum launcher started\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/figure\u003e\n\u003cp\u003eWhat a relief!\u003c/p\u003e\n\u003cp\u003eI hope this might help any wayward stragglers to see how the postgresql restart\nprocess works. Sometimes things don't shut down cleanly, but I think it is still\ngood to know some alternative steps to kill -9\u003c/p\u003e\n\u003ch2 id=\"footnote\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#footnote\"\u003e\u003ca href=\"#footnote\" style=\"margin-right: 10px\"\u003e#\u003c/a\u003e\u003c/a\u003eFootnote\u003c/h2\u003e\n\u003cp\u003eThis all happened right before the demo of our project to some stakeholders (it\nwas a small academic lab project, but still crucial!) so that made it extra\nscary\u003c/p\u003e"])</script><script>self.__next_f.push([1,"6:[\"$\",\"div\",null,{\"className\":\"lg:w-1/2\",\"children\":[[\"$\",\"div\",null,{\"children\":[[\"$\",\"h1\",null,{\"children\":\"Killing postgres the hard way\"}],[\"$\",\"h4\",null,{\"children\":\"2015-10-22\"}]]}],[\"$\",\"div\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"$e\"}}],[\"$\",\"$Lf\",null,{}]]}]\na:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"1\",{\"children\":\"Killing postgres the hard way\"}],[\"$\",\"meta\",\"2\",{\"name\":\"description\",\"content\":\"A blog\"}]]\n8:null\n"])</script></body></html>