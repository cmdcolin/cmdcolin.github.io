<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="description" content="Astro description"><meta name="viewport" content="width=device-width"><link rel="icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Astro v6.0.0-beta.1"><title>Beware! If you make custom React hooks, eslint-plugin-react-hooks may not catch some issues</title><style>.container[data-astro-cid-4oxc2zqz]{max-width:800px;margin:0 auto;padding:0 1rem}article[data-astro-cid-lvjzyg5v]{max-width:100%}.post-content[data-astro-cid-lvjzyg5v]{margin:2rem 0;line-height:1.6}
</style>
<link rel="stylesheet" href="/_astro/Layout.Ca4IH_rv.css"></head> <body> <div class="mb-8"> <a href="/">Misc scribbles</a> </div>  <div class="container" data-astro-cid-4oxc2zqz>  <article data-astro-cid-lvjzyg5v> <div data-astro-cid-lvjzyg5v> <h1 data-astro-cid-lvjzyg5v>Beware! If you make custom React hooks, eslint-plugin-react-hooks may not catch some issues</h1> <h4 data-astro-cid-lvjzyg5v>2025-12-27</h4> </div> <div class="post-content" data-astro-cid-lvjzyg5v> <p>I am reporting to you live from the debugging session…A useEffect in my
codebase has triggered in an infinite loop in my code. But this doesn’t just
cause trouble for me…</p>
<h2 id="a-problem-for-everybody">A problem for everybody</h2>
<p>This type of issue is something probably everyone has seen. Even CloudFlare saw
this bug in Sept 2025, and it caused some big troubles</p>
<blockquote>
<p>The incident’s impact stemmed from several issues, but the immediate trigger
was a bug in the dashboard. This bug caused repeated, unnecessary calls to the
Tenant Service API. The API calls were managed by a React useEffect hook, but
we mistakenly included a problematic object in its dependency array. Because
this object was recreated on every state or prop change, React treated it as
“always new,” causing the useEffect to re-run each time. As a result, the API
call executed many times during a single dashboard render instead of just
once. This behavior coincided with a service update to the Tenant Service API,
compounding instability and ultimately overwhelming the service, which then
failed to recover.</p>
<p>Source:
<a href="https://blog.cloudflare.com/deep-dive-into-cloudflares-sept-12-dashboard-and-api-outage/">https://blog.cloudflare.com/deep-dive-into-cloudflares-sept-12-dashboard-and-api-outage/</a></p>
</blockquote>
<p>Maybe interestingly, their “takeaways” going forward did not include more static
analysis of React to identify issues like this. Their takeaways were to try to
narrow the blast radius of things like this by “Reducing impact” and “Improving
visibility”. That is fine, every postmortem has a complex set of conditions that
leads to failure, but could this issue have been caught at compile time? (the
best time!)</p>
<h2 id="i-have-eslint-plugin-react-hooks-its-supposed-to-warn-about-this-why-is-this-happening">I have eslint-plugin-react-hooks, it’s supposed to warn about this, why is this happening???</h2>
<p>The critical reader may slap their forehead and say…you may not NEED a
useEffect! don’t you know? <code>&#x3C;link to react docs here></code></p>
<p>Sometimes you just do though. Ok moving on</p>
<p>Lets see what eslint-plugin-react-hooks can help catch</p>
<pre><code class="language-typescript"><a-f>useEffect</a-f><a-p>(()</a-p> <a-o>=></a-o> <a-p>{},</a-p> <a-p>[</a-p><a-k>new</a-k> <a-t>Number</a-t><a-p>(</a-p><a-n>94</a-n><a-p>)])</a-p>
</code></pre>
<p>This produces</p>
<pre><code>  warning  React Hook useEffect has a complex expression in the dependency array. Extract it to a separate variable so it can be statically checked  react-hooks/exhaustive-deps

</code></pre>
<p>What about</p>
<pre><code class="language-typescript"><a-k>const</a-k> <a-v>num</a-v> <a-o>=</a-o> <a-k>new</a-k> <a-t>Number</a-t><a-p>(</a-p><a-n>94</a-n><a-p>)</a-p>
<a-f>useEffect</a-f><a-p>(()</a-p> <a-o>=></a-o> <a-p>{},</a-p> <a-p>[</a-p><a-v>num</a-v><a-p>])</a-p>
</code></pre>
<p>This says</p>
<pre><code>  warning  The 'num' object construction makes the dependencies of useEffect Hook (at line 11) change on every render. Move it inside the useEffect callback. Alternatively, wrap the initialization of 'num' in its own useMemo() Hook  react-hooks/exhaustive-deps
</code></pre>
<p>But what about…</p>
<pre><code class="language-typescript"><a-k>import</a-k> <a-p>{</a-p> <a-v>useEffect</a-v><a-p>,</a-p> <a-v>useState</a-v> <a-p>}</a-p> <a-k>from</a-k> <a-s>'react'</a-s>

<a-k>function</a-k> <a-f>useMyHook</a-f><a-p>(</a-p><a-v>myVariable</a-v>: <a-t>number</a-t><a-p>[])</a-p> <a-p>{</a-p>
  <a-k>const</a-k> <a-p>[</a-p><a-v>result</a-v><a-p>,</a-p> <a-v>setResult</a-v><a-p>]</a-p> <a-o>=</a-o> <a-f>useState</a-f><a-p>(</a-p><a-n>0</a-n><a-p>)</a-p>
  <a-f>useEffect</a-f><a-p>(()</a-p> <a-o>=></a-o> <a-p>{</a-p>
    <a-v>console</a-v><a-p>.</a-p><a-f>log</a-f><a-p>(</a-p><a-s>'look mom custom hook'</a-s><a-p>,</a-p> <a-v>myVariable</a-v><a-p>)</a-p>
    <a-p>;(</a-p><a-k>async</a-k> <a-p>()</a-p> <a-o>=></a-o> <a-p>{</a-p>
      <a-f>setResult</a-f><a-p>(</a-p><a-v>result</a-v> <a-o>=></a-o> <a-v>result</a-v> <a-o>+</a-o> <a-n>1</a-n><a-p>)</a-p>
    <a-p>})()</a-p>
  <a-p>},</a-p> <a-p>[</a-p><a-v>myVariable</a-v><a-p>])</a-p>
  <a-k>return</a-k> <a-v>result</a-v>
<a-p>}</a-p>

<a-k>function</a-k> <a-t>App</a-t><a-p>()</a-p> <a-p>{</a-p>
  <a-f>useMyHook</a-f><a-p>([</a-p><a-n>1</a-n><a-p>,</a-p> <a-n>2</a-n><a-p>,</a-p> <a-n>3</a-n><a-p>])</a-p>

  <a-k>return</a-k> <a-p>(</a-p>
    <a-p>&#x3C;</a-p><a-t>h1</a-t><a-p>></a-p>
      <a-t>Hello</a-t>
    <a-o>&#x3C;</a-o><a-s>/</a-s><a-s>h1></a-s><a-o>
  </a-o><a-p>)</a-p><a-o>
</a-o><a-p>}</a-p><a-o>

</a-o><a-k>export</a-k><a-o> </a-o><a-k>default</a-k><a-o> </a-o><a-t>App</a-t>
</code></pre>
<p>This, as the console.log suggests, is an infinite loop because [1,2,3] is not a
stable reference, and we are not informed by the lint rule because we have
extracted it to a different hook</p>
<h3 id="a-thought-to-leave-you-with">A thought to leave you with</h3>
<p>Things like typescript eliminate huge classes of bugs via static analysis, and
typescript-eslint is able to push it even further by adding typed lints, but
what about this class of bugs. It appears to only be able to be detected via
heuristics. I was already a bit wary of using custom hooks in my code and this
will make me think twice or three more times about it, since the heuristic,
while imperfect, can help. There are of course also other reasons this failure
case could be triggered… a prop being used probably breaks the heuristic also.</p>
<p>Are there other ways we can catch or fix this issue? Feel free to let me know</p>
<pre><code></code></pre> </div> <div id="giscus"></div> <script>
  const script = document.createElement('script');
  script.src = 'https://giscus.app/client.js';
  script.setAttribute('data-repo', 'cmdcolin/cmdcolin.github.io');
  script.setAttribute('data-repo-id', 'MDEwOlJlcG9zaXRvcnkyNjE0OTY3Nw==');
  script.setAttribute('data-category', 'General');
  script.setAttribute('data-category-id', 'DIC_kwDOAY8DLc4CO-L9');
  script.setAttribute('data-mapping', 'pathname');
  script.setAttribute('data-strict', '0');
  script.setAttribute('data-reactions-enabled', '1');
  script.setAttribute('data-emit-metadata', '0');
  script.setAttribute('data-input-position', 'bottom');
  script.setAttribute('data-theme', 'light');
  script.setAttribute('data-lang', 'en');
  script.setAttribute('crossorigin', 'anonymous');
  script.async = true;
  document.getElementById('giscus').appendChild(script);
</script> </article>  </div>   <footer class="footer-style" data-astro-cid-k2f5zb5c> <a class="footer-link" href="/" data-astro-cid-k2f5zb5c>Home</a> <a class="footer-link" href="/archive" data-astro-cid-k2f5zb5c>Blog archive</a> <a class="footer-link" href="https://github.com/cmdcolin/" data-astro-cid-k2f5zb5c>Github</a> <a class="footer-link" href="/projects" data-astro-cid-k2f5zb5c>Projects</a> <a class="footer-link" href="/about" data-astro-cid-k2f5zb5c>About</a> </footer> </body></html> 