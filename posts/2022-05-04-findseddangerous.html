<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>Using find . -exec sed is dangerous in a git repo</title><meta name="next-head-count" content="3"/><link rel="shortcut icon" href="favicon.ico"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><meta name="description" content="Blogging for the future"/><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/prism.min.js" integrity="sha512-hpZ5pDCF2bRCweL5WoA0/N1elet1KYL5mx3LP555Eg/0ZguaHawxNvEjF6O3rufAChs16HVNhEc6blF/rZoowQ==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="preload" href="/_next/static/css/9d066bf523979bbf.css" as="style"/><link rel="stylesheet" href="/_next/static/css/9d066bf523979bbf.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-0d1b80a048d4787e.js"></script><script src="/_next/static/chunks/webpack-8b8836cfd4de0dcd.js" defer=""></script><script src="/_next/static/chunks/framework-c0d8f0fd2eea5ac1.js" defer=""></script><script src="/_next/static/chunks/main-ad18704b098b4264.js" defer=""></script><script src="/_next/static/chunks/pages/_app-d9139de5c3de3b6b.js" defer=""></script><script src="/_next/static/chunks/996-f78e375898643c6a.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-34e532adea304c66.js" defer=""></script><script src="/_next/static/QyQ1p7HbwkQvKciLQSphn/_buildManifest.js" defer=""></script><script src="/_next/static/QyQ1p7HbwkQvKciLQSphn/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div><main><div><div style="margin-bottom:100px"><a href="/">Misc scribbles</a></div><article><div><h1>Using find . -exec sed is dangerous in a git repo</h1><h4>2022-05-04</h4></div><p>You want to find and replace all instances of a string in your repo, so you
google &quot;find replace directory linux command&quot;. You end up here</p>
<p><a href="https://stackoverflow.com/a/6759339/2129219">https://stackoverflow.com/a/6759339/2129219</a></p>
<p>They tell us</p>
<pre><code class="language-sh">find ./ -type f -exec sed -i -e &#x27;s/apple/orange/g&#x27; {} \;
</code></pre>
<p>Ignoring the fact that this syntax is very long and hard to type, this command
is dangerous to use in a git repository. Specifically, this can corrupt your
.git contents.</p>
<h2>Why?</h2>
<p>This command is dangerous because, find . will enumerate dotfiles, including
the .git directory, and then of course will run the find and replace inside
them. We can see this in the following session</p>
<pre><code class="language-sh">&gt; mkdir corruptme
&gt; cd corruptme
&gt; git init
&gt; echo &quot;# README&quot; &gt; README.md
&gt; git add README.md
&gt; git commit -m &quot;Initial commit&quot;
&gt; echo &quot;Hello world, it is a beautiful day. I sure hope someone doesn&#x27;t corrupt this git repository&quot; &gt;&gt; README.md
&gt; git commit -am &quot;Update README.md&quot;
&gt; find .
.
./README.md
./.git
./.git/branches
./.git/config
./.git/COMMIT_EDITMSG
...more stuff...good indication the next command might be dangerous....
&gt; find ./ -type f -exec sed -i -e &quot;s/README/CORRUPTME/g&quot; {} \;
&gt; git status
error: index uses md extension, which we do not understand
fatal: index file corrupt
</code></pre>
<p>In this case, you may be able to recover it e.g. with
https://stackoverflow.com/questions/1115854/how-to-resolve-error-bad-index-fatal-index-file-corrupt-when-using-git</p>
<p>If you happened to replace some random text that is actually in an object file though e.g. .git/objects</p>
<pre><code class="language-sh">&gt; find ./ -type f -exec sed -i -e &quot;s/VHTHJM/OOOOOO/g&quot; {} \;
&gt; git status
error: inflate: data stream error (incorrect data check)
error: corrupt loose object &#x27;26cfc5964dfa5355a1747eb6eec6250aab5212d5&#x27;
fatal: unable to read 26cfc5964dfa5355a1747eb6eec6250aab5212d5
</code></pre>
<h2>What is better?</h2>
<p>My take: Use ruplacer <a href="https://github.com/dmerejkowsky/ruplacer">https://github.com/dmerejkowsky/ruplacer</a></p>
<p>This tool won&#x27;t try to replace stuff in your .git directory. It will also skip
anything in .gitignore including e.g. node_modules. I was delighted to discover
this tool so, just spreading the word</p>
<p>Addendum: Reddit /u/Snarwin also recommended using git ls-files instead of find</p>
<pre><code>git ls-files | xargs sed -i -e &#x27;s/apple/orange/g&#x27;
</code></pre><div style="margin-top:200px"></div></article></div></main></div><footer style="margin-top:100px"><a href="/">Home</a> <a href="/archive">Blog archive</a> <a href="https://github.com/cmdcolin/">Github</a> <a href="https://twitter.com/cmdcolin">Twitter</a> <a href="/projects">Projects</a> <a href="/photos">Photos</a> <a href="/rss.xml">RSS</a><a href="/about">About</a> </footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"Using find . -exec sed is dangerous in a git repo","date":"2022-05-04","slug":"2022-05-04-findseddangerous","mdxSource":{"compiledSource":"/*@jsxRuntime automatic @jsxImportSource react*/\nconst {Fragment: _Fragment, jsx: _jsx, jsxs: _jsxs} = arguments[0];\nconst {useMDXComponents: _provideComponents} = arguments[0];\nfunction _createMdxContent(props) {\n  const _components = Object.assign({\n    p: \"p\",\n    a: \"a\",\n    pre: \"pre\",\n    code: \"code\",\n    h2: \"h2\"\n  }, _provideComponents(), props.components);\n  return _jsxs(_Fragment, {\n    children: [_jsx(_components.p, {\n      children: \"You want to find and replace all instances of a string in your repo, so you\\ngoogle \\\"find replace directory linux command\\\". You end up here\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.a, {\n        href: \"https://stackoverflow.com/a/6759339/2129219\",\n        children: \"https://stackoverflow.com/a/6759339/2129219\"\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"They tell us\"\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-sh\",\n        children: \"find ./ -type f -exec sed -i -e 's/apple/orange/g' {} \\\\;\\n\"\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Ignoring the fact that this syntax is very long and hard to type, this command\\nis dangerous to use in a git repository. Specifically, this can corrupt your\\n.git contents.\"\n    }), \"\\n\", _jsx(_components.h2, {\n      children: \"Why?\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"This command is dangerous because, find . will enumerate dotfiles, including\\nthe .git directory, and then of course will run the find and replace inside\\nthem. We can see this in the following session\"\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-sh\",\n        children: \"\u003e mkdir corruptme\\n\u003e cd corruptme\\n\u003e git init\\n\u003e echo \\\"# README\\\" \u003e README.md\\n\u003e git add README.md\\n\u003e git commit -m \\\"Initial commit\\\"\\n\u003e echo \\\"Hello world, it is a beautiful day. I sure hope someone doesn't corrupt this git repository\\\" \u003e\u003e README.md\\n\u003e git commit -am \\\"Update README.md\\\"\\n\u003e find .\\n.\\n./README.md\\n./.git\\n./.git/branches\\n./.git/config\\n./.git/COMMIT_EDITMSG\\n...more stuff...good indication the next command might be dangerous....\\n\u003e find ./ -type f -exec sed -i -e \\\"s/README/CORRUPTME/g\\\" {} \\\\;\\n\u003e git status\\nerror: index uses md extension, which we do not understand\\nfatal: index file corrupt\\n\"\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"In this case, you may be able to recover it e.g. with\\nhttps://stackoverflow.com/questions/1115854/how-to-resolve-error-bad-index-fatal-index-file-corrupt-when-using-git\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"If you happened to replace some random text that is actually in an object file though e.g. .git/objects\"\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-sh\",\n        children: \"\u003e find ./ -type f -exec sed -i -e \\\"s/VHTHJM/OOOOOO/g\\\" {} \\\\;\\n\u003e git status\\nerror: inflate: data stream error (incorrect data check)\\nerror: corrupt loose object '26cfc5964dfa5355a1747eb6eec6250aab5212d5'\\nfatal: unable to read 26cfc5964dfa5355a1747eb6eec6250aab5212d5\\n\"\n      })\n    }), \"\\n\", _jsx(_components.h2, {\n      children: \"What is better?\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"My take: Use ruplacer \", _jsx(_components.a, {\n        href: \"https://github.com/dmerejkowsky/ruplacer\",\n        children: \"https://github.com/dmerejkowsky/ruplacer\"\n      })]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"This tool won't try to replace stuff in your .git directory. It will also skip\\nanything in .gitignore including e.g. node_modules. I was delighted to discover\\nthis tool so, just spreading the word\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Addendum: Reddit /u/Snarwin also recommended using git ls-files instead of find\"\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        children: \"git ls-files | xargs sed -i -e 's/apple/orange/g'\\n\"\n      })\n    })]\n  });\n}\nfunction MDXContent(props = {}) {\n  const {wrapper: MDXLayout} = Object.assign({}, _provideComponents(), props.components);\n  return MDXLayout ? _jsx(MDXLayout, Object.assign({}, props, {\n    children: _jsx(_createMdxContent, props)\n  })) : _createMdxContent(props);\n}\nreturn {\n  default: MDXContent\n};\n","frontmatter":{},"scope":{}}}},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"2022-05-04-findseddangerous"},"buildId":"QyQ1p7HbwkQvKciLQSphn","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>