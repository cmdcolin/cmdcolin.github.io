1:HL["/_next/static/css/e813e5fb1b51ad26.css",{"as":"style"}]
0:["64kXID8DVbqGk_FooXDz7",[[["",{"children":["posts",{"children":[["id","2021-10-30-spooky","d"],{"children":["__PAGE__?{\"id\":\"2021-10-30-spooky\"}",{}]}]}]},"$undefined","$undefined",true],"$L2",[[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/e813e5fb1b51ad26.css","precedence":"next"}]],["$L3",null]]]]]
4:I{"id":7095,"chunks":["95:static/chunks/95-fe2423899271355b.js","467:static/chunks/app/archive/page-27a5d9689f809faa.js"],"name":"","async":false}
5:I{"id":9180,"chunks":["272:static/chunks/webpack-6ceb684ef8a65d5e.js","253:static/chunks/bce60fc1-8c4748991edb1ec4.js","698:static/chunks/698-a688277c97192edd.js"],"name":"default","async":false}
6:I{"id":2306,"chunks":["272:static/chunks/webpack-6ceb684ef8a65d5e.js","253:static/chunks/bce60fc1-8c4748991edb1ec4.js","698:static/chunks/698-a688277c97192edd.js"],"name":"default","async":false}
2:[["$","html",null,{"lang":"en","children":["$","body",null,{"children":[["$","div",null,{"style":{"marginBottom":100},"children":["$","$L4",null,{"href":"/","children":"Misc scribbles"}]}],["$","$L5",null,{"parallelRouterKey":"children","segmentPath":["children"],"error":"$undefined","errorStyles":"$undefined","loading":"$undefined","loadingStyles":"$undefined","hasLoading":false,"template":["$","$L6",null,{}],"templateStyles":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined","childProp":{"current":["$","$L5",null,{"parallelRouterKey":"children","segmentPath":["children","posts","children"],"error":"$undefined","errorStyles":"$undefined","loading":"$undefined","loadingStyles":"$undefined","hasLoading":false,"template":["$","$L6",null,{}],"templateStyles":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined","childProp":{"current":["$","$L5",null,{"parallelRouterKey":"children","segmentPath":["children","posts","children",["id","2021-10-30-spooky","d"],"children"],"error":"$undefined","errorStyles":"$undefined","loading":"$undefined","loadingStyles":"$undefined","hasLoading":false,"template":["$","$L6",null,{}],"templateStyles":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined","childProp":{"current":["$L7",null],"segment":"__PAGE__?{\"id\":\"2021-10-30-spooky\"}"},"styles":[]}],"segment":["id","2021-10-30-spooky","d"]},"styles":[]}],"segment":"posts"},"styles":[]}],["$","footer",null,{"style":{"marginTop":100},"children":[["$","$L4",null,{"href":"/","children":"Home"}]," ",["$","$L4",null,{"href":"/archive","children":"Blog archive"}]," ",["$","$L4",null,{"href":"https://github.com/cmdcolin/","children":"Github"}]," ",["$","$L4",null,{"href":"https://twitter.com/cmdcolin","children":"Twitter"}]," ",["$","$L4",null,{"href":"/projects","children":"Projects"}]," ",["$","$L4",null,{"href":"/photos","children":"Photos"}]," ",["$","$L4",null,{"href":"/about","children":"About"}]]}]]}]}],null]
9:I{"id":8298,"chunks":["722:static/chunks/app/posts/[id]/page-e495db9298e19bb0.js"],"name":"","async":false}
8:T1fbf,<p>Now gather round for a spooky story</p>
<p>Late one night... in the haunted office/castle the midnight candles were burning
bright and we entered data for a user file....</p>
<p>(hindenbugs cackling in the background, dusty technical books line the dark
shelves)</p>
<p>A simple 52MB gzipped datafile that we want to process in the browser. We unzip
it, decode it, and ... we see an error!!! <strong>LIGHTNING CRACKS</strong></p>
<p><img src="/media/pumpkin-dark.jpg" alt=""></p>
<p>But... our code is so simple (we of course abide by the religion of writing
"simple code" you know)...what could be happening?</p>
<p>The code looks like this</p>
<pre class="shiki poimandres" style="background-color: #1b1e28" tabindex="0"><code><span class="line"><span style="color: #91B4D5">const</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">buf</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FBD0">unzip</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">file</span><span style="color: #A6ACCD">)</span></span>
<span class="line"><span style="color: #91B4D5">const</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">str</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #5DE4C7">new</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FBD0">TextDecoder</span><span style="color: #A6ACCD">().</span><span style="color: #E4F0FBD0">decode</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">buf</span><span style="color: #A6ACCD">)</span></span></code></pre>
<p>We trace it back and run a <code>console.log(str)</code></p>
<p>It looks empty. We try running <code>console.log(str.length)</code> ... it prints out 0</p>
<p>But if we look at <code>console.log(buffer.length)</code> we get 546,483,710 bytes...</p>
<p>What could be happening?</p>
<p>We see in the <code>TextDecoder</code> documentation that it has a note called "fatal". We
try</p>
<pre class="shiki poimandres" style="background-color: #1b1e28" tabindex="0"><code><span class="line"><span style="color: #91B4D5">const</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">buf</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FBD0">unzip</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">file</span><span style="color: #A6ACCD">)</span></span>
<span class="line"><span style="color: #91B4D5">const</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">str</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #5DE4C7">new</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FBD0">TextDecoder</span><span style="color: #A6ACCD">(</span><span style="color: #A6ACCD">'</span><span style="color: #5DE4C7">utf8</span><span style="color: #A6ACCD">'</span><span style="color: #A6ACCD">, {</span><span style="color: #E4F0FB"> </span><span style="color: #ADD7FF">fatal</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #5DE4C7">true</span><span style="color: #ADD7FF"> </span><span style="color: #A6ACCD">}).</span><span style="color: #E4F0FBD0">decode</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">buf</span><span style="color: #A6ACCD">)</span></span></code></pre>
<p>This doesn't change the results though</p>
<p>Then it dawns on us while the lightning hits and the thunderclap booms and the
wind blows through the rattly windows</p>
<p>We have hit...the maximum string length in Chrome</p>
<p>BWAHAHAHAHA</p>
<p>The maximum string length!!! Nooooooo</p>
<p>It is 512MB on the dot... 536,870,888 bytes. We test this to be sure</p>
<pre class="shiki poimandres" style="background-color: #1b1e28" tabindex="0"><code><span class="line"><span style="color: #91B4D5">const</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">len</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #5DE4C7">536_870_888</span></span>
<span class="line"><span style="color: #91B4D5">const</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">buf</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #5DE4C7">new</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FBD0">Uint8Array</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">len</span><span style="color: #A6ACCD">)</span></span>
<span class="line"><span style="color: #A6ACCD">for (</span><span style="color: #91B4D5">let</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">i</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #5DE4C7">0</span><span style="color: #A6ACCD">; </span><span style="color: #E4F0FB">i</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">&#x3C;</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">len</span><span style="color: #A6ACCD">; </span><span style="color: #E4F0FB">i</span><span style="color: #91B4D5">++</span><span style="color: #A6ACCD">) {</span></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #E4F0FB">buf</span><span style="color: #A6ACCD">[</span><span style="color: #E4F0FB">i</span><span style="color: #A6ACCD">] </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #A6ACCD">'</span><span style="color: #5DE4C7">a</span><span style="color: #A6ACCD">'</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">charCodeAt</span><span style="color: #A6ACCD">(</span><span style="color: #5DE4C7">0</span><span style="color: #A6ACCD">)</span></span>
<span class="line"><span style="color: #A6ACCD">}</span></span>
<span class="line"><span style="color: #91B4D5">const</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">str</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #5DE4C7">new</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FBD0">TextDecoder</span><span style="color: #A6ACCD">().</span><span style="color: #E4F0FBD0">decode</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">buf</span><span style="color: #A6ACCD">)</span></span>
<span class="line"><span style="color: #E4F0FB">console</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">log</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">str</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FB">length</span><span style="color: #A6ACCD">)</span></span></code></pre>
<p>This is correct, outputs 536,870,888</p>
<p>With anything, even one byte more, it fails and outputs 0</p>
<p>happy halloween!!</p>
<p>pumpkin photo source:
<a href="http://mountainbikerak.blogspot.com/2010/11/google-chrome-pumpkin.html">http://mountainbikerak.blogspot.com/2010/11/google-chrome-pumpkin.html</a></p>
<ul>
<li>
<p>chrome 95 tested</p>
</li>
<li>
<p>nodejs 15 - at 512MB+1 bytes it prints an error message
<code>Error: Cannot create a string longer than 0x1fffffe8 characters</code> for
significantly greater than 512MB e.g. 600MB it actually prints a different
error
<code>TypeError [ERR_ENCODING_INVALID_ENCODED_DATA]: The encoded data was not valid for encoding utf-8</code>)</p>
</li>
<li>
<p>firefox 93 - goes up to ~1GB but then gives Exception
<code>{ name: "NS_ERROR_OUT_OF_MEMORY", message: "", result: 2147942414 }</code></p>
</li>
<li>
<p>midori 6 (safari-alike/webkit) - goes up to ~2GB fine! will have to test more</p>
</li>
</ul>7:["$","article",null,{"children":[["$","div",null,{"children":[["$","h1",null,{"children":"A spooky error when you have a string bigger than 512MB in Chrome"}],["$","h4",null,{"children":"2021-10-30"}]]}],["$","div",null,{"dangerouslySetInnerHTML":{"__html":"$8"}}],["$","$L9",null,{}]]}]
3:[["$","meta","0",{"charSet":"utf-8"}],["$","title","1",{"children":"A spooky error when you have a string bigger than 512MB in Chrome"}],["$","meta","2",{"name":"description","content":"A blog"}],["$","meta","3",{"name":"viewport","content":"width=device-width, initial-scale=1"}],["$","link","4",{"rel":"icon","href":"/favicon.ico","type":"image/x-icon","sizes":"any"}]]
