<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="description" content="Astro description"><meta name="viewport" content="width=device-width"><link rel="icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Astro v6.0.0-beta.1"><title>Killing postgres the hard way</title><style>.container[data-astro-cid-4oxc2zqz]{max-width:800px;margin:0 auto;padding:0 1rem}article[data-astro-cid-lvjzyg5v]{max-width:100%}.post-content[data-astro-cid-lvjzyg5v]{margin:2rem 0;line-height:1.6}
</style>
<link rel="stylesheet" href="/_astro/Layout.Ca4IH_rv.css"></head> <body> <div class="mb-8"> <a href="/">Misc scribbles</a> </div>  <div class="container" data-astro-cid-4oxc2zqz>  <article data-astro-cid-lvjzyg5v> <div data-astro-cid-lvjzyg5v> <h1 data-astro-cid-lvjzyg5v>Killing postgres the hard way</h1> <h4 data-astro-cid-lvjzyg5v>2015-10-22</h4> </div> <div class="post-content" data-astro-cid-lvjzyg5v> <p>So today, I finally decided to do something about a query that we saw had been
running for 25 DAYS on our server</p>
<p>Note: If you find this post and you need to follow the hard way, backup your
data first if possible.</p>
<p>First I could obviously see the culprit: each postgresql query runs it’s own
process so I could see in “htop” that there was this process that had been
running for 600 hours, or about 25 days</p>
<p>Next, I opened a psql console and ran this query:</p>
<pre><code class="language-sql"><a-k>SELECT</a-k> <a-v>datname</a-v><a-p>,</a-p><a-v>procpid</a-v><a-p>,</a-p><a-v>current_query</a-v> <a-k>FROM</a-k> <a-t>pg_stat_activity</a-t> <a-k>WHERE</a-k> <a-v>datname</a-v><a-o>=</a-o><a-s>'database_name'</a-s> <a-k>ORDER</a-k> <a-k>BY</a-k> <a-v>procpid</a-v> <a-p>;</a-p>
</code></pre>
<p>This returns which actual queries are being run on the database at any given
time. I could easily see the one problematic query being run, which was a badly
constructed intermine template query that resulted in a weird “recursion”
essentially.</p>
<p>I wanted to try just terminating this query itself, so I ran this</p>
<pre><code>SELECT pg_cancel_backend(29033);
</code></pre>
<p>Each time I ran it, it would say it returned one result but it did nothing.</p>
<p>I also read that you can try to nicely “kill” it from the command line (no kill
-9) so I ran</p>
<pre><code class="language-sh"><a-o>></a-o> kill <a-f>29033</a-f>
</code></pre>
<p>This also did not work!</p>
<p>I thought perhaps all these problems were because tomcat was still active, so we
shut down tomcat, and retried killing the specific query, but to no avail</p>
<p>At this point, I just wanted to restart the whole database server. Kind of a
risky move… but I am sort of a risky kind of guy…(that is not a good thing
with databases). If you are doing this, make backups! I didn’t. Luckily I
suffered no data loss but what follows is kind of intense.</p>
<p>So first, I try and stop the database service</p>
<pre><code class="language-sh"><a-o>></a-o> service <a-f>postgresql-9.1</a-f> stop
</code></pre>
<p>Unfortunately, this <code>[FAILED]</code> ! And of course, even though it failed, the
database is now unusable. No logging into it anymore, we have to go with the
hard way now…</p>
<p>Looking at /etc/init.d/postgres-9.1 told me that the service stop command was
effectively using something like this:</p>
<pre><code class="language-sh"><a-o>></a-o> pg_ctl <a-co>-D</a-co> /db/postgres/data <a-co>-m</a-co> fast stop
</code></pre>
<p>After some reading, I learned that you can try using a slightly different flag
to restart it</p>
<pre><code class="language-sh"><a-o>></a-o> pg_ctl <a-co>-D</a-co> /db/postgres/data <a-co>-m</a-co> immediate  stop
</code></pre>
<p>I ran this and to my horror/surprise, it actually worked! At this point I
decided to start postgresql back up again!</p>
<pre><code class="language-sh"><a-o>></a-o> service <a-f>postgresql-9.1</a-f> start
</code></pre>
<p>The service start quickly returned a SUCCESS, which was great, but then I tried
to start a psql console and the console froze on me! I could not even ctrl+c it!</p>
<p>I got really worried at this point and I looked at the process manager, and saw
that there was one postmaster process running but it was not clear what it was
doing. I actually tried to shutdown the server again in a panic mode but at this
point it said</p>
<pre><code class="language-sh"><a-o>></a-o> /usr/pgsql-9.1/bin/pg_ctl <a-f>stop</a-f> <a-co>-D</a-co> /db/postgres/data/ <a-co>-m</a-co> immediate
<a-o>></a-o> waiting <a-f>for</a-f> server to shut
<a-o>></a-o> down...............................................................
<a-o>></a-o> failed
</code></pre>
<p>It was probably good that it didn’t shut down, because I would quickly find out
that it was in recovery mode. I looked at the postgresql logs and I saw this,
reproduced here for full detail (from before the shutdown to the restart)</p>
<pre><code class="language-sh"><a-o>></a-o> WARNING:  <a-f>pgstat</a-f> wait timeout
<a-o>></a-o> WARNING:  <a-f>pgstat</a-f> wait timeout
<a-o>></a-o> WARNING:  <a-f>pgstat</a-f> wait timeout
<a-o>></a-o> WARNING:  <a-f>pgstat</a-f> wait timeout
<a-o>></a-o> WARNING:  <a-f>pgstat</a-f> wait timeout
<a-o>></a-o> WARNING:  <a-f>pgstat</a-f> wait timeout
<a-o>></a-o> WARNING:  <a-f>pgstat</a-f> wait timeout
<a-o>></a-o> WARNING:  <a-f>pgstat</a-f> wait timeout
<a-o>></a-o>
<a-o>></a-o> ERROR:  <a-f>canceling</a-f> statement due to user request
<a-o>></a-o> STATEMENT:  <a-f>CREATE</a-f> TABLE precomp_90519 AS SELECT DISTINCT a1_.id AS
<a-o>></a-o> a1_id, <a-f>a2_.id</a-f> AS a2_id, a3_.id AS a3_id, a4_.id AS a4_id,
<a-o>></a-o> a5_.id <a-f>AS</a-f> a5_id, a6_.id AS a6_id, a12_.id AS a12_id, a10_.id AS
<a-o>></a-o> a10_id, <a-f>a1_.id</a-f> AS a13_, a1_.primaryIdentifier AS a14_,
<a-o>></a-o> a1_.secondaryIdentifier <a-f>AS</a-f> a15_, a2_.type AS a16_, a3_.name AS
<a-o>></a-o> a17_, <a-f>a4_.primaryIdentifier</a-f> AS a18_, a5_.primaryIdentifier AS
<a-o>></a-o> a19_, <a-f>a6_.shortName</a-f> AS a20_, a12_.identifier AS a21_, a10_.code
<a-o>></a-o> AS <a-f>a22_</a-f> FROM Gene AS a1_, Homologue AS a2_, Organism AS a3_, Gene
<a-o>></a-o> AS <a-f>a4_,</a-f> Gene AS a5_, Organism AS a6_, GOAnnotation AS a7_,
<a-o>></a-o> GOEvidence <a-f>AS</a-f> a8_, OntologyTerm AS a9_, GOEvidenceCode AS a10_,
<a-o>></a-o> OntologyAnnotation <a-f>AS</a-f> a11_, OntologyTerm AS a12_, GeneGoAnnotation
<a-o>></a-o> AS <a-f>indirect0,</a-f> EvidenceGOAnnotation AS indirect1 WHERE a1_.id =
<a-o>></a-o> a2_.geneId <a-f>AND</a-f> a1_.organismId = a3_.id AND a2_.geneId = a4_.id
<a-o>></a-o> AND <a-f>a2_.homologueId</a-f> = a5_.id AND a5_.organismId = a6_.id AND
<a-o>></a-o> a1_.id <a-f>=</a-f> indirect0.Gene AND indirect0.GoAnnotation = a7_.id AND
<a-o>></a-o> a7_.id <a-f>=</a-f> indirect1.GOAnnotation AND indirect1.Evidence = a8_.id AND
<a-o>></a-o> a7_.ontologyTermId <a-f>=</a-f> a9_.id AND a8_.codeId = a10_.id AND a9_.id =
<a-o>></a-o> a11_.ontologyTermId <a-f>AND</a-f> a11_.ontologyTermId = a12_.id ORDER BY
<a-o>></a-o> a1_.primaryIdentifier, <a-f>a1_.secondaryIdentifier,</a-f> a2_.type,
<a-o>></a-o> a3_.name, <a-f>a4_.primaryIdentifier,</a-f> a5_.primaryIdentifier,
<a-o>></a-o> a6_.shortName, <a-f>a12_.identifier,</a-f> a10_.code, a1_.id, a2_.id,
<a-o>></a-o> a3_.id, <a-f>a4_.id,</a-f> a5_.id, a6_.id, a12_.id, a10_.id
<a-o>></a-o> LOG:  <a-f>could</a-f> not send data to client: Broken pipe
<a-o>></a-o> STATEMENT:  <a-f>CREATE</a-f> TABLE precomp_90519 AS SELECT DISTINCT a1_.id AS
<a-o>></a-o> a1_id, <a-f>a2_.id</a-f> AS a2_id, a3_.id AS a3_id, a4_.id AS a4_id,
<a-o>></a-o> a5_.id <a-f>AS</a-f> a5_id, a6_.id AS a6_id, a12_.id AS a12_id, a10_.id AS
<a-o>></a-o> a10_id, <a-f>a1_.id</a-f> AS a13_, a1_.primaryIdentifier AS a14_,
<a-o>></a-o> a1_.secondaryIdentifier <a-f>AS</a-f> a15_, a2_.type AS a16_, a3_.name AS
<a-o>></a-o> a17_, <a-f>a4_.primaryIdentifier</a-f> AS a18_, a5_.primaryIdentifier AS
<a-o>></a-o> a19_, <a-f>a6_.shortName</a-f> AS a20_, a12_.identifier AS a21_, a10_.code
<a-o>></a-o> AS <a-f>a22_</a-f> FROM Gene AS a1_, Homologue AS a2_, Organism AS a3_, Gene
<a-o>></a-o> AS <a-f>a4_,</a-f> Gene AS a5_, Organism AS a6_, GOAnnotation AS a7_,
<a-o>></a-o> GOEvidence <a-f>AS</a-f> a8_, OntologyTerm AS a9_, GOEvidenceCode AS a10_,
<a-o>></a-o> OntologyAnnotation <a-f>AS</a-f> a11_, OntologyTerm AS a12_, GeneGoAnnotation
<a-o>></a-o> AS <a-f>indirect0,</a-f> EvidenceGOAnnotation AS indirect1 WHERE a1_.id =
<a-o>></a-o> a2_.geneId <a-f>AND</a-f> a1_.organismId = a3_.id AND a2_.geneId = a4_.id
<a-o>></a-o> AND <a-f>a2_.homologueId</a-f> = a5_.id AND a5_.organismId = a6_.id AND
<a-o>></a-o> a1_.id <a-f>=</a-f> indirect0.Gene AND indirect0.GoAnnotation = a7_.id AND
<a-o>></a-o> a7_.id <a-f>=</a-f> indirect1.GOAnnotation AND indirect1.Evidence = a8_.id AND
<a-o>></a-o> a7_.ontologyTermId <a-f>=</a-f> a9_.id AND a8_.codeId = a10_.id AND a9_.id =
<a-o>></a-o> a11_.ontologyTermId <a-f>AND</a-f> a11_.ontologyTermId = a12_.id ORDER BY
<a-o>></a-o> a1_.primaryIdentifier, <a-f>a1_.secondaryIdentifier,</a-f> a2_.type,
<a-o>></a-o> a3_.name, <a-f>a4_.primaryIdentifier,</a-f> a5_.primaryIdentifier,
<a-o>></a-o> a6_.shortName, <a-f>a12_.identifier,</a-f> a10_.code, a1_.id, a2_.id,
<a-o>></a-o> a3_.id, <a-f>a4_.id,</a-f> a5_.id, a6_.id, a12_.id, a10_.id
<a-o>></a-o> LOG:  <a-f>unexpected</a-f> EOF on client connection
<a-o>></a-o> LOG:  <a-f>unexpected</a-f> EOF on client connection
<a-o>></a-o> LOG:  <a-f>unexpected</a-f> EOF on client connection
<a-o>></a-o> LOG:  <a-f>unexpected</a-f> EOF on client connection
<a-o>></a-o> LOG:  <a-f>received</a-f> fast shutdown request
<a-o>></a-o> LOG:  <a-f>aborting</a-f> any active transactions
<a-o>></a-o> LOG:  <a-f>autovacuum</a-f> launcher shutting down
<a-o>></a-o> FATAL:  <a-f>the</a-f> database system is shutting down
<a-o>></a-o> FATAL:  <a-f>the</a-f> database system is shutting down
<a-o>></a-o> FATAL:  <a-f>the</a-f> database system is shutting down
<a-o>></a-o> FATAL:  <a-f>the</a-f> database system is shutting down
<a-o>></a-o> FATAL:  <a-f>the</a-f> database system is shutting down
<a-o>></a-o> FATAL:  <a-f>the</a-f> database system is shutting down
<a-o>></a-o> FATAL:  <a-f>the</a-f> database system is shutting down
<a-o>></a-o> FATAL:  <a-f>the</a-f> database system is shutting down
<a-o>></a-o> FATAL:  <a-f>the</a-f> database system is shutting down
<a-o>></a-o> FATAL:  <a-f>the</a-f> database system is shutting down
<a-o>></a-o> FATAL:  <a-f>the</a-f> database system is shutting down
<a-o>></a-o> FATAL:  <a-f>the</a-f> database system is shutting down
<a-o>></a-o> FATAL:  <a-f>the</a-f> database system is shutting down
<a-o>></a-o> FATAL:  <a-f>the</a-f> database system is shutting down
<a-o>></a-o> FATAL:  <a-f>the</a-f> database system is shutting down
<a-o>></a-o> FATAL:  <a-f>the</a-f> database system is shutting down
<a-o>></a-o> FATAL:  <a-f>the</a-f> database system is shutting down
<a-o>></a-o> FATAL:  <a-f>the</a-f> database system is shutting down
<a-o>></a-o> FATAL:  <a-f>the</a-f> database system is shutting down
<a-o>></a-o> FATAL:  <a-f>the</a-f> database system is shutting down
<a-o>></a-o> FATAL:  <a-f>the</a-f> database system is shutting down
<a-o>></a-o> FATAL:  <a-f>the</a-f> database system is shutting down
<a-o>></a-o> FATAL:  <a-f>the</a-f> database system is shutting down
<a-o>></a-o> FATAL:  <a-f>the</a-f> database system is shutting down
<a-o>></a-o> FATAL:  <a-f>the</a-f> database system is shutting down
<a-o>></a-o> FATAL:  <a-f>the</a-f> database system is shutting down
<a-o>></a-o> LOG:  <a-f>received</a-f> immediate shutdown request
<a-o>></a-o> WARNING:  <a-f>terminating</a-f> connection because of crash of another server
<a-o>></a-o> process
<a-o>></a-o> DETAIL:  <a-f>The</a-f> postmaster has commanded this server process to roll back
<a-o>></a-o> the <a-f>current</a-f> transaction and exit, because another server process
<a-o>></a-o> exited <a-f>abnormally</a-f> and possibly corrupted shared memory.
<a-o>></a-o> HINT:  <a-f>In</a-f> a moment you should be able to reconnect to the database and
<a-o>></a-o> repeat <a-f>your</a-f> command.
<a-o>></a-o> LOG:  <a-f>received</a-f> fast shutdown request
<a-o>></a-o> LOG:  <a-f>database</a-f> system was interrupted; <a-f>last</a-f> known up at 2015-10-22
<a-o>></a-o> 15:47:43 <a-f>CDT</a-f>
<a-o>></a-o> LOG:  <a-f>received</a-f> immediate shutdown request
<a-o>></a-o> LOG:  <a-f>database</a-f> system was interrupted; <a-f>last</a-f> known up at 2015-10-22
<a-o>></a-o> 15:47:43 <a-f>CDT</a-f>
<a-o>></a-o> LOG:  <a-f>database</a-f> system was not properly shut down; <a-f>automatic</a-f> recovery
<a-o>></a-o> in <a-f>progress</a-f>
<a-o>></a-o> LOG:  <a-f>record</a-f> with zero length at BBD/1CC2F0C0
<a-o>></a-o> ...
</code></pre>
<p>You can see all the weird activity that was done here</p>
<ul>
<li>first the attempt to “canceling statement due to user request” did not work</li>
<li>then the database stop using -m fast</li>
<li>then the database stop using -m immediate</li>
<li>the restart (with the HINT, should be ready soon)</li>
<li>the panic mode where i tried to shut it again anyways</li>
</ul>
<p>During the recovery period, I was still very concerned about the database was
doing, so I used “strace” to look at the main postmaster process.</p>
<p>I was pleasantly surprised to see that the postmaster process was just cleaning
up files in /db/postgres/data/base/pgsql_tmp/, I could see the file system
“unlink” command with successful status codes.</p>
<p>There were about 150 large files in /db/postgres/data/base/pgsql_tmp/, and I
waited about an hour for them to be deleted, and after that, the postgresql log
file said it was ready, and indeed, it was perfect :)</p>
<pre><code class="language-sh"><a-o>></a-o> LOG:  <a-f>redo</a-f> is not required
<a-o>></a-o> LOG:  <a-f>database</a-f> system is ready to accept connections
<a-o>></a-o> LOG:  <a-f>autovacuum</a-f> launcher started
</code></pre>
<p>What a relief!</p>
<p>I hope this might help any wayward stragglers to see how the postgresql restart
process works. Sometimes things don’t shut down cleanly, but I think it is still
good to know some alternative steps to kill -9</p>
<h2 id="footnote">Footnote</h2>
<p>This all happened right before the demo of our project to some stakeholders (it
was a small academic lab project, but still crucial!) so that made it extra
scary</p> </div> <div id="giscus"></div> <script>
  const script = document.createElement('script');
  script.src = 'https://giscus.app/client.js';
  script.setAttribute('data-repo', 'cmdcolin/cmdcolin.github.io');
  script.setAttribute('data-repo-id', 'MDEwOlJlcG9zaXRvcnkyNjE0OTY3Nw==');
  script.setAttribute('data-category', 'General');
  script.setAttribute('data-category-id', 'DIC_kwDOAY8DLc4CO-L9');
  script.setAttribute('data-mapping', 'pathname');
  script.setAttribute('data-strict', '0');
  script.setAttribute('data-reactions-enabled', '1');
  script.setAttribute('data-emit-metadata', '0');
  script.setAttribute('data-input-position', 'bottom');
  script.setAttribute('data-theme', 'light');
  script.setAttribute('data-lang', 'en');
  script.setAttribute('crossorigin', 'anonymous');
  script.async = true;
  document.getElementById('giscus').appendChild(script);
</script> </article>  </div>   <footer class="footer-style" data-astro-cid-k2f5zb5c> <a class="footer-link" href="/" data-astro-cid-k2f5zb5c>Home</a> <a class="footer-link" href="/archive" data-astro-cid-k2f5zb5c>Blog archive</a> <a class="footer-link" href="https://github.com/cmdcolin/" data-astro-cid-k2f5zb5c>Github</a> <a class="footer-link" href="/projects" data-astro-cid-k2f5zb5c>Projects</a> <a class="footer-link" href="/about" data-astro-cid-k2f5zb5c>About</a> </footer> </body></html> 