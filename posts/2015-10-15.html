<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><link rel="stylesheet" href="/_next/static/css/97dc5fe527f5d592.css" data-precedence="next"/><link rel="preload" href="/_next/static/chunks/webpack-40edba06f6f71edb.js" as="script"/><link rel="preload" href="/_next/static/chunks/fd9d1056-442c50ae6fbbd388.js" as="script"/><link rel="preload" href="/_next/static/chunks/596-ed3b1820f7e6eb53.js" as="script"/><link rel="preload" href="/_next/static/chunks/main-app-a0a3ace046004cf7.js" as="script"/><title>Tomcat memory debugging</title><meta name="description" content="A blog"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="icon" href="/favicon.ico" type="image/x-icon" sizes="any"/><script src="/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js" noModule=""></script></head><body><div style="margin-bottom:100px"><a href="/">Misc scribbles</a></div><article><div><h1>Tomcat memory debugging</h1><h4>2015-10-15</h4></div><div><p>In my previous posts, I speculated about the issues that were causing server lag
and CPU usage spiking with tomcat:
<a href="https://cmdcolin.github.io/posts/2015-09-16">https://cmdcolin.github.io/posts/2015-09-16</a></p>
<p>Unfortunately, I was completely wrong in my speculations, but we increased
tomcat memory limits so that the entire Lucene search index could fit in memory,
which was able to fix the spiky CPU problems.</p>
<p>Luckily, fixing the memory issues had very good implications for our webapp:</p>
<p>I have a cron job uses a simple curl command to grab different pages on the
website, and then it logs the time taken to a output file. I charted these
output times, before and after we increased the memory limits of tomcat, and it
turned out that the response time of the webapp was dramatically improved by
this change.</p>
<p><img src="/media/131229569383_0.png" alt=""></p>
<p>Figure 1. The webapp response time was extremely variable before the redeploy on
Oct 2nd where we increased tomcat's memory allocation, which thereafter
dramatically improved the response time.</p>
<p>Clearly, the webapp response time was being severely compromised by the memory
issues.</p>
<p>In response to all of these issues, I also added GC logging to the tomcat
configuration so that I can see if the GC is correlated with these webapp
response time. Figure 2 shows how high GC activity is correlated with longer
webapp response times, but note that this figure was made after the other memory
allocation problems were fixed, so it is still much better than the problems we
had in the past.</p>
<p><img src="/media/131229569383_1.png" alt=""></p>
<p>Figure 2. After increasing the memory, you can see webapp response time is much
better, except if the GC activity becomes very high, and then this increases the
response time.</p>
<p>Edit: Bonus screenshot, seemingly each friday we get a majoy activity burst that
triggers GC activity!</p>
<p><img src="/media/131229569383_2.png" alt=""></p>
<p>Figure 3. Crazy Java GC activity on a friday night, but the app seems to recover
from it</p>
<h2 id="conclusion"><a aria-hidden="true" tabindex="-1" href="#conclusion"><a href="#conclusion" style="margin-right: 10px">#</a></a>Conclusion</h2>
<p>Increasing the memory allocation to java and tomcat allows the entire system to
perform much better. If you can afford to get more memory to allocate to tomcat,
then it's probably a good idea.</p>
<p>Also, tracking your webapp response times will help you see if your changes are
having a good effect. I made this a script for graphing log outputs here
<a href="https://github.com/cmdcolin/loggraph">https://github.com/cmdcolin/loggraph</a></p>
<p>PS:</p>
<p>If your tomcat is running as the tomcat user, then it can be difficult to debug
the memory problems simply with the "get heap dump" from jvisualvm, because the
permissions will be wrong. To fix this, try using a privileged user to run the
jmap command:</p>
<pre><code>runuser -l tomcat -c "/usr/java/latest/bin/jmap-dump:format=b,file=/db/tomcat/tomcat.dump 25543"
</code></pre></div><div style="margin-top:200px"></div></article><footer style="margin-top:100px"><a href="/">Home</a> <a href="/archive">Blog archive</a> <a href="https://github.com/cmdcolin/">Github</a> <a href="https://twitter.com/cmdcolin">Twitter</a> <a href="/projects">Projects</a> <a href="/photos">Photos</a> <a href="/about">About</a></footer><script src="/_next/static/chunks/webpack-40edba06f6f71edb.js" async=""></script><script src="/_next/static/chunks/fd9d1056-442c50ae6fbbd388.js" async=""></script><script src="/_next/static/chunks/596-ed3b1820f7e6eb53.js" async=""></script><script src="/_next/static/chunks/main-app-a0a3ace046004cf7.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:HL[\"/_next/static/css/97dc5fe527f5d592.css\",{\"as\":\"style\"}]\n0:\"$L2\"\n"])</script><script>self.__next_f.push([1,"3:I{\"id\":7948,\"chunks\":[\"272:static/chunks/webpack-40edba06f6f71edb.js\",\"971:static/chunks/fd9d1056-442c50ae6fbbd388.js\",\"596:static/chunks/596-ed3b1820f7e6eb53.js\"],\"name\":\"default\",\"async\":false}\n5:I{\"id\":6628,\"chunks\":[\"272:static/chunks/webpack-40edba06f6f71edb.js\",\"971:static/chunks/fd9d1056-442c50ae6fbbd388.js\",\"596:static/chunks/596-ed3b1820f7e6eb53.js\"],\"name\":\"GlobalError\",\"async\":false}\n6:I{\"id\":6685,\"chunks\":[\"685:static/chunks/685-ccbb7d7ff1945e5d.js\",\"185:static/chunks/app/layout-3759995e3b279a"])</script><script>self.__next_f.push([1,"75.js\"],\"name\":\"\",\"async\":false}\n7:I{\"id\":7767,\"chunks\":[\"272:static/chunks/webpack-40edba06f6f71edb.js\",\"971:static/chunks/fd9d1056-442c50ae6fbbd388.js\",\"596:static/chunks/596-ed3b1820f7e6eb53.js\"],\"name\":\"default\",\"async\":false}\n8:I{\"id\":7920,\"chunks\":[\"272:static/chunks/webpack-40edba06f6f71edb.js\",\"971:static/chunks/fd9d1056-442c50ae6fbbd388.js\",\"596:static/chunks/596-ed3b1820f7e6eb53.js\"],\"name\":\"default\",\"async\":false}\n"])</script><script>self.__next_f.push([1,"2:[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/97dc5fe527f5d592.css\",\"precedence\":\"next\"}]],[\"$\",\"$L3\",null,{\"buildId\":\"qFPe4n-4LEM7FzAwOaTL6\",\"assetPrefix\":\"\",\"initialCanonicalUrl\":\"/posts/2015-10-15\",\"initialTree\":[\"\",{\"children\":[\"posts\",{\"children\":[[\"id\",\"2015-10-15\",\"d\"],{\"children\":[\"__PAGE__?{\\\"id\\\":\\\"2015-10-15\\\"}\",{}]}]}]},\"$undefined\",\"$undefined\",true],\"initialHead\":\"$L4\",\"globalErrorComponent\":\"$5\",\"children\":[[\"$\",\"html\",null,{\"lang\":\"en\",\"children\":[\"$\",\"body\",null,{\"children\":[[\"$\",\"div\",null,{\"style\":{\"marginBottom\":100},\"children\":[\"$\",\"$L6\",null,{\"href\":\"/\",\"children\":\"Misc scribbles\"}]}],[\"$\",\"$L7\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"template\":[\"$\",\"$L8\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"childProp\":{\"current\":[\"$\",\"$L7\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"posts\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"template\":[\"$\",\"$L8\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"childProp\":{\"current\":[\"$\",\"$L7\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"posts\",\"children\",[\"id\",\"2015-10-15\",\"d\"],\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"template\":[\"$\",\"$L8\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"childProp\":{\"current\":[\"$L9\",null],\"segment\":\"__PAGE__?{\\\"id\\\":\\\"2015-10-15\\\"}\"},\"styles\":[]}],\"segment\":[\"id\",\"2015-10-15\",\"d\"]},\"styles\":[]}],\"segment\":\"posts\"},\"styles\":[]}],[\"$\",\"footer\",null,{\"style\":{\"marginTop\":100},\"children\":[[\"$\",\"$L6\",null,{\"href\":\"/\",\"children\":\"Home\"}],\" \",[\"$\",\"$L6\",null,{\"href\":\"/archive\",\"children\":\"Blog archive\"}],\" \",[\"$\",\"$L6\",null,{\"href\":\"https://github.com/cmdcolin/\",\"children\":\"Github\"}],\" \",[\"$\",\"$L6\",null,{\"href\":\"https://twitter.com/cmdcolin\",\"children\":\"Twitter\"}],\" \",[\"$\",\"$L6\",null,{\"href\":\"/projects\",\"children\":\"Projects\"}],\" \",[\"$\",\"$L6\",null,{\"href\":\"/photos\",\"children\":\"Photos\"}],\" \",[\"$\",\"$L6\",null,{\"href\":\"/about\",\"children\":\"About\"}]]}]]}]}],null]}]]\n"])</script><script>self.__next_f.push([1,"b:I{\"id\":6306,\"chunks\":[\"722:static/chunks/app/posts/[id]/page-8cf76b3c924a344e.js\"],\"name\":\"\",\"async\":false}\na:Tc0d,"])</script><script>self.__next_f.push([1,"\u003cp\u003eIn my previous posts, I speculated about the issues that were causing server lag\nand CPU usage spiking with tomcat:\n\u003ca href=\"https://cmdcolin.github.io/posts/2015-09-16\"\u003ehttps://cmdcolin.github.io/posts/2015-09-16\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eUnfortunately, I was completely wrong in my speculations, but we increased\ntomcat memory limits so that the entire Lucene search index could fit in memory,\nwhich was able to fix the spiky CPU problems.\u003c/p\u003e\n\u003cp\u003eLuckily, fixing the memory issues had very good implications for our webapp:\u003c/p\u003e\n\u003cp\u003eI have a cron job uses a simple curl command to grab different pages on the\nwebsite, and then it logs the time taken to a output file. I charted these\noutput times, before and after we increased the memory limits of tomcat, and it\nturned out that the response time of the webapp was dramatically improved by\nthis change.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/media/131229569383_0.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003eFigure 1. The webapp response time was extremely variable before the redeploy on\nOct 2nd where we increased tomcat's memory allocation, which thereafter\ndramatically improved the response time.\u003c/p\u003e\n\u003cp\u003eClearly, the webapp response time was being severely compromised by the memory\nissues.\u003c/p\u003e\n\u003cp\u003eIn response to all of these issues, I also added GC logging to the tomcat\nconfiguration so that I can see if the GC is correlated with these webapp\nresponse time. Figure 2 shows how high GC activity is correlated with longer\nwebapp response times, but note that this figure was made after the other memory\nallocation problems were fixed, so it is still much better than the problems we\nhad in the past.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/media/131229569383_1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003eFigure 2. After increasing the memory, you can see webapp response time is much\nbetter, except if the GC activity becomes very high, and then this increases the\nresponse time.\u003c/p\u003e\n\u003cp\u003eEdit: Bonus screenshot, seemingly each friday we get a majoy activity burst that\ntriggers GC activity!\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/media/131229569383_2.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003eFigure 3. Crazy Java GC activity on a friday night, but the app seems to recover\nfrom it\u003c/p\u003e\n\u003ch2 id=\"conclusion\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#conclusion\"\u003e\u003ca href=\"#conclusion\" style=\"margin-right: 10px\"\u003e#\u003c/a\u003e\u003c/a\u003eConclusion\u003c/h2\u003e\n\u003cp\u003eIncreasing the memory allocation to java and tomcat allows the entire system to\nperform much better. If you can afford to get more memory to allocate to tomcat,\nthen it's probably a good idea.\u003c/p\u003e\n\u003cp\u003eAlso, tracking your webapp response times will help you see if your changes are\nhaving a good effect. I made this a script for graphing log outputs here\n\u003ca href=\"https://github.com/cmdcolin/loggraph\"\u003ehttps://github.com/cmdcolin/loggraph\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003ePS:\u003c/p\u003e\n\u003cp\u003eIf your tomcat is running as the tomcat user, then it can be difficult to debug\nthe memory problems simply with the \"get heap dump\" from jvisualvm, because the\npermissions will be wrong. To fix this, try using a privileged user to run the\njmap command:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003erunuser -l tomcat -c \"/usr/java/latest/bin/jmap-dump:format=b,file=/db/tomcat/tomcat.dump 25543\"\n\u003c/code\u003e\u003c/pre\u003e"])</script><script>self.__next_f.push([1,"9:[\"$\",\"article\",null,{\"children\":[[\"$\",\"div\",null,{\"children\":[[\"$\",\"h1\",null,{\"children\":\"Tomcat memory debugging\"}],[\"$\",\"h4\",null,{\"children\":\"2015-10-15\"}]]}],[\"$\",\"div\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"$a\"}}],[\"$\",\"$Lb\",null,{}]]}]\n"])</script><script>self.__next_f.push([1,"4:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"1\",{\"children\":\"Tomcat memory debugging\"}],[\"$\",\"meta\",\"2\",{\"name\":\"description\",\"content\":\"A blog\"}],[\"$\",\"meta\",\"3\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"link\",\"4\",{\"rel\":\"icon\",\"href\":\"/favicon.ico\",\"type\":\"image/x-icon\",\"sizes\":\"any\"}]]\n"])</script></body></html>