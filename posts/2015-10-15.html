<!DOCTYPE html><html lang="en"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Tomcat memory debugging</title><meta name="next-head-count" content="3"/><link rel="shortcut icon" href="favicon.ico"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><meta name="description" content="Blogging for the future"/><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/prism.min.js" integrity="sha512-hpZ5pDCF2bRCweL5WoA0/N1elet1KYL5mx3LP555Eg/0ZguaHawxNvEjF6O3rufAChs16HVNhEc6blF/rZoowQ==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="preload" href="/_next/static/css/0e13ae09fdc48bba.css" as="style"/><link rel="stylesheet" href="/_next/static/css/0e13ae09fdc48bba.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-3e9e72f6d5fa0854.js" defer=""></script><script src="/_next/static/chunks/framework-a87821de553db91d.js" defer=""></script><script src="/_next/static/chunks/main-896947e153b7d53e.js" defer=""></script><script src="/_next/static/chunks/pages/_app-d6e6a35eb3960502.js" defer=""></script><script src="/_next/static/chunks/996-9e3c12b77542c098.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-23a4b3bec5e8663d.js" defer=""></script><script src="/_next/static/lKCWASVHDT8FufeUgy1sw/_buildManifest.js" defer=""></script><script src="/_next/static/lKCWASVHDT8FufeUgy1sw/_ssgManifest.js" defer=""></script><script src="/_next/static/lKCWASVHDT8FufeUgy1sw/_middlewareManifest.js" defer=""></script></head><body><div id="__next"><div><main><div><div style="margin-bottom:100px"><a href="/">Misc scribbles</a></div><article><div><h1>Tomcat memory debugging</h1><h4>2015-10-15</h4></div><p>In my previous posts, I speculated about the issues that were causing
CPU usage spiking with
tomcat: http://searchvoidstar.tumblr.com/post/129241954103/fixing-spiky-cpu-issues-with-tomcat</p>
<!-- --><p>Unfortunately, I was completely wrong in my speculations, but we
increased tomcat memory limits so that the entire Lucene search index
could fit in memory, which was able to fix the spiky CPU problems.</p>
<!-- --><p>Luckily, fixing the memory issues had very good implications for our
webapp:</p>
<!-- --><p>I have a cron job uses a simple curl command to grab different pages on
the website, and then it logs the time taken to a output file. I charted
these output times, before and after we increased the memory limits of
tomcat, and it turned out that the response time of the webapp was
dramatically improved by this change.</p>
<!-- --><p><img src="/media/131229569383_0.png" alt=""/></p>
<!-- --><p>Figure 1. The webapp response time was extremely variable before the
redeploy on Oct 2nd where we increased tomcat&#x27;s memory allocation, which
thereafter dramatically improved the response time.</p>
<!-- --><p>Clearly, the webapp response time was being severely compromised by the
memory issues.</p>
<!-- --><p>In response to all of these issues, I also added GC logging to the
tomcat configuration so that I can see if the GC is correlated with
these webapp response time. Figure 2 shows how high GC activity is
correlated with longer webapp response times, but note that this figure
was made after the other memory allocation problems were fixed, so it is
still much better than the problems we had in the past.</p>
<!-- --><p><img src="/media/131229569383_1.png" alt=""/></p>
<!-- --><p>Figure 2. After increasing the memory, you can see webapp response time
is much better, except if the GC activity becomes very high, and then
this increases the response time.</p>
<!-- --><p>Edit: Bonus screenshot, seemingly each friday we get a majoy activity
burst that triggers GC activity!</p>
<!-- --><p><img src="/media/131229569383_2.png" alt=""/></p>
<!-- --><p>Figure 3. Crazy Java GC activity on a friday night, but the app seems to
recover from it</p>
<!-- --><h2>Conclusion</h2>
<!-- --><p>Increasing the memory allocation to java and tomcat allows the entire
system to perform much better. If you can afford to get more memory to
allocate to tomcat, then it&#x27;s probably a good idea.</p>
<!-- --><p>Also, tracking your webapp response times will help you see if your
changes are having a good effect. I made this a script for graphing log
outputs here https://github.com/cmdcolin/loggraph</p>
<!-- --><p>PS:</p>
<!-- --><p>If your tomcat is running as the tomcat user, then it can be difficult
to debug the memory problems simply with the &quot;get heap dump&quot; from
jvisualvm, because the permissions will be wrong. To fix this, try using
a privileged user to run the jmap command:</p>
<!-- --><p>runuser -l tomcat -c &quot;/usr/java/latest/bin/jmap-dump:format=b,file=/db/tomcat/tomcat.dump 25543&quot;</p><div style="margin-top:200px"></div></article></div></main></div><footer style="margin-top:100px"><a href="/">Home</a> <!-- --><a href="/archive">Blog archive</a> <!-- --><a href="https://github.com/cmdcolin/">Github</a> <!-- --><a href="https://twitter.com/cmdcolin">Twitter</a> <!-- --><a href="/projects">Projects</a> <!-- --><a href="/photos">Photos</a> <!-- --><a href="/rss.xml">RSS</a><a href="/about">About</a> <!-- --></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"Tomcat memory debugging","date":"2015-10-15","slug":"2015-10-15","mdxSource":{"compiledSource":"/*@jsxRuntime automatic @jsxImportSource react*/\nconst {Fragment: _Fragment, jsx: _jsx, jsxs: _jsxs} = arguments[0];\nconst {useMDXComponents: _provideComponents} = arguments[0];\nfunction MDXContent(props = {}) {\n  const {wrapper: MDXLayout} = Object.assign({}, _provideComponents(), props.components);\n  return MDXLayout ? _jsx(MDXLayout, Object.assign({}, props, {\n    children: _jsx(_createMdxContent, {})\n  })) : _createMdxContent();\n  function _createMdxContent() {\n    const _components = Object.assign({\n      p: \"p\",\n      img: \"img\",\n      h2: \"h2\"\n    }, _provideComponents(), props.components);\n    return _jsxs(_Fragment, {\n      children: [_jsx(_components.p, {\n        children: \"In my previous posts, I speculated about the issues that were causing\\nCPU usage spiking with\\ntomcat: http://searchvoidstar.tumblr.com/post/129241954103/fixing-spiky-cpu-issues-with-tomcat\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"Unfortunately, I was completely wrong in my speculations, but we\\nincreased tomcat memory limits so that the entire Lucene search index\\ncould fit in memory, which was able to fix the spiky CPU problems.\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"Luckily, fixing the memory issues had very good implications for our\\nwebapp:\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"I have a cron job uses a simple curl command to grab different pages on\\nthe website, and then it logs the time taken to a output file. I charted\\nthese output times, before and after we increased the memory limits of\\ntomcat, and it turned out that the response time of the webapp was\\ndramatically improved by this change.\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: _jsx(_components.img, {\n          src: \"/media/131229569383_0.png\",\n          alt: \"\"\n        })\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"Figure 1. The webapp response time was extremely variable before the\\nredeploy on Oct 2nd where we increased tomcat's memory allocation, which\\nthereafter dramatically improved the response time.\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"Clearly, the webapp response time was being severely compromised by the\\nmemory issues.\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"In response to all of these issues, I also added GC logging to the\\ntomcat configuration so that I can see if the GC is correlated with\\nthese webapp response time. Figure 2 shows how high GC activity is\\ncorrelated with longer webapp response times, but note that this figure\\nwas made after the other memory allocation problems were fixed, so it is\\nstill much better than the problems we had in the past.\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: _jsx(_components.img, {\n          src: \"/media/131229569383_1.png\",\n          alt: \"\"\n        })\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"Figure 2. After increasing the memory, you can see webapp response time\\nis much better, except if the GC activity becomes very high, and then\\nthis increases the response time.\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"Edit: Bonus screenshot, seemingly each friday we get a majoy activity\\nburst that triggers GC activity!\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: _jsx(_components.img, {\n          src: \"/media/131229569383_2.png\",\n          alt: \"\"\n        })\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"Figure 3. Crazy Java GC activity on a friday night, but the app seems to\\nrecover from it\"\n      }), \"\\n\", _jsx(_components.h2, {\n        children: \"Conclusion\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"Increasing the memory allocation to java and tomcat allows the entire\\nsystem to perform much better. If you can afford to get more memory to\\nallocate to tomcat, then it's probably a good idea.\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"Also, tracking your webapp response times will help you see if your\\nchanges are having a good effect. I made this a script for graphing log\\noutputs here https://github.com/cmdcolin/loggraph\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"PS:\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"If your tomcat is running as the tomcat user, then it can be difficult\\nto debug the memory problems simply with the \\\"get heap dump\\\" from\\njvisualvm, because the permissions will be wrong. To fix this, try using\\na privileged user to run the jmap command:\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"runuser -l tomcat -c \\\"/usr/java/latest/bin/jmap-dump:format=b,file=/db/tomcat/tomcat.dump 25543\\\"\"\n      })]\n    });\n  }\n}\nreturn {\n  default: MDXContent\n};\n","frontmatter":{},"scope":{}}}},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"2015-10-15"},"buildId":"lKCWASVHDT8FufeUgy1sw","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>