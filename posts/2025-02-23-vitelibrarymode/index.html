<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="description" content="Astro description"><meta name="viewport" content="width=device-width"><link rel="icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Astro v5.16.6"><title>Vite library mode bundles your library&#39;s dependencies (which I don&#39;t think is good for libraries published to NPM)</title><style>.container[data-astro-cid-4oxc2zqz]{max-width:800px;margin:0 auto;padding:0 1rem}article[data-astro-cid-lvjzyg5v]{max-width:100%}.post-content[data-astro-cid-lvjzyg5v]{margin:2rem 0;line-height:1.6}
.footer-style[data-astro-cid-k2f5zb5c]{margin-top:4rem}.footer-link[data-astro-cid-k2f5zb5c]{margin:.5rem}body{font-family:Helvetica,Arial,sans-serif;background-color:Canvas;color:CanvasText;color-scheme:light dark;overflow-wrap:break-word}img{max-width:100%}pre{max-width:100%;overflow:auto}li+li{margin-top:10px}pre{padding:10px;border-radius:5px}
</style></head> <body> <div class="mb-8"> <a href="/">Misc scribbles</a> </div>  <div class="container" data-astro-cid-4oxc2zqz>  <article data-astro-cid-lvjzyg5v> <div data-astro-cid-lvjzyg5v> <h1 data-astro-cid-lvjzyg5v>Vite library mode bundles your library&#39;s dependencies (which I don&#39;t think is good for libraries published to NPM)</h1> <h4 data-astro-cid-lvjzyg5v>2025-02-23</h4> </div> <div class="post-content" data-astro-cid-lvjzyg5v> <p><img src="/chiblets.jpg" alt="my cats"></p>
<p>Vite is a very popular “build tool” for making all sorts of javascript apps. It
is most commonly used for making single page apps, but it also has a feature
called <a href="https://vite.dev/guide/build#library-mode">“library mode”</a> which helps
you publish things that you have written on NPM. I imagine it is much less
commonly used than vite itself, but I wanted to comment on it because it has a
behavior I’m not a big fan of…</p>
<h2 id="vite-library-mode-completely-minifiesbundles-all-your-dependencies">Vite library mode completely minifies+bundles all your dependencies</h2>
<p>For example, if your library that is using vite library mode has</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> leftPad </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> 'left-pad'</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> str</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> leftPad</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'foobar'</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">6</span><span style="color:#E1E4E8">)</span></span></code></pre>
<p>then it is turned into this in the dist folder by vite library mode</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#F97583">function</span><span style="color:#B392F0"> d</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">t</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">  return</span><span style="color:#E1E4E8"> t </span><span style="color:#F97583">&#x26;&#x26;</span><span style="color:#E1E4E8"> t.__esModule </span><span style="color:#F97583">&#x26;&#x26;</span><span style="color:#79B8FF"> Object</span><span style="color:#E1E4E8">.</span><span style="color:#79B8FF">prototype</span><span style="color:#E1E4E8">.hasOwnProperty.</span><span style="color:#B392F0">call</span><span style="color:#E1E4E8">(t, </span><span style="color:#9ECBFF">'default'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">    ?</span><span style="color:#E1E4E8"> t.default</span></span>
<span class="line"><span style="color:#F97583">    :</span><span style="color:#E1E4E8"> t</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"><span style="color:#F97583">var</span><span style="color:#E1E4E8"> f, o</span></span>
<span class="line"><span style="color:#F97583">function</span><span style="color:#B392F0"> n</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">  if</span><span style="color:#E1E4E8"> (o) </span><span style="color:#F97583">return</span><span style="color:#E1E4E8"> f</span></span>
<span class="line"><span style="color:#E1E4E8">  ;((o </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">), (f </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> i))</span></span>
<span class="line"><span style="color:#F97583">  var</span><span style="color:#E1E4E8"> t </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [</span></span>
<span class="line"><span style="color:#9ECBFF">    ''</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">    ' '</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">    '  '</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">    '   '</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">    '    '</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">    '     '</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">    '      '</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">    '       '</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">    '        '</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">    '         '</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">  ]</span></span>
<span class="line"><span style="color:#F97583">  function</span><span style="color:#B392F0"> i</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">a</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">r</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">e</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (((a </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> a </span><span style="color:#F97583">+</span><span style="color:#9ECBFF"> ''</span><span style="color:#E1E4E8">), (r </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> r </span><span style="color:#F97583">-</span><span style="color:#E1E4E8"> a.</span><span style="color:#79B8FF">length</span><span style="color:#E1E4E8">), r </span><span style="color:#F97583">&#x3C;=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">)) </span><span style="color:#F97583">return</span><span style="color:#E1E4E8"> a</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> ((</span><span style="color:#F97583">!</span><span style="color:#E1E4E8">e </span><span style="color:#F97583">&#x26;&#x26;</span><span style="color:#E1E4E8"> e </span><span style="color:#F97583">!==</span><span style="color:#79B8FF"> 0</span><span style="color:#F97583"> &#x26;&#x26;</span><span style="color:#E1E4E8"> (e </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> ' '</span><span style="color:#E1E4E8">), (e </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> e </span><span style="color:#F97583">+</span><span style="color:#9ECBFF"> ''</span><span style="color:#E1E4E8">), e </span><span style="color:#F97583">===</span><span style="color:#9ECBFF"> ' '</span><span style="color:#F97583"> &#x26;&#x26;</span><span style="color:#E1E4E8"> r </span><span style="color:#F97583">&#x3C;</span><span style="color:#79B8FF"> 10</span><span style="color:#E1E4E8">))</span></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#E1E4E8"> t[r] </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> a</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">var</span><span style="color:#E1E4E8"> u </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> ''</span><span style="color:#E1E4E8">; r </span><span style="color:#F97583">&#x26;</span><span style="color:#79B8FF"> 1</span><span style="color:#F97583"> &#x26;&#x26;</span><span style="color:#E1E4E8"> (u </span><span style="color:#F97583">+=</span><span style="color:#E1E4E8"> e), (r </span><span style="color:#F97583">>>=</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">), r; ) e </span><span style="color:#F97583">+=</span><span style="color:#E1E4E8"> e</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> u </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> a</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#F97583">  return</span><span style="color:#E1E4E8"> f</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"><span style="color:#F97583">var</span><span style="color:#79B8FF"> P</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> n</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> l</span><span style="color:#F97583"> =</span><span style="color:#6A737D"> /* @__PURE__ */</span><span style="color:#B392F0"> d</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">P</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#B392F0">l</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'foobar'</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">6</span><span style="color:#E1E4E8">)</span></span></code></pre>
<p>yes, that’s the left-pad source code, inlined into your library’s distribution</p>
<p>I personally believe this is bad. It could have just put this into the dist
folder:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> leftPad </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> 'left-pad'</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> str</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> leftPad</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'foobar'</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">6</span><span style="color:#E1E4E8">)</span></span></code></pre>
<p>then, any consumer of your library can trace the import from your library to
left-pad, which is responsibly declared in your package.json “dependencies”, and
everything is fine and normal.</p>
<p>But this is not how vite library mode does it, so I must construct some strawmen
to wonder why anyone would do this</p>
<h3 id="why-someone-might-bundle-their-dependencies-they-upload-to-npm">Why someone might bundle their dependencies they upload to NPM</h3>
<ul>
<li>They are anti-toolchain enthusiasts or appeasing anti-toolchain
enthusiasts/luddites/non-JS users and want a single javascript file that they
can put in a script tag, from unpkg or similar</li>
<li>They think they are helping against supply chain attacks by bundling all their
dependencies to a fixed version. After all, left-pad happened one time</li>
<li>They don’t realize they are doing it</li>
</ul>
<h3 id="why-someone-might-minify-the-things-they-upload-to-npm">Why someone might minify the things they upload to NPM</h3>
<ul>
<li>They are anti-toolchain enthusiasts (see above) and yet they want the optimal
byte size savings from minification</li>
<li>They feel deeply connected to memes about node_modules folders being a black
hole and think minifying might help</li>
<li>They feel bad for NPMs servers having to serve so much data, and think
minifying could help save the internet (see articles titled “I saved NPM from
serving 440gb per week by removing THIS ONE LINER”)</li>
<li>They like inscrutable things</li>
</ul>
<p>(you can likely toggle minification in vite library mode settings, but it
minifies by default)</p>
<h3 id="why-i-think-it-is-bad-to-bundle-your-dependencies-for-artifacts-that-you-upload-to-npm">Why I think it is bad to bundle your dependencies for artifacts that you upload to NPM</h3>
<ul>
<li>Consumers of your library will not get semver updates from your
sub-dependencies</li>
<li>Consumers might think they are getting semver updates from your
sub-dependencies if you list these in the “dependencies” in your package.json,
but since you effectively hard-coded the particular version at build time via
bundling, they are not getting the updates</li>
<li>They may end up with duplicate dependencies, that could even be incompatible
in insane ways</li>
<li>The vite library technique only (to my knowledge) has the technique of
one-by-one externalizing dependencies e.g. only externalize React. Personal
note: I really don’t like this. Why do you think that you externalize React in
particular? Yes, it is because having multiple versions of React on a page
causes the most insane error messages the world has ever seen. I only wrote
this blogpost because of one of these errors. I wasn’t able to consume a plain
old function component that I exported from a package I tried to make with
vite library mode.</li>
<li>Users of your library will have very little recourse to fix the issue
(particularly combined with the minification), so they will not be able to use
a yarn <code>resolution</code> to lock to a working version or use <code>yarn link</code> to get a
patched version</li>
<li>Couple more reasons listed here
<a href="https://cmdcolin.github.io/posts/2022-05-27-youmaynotneedabundler#why-would-you-not-want-a-bundler-for-your-library">https://cmdcolin.github.io/posts/2022-05-27-youmaynotneedabundler#why-would-you-not-want-a-bundler-for-your-library</a></li>
</ul>
<h3 id="why-i-think-it-is-bad-to-minify-the-libraries-that-you-upload-to-npm">Why I think it is bad to minify the libraries that you upload to NPM</h3>
<ul>
<li>It is an obscure mess that is difficult to inspect</li>
<li>Consumers of the app should do minification if they need it</li>
</ul>
<h2 id="conclusions">Conclusions</h2>
<p>I am a dependencies apologist. I like libraries, they do good things for me, and
I enjoy getting regular bugfixes and improvements. I like good library hygiene</p>
<p>I have previously written about why you may NOT need a bundler for your library
here <a href="https://cmdcolin.github.io/posts/2022-05-27-youmaynotneedabundler">https://cmdcolin.github.io/posts/2022-05-27-youmaynotneedabundler</a>.</p>
<p>I also wrote a small article about a bundler-less way to make a pure-ESM
typescript packages here <a href="https://cmdcolin.github.io/posts/2025-01-12-pureesm">https://cmdcolin.github.io/posts/2025-01-12-pureesm</a></p>
<h2 id="footnote-1">Footnote 1</h2>
<p>I am not trying to pick on vite here. They do great work for the community. I
bet many other quickstart NPM library creation kits have this same trouble (e.g.
from my list <a href="https://cmdcolin.github.io/posts/2022-05-27-youmaynotneedabundler">https://cmdcolin.github.io/posts/2022-05-27-youmaynotneedabundler</a>)</p>
<p>For example, the first one on that list, microbundle, has a full wiki page to
justify doing things this way, but has even more complex subtle behavior
<a href="https://github.com/developit/microbundle/wiki/How-Microbundle-decides-which-dependencies-to-bundle">https://github.com/developit/microbundle/wiki/How-Microbundle-decides-which-dependencies-to-bundle</a></p>
<h2 id="footnote-2">Footnote 2</h2>
<p>I changed the title to explicitly say that I think it is bad for libraries that
are published to NPM.</p>
<p>If you want to make a single file build that people can use in script tag, then
you can use it</p> </div> <div id="giscus"></div> <script>
  const script = document.createElement('script');
  script.src = 'https://giscus.app/client.js';
  script.setAttribute('data-repo', 'cmdcolin/cmdcolin.github.io');
  script.setAttribute('data-repo-id', 'MDEwOlJlcG9zaXRvcnkyNjE0OTY3Nw==');
  script.setAttribute('data-category', 'General');
  script.setAttribute('data-category-id', 'DIC_kwDOAY8DLc4CO-L9');
  script.setAttribute('data-mapping', 'pathname');
  script.setAttribute('data-strict', '0');
  script.setAttribute('data-reactions-enabled', '1');
  script.setAttribute('data-emit-metadata', '0');
  script.setAttribute('data-input-position', 'bottom');
  script.setAttribute('data-theme', 'light');
  script.setAttribute('data-lang', 'en');
  script.setAttribute('crossorigin', 'anonymous');
  script.async = true;
  document.getElementById('giscus').appendChild(script);
</script> </article>  </div>   <footer class="footer-style" data-astro-cid-k2f5zb5c> <a class="footer-link" href="/" data-astro-cid-k2f5zb5c>Home</a> <a class="footer-link" href="/archive" data-astro-cid-k2f5zb5c>Blog archive</a> <a class="footer-link" href="https://github.com/cmdcolin/" data-astro-cid-k2f5zb5c>Github</a> <a class="footer-link" href="/projects" data-astro-cid-k2f5zb5c>Projects</a> <a class="footer-link" href="/about" data-astro-cid-k2f5zb5c>About</a> </footer> </body></html> 