<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>Creating a music player using Rust/GTK4 - fml9000</title><meta name="next-head-count" content="3"/><link rel="shortcut icon" href="favicon.ico"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><meta name="description" content="Blogging for the future"/><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/prism.min.js" integrity="sha512-hpZ5pDCF2bRCweL5WoA0/N1elet1KYL5mx3LP555Eg/0ZguaHawxNvEjF6O3rufAChs16HVNhEc6blF/rZoowQ==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="preload" href="/_next/static/css/50853c3f2e0364c3.css" as="style"/><link rel="stylesheet" href="/_next/static/css/50853c3f2e0364c3.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-93aa87d657ed1852.js" defer=""></script><script src="/_next/static/chunks/framework-c0d8f0fd2eea5ac1.js" defer=""></script><script src="/_next/static/chunks/main-b12cd062888056b2.js" defer=""></script><script src="/_next/static/chunks/pages/_app-d9139de5c3de3b6b.js" defer=""></script><script src="/_next/static/chunks/996-3d2a4318c0ac6f1a.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-b6f09b4db8bfc341.js" defer=""></script><script src="/_next/static/GwYozH6bTo82t2bxbLL9n/_buildManifest.js" defer=""></script><script src="/_next/static/GwYozH6bTo82t2bxbLL9n/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div><main><div><div style="margin-bottom:100px"><a href="/">Misc scribbles</a></div><article><div><h1>Creating a music player using Rust/GTK4 - fml9000</h1><h4>2022-09-05</h4></div><div><p>I have started endeavoring to learn Rust. I did the rustlings exercises but I
knew the concepts would fade rapidly from my brain without some practice. I
have now started making a music player using Rust+GTK4.</p>
<p>I chose GTK4 to have a linux native GUI music player. Particularly, I have a
particular foobar2000 setup that I wanted to emulate. I have used foobar2000
under wine (windows emulator on linux) and it's not terrible, but it has
background CPU consumption of about 15% idle and doesn't feel quite right
sometimes. I have used a variety of other linux music players such as quodlibet
(GUI/GTK based) and cmus (command line) but they didn't really feel quite
right.</p>
<h3 id="choosing-a-tech-stack"><a aria-hidden="true" tabindex="-1" href="#choosing-a-tech-stack"><a href="#choosing-a-tech-stack" style="margin-right: 10px">#</a></a>Choosing a tech stack</h3>
<p>I started by attempting with <code>Relm4</code>, which I may return to at some point, but
trying to juggle learning Relm4-style widgets, GTK, and rust all at once was a
bit much. I stepped to using <code>gtk4-rs</code> directly.</p>
<h3 id="trying-to-create-a-spreadsheet-style-or-data-grid-of-tracks"><a aria-hidden="true" tabindex="-1" href="#trying-to-create-a-spreadsheet-style-or-data-grid-of-tracks"><a href="#trying-to-create-a-spreadsheet-style-or-data-grid-of-tracks" style="margin-right: 10px">#</a></a>Trying to create a "spreadsheet style" or data grid of tracks</h3>
<p>Then, I wanted to create a data grid showing to display e.g. a table with
artist, track, album, etc. I chose to use the GTK
<a href="https://docs.gtk.org/gtk4/class.ColumnView.html"><code>ColumnView</code></a> to drive this.
I stumbled around looking for example code, but there was none specifically for
the <code>ColumnView</code>. I also realized the <code>ListView</code> example from the <code>gtk4-rs</code>
examples with it's factory function had similar needs that the <code>ColumnView</code>.</p>
<h3 id="how-set-up-the-columnview"><a aria-hidden="true" tabindex="-1" href="#how-set-up-the-columnview"><a href="#how-set-up-the-columnview" style="margin-right: 10px">#</a></a>How set up the <code>ColumnView</code></h3>
<p>I found out that I basically needed to create a <code>ListStore</code>. I thought if
I could make my own <code>GObject</code> subclass, it would solve everything, but I had
trouble getting making this work (rust doesn't have the concept of extending a
class for one thing, you implement various traits instead). Finally, I randomly
stumbled on this link using a <code>BoxedAnyObject</code> with a good example of storing
data in a ListStore
<a href="https://gtk-rs.org/gtk-rs-core/git/docs/glib/struct.BoxedAnyObject.html">https://gtk-rs.org/gtk-rs-core/git/docs/glib/struct.BoxedAnyObject.html</a></p>
<p>The <code>BoxedAnyObject</code> is a <code>GObject</code>, so this was an good route to storing the
<code>ListView</code> items.</p>
<h3 id="accessing-the-liststore-in-the-columnview-factory-function"><a aria-hidden="true" tabindex="-1" href="#accessing-the-liststore-in-the-columnview-factory-function"><a href="#accessing-the-liststore-in-the-columnview-factory-function" style="margin-right: 10px">#</a></a>Accessing the <code>ListStore</code> in the <code>ColumnView</code> factory function</h3>
<p>There was no example code for this so I stuggled for awhile before realizing
that the ListView example in the gtk4-rs codebase has similar concepts (factory
to create grid cells, etc).</p>
<h3 id="creating-a-pr-to-the-gtk4-rs-repo-to-demonstrate-example-columnview-usage"><a aria-hidden="true" tabindex="-1" href="#creating-a-pr-to-the-gtk4-rs-repo-to-demonstrate-example-columnview-usage"><a href="#creating-a-pr-to-the-gtk4-rs-repo-to-demonstrate-example-columnview-usage" style="margin-right: 10px">#</a></a>Creating a PR to the <code>gtk4-rs</code> repo to demonstrate example ColumnView usage</h3>
<p>I created a PR (<a href="https://github.com/gtk-rs/gtk4-rs/pull/1111">https://github.com/gtk-rs/gtk4-rs/pull/1111</a>) to demonstrate
simple ColumnView usage. The code review that was given on the PR was
excellent. They explained how to simplify the code I submitted so that each
grid cell was very minimal (starting from a <code>gtk::Box</code> with a <code>gtk::Label</code>
inside of it, to just being a <code>gtk::Inscription</code> which is very fast). Big
thanks to the team for helping out with this!</p>
<p>After this hurdle was crossed, I felt much more comfortable in the GTK mindset,
and I quickly fleshed out some more UI for the app
a</p>
<h3 id="choosing-a-audio-tech-stack"><a aria-hidden="true" tabindex="-1" href="#choosing-a-audio-tech-stack"><a href="#choosing-a-audio-tech-stack" style="margin-right: 10px">#</a></a>Choosing a audio tech stack</h3>
<p>To actually play audio, I looked at a couple options. There was even one option
called Gtk::MediaFile which should to be able to play e.g. mp3s, making my job
of making a media player much simpler, but it produced an error <a href="https://www.google.com/search?q=%22GTK+could+not+find+a+media+module.+Check+your+installation.%22&#x26;oq=%22GTK+could+not+find+a+media+module.+Check+your+installation.%22&#x26;aqs=chrome..69i57.267j0j7&#x26;sourceid=chrome&#x26;ie=UTF-8">"GTK could not
find a media module. Check your
installation."</a>
which had very few references on the internet. I figured this could be difficult to solve or point to issues I could face later on making minimal executables for usersSo</p>
<p>So, next I tried out symphonia (<a href="https://github.com/pdeljanov/Symphonia/">https://github.com/pdeljanov/Symphonia/</a>), with
the hope being that it is easier to package these for consumers of the app.
This requires a lot more code to work (~1000 lines so far, copying from the
<code>symphonia-play</code> example).</p>
<h3 id="reading-audio-metadata-and-storing-in-a-sqlite-database"><a aria-hidden="true" tabindex="-1" href="#reading-audio-metadata-and-storing-in-a-sqlite-database"><a href="#reading-audio-metadata-and-storing-in-a-sqlite-database" style="margin-right: 10px">#</a></a>Reading audio metadata and storing in a sqlite database</h3>
<p>I also wanted to have the option of reading and writing metadata. Symphonia
only reads metadata, so I used the <code>lofty</code> crate to read metadata for now. I
also realized that reading tens of thousands of file's metadata at each app
startup would be slow, so I endeavored to store that data in an sqlite
database. I found that music players like foobar2000 and 0xdeadbeef have
databases of track metadata also (Example folder on foobar2000 (1.x) for this
snap/foobar2000/433/foobar2000/profile/library/74E45640B1C695CC/meta-0001,
meta-0002, etc.)</p>
<p>I used the <code>walkdir</code> crate to walk a directory for files, <code>lofty</code> to read the
metadata, and then finally inserted the data into the sqlite db.</p>
<h3 id="learning-about-reference-counting-and-move-semantics"><a aria-hidden="true" tabindex="-1" href="#learning-about-reference-counting-and-move-semantics"><a href="#learning-about-reference-counting-and-move-semantics" style="margin-right: 10px">#</a></a>Learning about reference counting and move semantics</h3>
<p>Originally I queried the sqlite database and stored a Vec, where Track
is a struct with artist, album, song title, etc. I realized that this causes
issues passing this around to different functions, and storing them in the
BoxedAnyObject, (example thread discussing issue
<a href="https://stackoverflow.com/questions/42954008/how-to-pass-one-vec-to-multiple-functions-in-rust">https://stackoverflow.com/questions/42954008/how-to-pass-one-vec-to-multiple-functions-in-rust</a>)
so I changed functions to accept slices of the Vec, and to make it a
Vec&#x3C;Rc> instead of just Vec (another related thread
<a href="https://users.rust-lang.org/t/self-has-an-anonymous-lifetime-but-it-needs-to-satisfy-a-static-lifetime-requirement/58641/3">https://users.rust-lang.org/t/self-has-an-anonymous-lifetime-but-it-needs-to-satisfy-a-static-lifetime-requirement/58641/3</a>).</p>
<h3 id="result"><a aria-hidden="true" tabindex="-1" href="#result"><a href="#result" style="margin-right: 10px">#</a></a>Result</h3>
<p>The current work is at <a href="https://github.com/cmdcolin/fml9000">https://github.com/cmdcolin/fml9000</a></p>
<p><img src="/media/fml9000_1.png" alt=""></p>
<p>Screenshot shows the current look and feel. Some stuff in the screenshot is
mocked and not fully functional, but it has been a great learning experience
thus far</p></div><div style="margin-top:200px"></div></article></div></main></div><footer style="margin-top:100px"><a href="/">Home</a> <a href="/archive">Blog archive</a> <a href="https://github.com/cmdcolin/">Github</a> <a href="https://twitter.com/cmdcolin">Twitter</a> <a href="/projects">Projects</a> <a href="/photos">Photos</a> <a href="/rss.xml">RSS</a><a href="/about">About</a> </footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"Creating a music player using Rust/GTK4 - fml9000","date":"2022-09-05","slug":"2022-09-05-rustmusicplayer","html":"\u003cp\u003eI have started endeavoring to learn Rust. I did the rustlings exercises but I\nknew the concepts would fade rapidly from my brain without some practice. I\nhave now started making a music player using Rust+GTK4.\u003c/p\u003e\n\u003cp\u003eI chose GTK4 to have a linux native GUI music player. Particularly, I have a\nparticular foobar2000 setup that I wanted to emulate. I have used foobar2000\nunder wine (windows emulator on linux) and it's not terrible, but it has\nbackground CPU consumption of about 15% idle and doesn't feel quite right\nsometimes. I have used a variety of other linux music players such as quodlibet\n(GUI/GTK based) and cmus (command line) but they didn't really feel quite\nright.\u003c/p\u003e\n\u003ch3 id=\"choosing-a-tech-stack\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#choosing-a-tech-stack\"\u003e\u003ca href=\"#choosing-a-tech-stack\" style=\"margin-right: 10px\"\u003e#\u003c/a\u003e\u003c/a\u003eChoosing a tech stack\u003c/h3\u003e\n\u003cp\u003eI started by attempting with \u003ccode\u003eRelm4\u003c/code\u003e, which I may return to at some point, but\ntrying to juggle learning Relm4-style widgets, GTK, and rust all at once was a\nbit much. I stepped to using \u003ccode\u003egtk4-rs\u003c/code\u003e directly.\u003c/p\u003e\n\u003ch3 id=\"trying-to-create-a-spreadsheet-style-or-data-grid-of-tracks\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#trying-to-create-a-spreadsheet-style-or-data-grid-of-tracks\"\u003e\u003ca href=\"#trying-to-create-a-spreadsheet-style-or-data-grid-of-tracks\" style=\"margin-right: 10px\"\u003e#\u003c/a\u003e\u003c/a\u003eTrying to create a \"spreadsheet style\" or data grid of tracks\u003c/h3\u003e\n\u003cp\u003eThen, I wanted to create a data grid showing to display e.g. a table with\nartist, track, album, etc. I chose to use the GTK\n\u003ca href=\"https://docs.gtk.org/gtk4/class.ColumnView.html\"\u003e\u003ccode\u003eColumnView\u003c/code\u003e\u003c/a\u003e to drive this.\nI stumbled around looking for example code, but there was none specifically for\nthe \u003ccode\u003eColumnView\u003c/code\u003e. I also realized the \u003ccode\u003eListView\u003c/code\u003e example from the \u003ccode\u003egtk4-rs\u003c/code\u003e\nexamples with it's factory function had similar needs that the \u003ccode\u003eColumnView\u003c/code\u003e.\u003c/p\u003e\n\u003ch3 id=\"how-set-up-the-columnview\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#how-set-up-the-columnview\"\u003e\u003ca href=\"#how-set-up-the-columnview\" style=\"margin-right: 10px\"\u003e#\u003c/a\u003e\u003c/a\u003eHow set up the \u003ccode\u003eColumnView\u003c/code\u003e\u003c/h3\u003e\n\u003cp\u003eI found out that I basically needed to create a \u003ccode\u003eListStore\u003c/code\u003e. I thought if\nI could make my own \u003ccode\u003eGObject\u003c/code\u003e subclass, it would solve everything, but I had\ntrouble getting making this work (rust doesn't have the concept of extending a\nclass for one thing, you implement various traits instead). Finally, I randomly\nstumbled on this link using a \u003ccode\u003eBoxedAnyObject\u003c/code\u003e with a good example of storing\ndata in a ListStore\n\u003ca href=\"https://gtk-rs.org/gtk-rs-core/git/docs/glib/struct.BoxedAnyObject.html\"\u003ehttps://gtk-rs.org/gtk-rs-core/git/docs/glib/struct.BoxedAnyObject.html\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003eBoxedAnyObject\u003c/code\u003e is a \u003ccode\u003eGObject\u003c/code\u003e, so this was an good route to storing the\n\u003ccode\u003eListView\u003c/code\u003e items.\u003c/p\u003e\n\u003ch3 id=\"accessing-the-liststore-in-the-columnview-factory-function\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#accessing-the-liststore-in-the-columnview-factory-function\"\u003e\u003ca href=\"#accessing-the-liststore-in-the-columnview-factory-function\" style=\"margin-right: 10px\"\u003e#\u003c/a\u003e\u003c/a\u003eAccessing the \u003ccode\u003eListStore\u003c/code\u003e in the \u003ccode\u003eColumnView\u003c/code\u003e factory function\u003c/h3\u003e\n\u003cp\u003eThere was no example code for this so I stuggled for awhile before realizing\nthat the ListView example in the gtk4-rs codebase has similar concepts (factory\nto create grid cells, etc).\u003c/p\u003e\n\u003ch3 id=\"creating-a-pr-to-the-gtk4-rs-repo-to-demonstrate-example-columnview-usage\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#creating-a-pr-to-the-gtk4-rs-repo-to-demonstrate-example-columnview-usage\"\u003e\u003ca href=\"#creating-a-pr-to-the-gtk4-rs-repo-to-demonstrate-example-columnview-usage\" style=\"margin-right: 10px\"\u003e#\u003c/a\u003e\u003c/a\u003eCreating a PR to the \u003ccode\u003egtk4-rs\u003c/code\u003e repo to demonstrate example ColumnView usage\u003c/h3\u003e\n\u003cp\u003eI created a PR (\u003ca href=\"https://github.com/gtk-rs/gtk4-rs/pull/1111\"\u003ehttps://github.com/gtk-rs/gtk4-rs/pull/1111\u003c/a\u003e) to demonstrate\nsimple ColumnView usage. The code review that was given on the PR was\nexcellent. They explained how to simplify the code I submitted so that each\ngrid cell was very minimal (starting from a \u003ccode\u003egtk::Box\u003c/code\u003e with a \u003ccode\u003egtk::Label\u003c/code\u003e\ninside of it, to just being a \u003ccode\u003egtk::Inscription\u003c/code\u003e which is very fast). Big\nthanks to the team for helping out with this!\u003c/p\u003e\n\u003cp\u003eAfter this hurdle was crossed, I felt much more comfortable in the GTK mindset,\nand I quickly fleshed out some more UI for the app\na\u003c/p\u003e\n\u003ch3 id=\"choosing-a-audio-tech-stack\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#choosing-a-audio-tech-stack\"\u003e\u003ca href=\"#choosing-a-audio-tech-stack\" style=\"margin-right: 10px\"\u003e#\u003c/a\u003e\u003c/a\u003eChoosing a audio tech stack\u003c/h3\u003e\n\u003cp\u003eTo actually play audio, I looked at a couple options. There was even one option\ncalled Gtk::MediaFile which should to be able to play e.g. mp3s, making my job\nof making a media player much simpler, but it produced an error \u003ca href=\"https://www.google.com/search?q=%22GTK+could+not+find+a+media+module.+Check+your+installation.%22\u0026#x26;oq=%22GTK+could+not+find+a+media+module.+Check+your+installation.%22\u0026#x26;aqs=chrome..69i57.267j0j7\u0026#x26;sourceid=chrome\u0026#x26;ie=UTF-8\"\u003e\"GTK could not\nfind a media module. Check your\ninstallation.\"\u003c/a\u003e\nwhich had very few references on the internet. I figured this could be difficult to solve or point to issues I could face later on making minimal executables for usersSo\u003c/p\u003e\n\u003cp\u003eSo, next I tried out symphonia (\u003ca href=\"https://github.com/pdeljanov/Symphonia/\"\u003ehttps://github.com/pdeljanov/Symphonia/\u003c/a\u003e), with\nthe hope being that it is easier to package these for consumers of the app.\nThis requires a lot more code to work (~1000 lines so far, copying from the\n\u003ccode\u003esymphonia-play\u003c/code\u003e example).\u003c/p\u003e\n\u003ch3 id=\"reading-audio-metadata-and-storing-in-a-sqlite-database\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#reading-audio-metadata-and-storing-in-a-sqlite-database\"\u003e\u003ca href=\"#reading-audio-metadata-and-storing-in-a-sqlite-database\" style=\"margin-right: 10px\"\u003e#\u003c/a\u003e\u003c/a\u003eReading audio metadata and storing in a sqlite database\u003c/h3\u003e\n\u003cp\u003eI also wanted to have the option of reading and writing metadata. Symphonia\nonly reads metadata, so I used the \u003ccode\u003elofty\u003c/code\u003e crate to read metadata for now. I\nalso realized that reading tens of thousands of file's metadata at each app\nstartup would be slow, so I endeavored to store that data in an sqlite\ndatabase. I found that music players like foobar2000 and 0xdeadbeef have\ndatabases of track metadata also (Example folder on foobar2000 (1.x) for this\nsnap/foobar2000/433/foobar2000/profile/library/74E45640B1C695CC/meta-0001,\nmeta-0002, etc.)\u003c/p\u003e\n\u003cp\u003eI used the \u003ccode\u003ewalkdir\u003c/code\u003e crate to walk a directory for files, \u003ccode\u003elofty\u003c/code\u003e to read the\nmetadata, and then finally inserted the data into the sqlite db.\u003c/p\u003e\n\u003ch3 id=\"learning-about-reference-counting-and-move-semantics\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#learning-about-reference-counting-and-move-semantics\"\u003e\u003ca href=\"#learning-about-reference-counting-and-move-semantics\" style=\"margin-right: 10px\"\u003e#\u003c/a\u003e\u003c/a\u003eLearning about reference counting and move semantics\u003c/h3\u003e\n\u003cp\u003eOriginally I queried the sqlite database and stored a Vec, where Track\nis a struct with artist, album, song title, etc. I realized that this causes\nissues passing this around to different functions, and storing them in the\nBoxedAnyObject, (example thread discussing issue\n\u003ca href=\"https://stackoverflow.com/questions/42954008/how-to-pass-one-vec-to-multiple-functions-in-rust\"\u003ehttps://stackoverflow.com/questions/42954008/how-to-pass-one-vec-to-multiple-functions-in-rust\u003c/a\u003e)\nso I changed functions to accept slices of the Vec, and to make it a\nVec\u0026#x3C;Rc\u003e instead of just Vec (another related thread\n\u003ca href=\"https://users.rust-lang.org/t/self-has-an-anonymous-lifetime-but-it-needs-to-satisfy-a-static-lifetime-requirement/58641/3\"\u003ehttps://users.rust-lang.org/t/self-has-an-anonymous-lifetime-but-it-needs-to-satisfy-a-static-lifetime-requirement/58641/3\u003c/a\u003e).\u003c/p\u003e\n\u003ch3 id=\"result\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#result\"\u003e\u003ca href=\"#result\" style=\"margin-right: 10px\"\u003e#\u003c/a\u003e\u003c/a\u003eResult\u003c/h3\u003e\n\u003cp\u003eThe current work is at \u003ca href=\"https://github.com/cmdcolin/fml9000\"\u003ehttps://github.com/cmdcolin/fml9000\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/media/fml9000_1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003eScreenshot shows the current look and feel. Some stuff in the screenshot is\nmocked and not fully functional, but it has been a great learning experience\nthus far\u003c/p\u003e"}},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"2022-09-05-rustmusicplayer"},"buildId":"GwYozH6bTo82t2bxbLL9n","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>