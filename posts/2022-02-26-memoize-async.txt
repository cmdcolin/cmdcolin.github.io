0:[[["",{"children":["posts",{"children":[["id","2022-02-26-memoize-async","d"],{"children":["__PAGE__?{\"id\":\"2022-02-26-memoize-async\"}",{}]}]}]},"$undefined","$undefined",true],"$L1","$L2"]]
3:I{"id":"3619","name":"","chunks":["619:619-d3e80a47715091a2","931:app/page-59752a1737368847"],"async":false}
4:I{"id":"1300","name":"","chunks":["272:webpack-3224743bbfce757e","667:2443530c-7c83a1ec49cb3fce","961:961-0b7193e5f574b882"],"async":false}
5:I{"id":"6022","name":"","chunks":["272:webpack-3224743bbfce757e","667:2443530c-7c83a1ec49cb3fce","961:961-0b7193e5f574b882"],"async":false}
1:[["$","html",null,{"lang":"en","children":["$","body",null,{"children":[["$","div",null,{"style":{"marginBottom":100},"children":["$","$L3",null,{"href":"/","children":"Misc scribbles"}]}],["$","$L4",null,{"parallelRouterKey":"children","segmentPath":["children"],"error":"$undefined","errorStyles":"$undefined","loading":"$undefined","loadingStyles":"$undefined","hasLoading":false,"template":["$","$L5",null,{}],"templateStyles":"$undefined","notFound":[["$","title",null,{"children":"404: This page could not be found."}],["$","div",null,{"style":{"fontFamily":"system-ui,\"Segoe UI\",Roboto,Helvetica,Arial,sans-serif,\"Apple Color Emoji\",\"Segoe UI Emoji\"","height":"100vh","textAlign":"center","display":"flex","flexDirection":"column","alignItems":"center","justifyContent":"center"},"children":["$","div",null,{"children":[["$","style",null,{"dangerouslySetInnerHTML":{"__html":"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}"}}],["$","h1",null,{"className":"next-error-h1","style":{"display":"inline-block","margin":"0 20px 0 0","padding":"0 23px 0 0","fontSize":24,"fontWeight":500,"verticalAlign":"top","lineHeight":"49px"},"children":"404"}],["$","div",null,{"style":{"display":"inline-block"},"children":["$","h2",null,{"style":{"fontSize":14,"fontWeight":400,"lineHeight":"49px","margin":0},"children":"This page could not be found."}]}]]}]}]],"notFoundStyles":"$undefined","asNotFound":false,"childProp":{"current":["$","$L4",null,{"parallelRouterKey":"children","segmentPath":["children","posts","children"],"error":"$undefined","errorStyles":"$undefined","loading":"$undefined","loadingStyles":"$undefined","hasLoading":false,"template":["$","$L5",null,{}],"templateStyles":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined","asNotFound":false,"childProp":{"current":["$","$L4",null,{"parallelRouterKey":"children","segmentPath":["children","posts","children",["id","2022-02-26-memoize-async","d"],"children"],"error":"$undefined","errorStyles":"$undefined","loading":"$undefined","loadingStyles":"$undefined","hasLoading":false,"template":["$","$L5",null,{}],"templateStyles":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined","asNotFound":false,"childProp":{"current":["$L6","$@7"],"segment":"__PAGE__?{\"id\":\"2022-02-26-memoize-async\"}"}}],"segment":["id","2022-02-26-memoize-async","d"]}}],"segment":"posts"}}],["$","footer",null,{"style":{"marginTop":100},"children":[["$","$L3",null,{"href":"/","children":"Home"}]," ",["$","$L3",null,{"href":"/archive","children":"Blog archive"}]," ",["$","$L3",null,{"href":"https://github.com/cmdcolin/","children":"Github"}]," ",["$","$L3",null,{"href":"https://twitter.com/cmdcolin","children":"Twitter"}]," ",["$","$L3",null,{"href":"/projects","children":"Projects"}]," ",["$","$L3",null,{"href":"/photos","children":"Photos"}]," ",["$","$L3",null,{"href":"/rss.xml","children":"RSS"}]," ",["$","$L3",null,{"href":"/about","children":"About"}]]}]]}]}],"$@8"]
9:I{"id":"3591","name":"","chunks":["722:app/posts/[id]/page-cb4a6e559310dd46"],"async":false}
7:[null,null,[]]
8:[null,null,[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/97dc5fe527f5d592.css","precedence":"next.js"}]]]
2:[[["$","meta",null,{"charSet":"utf-8"}],["$","title",null,{"children":"Memoizing async functions so that you don't cache errors"}],["$","meta",null,{"name":"description","content":"A blog"}],null,null,null,null,null,null,null,null,["$","meta",null,{"name":"viewport","content":"width=device-width, initial-scale=1"}],null,null,null,null,null,null,null,null,null,null,[]],[null,null,null,null],null,null,[null,null,null,null,null],null,null,null,null,[null,[["$","link",null,{"rel":"icon","href":"/favicon.ico","type":"image/x-icon","sizes":"any"}]],[],null]]
6:["$","article",null,{"children":[["$","div",null,{"children":[["$","h1",null,{"children":"Memoizing async functions so that you don't cache errors"}],["$","h4",null,{"children":"2022-02-26"}]]}],["$","div",null,{"dangerouslySetInnerHTML":{"__html":"<p>There are two hard problems in computer science:\n<a href=\"https://martinfowler.com/bliki/TwoHardThings.html\">Cache invalidation and naming things</a>.\nIn this post we'll show how memoize an async function, and how to invalidate the\nmemoization when the promise throws an error.</p>\n<p>This helps us with being able to re-try because since the error is not cached,\ncalling it again after an error retries automatically.</p>\n<p>Example async function: fetch from the pokemon API</p>\n<pre class=\"shiki poimandres\" style=\"background-color: #1b1e28\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #5DE4C7\">async</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #91B4D5\">function</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #ADD7FF\">getPokemon</span><span style=\"color: #A6ACCD\">() {</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">  </span><span style=\"color: #91B4D5\">const</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #E4F0FB\">id</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #91B4D5\">=</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #E4F0FB\">Math</span><span style=\"color: #A6ACCD\">.</span><span style=\"color: #E4F0FBD0\">floor</span><span style=\"color: #A6ACCD\">(</span><span style=\"color: #E4F0FB\">Math</span><span style=\"color: #A6ACCD\">.</span><span style=\"color: #E4F0FBD0\">random</span><span style=\"color: #A6ACCD\">() </span><span style=\"color: #91B4D5\">*</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #5DE4C7\">150</span><span style=\"color: #A6ACCD\">)</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">  </span><span style=\"color: #91B4D5\">const</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #E4F0FB\">url</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #91B4D5\">=</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #A6ACCD\">'</span><span style=\"color: #5DE4C7\">https://pokeapi.co/api/v2/pokemon/</span><span style=\"color: #A6ACCD\">'</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #91B4D5\">+</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #E4F0FB\">id</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">  </span><span style=\"color: #91B4D5\">const</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #E4F0FB\">ret</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #91B4D5\">=</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #5DE4C7C0\">await</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #E4F0FBD0\">fetch</span><span style=\"color: #A6ACCD\">(</span><span style=\"color: #E4F0FB\">url</span><span style=\"color: #A6ACCD\">)</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">  if (</span><span style=\"color: #91B4D5\">!</span><span style=\"color: #E4F0FB\">ret</span><span style=\"color: #A6ACCD\">.</span><span style=\"color: #E4F0FB\">ok</span><span style=\"color: #A6ACCD\">) {</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">    </span><span style=\"color: #D0679D\">throw</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #5DE4C7\">new</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #E4F0FBD0\">Error</span><span style=\"color: #A6ACCD\">(</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">      </span><span style=\"color: #A6ACCD\">`</span><span style=\"color: #5DE4C7\">Failed to fetch </span><span style=\"color: #A6ACCD\">${</span><span style=\"color: #E4F0FB\">url</span><span style=\"color: #A6ACCD\">}</span><span style=\"color: #5DE4C7\"> HTTP </span><span style=\"color: #A6ACCD\">${</span><span style=\"color: #E4F0FB\">ret</span><span style=\"color: #A6ACCD\">.</span><span style=\"color: #E4F0FB\">status</span><span style=\"color: #A6ACCD\">}</span><span style=\"color: #5DE4C7\"> </span><span style=\"color: #A6ACCD\">${</span><span style=\"color: #5DE4C7C0\">await</span><span style=\"color: #5DE4C7\"> </span><span style=\"color: #E4F0FB\">ret</span><span style=\"color: #A6ACCD\">.</span><span style=\"color: #E4F0FBD0\">text</span><span style=\"color: #A6ACCD\">()</span><span style=\"color: #A6ACCD\">}`</span><span style=\"color: #A6ACCD\">,</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">    )</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">  }</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">  </span><span style=\"color: #5DE4C7C0\">return</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #E4F0FB\">ret</span><span style=\"color: #A6ACCD\">.</span><span style=\"color: #E4F0FBD0\">json</span><span style=\"color: #A6ACCD\">()</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">}</span></span></code></pre>\n<p>Here is a technique that can be used to memoize this function</p>\n<pre class=\"shiki poimandres\" style=\"background-color: #1b1e28\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #91B4D5\">function</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #ADD7FF\">getPokemonMemoized</span><span style=\"color: #A6ACCD\">() {</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">  if (</span><span style=\"color: #91B4D5\">!</span><span style=\"color: #5DE4C7; font-style: italic\">this</span><span style=\"color: #A6ACCD\">.</span><span style=\"color: #E4F0FB\">promise</span><span style=\"color: #A6ACCD\">) {</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">    </span><span style=\"color: #5DE4C7; font-style: italic\">this</span><span style=\"color: #A6ACCD\">.</span><span style=\"color: #E4F0FB\">promise</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #91B4D5\">=</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #E4F0FBD0\">getPokemon</span><span style=\"color: #A6ACCD\">().</span><span style=\"color: #E4F0FBD0\">catch</span><span style=\"color: #A6ACCD\">(</span><span style=\"color: #E4F0FB\">e</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #91B4D5\">=></span><span style=\"color: #A6ACCD\"> {</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">      </span><span style=\"color: #5DE4C7; font-style: italic\">this</span><span style=\"color: #A6ACCD\">.</span><span style=\"color: #E4F0FB\">promise</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #91B4D5\">=</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #D0679D\">undefined</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">      </span><span style=\"color: #D0679D\">throw</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #E4F0FB\">e</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">    })</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">  }</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">  </span><span style=\"color: #5DE4C7C0\">return</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #5DE4C7; font-style: italic\">this</span><span style=\"color: #A6ACCD\">.</span><span style=\"color: #E4F0FB\">promise</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">}</span></span></code></pre>\n<p>The promise is held in this.promise, and the important part of this function is\nthat when I get an error, I clear this.promise and re-throw the error. The\ncaller of the function, on error, will receive the error message, but caching\nwill not take place, allowing retries to take place later on.</p>\n<p>See <a href=\"https://cmdcolin.github.io/pokemon.html\">https://cmdcolin.github.io/pokemon.html</a> for demo</p>\n<h2 id=\"footnote-0-arguments-to-function\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#footnote-0-arguments-to-function\"><a href=\"#footnote-0-arguments-to-function\" style=\"margin-right: 10px\">#</a></a>Footnote 0: Arguments to function</h2>\n<p>If your function takes arguments, then you can use a hashmap associating the\nargument with the promise. You may also consider using an LRU cache so that your\nhashmap doesn't grow infinitely in size</p>\n<p>Generally you need a way to stringify or otherwise make them able to be stored\nin a Map or Object to do this.</p>\n<p>See <a href=\"https://github.com/nodeca/promise-memoize\">https://github.com/nodeca/promise-memoize</a> for example</p>\n<h2 id=\"footnote-1-error-handling-of-fetch\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#footnote-1-error-handling-of-fetch\"><a href=\"#footnote-1-error-handling-of-fetch\" style=\"margin-right: 10px\">#</a></a>Footnote 1: Error handling of <code>fetch</code></h2>\n<p>This demo also demonstrates some basic fetch error handling, and uses\n<code>await response.text()</code> to get the error message from the API. Sometimes an api\nwill return it's error in JSON format, so you can handle that as is, sometimes\nyou have to check both text and json</p>\n<p>Note also, that response.statusText does\n<a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Response/statusText\">not exist in HTTP/2</a>\nso it's better to use <code>response.text()</code> or <code>response.json()</code>.</p>\n<h2 id=\"footnote-2-global-cache\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#footnote-2-global-cache\"><a href=\"#footnote-2-global-cache\" style=\"margin-right: 10px\">#</a></a>Footnote 2: Global cache</h2>\n<p>You could also keep a cache in a global variable, or as a property on a class,\nor other methods. I have also found it useful to have a specific function for\nclearing the cache, so you can get a clean slate each time a test runs in unit\ntesting or similar</p>\n<pre class=\"shiki poimandres\" style=\"background-color: #1b1e28\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #91B4D5\">let</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #E4F0FB\">promise</span></span>\n<span class=\"line\"><span style=\"color: #5DE4C7\">async</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #91B4D5\">function</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #ADD7FF\">getPokemonMemoized</span><span style=\"color: #A6ACCD\">() {</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">  if (</span><span style=\"color: #91B4D5\">!</span><span style=\"color: #E4F0FB\">promise</span><span style=\"color: #A6ACCD\">) {</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">    </span><span style=\"color: #E4F0FB\">promise</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #91B4D5\">=</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #E4F0FBD0\">getPokemon</span><span style=\"color: #A6ACCD\">().</span><span style=\"color: #E4F0FBD0\">catch</span><span style=\"color: #A6ACCD\">(</span><span style=\"color: #E4F0FB\">e</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #91B4D5\">=></span><span style=\"color: #A6ACCD\"> {</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">      </span><span style=\"color: #E4F0FB\">promise</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #91B4D5\">=</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #D0679D\">undefined</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">      </span><span style=\"color: #D0679D\">throw</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #E4F0FB\">e</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">    })</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">  }</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">  </span><span style=\"color: #5DE4C7C0\">return</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #E4F0FB\">promise</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">}</span></span>\n<span class=\"line\"><span style=\"color: #91B4D5\">function</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #ADD7FF\">clearCache</span><span style=\"color: #A6ACCD\">() {</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">  </span><span style=\"color: #E4F0FB\">promise</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #91B4D5\">=</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #D0679D\">undefined</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">}</span></span></code></pre>\n<p>You can also make a general purpose utility to memoize any promise function</p>\n<pre class=\"shiki poimandres\" style=\"background-color: #1b1e28\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #91B4D5\">function</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #ADD7FF\">memoize</span><span style=\"color: #A6ACCD\">(</span><span style=\"color: #E4F0FB\">fn</span><span style=\"color: #A6ACCD\">) {</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">  </span><span style=\"color: #91B4D5\">let</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #E4F0FB\">promise</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">  </span><span style=\"color: #5DE4C7C0\">return</span><span style=\"color: #A6ACCD\"> () </span><span style=\"color: #91B4D5\">=></span><span style=\"color: #A6ACCD\"> {</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">    if (</span><span style=\"color: #91B4D5\">!</span><span style=\"color: #E4F0FB\">promise</span><span style=\"color: #A6ACCD\">) {</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">      </span><span style=\"color: #E4F0FB\">promise</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #91B4D5\">=</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #E4F0FBD0\">fn</span><span style=\"color: #A6ACCD\">().</span><span style=\"color: #E4F0FBD0\">catch</span><span style=\"color: #A6ACCD\">(</span><span style=\"color: #E4F0FB\">e</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #91B4D5\">=></span><span style=\"color: #A6ACCD\"> {</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">        </span><span style=\"color: #E4F0FB\">promise</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #91B4D5\">=</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #D0679D\">undefined</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">        </span><span style=\"color: #D0679D\">throw</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #E4F0FB\">e</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">      })</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">    }</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">  }</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">}</span></span></code></pre>\n<h2 id=\"footnote-3---aborting\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#footnote-3---aborting\"><a href=\"#footnote-3---aborting\" style=\"margin-right: 10px\">#</a></a>Footnote 3 - Aborting</h2>\n<p>If you want to handle aborting, it is a bit trickier. Aborting in javascript is\nhandled by\n<a href=\"https://developer.mozilla.org/en-US/docs/Web/API/AbortController/AbortController\">AbortController</a>.\nThis is an object that gives you an\n<a href=\"https://developer.mozilla.org/en-US/docs/Web/API/AbortSignal\">AbortSignal</a> that\ncan be passed to fetch calls and the like to stop a big download from happening.</p>\n<p>In our above example, if we passed an abort signal to the first call to fetch,\nand then aborted it, it would abort the fetch,\n<a href=\"https://developer.mozilla.org/en-US/docs/Web/API/AbortController/abort\">which throws a DOMException called \"AbortError\"</a>.\nYou can detect that it is an AbortError like this, and may choose not to display\nor re-throw the abort exception</p>\n<pre class=\"shiki poimandres\" style=\"background-color: #1b1e28\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #91B4D5\">function</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #ADD7FF\">isAbortException</span><span style=\"color: #A6ACCD\">(</span><span style=\"color: #E4F0FB\">e</span><span style=\"color: #A6ACCD\">) {</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">  </span><span style=\"color: #5DE4C7C0\">return</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #E4F0FB\">e</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #91B4D5\">instanceof</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #A6ACCDC0\">Error</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #91B4D5\">&#x26;&#x26;</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #E4F0FB\">exception</span><span style=\"color: #A6ACCD\">.</span><span style=\"color: #E4F0FB\">name</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #91B4D5\">===</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #A6ACCD\">'</span><span style=\"color: #5DE4C7\">AbortError</span><span style=\"color: #A6ACCD\">'</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">}</span></span></code></pre>\n<p>Now, what if 5 functions call getPokemonMemoized(), all passing different abort\nsignals. What if the first one aborts? Then all the rest will get aborted also.\nBut what if we only want to abort the cached call if literally all of them\naborted? Then we may have to synthesize an abortcontroller inside our function</p>\n<pre class=\"shiki poimandres\" style=\"background-color: #1b1e28\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #91B4D5\">let</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #E4F0FB\">promise</span></span>\n<span class=\"line\"><span style=\"color: #91B4D5\">let</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #E4F0FB\">abortcontroller</span></span>\n<span class=\"line\"><span style=\"color: #91B4D5\">let</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #E4F0FB\">listeners</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #91B4D5\">=</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #5DE4C7\">0</span></span>\n<span class=\"line\"><span style=\"color: #5DE4C7\">async</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #91B4D5\">function</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #ADD7FF\">getPokemonMemoized</span><span style=\"color: #A6ACCD\">(</span><span style=\"color: #E4F0FB\">signal</span><span style=\"color: #A6ACCD\">) {</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">  if (</span><span style=\"color: #91B4D5\">!</span><span style=\"color: #E4F0FB\">promise</span><span style=\"color: #A6ACCD\">) {</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">    </span><span style=\"color: #E4F0FB\">abortcontroller</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #91B4D5\">=</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #5DE4C7\">new</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #E4F0FBD0\">AbortController</span><span style=\"color: #A6ACCD\">()</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">    </span><span style=\"color: #767C9DB0; font-style: italic\">// synthesize a new signal instead of using the passed in signal</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">    </span><span style=\"color: #E4F0FB\">promise</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #91B4D5\">=</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #E4F0FBD0\">getPokemon</span><span style=\"color: #A6ACCD\">(</span><span style=\"color: #E4F0FB\">abortcontroller</span><span style=\"color: #A6ACCD\">.</span><span style=\"color: #E4F0FB\">signal</span><span style=\"color: #A6ACCD\">).</span><span style=\"color: #E4F0FBD0\">catch</span><span style=\"color: #A6ACCD\">(</span><span style=\"color: #E4F0FB\">e</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #91B4D5\">=></span><span style=\"color: #A6ACCD\"> {</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">      </span><span style=\"color: #E4F0FB\">promise</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #91B4D5\">=</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #D0679D\">undefined</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">      </span><span style=\"color: #D0679D\">throw</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #E4F0FB\">e</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">    })</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">  }</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">  if (</span><span style=\"color: #E4F0FB\">signal</span><span style=\"color: #A6ACCD\">) {</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">    </span><span style=\"color: #E4F0FB\">listeners</span><span style=\"color: #91B4D5\">++</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">    </span><span style=\"color: #767C9DB0; font-style: italic\">// add listener to the passed in signal</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">    </span><span style=\"color: #E4F0FB\">signal</span><span style=\"color: #A6ACCD\">.</span><span style=\"color: #E4F0FBD0\">addEventListener</span><span style=\"color: #A6ACCD\">(</span><span style=\"color: #A6ACCD\">'</span><span style=\"color: #5DE4C7\">abort</span><span style=\"color: #A6ACCD\">'</span><span style=\"color: #A6ACCD\">, () </span><span style=\"color: #91B4D5\">=></span><span style=\"color: #A6ACCD\"> {</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">      </span><span style=\"color: #E4F0FB\">listeners</span><span style=\"color: #91B4D5\">--</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">      if (</span><span style=\"color: #E4F0FB\">listeners</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #91B4D5\">===</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #5DE4C7\">0</span><span style=\"color: #A6ACCD\">) {</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">        </span><span style=\"color: #E4F0FB\">abortcontroller</span><span style=\"color: #A6ACCD\">.</span><span style=\"color: #E4F0FBD0\">abort</span><span style=\"color: #A6ACCD\">()</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">      }</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">    })</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">  }</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">  </span><span style=\"color: #5DE4C7C0\">return</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #E4F0FB\">promise</span></span>\n<span class=\"line\"><span style=\"color: #A6ACCD\">}</span></span></code></pre>\n<p>A library my team created,\n<a href=\"https://github.com/GMOD/abortable-promise-cache\">abortable-promise-cache</a>,\ntries to help with this scenario with a cleaner abstraction.</p>\n<h2 id=\"footnote-4\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#footnote-4\"><a href=\"#footnote-4\" style=\"margin-right: 10px\">#</a></a>Footnote 4</h2>\n<p>I have been playing through Pokemon Yellow and find it really amusing hence the\npokemon theme</p>\n<p>Fun stuff: The cutting room floor wiki with unused moves, sounds, and sprites in\nPokemon Yellow <a href=\"https://tcrf.net/Pok%C3%A9mon_Yellow\">https://tcrf.net/Pok%C3%A9mon_Yellow</a></p>\n<h2 id=\"footnote-5\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#footnote-5\"><a href=\"#footnote-5\" style=\"margin-right: 10px\">#</a></a>Footnote 5</h2>\n<p>This blog post mentioned in a comment thread <a href=\"https://zansh.in/memoizer.html\">https://zansh.in/memoizer.html</a> has\ngreat interactive examples and shows the \"invalidate on .catch()\" behavior!</p>"}}],["$","$L9",null,{}]]}]
