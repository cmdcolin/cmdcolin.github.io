<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>Memoizing async functions so that you don&#x27;t cache errors</title><meta name="next-head-count" content="3"/><link rel="shortcut icon" href="favicon.ico"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><meta name="description" content="Blogging for the future"/><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/prism.min.js" integrity="sha512-hpZ5pDCF2bRCweL5WoA0/N1elet1KYL5mx3LP555Eg/0ZguaHawxNvEjF6O3rufAChs16HVNhEc6blF/rZoowQ==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="preload" href="/_next/static/css/97dc5fe527f5d592.css" as="style"/><link rel="stylesheet" href="/_next/static/css/97dc5fe527f5d592.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-7a0a4d5d8e055b82.js" defer=""></script><script src="/_next/static/chunks/framework-654b6047e3d0e6e1.js" defer=""></script><script src="/_next/static/chunks/main-d6f7fa9112f73dec.js" defer=""></script><script src="/_next/static/chunks/pages/_app-7749755fef3ce988.js" defer=""></script><script src="/_next/static/chunks/996-671cdcc64ad16425.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-ef4890d9003e1e61.js" defer=""></script><script src="/_next/static/_YMuq3zsME1OjCEtwgBe6/_buildManifest.js" defer=""></script><script src="/_next/static/_YMuq3zsME1OjCEtwgBe6/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div><main><div><div style="margin-bottom:100px"><a href="/">Misc scribbles</a></div><article><div><h1>Memoizing async functions so that you don&#x27;t cache errors</h1><h4>2022-02-26</h4></div><div><p>There are two hard problems in computer science: <a href="https://martinfowler.com/bliki/TwoHardThings.html">Cache invalidation and naming
things</a>. In this post we'll
show how memoize an async function, and how to invalidate the memoization when
the promise throws an error.</p>
<p>This helps us with being able to re-try because since the error is not cached,
calling it again after an error retries automatically.</p>
<p>Example async function: fetch from the pokemon API</p>
<pre class="shiki" style="background-color: #1b1e28"><code><span class="line"><span style="color: #5DE4C7">async</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">function</span><span style="color: #A6ACCD"> </span><span style="color: #ADD7FF">getPokemon</span><span style="color: #A6ACCD">() {</span></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #91B4D5">const</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">id</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">Math</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">floor</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">Math</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">random</span><span style="color: #A6ACCD">() </span><span style="color: #91B4D5">*</span><span style="color: #A6ACCD"> </span><span style="color: #5DE4C7">150</span><span style="color: #A6ACCD">)</span></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #91B4D5">const</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">url</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #A6ACCD">'</span><span style="color: #5DE4C7">https://pokeapi.co/api/v2/pokemon/</span><span style="color: #A6ACCD">'</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">+</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">id</span></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #91B4D5">const</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">ret</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #5DE4C7C0">await</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FBD0">fetch</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">url</span><span style="color: #A6ACCD">)</span></span>
<span class="line"><span style="color: #A6ACCD">  if (</span><span style="color: #91B4D5">!</span><span style="color: #E4F0FB">ret</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FB">ok</span><span style="color: #A6ACCD">) {</span></span>
<span class="line"><span style="color: #A6ACCD">    </span><span style="color: #D0679D">throw</span><span style="color: #A6ACCD"> </span><span style="color: #5DE4C7">new</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FBD0">Error</span><span style="color: #A6ACCD">(</span></span>
<span class="line"><span style="color: #A6ACCD">      </span><span style="color: #A6ACCD">`</span><span style="color: #5DE4C7">Failed to fetch </span><span style="color: #A6ACCD">${</span><span style="color: #E4F0FB">url</span><span style="color: #A6ACCD">}</span><span style="color: #5DE4C7"> HTTP </span><span style="color: #A6ACCD">${</span><span style="color: #E4F0FB">ret</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FB">status</span><span style="color: #A6ACCD">}</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">${</span><span style="color: #5DE4C7C0">await</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">ret</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">text</span><span style="color: #A6ACCD">()</span><span style="color: #A6ACCD">}`</span><span style="color: #A6ACCD">,</span></span>
<span class="line"><span style="color: #A6ACCD">    )</span></span>
<span class="line"><span style="color: #A6ACCD">  }</span></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #5DE4C7C0">return</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">ret</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">json</span><span style="color: #A6ACCD">()</span></span>
<span class="line"><span style="color: #A6ACCD">}</span></span></code></pre>
<p>Here is a technique that can be used to memoize this function</p>
<pre class="shiki" style="background-color: #1b1e28"><code><span class="line"><span style="color: #91B4D5">function</span><span style="color: #A6ACCD"> </span><span style="color: #ADD7FF">getPokemonMemoized</span><span style="color: #A6ACCD">() {</span></span>
<span class="line"><span style="color: #A6ACCD">  if (</span><span style="color: #91B4D5">!</span><span style="color: #5DE4C7">this</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FB">promise</span><span style="color: #A6ACCD">) {</span></span>
<span class="line"><span style="color: #A6ACCD">    </span><span style="color: #5DE4C7">this</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FB">promise</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FBD0">getPokemon</span><span style="color: #A6ACCD">().</span><span style="color: #E4F0FBD0">catch</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">e</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">=></span><span style="color: #A6ACCD"> {</span></span>
<span class="line"><span style="color: #A6ACCD">      </span><span style="color: #5DE4C7">this</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FB">promise</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #D0679D">undefined</span></span>
<span class="line"><span style="color: #A6ACCD">      </span><span style="color: #D0679D">throw</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">e</span></span>
<span class="line"><span style="color: #A6ACCD">    })</span></span>
<span class="line"><span style="color: #A6ACCD">  }</span></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #5DE4C7C0">return</span><span style="color: #A6ACCD"> </span><span style="color: #5DE4C7">this</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FB">promise</span></span>
<span class="line"><span style="color: #A6ACCD">}</span></span></code></pre>
<p>The promise is held in this.promise, and the important part of this function is
that when I get an error, I clear this.promise and re-throw the error. The caller
of the function, on error, will receive the error message, but caching will not
take place, allowing retries to take place later on.</p>
<p>See <a href="https://cmdcolin.github.io/pokemon.html">https://cmdcolin.github.io/pokemon.html</a> for demo</p>
<h2 id="footnote-0-arguments-to-function"><a aria-hidden="true" tabindex="-1" href="#footnote-0-arguments-to-function"><a href="#footnote-0-arguments-to-function" style="margin-right: 10px">#</a></a>Footnote 0: Arguments to function</h2>
<p>If your function takes arguments, then you can use a hashmap associating the
argument with the promise. You may also consider using an LRU cache so that
your hashmap doesn't grow infinitely in size</p>
<p>Generally you need a way to stringify or otherwise make them able to be stored
in a Map or Object to do this.</p>
<p>See <a href="https://github.com/nodeca/promise-memoize">https://github.com/nodeca/promise-memoize</a> for example</p>
<h2 id="footnote-1-error-handling-of-fetch"><a aria-hidden="true" tabindex="-1" href="#footnote-1-error-handling-of-fetch"><a href="#footnote-1-error-handling-of-fetch" style="margin-right: 10px">#</a></a>Footnote 1: Error handling of <code>fetch</code></h2>
<p>This demo also demonstrates some basic fetch error handling, and uses <code>await response.text()</code> to get the error message from the API. Sometimes an api will
return it's error in JSON format, so you can handle that as is, sometimes you
have to check both text and json</p>
<p>Note also, that response.statusText does <a href="https://developer.mozilla.org/en-US/docs/Web/API/Response/statusText">not exist in
HTTP/2</a>
so it's better to use <code>response.text()</code> or <code>response.json()</code>.</p>
<h2 id="footnote-2-global-cache"><a aria-hidden="true" tabindex="-1" href="#footnote-2-global-cache"><a href="#footnote-2-global-cache" style="margin-right: 10px">#</a></a>Footnote 2: Global cache</h2>
<p>You could also keep a cache in a global variable, or as a property on a class,
or other methods. I have also found it useful to have a specific function for
clearing the cache, so you can get a clean slate each time a test runs in unit
testing or similar</p>
<pre class="shiki" style="background-color: #1b1e28"><code><span class="line"><span style="color: #91B4D5">let</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">promise</span></span>
<span class="line"><span style="color: #5DE4C7">async</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">function</span><span style="color: #A6ACCD"> </span><span style="color: #ADD7FF">getPokemonMemoized</span><span style="color: #A6ACCD">() {</span></span>
<span class="line"><span style="color: #A6ACCD">  if (</span><span style="color: #91B4D5">!</span><span style="color: #E4F0FB">promise</span><span style="color: #A6ACCD">) {</span></span>
<span class="line"><span style="color: #A6ACCD">    </span><span style="color: #E4F0FB">promise</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FBD0">getPokemon</span><span style="color: #A6ACCD">().</span><span style="color: #E4F0FBD0">catch</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">e</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">=></span><span style="color: #A6ACCD"> {</span></span>
<span class="line"><span style="color: #A6ACCD">      </span><span style="color: #E4F0FB">promise</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #D0679D">undefined</span></span>
<span class="line"><span style="color: #A6ACCD">      </span><span style="color: #D0679D">throw</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">e</span></span>
<span class="line"><span style="color: #A6ACCD">    })</span></span>
<span class="line"><span style="color: #A6ACCD">  }</span></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #5DE4C7C0">return</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">promise</span></span>
<span class="line"><span style="color: #A6ACCD">}</span></span>
<span class="line"><span style="color: #91B4D5">function</span><span style="color: #A6ACCD"> </span><span style="color: #ADD7FF">clearCache</span><span style="color: #A6ACCD">() {</span></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #E4F0FB">promise</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #D0679D">undefined</span></span>
<span class="line"><span style="color: #A6ACCD">}</span></span></code></pre>
<p>You can also make a general purpose utility to memoize any promise function</p>
<pre class="shiki" style="background-color: #1b1e28"><code><span class="line"><span style="color: #91B4D5">function</span><span style="color: #A6ACCD"> </span><span style="color: #ADD7FF">memoize</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">fn</span><span style="color: #A6ACCD">) {</span></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #91B4D5">let</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">promise</span></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #5DE4C7C0">return</span><span style="color: #A6ACCD"> () </span><span style="color: #91B4D5">=></span><span style="color: #A6ACCD"> {</span></span>
<span class="line"><span style="color: #A6ACCD">    if (</span><span style="color: #91B4D5">!</span><span style="color: #E4F0FB">promise</span><span style="color: #A6ACCD">) {</span></span>
<span class="line"><span style="color: #A6ACCD">      </span><span style="color: #E4F0FB">promise</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FBD0">fn</span><span style="color: #A6ACCD">().</span><span style="color: #E4F0FBD0">catch</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">e</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">=></span><span style="color: #A6ACCD"> {</span></span>
<span class="line"><span style="color: #A6ACCD">        </span><span style="color: #E4F0FB">promise</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #D0679D">undefined</span></span>
<span class="line"><span style="color: #A6ACCD">        </span><span style="color: #D0679D">throw</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">e</span></span>
<span class="line"><span style="color: #A6ACCD">      })</span></span>
<span class="line"><span style="color: #A6ACCD">    }</span></span>
<span class="line"><span style="color: #A6ACCD">  }</span></span>
<span class="line"><span style="color: #A6ACCD">}</span></span></code></pre>
<h2 id="footnote-3---aborting"><a aria-hidden="true" tabindex="-1" href="#footnote-3---aborting"><a href="#footnote-3---aborting" style="margin-right: 10px">#</a></a>Footnote 3 - Aborting</h2>
<p>If you want to handle aborting, it is a bit trickier. Aborting in javascript is
handled by
<a href="https://developer.mozilla.org/en-US/docs/Web/API/AbortController/AbortController">AbortController</a>.
This is an object that gives you an
<a href="https://developer.mozilla.org/en-US/docs/Web/API/AbortSignal">AbortSignal</a>
that can be passed to fetch calls and the like to stop a big download from
happening.</p>
<p>In our above example, if we passed an abort signal to the first call to fetch,
and then aborted it, it would abort the fetch, <a href="https://developer.mozilla.org/en-US/docs/Web/API/AbortController/abort">which throws a DOMException
called
"AbortError"</a>.
You can detect that it is an AbortError like this, and may choose not to
display or re-throw the abort exception</p>
<pre class="shiki" style="background-color: #1b1e28"><code><span class="line"><span style="color: #91B4D5">function</span><span style="color: #A6ACCD"> </span><span style="color: #ADD7FF">isAbortException</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">e</span><span style="color: #A6ACCD">) {</span></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #5DE4C7C0">return</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">e</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">instanceof</span><span style="color: #A6ACCD"> </span><span style="color: #A6ACCDC0">Error</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">&#x26;&#x26;</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">exception</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FB">name</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">===</span><span style="color: #A6ACCD"> </span><span style="color: #A6ACCD">'</span><span style="color: #5DE4C7">AbortError</span><span style="color: #A6ACCD">'</span></span>
<span class="line"><span style="color: #A6ACCD">}</span></span></code></pre>
<p>Now, what if 5 functions call getPokemonMemoized(), all passing different abort
signals. What if the first one aborts? Then all the rest will get aborted also.
But what if we only want to abort the cached call if literally all of them
aborted? Then we may have to synthesize an abortcontroller inside our function</p>
<pre class="shiki" style="background-color: #1b1e28"><code><span class="line"><span style="color: #91B4D5">let</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">promise</span></span>
<span class="line"><span style="color: #91B4D5">let</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">abortcontroller</span></span>
<span class="line"><span style="color: #91B4D5">let</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">listeners</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #5DE4C7">0</span></span>
<span class="line"><span style="color: #5DE4C7">async</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">function</span><span style="color: #A6ACCD"> </span><span style="color: #ADD7FF">getPokemonMemoized</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">signal</span><span style="color: #A6ACCD">) {</span></span>
<span class="line"><span style="color: #A6ACCD">  if (</span><span style="color: #91B4D5">!</span><span style="color: #E4F0FB">promise</span><span style="color: #A6ACCD">) {</span></span>
<span class="line"><span style="color: #A6ACCD">    </span><span style="color: #E4F0FB">abortcontroller</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #5DE4C7">new</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FBD0">AbortController</span><span style="color: #A6ACCD">()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #A6ACCD">    </span><span style="color: #767C9DB0">// synthesize a new signal instead of using the passed in signal</span></span>
<span class="line"><span style="color: #A6ACCD">    </span><span style="color: #E4F0FB">promise</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FBD0">getPokemon</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">abortcontroller</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FB">signal</span><span style="color: #A6ACCD">).</span><span style="color: #E4F0FBD0">catch</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">e</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">=></span><span style="color: #A6ACCD"> {</span></span>
<span class="line"><span style="color: #A6ACCD">      </span><span style="color: #E4F0FB">promise</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #D0679D">undefined</span></span>
<span class="line"><span style="color: #A6ACCD">      </span><span style="color: #D0679D">throw</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">e</span></span>
<span class="line"><span style="color: #A6ACCD">    })</span></span>
<span class="line"><span style="color: #A6ACCD">  }</span></span>
<span class="line"><span style="color: #A6ACCD">  if (</span><span style="color: #E4F0FB">signal</span><span style="color: #A6ACCD">) {</span></span>
<span class="line"><span style="color: #A6ACCD">    </span><span style="color: #E4F0FB">listeners</span><span style="color: #91B4D5">++</span></span>
<span class="line"><span style="color: #A6ACCD">    </span><span style="color: #767C9DB0">// add listener to the passed in signal</span></span>
<span class="line"><span style="color: #A6ACCD">    </span><span style="color: #E4F0FB">signal</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">addEventListener</span><span style="color: #A6ACCD">(</span><span style="color: #A6ACCD">'</span><span style="color: #5DE4C7">abort</span><span style="color: #A6ACCD">'</span><span style="color: #A6ACCD">, () </span><span style="color: #91B4D5">=></span><span style="color: #A6ACCD"> {</span></span>
<span class="line"><span style="color: #A6ACCD">      </span><span style="color: #E4F0FB">listeners</span><span style="color: #91B4D5">--</span></span>
<span class="line"><span style="color: #A6ACCD">      if (</span><span style="color: #E4F0FB">listeners</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">===</span><span style="color: #A6ACCD"> </span><span style="color: #5DE4C7">0</span><span style="color: #A6ACCD">) {</span></span>
<span class="line"><span style="color: #A6ACCD">        </span><span style="color: #E4F0FB">abortcontroller</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">abort</span><span style="color: #A6ACCD">()</span></span>
<span class="line"><span style="color: #A6ACCD">      }</span></span>
<span class="line"><span style="color: #A6ACCD">    })</span></span>
<span class="line"><span style="color: #A6ACCD">  }</span></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #5DE4C7C0">return</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">promise</span></span>
<span class="line"><span style="color: #A6ACCD">}</span></span></code></pre>
<p>A library my team created,
<a href="https://github.com/GMOD/abortable-promise-cache">abortable-promise-cache</a>,
tries to help with this scenario with a cleaner abstraction.</p>
<h2 id="footnote-4"><a aria-hidden="true" tabindex="-1" href="#footnote-4"><a href="#footnote-4" style="margin-right: 10px">#</a></a>Footnote 4</h2>
<p>I have been playing through Pokemon Yellow and find it really amusing hence the
pokemon theme</p>
<p>Fun stuff: The cutting room floor wiki with unused moves, sounds, and sprites
in Pokemon Yellow <a href="https://tcrf.net/Pok%C3%A9mon_Yellow">https://tcrf.net/Pok%C3%A9mon_Yellow</a></p>
<h2 id="footnote-5"><a aria-hidden="true" tabindex="-1" href="#footnote-5"><a href="#footnote-5" style="margin-right: 10px">#</a></a>Footnote 5</h2>
<p>This blog post mentioned in a comment thread <a href="https://zansh.in/memoizer.html">https://zansh.in/memoizer.html</a> has
great interactive examples and shows the "invalidate on .catch()" behavior!</p></div><div style="margin-top:200px"></div></article></div></main></div><footer style="margin-top:100px"><a href="/">Home</a> <a href="/archive">Blog archive</a> <a href="https://github.com/cmdcolin/">Github</a> <a href="https://twitter.com/cmdcolin">Twitter</a> <a href="/projects">Projects</a><a href="/photos">Photos</a> <a href="/rss.xml">RSS</a><a href="/about">About</a></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"Memoizing async functions so that you don't cache errors","date":"2022-02-26","slug":"2022-02-26-memoize-async","html":"\u003cp\u003eThere are two hard problems in computer science: \u003ca href=\"https://martinfowler.com/bliki/TwoHardThings.html\"\u003eCache invalidation and naming\nthings\u003c/a\u003e. In this post we'll\nshow how memoize an async function, and how to invalidate the memoization when\nthe promise throws an error.\u003c/p\u003e\n\u003cp\u003eThis helps us with being able to re-try because since the error is not cached,\ncalling it again after an error retries automatically.\u003c/p\u003e\n\u003cp\u003eExample async function: fetch from the pokemon API\u003c/p\u003e\n\u003cpre class=\"shiki\" style=\"background-color: #1b1e28\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #5DE4C7\"\u003easync\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #91B4D5\"\u003efunction\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #ADD7FF\"\u003egetPokemon\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e() {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #91B4D5\"\u003econst\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003eid\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #91B4D5\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003eMath\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #E4F0FBD0\"\u003efloor\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003eMath\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #E4F0FBD0\"\u003erandom\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e() \u003c/span\u003e\u003cspan style=\"color: #91B4D5\"\u003e*\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #5DE4C7\"\u003e150\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #91B4D5\"\u003econst\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003eurl\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #91B4D5\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e'\u003c/span\u003e\u003cspan style=\"color: #5DE4C7\"\u003ehttps://pokeapi.co/api/v2/pokemon/\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e'\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #91B4D5\"\u003e+\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003eid\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #91B4D5\"\u003econst\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003eret\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #91B4D5\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #5DE4C7C0\"\u003eawait\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #E4F0FBD0\"\u003efetch\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003eurl\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e  if (\u003c/span\u003e\u003cspan style=\"color: #91B4D5\"\u003e!\u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003eret\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003eok\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #D0679D\"\u003ethrow\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #5DE4C7\"\u003enew\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #E4F0FBD0\"\u003eError\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e      \u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e`\u003c/span\u003e\u003cspan style=\"color: #5DE4C7\"\u003eFailed to fetch \u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e${\u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003eurl\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e}\u003c/span\u003e\u003cspan style=\"color: #5DE4C7\"\u003e HTTP \u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e${\u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003eret\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003estatus\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e}\u003c/span\u003e\u003cspan style=\"color: #5DE4C7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e${\u003c/span\u003e\u003cspan style=\"color: #5DE4C7C0\"\u003eawait\u003c/span\u003e\u003cspan style=\"color: #5DE4C7\"\u003e \u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003eret\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #E4F0FBD0\"\u003etext\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e()\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e}`\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e    )\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e  }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #5DE4C7C0\"\u003ereturn\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003eret\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #E4F0FBD0\"\u003ejson\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e()\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eHere is a technique that can be used to memoize this function\u003c/p\u003e\n\u003cpre class=\"shiki\" style=\"background-color: #1b1e28\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003efunction\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #ADD7FF\"\u003egetPokemonMemoized\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e() {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e  if (\u003c/span\u003e\u003cspan style=\"color: #91B4D5\"\u003e!\u003c/span\u003e\u003cspan style=\"color: #5DE4C7\"\u003ethis\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003epromise\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #5DE4C7\"\u003ethis\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003epromise\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #91B4D5\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #E4F0FBD0\"\u003egetPokemon\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e().\u003c/span\u003e\u003cspan style=\"color: #E4F0FBD0\"\u003ecatch\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003ee\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #91B4D5\"\u003e=\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e      \u003c/span\u003e\u003cspan style=\"color: #5DE4C7\"\u003ethis\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003epromise\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #91B4D5\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #D0679D\"\u003eundefined\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e      \u003c/span\u003e\u003cspan style=\"color: #D0679D\"\u003ethrow\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003ee\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e    })\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e  }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #5DE4C7C0\"\u003ereturn\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #5DE4C7\"\u003ethis\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003epromise\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe promise is held in this.promise, and the important part of this function is\nthat when I get an error, I clear this.promise and re-throw the error. The caller\nof the function, on error, will receive the error message, but caching will not\ntake place, allowing retries to take place later on.\u003c/p\u003e\n\u003cp\u003eSee \u003ca href=\"https://cmdcolin.github.io/pokemon.html\"\u003ehttps://cmdcolin.github.io/pokemon.html\u003c/a\u003e for demo\u003c/p\u003e\n\u003ch2 id=\"footnote-0-arguments-to-function\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#footnote-0-arguments-to-function\"\u003e\u003ca href=\"#footnote-0-arguments-to-function\" style=\"margin-right: 10px\"\u003e#\u003c/a\u003e\u003c/a\u003eFootnote 0: Arguments to function\u003c/h2\u003e\n\u003cp\u003eIf your function takes arguments, then you can use a hashmap associating the\nargument with the promise. You may also consider using an LRU cache so that\nyour hashmap doesn't grow infinitely in size\u003c/p\u003e\n\u003cp\u003eGenerally you need a way to stringify or otherwise make them able to be stored\nin a Map or Object to do this.\u003c/p\u003e\n\u003cp\u003eSee \u003ca href=\"https://github.com/nodeca/promise-memoize\"\u003ehttps://github.com/nodeca/promise-memoize\u003c/a\u003e for example\u003c/p\u003e\n\u003ch2 id=\"footnote-1-error-handling-of-fetch\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#footnote-1-error-handling-of-fetch\"\u003e\u003ca href=\"#footnote-1-error-handling-of-fetch\" style=\"margin-right: 10px\"\u003e#\u003c/a\u003e\u003c/a\u003eFootnote 1: Error handling of \u003ccode\u003efetch\u003c/code\u003e\u003c/h2\u003e\n\u003cp\u003eThis demo also demonstrates some basic fetch error handling, and uses \u003ccode\u003eawait response.text()\u003c/code\u003e to get the error message from the API. Sometimes an api will\nreturn it's error in JSON format, so you can handle that as is, sometimes you\nhave to check both text and json\u003c/p\u003e\n\u003cp\u003eNote also, that response.statusText does \u003ca href=\"https://developer.mozilla.org/en-US/docs/Web/API/Response/statusText\"\u003enot exist in\nHTTP/2\u003c/a\u003e\nso it's better to use \u003ccode\u003eresponse.text()\u003c/code\u003e or \u003ccode\u003eresponse.json()\u003c/code\u003e.\u003c/p\u003e\n\u003ch2 id=\"footnote-2-global-cache\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#footnote-2-global-cache\"\u003e\u003ca href=\"#footnote-2-global-cache\" style=\"margin-right: 10px\"\u003e#\u003c/a\u003e\u003c/a\u003eFootnote 2: Global cache\u003c/h2\u003e\n\u003cp\u003eYou could also keep a cache in a global variable, or as a property on a class,\nor other methods. I have also found it useful to have a specific function for\nclearing the cache, so you can get a clean slate each time a test runs in unit\ntesting or similar\u003c/p\u003e\n\u003cpre class=\"shiki\" style=\"background-color: #1b1e28\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003elet\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003epromise\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #5DE4C7\"\u003easync\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #91B4D5\"\u003efunction\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #ADD7FF\"\u003egetPokemonMemoized\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e() {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e  if (\u003c/span\u003e\u003cspan style=\"color: #91B4D5\"\u003e!\u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003epromise\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003epromise\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #91B4D5\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #E4F0FBD0\"\u003egetPokemon\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e().\u003c/span\u003e\u003cspan style=\"color: #E4F0FBD0\"\u003ecatch\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003ee\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #91B4D5\"\u003e=\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e      \u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003epromise\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #91B4D5\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #D0679D\"\u003eundefined\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e      \u003c/span\u003e\u003cspan style=\"color: #D0679D\"\u003ethrow\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003ee\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e    })\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e  }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #5DE4C7C0\"\u003ereturn\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003epromise\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e}\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003efunction\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #ADD7FF\"\u003eclearCache\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e() {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003epromise\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #91B4D5\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #D0679D\"\u003eundefined\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eYou can also make a general purpose utility to memoize any promise function\u003c/p\u003e\n\u003cpre class=\"shiki\" style=\"background-color: #1b1e28\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003efunction\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #ADD7FF\"\u003ememoize\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003efn\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #91B4D5\"\u003elet\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003epromise\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #5DE4C7C0\"\u003ereturn\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e () \u003c/span\u003e\u003cspan style=\"color: #91B4D5\"\u003e=\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e    if (\u003c/span\u003e\u003cspan style=\"color: #91B4D5\"\u003e!\u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003epromise\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e      \u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003epromise\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #91B4D5\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #E4F0FBD0\"\u003efn\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e().\u003c/span\u003e\u003cspan style=\"color: #E4F0FBD0\"\u003ecatch\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003ee\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #91B4D5\"\u003e=\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003epromise\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #91B4D5\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #D0679D\"\u003eundefined\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #D0679D\"\u003ethrow\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003ee\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e      })\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e    }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e  }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"footnote-3---aborting\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#footnote-3---aborting\"\u003e\u003ca href=\"#footnote-3---aborting\" style=\"margin-right: 10px\"\u003e#\u003c/a\u003e\u003c/a\u003eFootnote 3 - Aborting\u003c/h2\u003e\n\u003cp\u003eIf you want to handle aborting, it is a bit trickier. Aborting in javascript is\nhandled by\n\u003ca href=\"https://developer.mozilla.org/en-US/docs/Web/API/AbortController/AbortController\"\u003eAbortController\u003c/a\u003e.\nThis is an object that gives you an\n\u003ca href=\"https://developer.mozilla.org/en-US/docs/Web/API/AbortSignal\"\u003eAbortSignal\u003c/a\u003e\nthat can be passed to fetch calls and the like to stop a big download from\nhappening.\u003c/p\u003e\n\u003cp\u003eIn our above example, if we passed an abort signal to the first call to fetch,\nand then aborted it, it would abort the fetch, \u003ca href=\"https://developer.mozilla.org/en-US/docs/Web/API/AbortController/abort\"\u003ewhich throws a DOMException\ncalled\n\"AbortError\"\u003c/a\u003e.\nYou can detect that it is an AbortError like this, and may choose not to\ndisplay or re-throw the abort exception\u003c/p\u003e\n\u003cpre class=\"shiki\" style=\"background-color: #1b1e28\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003efunction\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #ADD7FF\"\u003eisAbortException\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003ee\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #5DE4C7C0\"\u003ereturn\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003ee\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #91B4D5\"\u003einstanceof\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #A6ACCDC0\"\u003eError\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #91B4D5\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003eexception\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003ename\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #91B4D5\"\u003e===\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e'\u003c/span\u003e\u003cspan style=\"color: #5DE4C7\"\u003eAbortError\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e'\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNow, what if 5 functions call getPokemonMemoized(), all passing different abort\nsignals. What if the first one aborts? Then all the rest will get aborted also.\nBut what if we only want to abort the cached call if literally all of them\naborted? Then we may have to synthesize an abortcontroller inside our function\u003c/p\u003e\n\u003cpre class=\"shiki\" style=\"background-color: #1b1e28\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003elet\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003epromise\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003elet\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003eabortcontroller\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #91B4D5\"\u003elet\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003elisteners\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #91B4D5\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #5DE4C7\"\u003e0\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #5DE4C7\"\u003easync\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #91B4D5\"\u003efunction\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #ADD7FF\"\u003egetPokemonMemoized\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003esignal\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e  if (\u003c/span\u003e\u003cspan style=\"color: #91B4D5\"\u003e!\u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003epromise\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003eabortcontroller\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #91B4D5\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #5DE4C7\"\u003enew\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #E4F0FBD0\"\u003eAbortController\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e()\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #767C9DB0\"\u003e// synthesize a new signal instead of using the passed in signal\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003epromise\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #91B4D5\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #E4F0FBD0\"\u003egetPokemon\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003eabortcontroller\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003esignal\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e).\u003c/span\u003e\u003cspan style=\"color: #E4F0FBD0\"\u003ecatch\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003ee\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #91B4D5\"\u003e=\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e      \u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003epromise\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #91B4D5\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #D0679D\"\u003eundefined\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e      \u003c/span\u003e\u003cspan style=\"color: #D0679D\"\u003ethrow\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003ee\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e    })\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e  }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e  if (\u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003esignal\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003elisteners\u003c/span\u003e\u003cspan style=\"color: #91B4D5\"\u003e++\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #767C9DB0\"\u003e// add listener to the passed in signal\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003esignal\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #E4F0FBD0\"\u003eaddEventListener\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e'\u003c/span\u003e\u003cspan style=\"color: #5DE4C7\"\u003eabort\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e'\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e, () \u003c/span\u003e\u003cspan style=\"color: #91B4D5\"\u003e=\u003e\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e      \u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003elisteners\u003c/span\u003e\u003cspan style=\"color: #91B4D5\"\u003e--\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e      if (\u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003elisteners\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #91B4D5\"\u003e===\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #5DE4C7\"\u003e0\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003eabortcontroller\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #E4F0FBD0\"\u003eabort\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e()\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e      }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e    })\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e  }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #5DE4C7C0\"\u003ereturn\u003c/span\u003e\u003cspan style=\"color: #A6ACCD\"\u003e \u003c/span\u003e\u003cspan style=\"color: #E4F0FB\"\u003epromise\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #A6ACCD\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eA library my team created,\n\u003ca href=\"https://github.com/GMOD/abortable-promise-cache\"\u003eabortable-promise-cache\u003c/a\u003e,\ntries to help with this scenario with a cleaner abstraction.\u003c/p\u003e\n\u003ch2 id=\"footnote-4\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#footnote-4\"\u003e\u003ca href=\"#footnote-4\" style=\"margin-right: 10px\"\u003e#\u003c/a\u003e\u003c/a\u003eFootnote 4\u003c/h2\u003e\n\u003cp\u003eI have been playing through Pokemon Yellow and find it really amusing hence the\npokemon theme\u003c/p\u003e\n\u003cp\u003eFun stuff: The cutting room floor wiki with unused moves, sounds, and sprites\nin Pokemon Yellow \u003ca href=\"https://tcrf.net/Pok%C3%A9mon_Yellow\"\u003ehttps://tcrf.net/Pok%C3%A9mon_Yellow\u003c/a\u003e\u003c/p\u003e\n\u003ch2 id=\"footnote-5\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#footnote-5\"\u003e\u003ca href=\"#footnote-5\" style=\"margin-right: 10px\"\u003e#\u003c/a\u003e\u003c/a\u003eFootnote 5\u003c/h2\u003e\n\u003cp\u003eThis blog post mentioned in a comment thread \u003ca href=\"https://zansh.in/memoizer.html\"\u003ehttps://zansh.in/memoizer.html\u003c/a\u003e has\ngreat interactive examples and shows the \"invalidate on .catch()\" behavior!\u003c/p\u003e"}},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"2022-02-26-memoize-async"},"buildId":"_YMuq3zsME1OjCEtwgBe6","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>