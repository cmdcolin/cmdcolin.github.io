(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[614],{3905:function(e,n,t){"use strict";t.d(n,{kt:function(){return p}});var r=t(7294);function o(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function a(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function l(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?a(Object(t),!0).forEach((function(n){o(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function i(e,n){if(null==e)return{};var t,r,o=function(e,n){if(null==e)return{};var t,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)t=a[r],n.indexOf(t)>=0||(o[t]=e[t]);return o}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)t=a[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var u=r.createContext({}),c=function(e){var n=r.useContext(u),t=n;return e&&(t="function"===typeof e?e(n):l(l({},n),e)),t},s={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},d=r.forwardRef((function(e,n){var t=e.components,o=e.mdxType,a=e.originalType,u=e.parentName,d=i(e,["components","mdxType","originalType","parentName"]),p=c(t),f=o,h=p["".concat(u,".").concat(f)]||p[f]||s[f]||a;return t?r.createElement(h,l(l({ref:n},d),{},{components:t})):r.createElement(h,l({ref:n},d))}));function p(e,n){var t=arguments,o=n&&n.mdxType;if("string"===typeof e||o){var a=t.length,l=new Array(a);l[0]=d;var i={};for(var u in n)hasOwnProperty.call(n,u)&&(i[u]=n[u]);i.originalType=e,i.mdxType="string"===typeof e?e:o,l[1]=i;for(var c=2;c<a;c++)l[c]=t[c];return r.createElement.apply(null,l)}return r.createElement.apply(null,t)}d.displayName="MDXCreateElement"},4995:function(e,n,t){"use strict";t.r(n),t.d(n,{default:function(){return o}});var r=t(5893);function o(e){var n=e.children;return(0,r.jsxs)("div",{children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("a",{href:"/",children:"Return home"}),(0,r.jsx)("img",{src:"/avatar.png",style:{height:"2em",marginLeft:"1em"}})]}),(0,r.jsx)("div",{className:"blog",children:n})]})}},7277:function(e,n,t){"use strict";t.r(n),t.d(n,{default:function(){return s}});var r=t(159),o=t(219),a=(t(7294),t(3905)),l=t(4995),i=["components"],u={},c=function(e){var n=e.children;return(0,a.kt)(l.default,null,n)};function s(e){var n=e.components,t=(0,o.Z)(e,i);return(0,a.kt)(c,(0,r.Z)({},u,t,{components:n,mdxType:"MDXLayout"}),(0,a.kt)("h2",null,"A spooky error when you have a string bigger than 512MB"),(0,a.kt)("p",null,"Now gather round for a spooky story"),(0,a.kt)("p",null,"Late one night... in the haunted office space castle (hindenbugs cackling in\nthe background amongst the dusty technical books) the midnight candles were\nburning bright and we entered data for a user file"),(0,a.kt)("p",null,"A simple 52MB gzipped datafile that we want to process in the browser. We unzip\nit, decode it, and ...an error"),(0,a.kt)("p",null,"ERROR: data not found"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"/media/pumpkin-dark.jpg",alt:null})),(0,a.kt)("p",null,"Our code is simple, it looks like"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"const buffer = unzip(file)\nconst str = new TextDecoder().decode(buf);\n")),(0,a.kt)("p",null,"We trace it back and run a console.log(str)"),(0,a.kt)("p",null,"It looks empty. We try running console.log(str.length) ... it prints out 0"),(0,a.kt)("p",null,"But if we console.log(buffer.length) we get 546,483,710 bytes..."),(0,a.kt)("p",null,"What could be happening?"),(0,a.kt)("p",null,'We see in the TextDecoder documentation that it has a note called "fatal". We try'),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},'const buffer = unzip(file)\nconst str = new TextDecoder("utf8",{fatal:true}).decode(buf);\n')),(0,a.kt)("p",null,"This doesn't change, but it seems like TextDecoder is failing."),(0,a.kt)("p",null,"Then it dawns on us while the lightning hits and the thunderclap booms and the wind blows through the rattly windows"),(0,a.kt)("p",null,"We have hit...the maximum string length in Chrome"),(0,a.kt)("p",null,"BWAHAHAHAHA"),(0,a.kt)("p",null,"The maximum string length!!! Nooooooo"),(0,a.kt)("p",null,"It is 512MB on the dot... 536,870,888 bytes. We test this to be sure"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'const len = 536_870_888;\nconst buf = new Uint8Array(len);\nfor (let i = 0; i < len; i++) {\n  buf[i] = "a".charCodeAt(0);\n}\nconst str = new TextDecoder().decode(buf);\nconsole.log(str.length);\n\n')),(0,a.kt)("p",null,"This is correct, outputs  536,870,888"),(0,a.kt)("p",null,"With anything, even one byte more, it fails and outputs 0"),(0,a.kt)("p",null,"With 512MB+1 bytes on node.js it actually prints an error instead of no error\nmessage like chrome"),(0,a.kt)("p",null,"happy halloween!!"),(0,a.kt)("p",null,"pumpkin photo source: ",(0,a.kt)("a",{parentName:"p",href:"http://mountainbikerak.blogspot.com/2010/11/google-chrome-pumpkin.html"},"http://mountainbikerak.blogspot.com/2010/11/google-chrome-pumpkin.html")),(0,a.kt)("p",null,"addendum: with node js it actually prints an error instead of being silent"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"~ \u276f\u276f\u276f node test.js                                                                            \u2718 130\nnode:buffer:603\n    slice: (buf, start, end) => buf.ucs2Slice(start, end),\n                                    ^\n\nError: Cannot create a string longer than 0x1fffffe8 characters\n    at Object.slice (node:buffer:603:37)\n    at Uint8Array.toString (node:buffer:812:14)\n    at TextDecoder.decode (node:internal/encoding:426:18)\n    at Object.<anonymous> (/home/cdiesh/test.js:6:31)\n    at Module._compile (node:internal/modules/cjs/loader:1092:14)\n    at Object.Module._extensions..js (node:internal/modules/cjs/loader:1121:10)\n    at Module.load (node:internal/modules/cjs/loader:972:32)\n    at Function.Module._load (node:internal/modules/cjs/loader:813:14)\n    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:76:12)\n    at node:internal/main/run_main_module:17:47 {\n  code: 'ERR_STRING_TOO_LONG'\n\n")),(0,a.kt)("p",null,"Curiously, with a 600_000_000 byte string it is a different error...who knows why (lightning clap)"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"~ \u276f\u276f\u276f node test.js                                                                            \u2718 130\nnode:internal/encoding:424\n        throw new ERR_ENCODING_INVALID_ENCODED_DATA(this.encoding, ret);\n        ^\n\nTypeError [ERR_ENCODING_INVALID_ENCODED_DATA]: The encoded data was not valid for encoding utf-8\n    at new NodeError (node:internal/errors:329:5)\n    at TextDecoder.decode (node:internal/encoding:424:15)\n    at Object.<anonymous> (/home/cdiesh/test.js:6:31)\n    at Module._compile (node:internal/modules/cjs/loader:1092:14)\n    at Object.Module._extensions..js (node:internal/modules/cjs/loader:1121:10)\n    at Module.load (node:internal/modules/cjs/loader:972:32)\n    at Function.Module._load (node:internal/modules/cjs/loader:813:14)\n    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:76:12)\n    at node:internal/main/run_main_module:17:47 {\n  errno: 1,\n  code: 'ERR_ENCODING_INVALID_ENCODED_DATA'\n}\n\n")))}s.isMDXComponent=!0},3308:function(e,n,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/2021-10-30-spooky",function(){return t(7277)}])},159:function(e,n,t){"use strict";function r(){return(r=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])}return e}).apply(this,arguments)}t.d(n,{Z:function(){return r}})},219:function(e,n,t){"use strict";function r(e,n){if(null==e)return{};var t,r,o=function(e,n){if(null==e)return{};var t,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)t=a[r],n.indexOf(t)>=0||(o[t]=e[t]);return o}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)t=a[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}t.d(n,{Z:function(){return r}})}},function(e){e.O(0,[774,888,179],(function(){return n=3308,e(e.s=n);var n}));var n=e.O();_N_E=n}]);