(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[614],{3905:function(e,t,n){"use strict";n.d(t,{kt:function(){return f}});var r=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},l=Object.keys(e);for(r=0;r<l.length;r++)n=l[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(r=0;r<l.length;r++)n=l[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var u=r.createContext({}),c=function(e){var t=r.useContext(u),n=t;return e&&(n="function"===typeof e?e(t):a(a({},t),e)),n},s={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},p=r.forwardRef((function(e,t){var n=e.components,o=e.mdxType,l=e.originalType,u=e.parentName,p=i(e,["components","mdxType","originalType","parentName"]),f=c(n),h=o,d=f["".concat(u,".").concat(h)]||f[h]||s[h]||l;return n?r.createElement(d,a(a({ref:t},p),{},{components:n})):r.createElement(d,a({ref:t},p))}));function f(e,t){var n=arguments,o=t&&t.mdxType;if("string"===typeof e||o){var l=n.length,a=new Array(l);a[0]=p;var i={};for(var u in t)hasOwnProperty.call(t,u)&&(i[u]=t[u]);i.originalType=e,i.mdxType="string"===typeof e?e:o,a[1]=i;for(var c=2;c<l;c++)a[c]=n[c];return r.createElement.apply(null,a)}return r.createElement.apply(null,n)}p.displayName="MDXCreateElement"},4995:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return o}});var r=n(5893);function o(e){var t=e.children;return(0,r.jsxs)("div",{children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("a",{href:"/",children:"Return home"}),(0,r.jsx)("img",{src:"/avatar.png",style:{height:"2em",marginLeft:"1em"}})]}),(0,r.jsx)("div",{className:"blog",children:t})]})}},7277:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return s}});var r=n(159),o=n(219),l=(n(7294),n(3905)),a=n(4995),i=["components"],u={},c=function(e){var t=e.children;return(0,l.kt)(a.default,null,t)};function s(e){var t=e.components,n=(0,o.Z)(e,i);return(0,l.kt)(c,(0,r.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,l.kt)("h2",null,"A spooky error when you have a string bigger than 512MB in Chrome"),(0,l.kt)("p",null,"Now gather round for a spooky story"),(0,l.kt)("p",null,"Late one night... in the haunted office space castle (hindenbugs cackling in\nthe background amongst the dusty technical books) the midnight candles were\nburning bright and we entered data for a user file"),(0,l.kt)("p",null,"A simple 52MB gzipped datafile that we want to process in the browser. We unzip\nit, decode it, and ...an error"),(0,l.kt)("p",null,"ERROR: data not found"),(0,l.kt)("p",null,(0,l.kt)("img",{parentName:"p",src:"/media/pumpkin-dark.jpg",alt:null})),(0,l.kt)("p",null,'But... our code is so simple (we of course abide by the religion of writing "simple code" you know)...what could be happening?'),(0,l.kt)("p",null,"The code looks like this"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"const buffer = unzip(file)\nconst str = new TextDecoder().decode(buf);\n")),(0,l.kt)("p",null,"We trace it back and run a console.log(str)"),(0,l.kt)("p",null,"It looks empty. We try running console.log(str.length) ... it prints out 0"),(0,l.kt)("p",null,"But if we console.log(buffer.length) we get 546,483,710 bytes..."),(0,l.kt)("p",null,"What could be happening?"),(0,l.kt)("p",null,'We see in the TextDecoder documentation that it has a note called "fatal". We try'),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},'const buffer = unzip(file)\nconst str = new TextDecoder("utf8",{fatal:true}).decode(buf);\n')),(0,l.kt)("p",null,"This doesn't change the results though"),(0,l.kt)("p",null,"Then it dawns on us while the lightning hits and the thunderclap booms and the\nwind blows through the rattly windows"),(0,l.kt)("p",null,"We have hit...the maximum string length in Chrome"),(0,l.kt)("p",null,"BWAHAHAHAHA"),(0,l.kt)("p",null,"The maximum string length!!! Nooooooo"),(0,l.kt)("p",null,"It is 512MB on the dot... 536,870,888 bytes. We test this to be sure"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},'const len = 536_870_888;\nconst buf = new Uint8Array(len);\nfor (let i = 0; i < len; i++) {\n  buf[i] = "a".charCodeAt(0);\n}\nconst str = new TextDecoder().decode(buf);\nconsole.log(str.length);\n\n')),(0,l.kt)("p",null,"This is correct, outputs  536,870,888"),(0,l.kt)("p",null,"With anything, even one byte more, it fails and outputs 0"),(0,l.kt)("p",null,"With 512MB+1 bytes on node.js it actually prints an error instead of no error\nmessage like chrome (node prints ",(0,l.kt)("inlineCode",{parentName:"p"},"Error: Cannot create a string longer than\n0x1fffffe8 characters")," for slightly over 512MB and actually prints a different\nerror at e.g. 600MB ",(0,l.kt)("inlineCode",{parentName:"p"},"TypeError [ERR_ENCODING_INVALID_ENCODED_DATA]: The encoded\ndata was not valid for encoding utf-8"),")"),(0,l.kt)("p",null,"happy halloween!!"),(0,l.kt)("p",null,"pumpkin photo source: ",(0,l.kt)("a",{parentName:"p",href:"http://mountainbikerak.blogspot.com/2010/11/google-chrome-pumpkin.html"},"http://mountainbikerak.blogspot.com/2010/11/google-chrome-pumpkin.html")))}s.isMDXComponent=!0},3308:function(e,t,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/2021-10-30-spooky",function(){return n(7277)}])},159:function(e,t,n){"use strict";function r(){return(r=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}n.d(t,{Z:function(){return r}})},219:function(e,t,n){"use strict";function r(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},l=Object.keys(e);for(r=0;r<l.length;r++)n=l[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(r=0;r<l.length;r++)n=l[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}n.d(t,{Z:function(){return r}})}},function(e){e.O(0,[774,888,179],(function(){return t=3308,e(e.s=t);var t}));var t=e.O();_N_E=t}]);