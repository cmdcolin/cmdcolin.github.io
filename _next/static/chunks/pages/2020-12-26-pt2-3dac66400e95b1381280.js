(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[954],{3905:function(e,t,n){"use strict";n.d(t,{kt:function(){return d}});var o=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,o,r=function(e,t){if(null==e)return{};var n,o,r={},a=Object.keys(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var u=o.createContext({}),s=function(e){var t=o.useContext(u),n=t;return e&&(n="function"===typeof e?e(t):i(i({},t),e)),n},c={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},p=o.forwardRef((function(e,t){var n=e.components,r=e.mdxType,a=e.originalType,u=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),d=s(n),m=r,h=d["".concat(u,".").concat(m)]||d[m]||c[m]||a;return n?o.createElement(h,i(i({ref:t},p),{},{components:n})):o.createElement(h,i({ref:t},p))}));function d(e,t){var n=arguments,r=t&&t.mdxType;if("string"===typeof e||r){var a=n.length,i=new Array(a);i[0]=p;var l={};for(var u in t)hasOwnProperty.call(t,u)&&(l[u]=t[u]);l.originalType=e,l.mdxType="string"===typeof e?e:r,i[1]=l;for(var s=2;s<a;s++)i[s]=n[s];return o.createElement.apply(null,i)}return o.createElement.apply(null,n)}p.displayName="MDXCreateElement"},4995:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return r}});var o=n(5893);function r(e){var t=e.children;return(0,o.jsxs)("div",{children:[(0,o.jsxs)("div",{children:[(0,o.jsx)("a",{href:"/",children:"Return home"}),(0,o.jsx)("img",{src:"/avatar.png",style:{height:"2em",marginLeft:"1em"}})]}),(0,o.jsx)("div",{className:"blog",children:t})]})}},9738:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return c}});var o=n(159),r=n(219),a=(n(7294),n(3905)),i=n(4995),l=["components"],u={},s=function(e){var t=e.children;return(0,a.kt)(i.default,null,t)};function c(e){var t=e.components,n=(0,r.Z)(e,l);return(0,a.kt)(s,(0,o.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",null,"Making a HTTPS accessible S3 powered static site with CloudFront+route 53"),(0,a.kt)("p",null,"This is not a very authoritative post because I stumbled though this but\nI think I got it working now on my website :)"),(0,a.kt)("h2",null,"Setup your S3 bucket"),(0,a.kt)("p",null,"First setup your S3 bucket, your bucket must be named yourdomain.com\ne.g. named after your domain"),(0,a.kt)("p",null,"Then if you have a create-react-app setup I add a script in package.json\nthat runs"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},' "predeploy": "npm run build",\n "deploy": "aws sync --delete build s3://yourdomain.com"\n')),(0,a.kt)("p",null,'Then we can run "yarn deploy" and it will automatically upload our\ncreate-react-app website to our S3 static site bucket.'),(0,a.kt)("p",null,"Then make sure your bucket has public permissions enabled\n",(0,a.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/AmazonS3/latest/dev/example-bucket-policies.html#example-bucket-policies-use-case-2"},"https://docs.aws.amazon.com/AmazonS3/latest/dev/example-bucket-policies.html#example-bucket-policies-use-case-2"),'Then\nmake sure your bucket has "static site hosting" enabled too'),(0,a.kt)("h2",null,"Setup route 53, and make your NS entries in domains.google.com"),(0,a.kt)("p",null,"I bought a domain with domains.google.com"),(0,a.kt)("p",null,"Google then emailed me to validate my ownership"),(0,a.kt)("p",null,"Then I went to aws.amazon.com route 53\xa0and I created a hosted zone"),(0,a.kt)("p",null,"This generated 4 name server entries and I added those to the\ndomains.google.com site"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"/media/638618421776515072_0.png",alt:null})),(0,a.kt)("p",null,"Screenshot shows copying the NS values from route 53 to the name servers\narea of domains.google.com"),(0,a.kt)("h2",null,"Setup your Amazon certificate for making SSL work on CloudFront"),(0,a.kt)("p",null,"To properly setup However, this does not work so you need to go to\nAmazon Certificates->Provision certificates"),(0,a.kt)("p",null,"We request the certificate for"),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"http://www.yourdomain.com"},"www.yourdomain.com"),"\nyourdomain.com"),(0,a.kt)("p",null,"Then it generates some codes for a CNAME value for each of those two\nentries, and has a button to autoimport those CNAME values to route53"),(0,a.kt)("p",null,'Then it will say\xa0"Pending validation"...I waited like an hour and then\nit changed to\xa0"Success".'),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"/media/638618421776515072_1.png",alt:null})),(0,a.kt)("p",null,"Screenshot shows the now successful Amazon Certificate. After you get\nthis, you can proceed to finishing your cloudfront"),(0,a.kt)("h2",null,'Create a CloudFront distribution and add "Alternative CNAME" entries for your domain'),(0,a.kt)("p",null,'Then we can update our CloudFront distribution and add these to\nthe\xa0"Alternative CNAME" input box'),(0,a.kt)("p",null,"yourdomain.com\n",(0,a.kt)("a",{parentName:"p",href:"http://www.yourdomain.com"},"www.yourdomain.com")),(0,a.kt)("p",null,'Note also that I first generated my certificate in us-east-2 but the\n"Import certificate form" in cloudfront said I had to create it in\nus-east-1'),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"/media/638618421776515072_2.png",alt:null})),(0,a.kt)("h2",null,"Add a default object index.html to the CloudFront setting"),(0,a.kt)("p",null,'Make your CloudFront\xa0"default object" is index.html'),(0,a.kt)("p",null,"You have to manually type this in :)"),(0,a.kt)("h2",null,"Add the CloudFront distribution to your Route 53"),(0,a.kt)("p",null,'Add a Route 53 "A" record that points to the CloudFront domain name e.g.\nd897d897d87d98dd.cloudfront.net'),(0,a.kt)("h2",null,"Summary of steps needed"),(0,a.kt)("p",null,"The general hindsight 20/20 procedure is"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Upload your static content to an S3 bucket called yoursite.com (must\nbe your domain name)"),(0,a.kt)("li",{parentName:"ol"},'Make your S3 bucket have the "static website" setting on in the\nproperties menu and add a permissions policy that supports getObject\ne.g.\xa0',(0,a.kt)("a",{parentName:"li",href:"https://docs.aws.amazon.com/AmazonS3/latest/dev/example-bucket-policies.html#example-bucket-policies-use-case-2"},"https://docs.aws.amazon.com/AmazonS3/latest/dev/example-bucket-policies.html#example-bucket-policies-use-case-2")),(0,a.kt)("li",{parentName:"ol"},"Create a CloudFront distribution for your website"),(0,a.kt)("li",{parentName:"ol"},"Make the CloudFront default object index.html"),(0,a.kt)("li",{parentName:"ol"},"Create your domain with domains.google.com or similar"),(0,a.kt)("li",{parentName:"ol"},"Point the google domain's name server to Route 53 NS list from AWS"),(0,a.kt)("li",{parentName:"ol"},"Add Route 53 A records that point to the CloudFront domain name e.g.\nd897d897d87d98dd.cloudfront.net"),(0,a.kt)("li",{parentName:"ol"},"Create Amazon issued certificate for yourdomain.com, which can\nauto-import a validation CNAME to your Route 53"),(0,a.kt)("li",{parentName:"ol"},"Make your CloudFront domain support your Alternative CNAME's e.g.\nyourdomain.com which requires importing (e.g. selecting from a list\nthat they auto-populate) your Amazon-issued-certificate")),(0,a.kt)("h2",null,"Troubleshooting and notes"),(0,a.kt)("p",null,"Problem: Your website gives 403 CloudFlare error\nSolution: You have to get the Alternateive CNAME configuration setup\n(pre-step involves the certificate request and validation)"),(0,a.kt)("p",null,'Problem: Your website gives an object not found error\nSolution: Set the CloudFront "default object" to index.html'),(0,a.kt)("h2",null,"Random comment"),(0,a.kt)("p",null,"This is one of those processes (creating the cloudfront/route 53) that\nprobably could have done with the aws-sam CLI and it would have possibly\nbeen easier, it is quite fiddly doing all these steps in the web\ninterface"),(0,a.kt)("p",null,"::: {#footer}\n","[ December 26th, 2020 8:53pm ]","{#timestamp}\n:::"))}c.isMDXComponent=!0},5243:function(e,t,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/2020-12-26-pt2",function(){return n(9738)}])},159:function(e,t,n){"use strict";function o(){return(o=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e}).apply(this,arguments)}n.d(t,{Z:function(){return o}})},219:function(e,t,n){"use strict";function o(e,t){if(null==e)return{};var n,o,r=function(e,t){if(null==e)return{};var n,o,r={},a=Object.keys(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}n.d(t,{Z:function(){return o}})}},function(e){e.O(0,[774,888,179],(function(){return t=5243,e(e.s=t);var t}));var t=e.O();_N_E=t}]);