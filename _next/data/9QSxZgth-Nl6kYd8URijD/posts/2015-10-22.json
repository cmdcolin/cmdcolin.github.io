{"pageProps":{"post":{"title":"Killing postgres the hard way","date":"2015-10-22","slug":"2015-10-22","html":"<p>So today, I finally decided to do something about a query that we saw\nhad been running for 25 DAYS on our server</p>\n<p>Note: If you find this post and you need to follow the hard way, backup\nyour data first if possible.</p>\n<p>First I could obviously see the culprit: each postgress query runs it's\nown process so I could see in \"htop\" that there was this process that\nhad been running for 600 hours, or about 25 days</p>\n<p>Next, I opened a psql console and ran this query:</p>\n<div class=\"highlight highlight-sql\"><pre><span class=\"pl-k\">SELECT</span> datname,procpid,current_query <span class=\"pl-k\">FROM</span> pg_stat_activity <span class=\"pl-k\">WHERE</span> datname<span class=\"pl-k\">=</span><span class=\"pl-s\"><span class=\"pl-pds\">'</span>database_name<span class=\"pl-pds\">'</span></span> <span class=\"pl-k\">ORDER BY</span> procpid ;\n</pre></div>\n<p>This returns which actual queries are being run on the database at any\ngiven time. I could easily see the one problematic query being run,\nwhich was a badly constructed intermine template query that resulted in\na weird \"recursion\" essentially.</p>\n<p>I wanted to try just terminating this query itself, so I ran this</p>\n<pre><code>SELECT pg_cancel_backend(29033);\n</code></pre>\n<p>Each time I ran it, it would say it returned one result but it did\nnothing.</p>\n<p>I also read that you can try to nicely \"kill\" it from the command line\n(no kill -9) so I ran</p>\n<div class=\"highlight highlight-shell\"><pre><span class=\"pl-k\">></span> <span class=\"pl-c1\">kill</span> 29033\n</pre></div>\n<p>This also did not work!</p>\n<p>I thought perhaps all these problems were because tomcat was still\nactive, so we shut down tomcat, and retried killing the specific query,\nbut to no avail</p>\n<p>At this point, I just wanted to restart the whole database server. Kind\nof a risky move... but I am sort of a risky kind of guy...(that is not a\ngood thing with databases). If you are doing this, make backups! I\ndidn't. Luckily I suffered no data loss but what follows is kind of\nintense.</p>\n<p>So first, I try and stop the database service</p>\n<div class=\"highlight highlight-shell\"><pre><span class=\"pl-k\">></span> service postgresql-9.1 stop\n</pre></div>\n<p>Unfortunately, this <code>[FAILED]</code> ! And of course, even though it failed,\nthe database is now unusable. No logging into it anymore, we have to go\nwith the hard way now...</p>\n<p>Looking at /etc/init.d/postgres-9.1 told me that the service stop\ncommand was effectively using something like this:</p>\n<div class=\"highlight highlight-shell\"><pre><span class=\"pl-k\">></span> pg_ctl -D /db/postgres/data -m fast stop\n</pre></div>\n<p>After some reading, I learned that you can try using a slightly\ndifferent flag to restart it</p>\n<div class=\"highlight highlight-shell\"><pre><span class=\"pl-k\">></span> pg_ctl -D /db/postgres/data -m immediate  stop\n</pre></div>\n<p>I ran this and to my horror/surprise, it actually worked! At this point\nI decided to start postgresql back up again!</p>\n<div class=\"highlight highlight-shell\"><pre><span class=\"pl-k\">></span> service postgresql-9.1 start\n</pre></div>\n<p>The service start quickly returned a SUCCESS, which was great, but then\nI tried to start a psql console and the console froze on me! I could not\neven ctrl+c it!</p>\n<p>I got really worried at this point and I looked at the process manager,\nand saw that there was one postmaster process running but it was not\nclear what it was doing. I actually tried to shutdown the server again\nin a panic mode but at this point it said</p>\n<div class=\"highlight highlight-shell\"><pre><span class=\"pl-k\">></span> /usr/pgsql-9.1/bin/pg_ctl stop -D /db/postgres/data/ -m immediate\n<span class=\"pl-k\">></span> waiting <span class=\"pl-k\">for</span> server to shut\n<span class=\"pl-k\">></span> down...............................................................\n<span class=\"pl-k\">></span> failed\n</pre></div>\n<p>It was probably good that it didn't shut down, because I would quickly\nfind out that it was in recovery mode. I looked at the postgresql logs\nand I saw this, reproduced here for full detail (from before the\nshutdown to the restart)</p>\n<div class=\"highlight highlight-shell\"><pre><span class=\"pl-k\">></span> WARNING:  pgstat <span class=\"pl-c1\">wait</span> timeout\n<span class=\"pl-k\">></span> WARNING:  pgstat <span class=\"pl-c1\">wait</span> timeout\n<span class=\"pl-k\">></span> WARNING:  pgstat <span class=\"pl-c1\">wait</span> timeout\n<span class=\"pl-k\">></span> WARNING:  pgstat <span class=\"pl-c1\">wait</span> timeout\n<span class=\"pl-k\">></span> WARNING:  pgstat <span class=\"pl-c1\">wait</span> timeout\n<span class=\"pl-k\">></span> WARNING:  pgstat <span class=\"pl-c1\">wait</span> timeout\n<span class=\"pl-k\">></span> WARNING:  pgstat <span class=\"pl-c1\">wait</span> timeout\n<span class=\"pl-k\">></span> WARNING:  pgstat <span class=\"pl-c1\">wait</span> timeout\n<span class=\"pl-k\">></span>\n<span class=\"pl-k\">></span> ERROR:  canceling statement due to user request\n<span class=\"pl-k\">></span> STATEMENT:  CREATE TABLE precomp_90519 AS SELECT DISTINCT a1_.id AS\n<span class=\"pl-k\">></span> a1_id, a2_.id AS a2_id, a3_.id AS a3_id, a4_.id AS a4_id,\n<span class=\"pl-k\">></span> a5_.id AS a5_id, a6_.id AS a6_id, a12_.id AS a12_id, a10_.id AS\n<span class=\"pl-k\">></span> a10_id, a1_.id AS a13_, a1_.primaryIdentifier AS a14_,\n<span class=\"pl-k\">></span> a1_.secondaryIdentifier AS a15_, a2_.type AS a16_, a3_.name AS\n<span class=\"pl-k\">></span> a17_, a4_.primaryIdentifier AS a18_, a5_.primaryIdentifier AS\n<span class=\"pl-k\">></span> a19_, a6_.shortName AS a20_, a12_.identifier AS a21_, a10_.code\n<span class=\"pl-k\">></span> AS a22_ FROM Gene AS a1_, Homologue AS a2_, Organism AS a3_, Gene\n<span class=\"pl-k\">></span> AS a4_, Gene AS a5_, Organism AS a6_, GOAnnotation AS a7_,\n<span class=\"pl-k\">></span> GOEvidence AS a8_, OntologyTerm AS a9_, GOEvidenceCode AS a10_,\n<span class=\"pl-k\">></span> OntologyAnnotation AS a11_, OntologyTerm AS a12_, GeneGoAnnotation\n<span class=\"pl-k\">></span> AS indirect0, EvidenceGOAnnotation AS indirect1 WHERE a1_.id =\n<span class=\"pl-k\">></span> a2_.geneId AND a1_.organismId = a3_.id AND a2_.geneId = a4_.id\n<span class=\"pl-k\">></span> AND a2_.homologueId = a5_.id AND a5_.organismId = a6_.id AND\n<span class=\"pl-k\">></span> a1_.id = indirect0.Gene AND indirect0.GoAnnotation = a7_.id AND\n<span class=\"pl-k\">></span> a7_.id = indirect1.GOAnnotation AND indirect1.Evidence = a8_.id AND\n<span class=\"pl-k\">></span> a7_.ontologyTermId = a9_.id AND a8_.codeId = a10_.id AND a9_.id =\n<span class=\"pl-k\">></span> a11_.ontologyTermId AND a11_.ontologyTermId = a12_.id ORDER BY\n<span class=\"pl-k\">></span> a1_.primaryIdentifier, a1_.secondaryIdentifier, a2_.type,\n<span class=\"pl-k\">></span> a3_.name, a4_.primaryIdentifier, a5_.primaryIdentifier,\n<span class=\"pl-k\">></span> a6_.shortName, a12_.identifier, a10_.code, a1_.id, a2_.id,\n<span class=\"pl-k\">></span> a3_.id, a4_.id, a5_.id, a6_.id, a12_.id, a10_.id\n<span class=\"pl-k\">></span> LOG:  could not send data to client: Broken pipe\n<span class=\"pl-k\">></span> STATEMENT:  CREATE TABLE precomp_90519 AS SELECT DISTINCT a1_.id AS\n<span class=\"pl-k\">></span> a1_id, a2_.id AS a2_id, a3_.id AS a3_id, a4_.id AS a4_id,\n<span class=\"pl-k\">></span> a5_.id AS a5_id, a6_.id AS a6_id, a12_.id AS a12_id, a10_.id AS\n<span class=\"pl-k\">></span> a10_id, a1_.id AS a13_, a1_.primaryIdentifier AS a14_,\n<span class=\"pl-k\">></span> a1_.secondaryIdentifier AS a15_, a2_.type AS a16_, a3_.name AS\n<span class=\"pl-k\">></span> a17_, a4_.primaryIdentifier AS a18_, a5_.primaryIdentifier AS\n<span class=\"pl-k\">></span> a19_, a6_.shortName AS a20_, a12_.identifier AS a21_, a10_.code\n<span class=\"pl-k\">></span> AS a22_ FROM Gene AS a1_, Homologue AS a2_, Organism AS a3_, Gene\n<span class=\"pl-k\">></span> AS a4_, Gene AS a5_, Organism AS a6_, GOAnnotation AS a7_,\n<span class=\"pl-k\">></span> GOEvidence AS a8_, OntologyTerm AS a9_, GOEvidenceCode AS a10_,\n<span class=\"pl-k\">></span> OntologyAnnotation AS a11_, OntologyTerm AS a12_, GeneGoAnnotation\n<span class=\"pl-k\">></span> AS indirect0, EvidenceGOAnnotation AS indirect1 WHERE a1_.id =\n<span class=\"pl-k\">></span> a2_.geneId AND a1_.organismId = a3_.id AND a2_.geneId = a4_.id\n<span class=\"pl-k\">></span> AND a2_.homologueId = a5_.id AND a5_.organismId = a6_.id AND\n<span class=\"pl-k\">></span> a1_.id = indirect0.Gene AND indirect0.GoAnnotation = a7_.id AND\n<span class=\"pl-k\">></span> a7_.id = indirect1.GOAnnotation AND indirect1.Evidence = a8_.id AND\n<span class=\"pl-k\">></span> a7_.ontologyTermId = a9_.id AND a8_.codeId = a10_.id AND a9_.id =\n<span class=\"pl-k\">></span> a11_.ontologyTermId AND a11_.ontologyTermId = a12_.id ORDER BY\n<span class=\"pl-k\">></span> a1_.primaryIdentifier, a1_.secondaryIdentifier, a2_.type,\n<span class=\"pl-k\">></span> a3_.name, a4_.primaryIdentifier, a5_.primaryIdentifier,\n<span class=\"pl-k\">></span> a6_.shortName, a12_.identifier, a10_.code, a1_.id, a2_.id,\n<span class=\"pl-k\">></span> a3_.id, a4_.id, a5_.id, a6_.id, a12_.id, a10_.id\n<span class=\"pl-k\">></span> LOG:  unexpected EOF on client connection\n<span class=\"pl-k\">></span> LOG:  unexpected EOF on client connection\n<span class=\"pl-k\">></span> LOG:  unexpected EOF on client connection\n<span class=\"pl-k\">></span> LOG:  unexpected EOF on client connection\n<span class=\"pl-k\">></span> LOG:  received fast shutdown request\n<span class=\"pl-k\">></span> LOG:  aborting any active transactions\n<span class=\"pl-k\">></span> LOG:  autovacuum launcher shutting down\n<span class=\"pl-k\">></span> FATAL:  the database system is shutting down\n<span class=\"pl-k\">></span> FATAL:  the database system is shutting down\n<span class=\"pl-k\">></span> FATAL:  the database system is shutting down\n<span class=\"pl-k\">></span> FATAL:  the database system is shutting down\n<span class=\"pl-k\">></span> FATAL:  the database system is shutting down\n<span class=\"pl-k\">></span> FATAL:  the database system is shutting down\n<span class=\"pl-k\">></span> FATAL:  the database system is shutting down\n<span class=\"pl-k\">></span> FATAL:  the database system is shutting down\n<span class=\"pl-k\">></span> FATAL:  the database system is shutting down\n<span class=\"pl-k\">></span> FATAL:  the database system is shutting down\n<span class=\"pl-k\">></span> FATAL:  the database system is shutting down\n<span class=\"pl-k\">></span> FATAL:  the database system is shutting down\n<span class=\"pl-k\">></span> FATAL:  the database system is shutting down\n<span class=\"pl-k\">></span> FATAL:  the database system is shutting down\n<span class=\"pl-k\">></span> FATAL:  the database system is shutting down\n<span class=\"pl-k\">></span> FATAL:  the database system is shutting down\n<span class=\"pl-k\">></span> FATAL:  the database system is shutting down\n<span class=\"pl-k\">></span> FATAL:  the database system is shutting down\n<span class=\"pl-k\">></span> FATAL:  the database system is shutting down\n<span class=\"pl-k\">></span> FATAL:  the database system is shutting down\n<span class=\"pl-k\">></span> FATAL:  the database system is shutting down\n<span class=\"pl-k\">></span> FATAL:  the database system is shutting down\n<span class=\"pl-k\">></span> FATAL:  the database system is shutting down\n<span class=\"pl-k\">></span> FATAL:  the database system is shutting down\n<span class=\"pl-k\">></span> FATAL:  the database system is shutting down\n<span class=\"pl-k\">></span> FATAL:  the database system is shutting down\n<span class=\"pl-k\">></span> LOG:  received immediate shutdown request\n<span class=\"pl-k\">></span> WARNING:  terminating connection because of crash of another server\n<span class=\"pl-k\">></span> process\n<span class=\"pl-k\">></span> DETAIL:  The postmaster has commanded this server process to roll back\n<span class=\"pl-k\">></span> the current transaction and exit, because another server process\n<span class=\"pl-k\">></span> exited abnormally and possibly corrupted shared memory.\n<span class=\"pl-k\">></span> HINT:  In a moment you should be able to reconnect to the database and\n<span class=\"pl-k\">></span> repeat your command.\n<span class=\"pl-k\">></span> LOG:  received fast shutdown request\n<span class=\"pl-k\">></span> LOG:  database system was interrupted<span class=\"pl-k\">;</span> last known up at 2015-10-22\n<span class=\"pl-k\">></span> 15:47:43 CDT\n<span class=\"pl-k\">></span> LOG:  received immediate shutdown request\n<span class=\"pl-k\">></span> LOG:  database system was interrupted<span class=\"pl-k\">;</span> last known up at 2015-10-22\n<span class=\"pl-k\">></span> 15:47:43 CDT\n<span class=\"pl-k\">></span> LOG:  database system was not properly shut down<span class=\"pl-k\">;</span> automatic recovery\n<span class=\"pl-k\">></span> <span class=\"pl-k\">in</span> progress\n<span class=\"pl-k\">></span> LOG:  record with zero length at BBD/1CC2F0C0\n<span class=\"pl-k\">></span> ...\n</pre></div>\n<p>You can see all the weird activity that was done here</p>\n<ul>\n<li>first the attempt to \"canceling statement due to user request\" did not work</li>\n<li>then the database stop using -m fast</li>\n<li>then the database stop using -m immediate</li>\n<li>the restart (with the HINT, should be ready soon)</li>\n<li>the panic mode where i tried to shut it again anyways</li>\n</ul>\n<p>During the recovery period, I was still very concerned about the\ndatabase was doing, so I used \"strace\" to look at the main postmaster\nprocess.</p>\n<p>I was pleasantly surprised to see that the postmaster process was just\ncleaning up files in /db/postgres/data/base/pgsql_tmp/, I could see the\nfile system \"unlink\" command with successful status codes.</p>\n<p>There were about 150 large files in /db/postgres/data/base/pgsql_tmp/,\nand I waited about an hour for them to be deleted, and after that, the\npostgresql log file said it was ready, and indeed, it was perfect :)</p>\n<div class=\"highlight highlight-shell\"><pre><span class=\"pl-k\">></span> LOG:  redo is not required\n<span class=\"pl-k\">></span> LOG:  database system is ready to accept connections\n<span class=\"pl-k\">></span> LOG:  autovacuum launcher started\n</pre></div>\n<p>What a relief!</p>\n<p>I hope this might help any wayward stragglers to see how the postgresql\nrestart process works. Sometimes things don't shut down cleanly, but I\nthink it is still good to know some alternative steps to kill -9</p>"}},"__N_SSG":true}