{"pageProps":{"post":{"title":"Using Rust/WASM in a monorepo with create-react-app","date":"2022-08-22","slug":"2022-08-22-rustwasm","html":"<p>Behold, the buzzwords:</p>\n<ul>\n<li>Rust / WASM / wasm-bindgen</li>\n<li>React</li>\n<li>Monorepo / Yarn workspaces</li>\n<li>Webpack 5 / create-react-app 5</li>\n<li>Typescript</li>\n</ul>\n<p>The main goal here: To use Rust + WASM in a react app, inside a monorepo.</p>\n<p>TLDR: visit the final product!\n<a href=\"https://github.com/cmdcolin/rust_react_monorepo_template\">https://github.com/cmdcolin/rust_react_monorepo_template</a>. It is also deployed\nlive here <a href=\"https://cmdcolin.github.io/rust_react_monorepo_template\">https://cmdcolin.github.io/rust_react_monorepo_template</a></p>\n<h2 id=\"steps-to-create-this-type-of-integration-from-scratch\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#steps-to-create-this-type-of-integration-from-scratch\"><a href=\"#steps-to-create-this-type-of-integration-from-scratch\" style=\"margin-right: 10px\">#</a></a>Steps to create this type of integration from scratch</h2>\n<h3 id=\"create-repo\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#create-repo\"><a href=\"#create-repo\" style=\"margin-right: 10px\">#</a></a>Create repo</h3>\n<pre><code>mkdir template\ncd template\ngit init\n</code></pre>\n<h3 id=\"create-root-packagejson\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#create-root-packagejson\"><a href=\"#create-root-packagejson\" style=\"margin-right: 10px\">#</a></a>Create root <code>package.json</code></h3>\n<p>Then put this in the monorepo's root <code>package.json</code></p>\n<div class=\"highlight highlight-json\"><pre>{\n  <span class=\"pl-ent\">\"private\"</span>: <span class=\"pl-c1\">true</span>,\n  <span class=\"pl-ent\">\"workspaces\"</span>: [<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>hello-wasm<span class=\"pl-pds\">\"</span></span>, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>app<span class=\"pl-pds\">\"</span></span>]\n}\n</pre></div>\n<p>This sets our repo up as a \"monorepo\" with two \"workspaces\". one will be the\nwasm code, in <code>hello-wasm</code>, one will be an instance of <code>create-react-app</code></p>\n<h3 id=\"add-a-create-react-app-instance-inside-the-monorepo\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#add-a-create-react-app-instance-inside-the-monorepo\"><a href=\"#add-a-create-react-app-instance-inside-the-monorepo\" style=\"margin-right: 10px\">#</a></a>Add a <code>create-react-app</code> instance inside the monorepo</h3>\n<div class=\"highlight highlight-shell\"><pre>npx create-react-app --template typescript app\n</pre></div>\n<p>This will make an <code>app</code> subfolder inside our monorepo</p>\n<h3 id=\"download-the-hello-world-rust-wasm-bindgen-example-and-put-it-in-a-folder-named-hello-wasm\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#download-the-hello-world-rust-wasm-bindgen-example-and-put-it-in-a-folder-named-hello-wasm\"><a href=\"#download-the-hello-world-rust-wasm-bindgen-example-and-put-it-in-a-folder-named-hello-wasm\" style=\"margin-right: 10px\">#</a></a>Download the hello world rust <code>wasm-bindgen</code> example and put it in a folder named <code>hello-wasm</code></h3>\n<p>Download <a href=\"https://github.com/rustwasm/wasm-bindgen/tree/main/examples/hello_world\">https://github.com/rustwasm/wasm-bindgen/tree/main/examples/hello_world</a> to the hello-wasm folder</p>\n<p>This link can help <a href=\"https://download-directory.github.io/?url=https%3A%2F%2Fgithub.com%2Frustwasm%2Fwasm-bindgen%2Ftree%2Fmain%2Fexamples%2Fhello_world\">https://download-directory.github.io/?url=https%3A%2F%2Fgithub.com%2Frustwasm%2Fwasm-bindgen%2Ftree%2Fmain%2Fexamples%2Fhello_world</a></p>\n<h3 id=\"add-some-extra-fields-to-the-packagejson-in-the-hello-wasm-folder\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#add-some-extra-fields-to-the-packagejson-in-the-hello-wasm-folder\"><a href=\"#add-some-extra-fields-to-the-packagejson-in-the-hello-wasm-folder\" style=\"margin-right: 10px\">#</a></a>Add some extra fields to the <code>package.json</code> in the <code>hello-wasm</code> folder</h3>\n<div class=\"highlight highlight-json\"><pre>{\n  <span class=\"pl-ent\">\"name\"</span>: <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>hello-wasm<span class=\"pl-pds\">\"</span></span>,\n  <span class=\"pl-ent\">\"version\"</span>: <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>1.0.0<span class=\"pl-pds\">\"</span></span>,\n  <span class=\"pl-ent\">\"files\"</span>: [<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>pkg<span class=\"pl-pds\">\"</span></span>],\n  <span class=\"pl-ent\">\"main\"</span>: <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>pkg/index.js<span class=\"pl-pds\">\"</span></span>\n  <span class=\"pl-ii\">... rest</span>\n}\n</pre></div>\n<h3 id=\"modify-the-hello-wasm-example-to-return-a-value-instead-of-making-an-alert\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#modify-the-hello-wasm-example-to-return-a-value-instead-of-making-an-alert\"><a href=\"#modify-the-hello-wasm-example-to-return-a-value-instead-of-making-an-alert\" style=\"margin-right: 10px\">#</a></a>Modify the <code>hello-wasm</code> example to return a value instead of making an alert</h3>\n<p>I changed the rust code to return a String value instead of making an alert box</p>\n<div class=\"highlight highlight-rust\"><pre>#[wasm_bindgen]\n<span class=\"pl-k\">pub</span> <span class=\"pl-k\">fn</span> <span class=\"pl-en\">greet</span>(name: <span class=\"pl-k\">&#x26;str</span>) -> <span class=\"pl-k\">String</span> {\n    <span class=\"pl-c1\">format!</span>(<span class=\"pl-s\">\"Hello {}\"</span>, name)\n}\n</pre></div>\n<h3 id=\"build-the-hello-wasm-pkg\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#build-the-hello-wasm-pkg\"><a href=\"#build-the-hello-wasm-pkg\" style=\"margin-right: 10px\">#</a></a>Build the <code>hello-wasm</code> pkg</h3>\n<p>Go into the <code>hello-wasm</code> folder and run <code>yarn build</code>. This creates a directory\nnamed <code>pkg</code> which has <code>.wasm</code> files and <code>.js</code> files. Now, the <code>hello-wasm</code>\nfolder is effectively a node package. We could publish this to <code>NPM</code> (see\nfootnote 1)</p>\n<h3 id=\"add-the-hello-wasm-package-to-the-app-dependencies\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#add-the-hello-wasm-package-to-the-app-dependencies\"><a href=\"#add-the-hello-wasm-package-to-the-app-dependencies\" style=\"margin-right: 10px\">#</a></a>Add the <code>hello-wasm</code> package to the <code>app</code> dependencies</h3>\n<p>Add <code>\"hello-wasm\":\"^1.0.0\"</code> to the <code>dependencies</code> array in <code>app/package.json</code>. This\nwill refer to our local monorepo's rust wasm package!</p>\n<h3 id=\"create-craco-config-for-create-react-app\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#create-craco-config-for-create-react-app\"><a href=\"#create-craco-config-for-create-react-app\" style=\"margin-right: 10px\">#</a></a>Create craco config for <code>create-react-app</code></h3>\n<p>As of writing, with <code>webpack</code> v5/<code>create-react-app</code> v5, you have to customize\nthe <code>create-react-app</code> to add extra <code>webpack</code> flags.</p>\n<p>So, <code>yarn add @craco/craco</code> in the app folder, then create this <code>craco.config.js</code></p>\n<div class=\"highlight highlight-js\"><pre><span class=\"pl-c1\">module</span>.<span class=\"pl-smi\">exports</span> <span class=\"pl-k\">=</span> {\n  webpack<span class=\"pl-k\">:</span> {\n    <span class=\"pl-en\">configure</span><span class=\"pl-k\">:</span> <span class=\"pl-smi\">config</span> <span class=\"pl-k\">=></span> {\n      <span class=\"pl-k\">const</span> <span class=\"pl-c1\">wasmExtensionRegExp</span> <span class=\"pl-k\">=</span> <span class=\"pl-k\">/</span>\\.<span class=\"pl-smi\">wasm$</span><span class=\"pl-k\">/</span>\n      <span class=\"pl-smi\">config</span>.<span class=\"pl-smi\">resolve</span>.<span class=\"pl-smi\">extensions</span>.<span class=\"pl-c1\">push</span>(<span class=\"pl-s\"><span class=\"pl-pds\">'</span>.wasm<span class=\"pl-pds\">'</span></span>)\n      <span class=\"pl-smi\">config</span>.<span class=\"pl-smi\">experiments</span> <span class=\"pl-k\">=</span> {\n        syncWebAssembly<span class=\"pl-k\">:</span> <span class=\"pl-c1\">true</span>,\n      }\n\n      <span class=\"pl-smi\">config</span>.<span class=\"pl-smi\">module</span>.<span class=\"pl-c1\">rules</span>.<span class=\"pl-c1\">forEach</span>(<span class=\"pl-smi\">rule</span> <span class=\"pl-k\">=></span> {\n        ;(<span class=\"pl-smi\">rule</span>.<span class=\"pl-smi\">oneOf</span> <span class=\"pl-k\">||</span> []).<span class=\"pl-c1\">forEach</span>(<span class=\"pl-smi\">oneOf</span> <span class=\"pl-k\">=></span> {\n          <span class=\"pl-k\">if</span> (<span class=\"pl-smi\">oneOf</span>.<span class=\"pl-c1\">type</span> <span class=\"pl-k\">===</span> <span class=\"pl-s\"><span class=\"pl-pds\">'</span>asset/resource<span class=\"pl-pds\">'</span></span>) {\n            <span class=\"pl-smi\">oneOf</span>.<span class=\"pl-smi\">exclude</span>.<span class=\"pl-c1\">push</span>(wasmExtensionRegExp)\n          }\n        })\n      })\n\n      <span class=\"pl-k\">return</span> config\n    },\n  },\n}\n</pre></div>\n<p>Note: this thread helped me to create the craco config\n<a href=\"https://github.com/Emurgo/cardano-serialization-lib/issues/295\">https://github.com/Emurgo/cardano-serialization-lib/issues/295</a></p>\n<p>Also see footnote 2 for more info</p>\n<h3 id=\"final-step-use-async-import-to-import-the-hello-wasm-greeting\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#final-step-use-async-import-to-import-the-hello-wasm-greeting\"><a href=\"#final-step-use-async-import-to-import-the-hello-wasm-greeting\" style=\"margin-right: 10px\">#</a></a>Final step: Use async <code>import()</code> to import the <code>hello-wasm</code> greeting</h3>\n<p>We use a <code>useEffect</code> hook to import the code asynchronously, and can call our\nrust function, <code>greet</code>, from javascript!</p>\n<div class=\"highlight highlight-ts\"><pre><span class=\"pl-k\">function</span> <span class=\"pl-en\">App</span>() {\n  <span class=\"pl-k\">const</span> [<span class=\"pl-c1\">greeting</span>, <span class=\"pl-c1\">setGreeting</span>] <span class=\"pl-k\">=</span> <span class=\"pl-en\">useState</span>&#x3C;<span class=\"pl-c1\">string</span>>()\n  <span class=\"pl-en\">useEffect</span>(() <span class=\"pl-k\">=></span> {\n    ;(<span class=\"pl-k\">async</span> () <span class=\"pl-k\">=></span> {\n      <span class=\"pl-k\">try</span> {\n        <span class=\"pl-k\">const</span> <span class=\"pl-c1\">wasm</span> <span class=\"pl-k\">=</span> <span class=\"pl-k\">await</span> <span class=\"pl-k\">import</span>(<span class=\"pl-s\"><span class=\"pl-pds\">'</span>hello-wasm<span class=\"pl-pds\">'</span></span>)\n        <span class=\"pl-k\">const</span> <span class=\"pl-c1\">greeting</span> <span class=\"pl-k\">=</span> <span class=\"pl-smi\">wasm</span>.<span class=\"pl-en\">greet</span>(<span class=\"pl-s\"><span class=\"pl-pds\">'</span>Colin<span class=\"pl-pds\">'</span></span>)\n        <span class=\"pl-en\">setGreeting</span>(<span class=\"pl-smi\">greeting</span>)\n      } <span class=\"pl-k\">catch</span> (<span class=\"pl-smi\">e</span>) {\n        <span class=\"pl-c1\">console</span>.<span class=\"pl-c1\">error</span>(<span class=\"pl-smi\">e</span>)\n      }\n    })()\n  }, [])\n\n  <span class=\"pl-k\">return</span> (\n    &#x3C;<span class=\"pl-en\">div</span>>\n      &#x3C;<span class=\"pl-en\">h1</span>><span class=\"pl-smi\">rust</span> <span class=\"pl-smi\">monorepo</span> <span class=\"pl-smi\">wasm</span> <span class=\"pl-smi\">demo</span><span class=\"pl-k\">&#x3C;/</span><span class=\"pl-smi\">h1</span><span class=\"pl-k\">></span>\n      &#x3C;<span class=\"pl-en\">h2</span>><span class=\"pl-smi\">Greeting</span> <span class=\"pl-smi\">from</span> <span class=\"pl-v\">wasm</span><span class=\"pl-k\">:</span> {!<span class=\"pl-en\">greeting</span> <span class=\"pl-k\">?</span> <span class=\"pl-s\"><span class=\"pl-pds\">'</span>Loading...<span class=\"pl-pds\">'</span></span> <span class=\"pl-k\">:</span> <span class=\"pl-en\">greeting</span>}&#x3C;/<span class=\"pl-en\">h2</span>>\n    <span class=\"pl-k\">&#x3C;/</span><span class=\"pl-smi\">div</span><span class=\"pl-k\">></span>\n  )\n}\n</pre></div>\n<p>In order to greet an arbitrary person, I modified this slightly in the live\ndemo. See\n<a href=\"https://github.com/cmdcolin/rust_react_monorepo_template/blob/master/app/src/App.tsx\">https://github.com/cmdcolin/rust_react_monorepo_template/blob/master/app/src/App.tsx</a></p>\n<h3 id=\"run-the-app\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#run-the-app\"><a href=\"#run-the-app\" style=\"margin-right: 10px\">#</a></a>Run the app!</h3>\n<p>Go into the <code>app</code> folder, and then run <code>yarn start</code></p>\n<h2 id=\"result\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#result\"><a href=\"#result\" style=\"margin-right: 10px\">#</a></a>Result!</h2>\n<p>A screenshot of the app, showing the string \"Hello Colin\" which is generated\nvia rust and wasm</p>\n<p><img src=\"/media/rust_wasm_demo.png\" alt=\"\"></p>\n<h2 id=\"conclusion\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#conclusion\"><a href=\"#conclusion\" style=\"margin-right: 10px\">#</a></a>Conclusion</h2>\n<p>My main aim was to demonstrate creating a \"simple\" monorepo setup showing how\nyou can integrate Rust+WASM and React. Feel free to ask me any questions and go\ncheck out the repo!</p>\n<p><a href=\"https://github.com/cmdcolin/rust_react_monorepo_template\">https://github.com/cmdcolin/rust_react_monorepo_template</a></p>\n<h2 id=\"other-resources\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#other-resources\"><a href=\"#other-resources\" style=\"margin-right: 10px\">#</a></a>Other resources</h2>\n<p>This article is quite helpful also, but uses a file:/ reference in their\n<code>package.json</code> while my approach uses a monorepo, it is fundamentally quite\nsimilar though!\n<a href=\"https://tkat0.github.io/posts/how-to-create-a-react-app-with-rust-and-wasm\">https://tkat0.github.io/posts/how-to-create-a-react-app-with-rust-and-wasm</a></p>\n<h2 id=\"footnote-1-the-hello-wasm-folder-is-a-npm-package-with-wasm-files\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#footnote-1-the-hello-wasm-folder-is-a-npm-package-with-wasm-files\"><a href=\"#footnote-1-the-hello-wasm-folder-is-a-npm-package-with-wasm-files\" style=\"margin-right: 10px\">#</a></a>Footnote 1: The <code>hello-wasm</code> folder IS a npm package with wasm files</h2>\n<p>The <code>hello-wasm</code> folder can be published to NPM by itself. When consumers of\nthe package import the module, they would receive <code>pkg/index.js</code> from the\n<code>main</code> field in <code>package.json</code>, and then <code>pkg/index.js</code> in turn imports the\n<code>index.wasm</code> file. Then it is up to the consumers bundler to package that\ncorrectly.</p>\n<h2 id=\"footnote-2-bundlers-and-wasm\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#footnote-2-bundlers-and-wasm\"><a href=\"#footnote-2-bundlers-and-wasm\" style=\"margin-right: 10px\">#</a></a>Footnote 2: Bundlers and wasm</h2>\n<p>As of writing, I am using <code>webpack</code> v5 (part of <code>create-react-app</code> v5), which has\n\"native support\" for wasm. Still, it is hidden behind a flag called\n\"experiments\" (see first google result for webpack wasm here\n<a href=\"https://webpack.js.org/configuration/experiments/\">https://webpack.js.org/configuration/experiments/</a>) so I use <code>@craco/craco</code> to\nmodify the <code>webpack</code> config of <code>create-react-app</code> v5 to add this.</p>\n<p>Note also: The first time I wrote this, I used <code>webpack</code> v4, which used a\nslightly different workflow (used a special <code>webpack</code> loader called\n<code>wasm-loader</code>)</p>\n<p>You can also likely use similar techniques described in this article to\nincorporate into <code>next.js</code> since it also uses <code>webpack</code>. If you have info on\nhow other bundlers use wasm, feel free to leave a comment.</p>\n<h2 id=\"footnote-3-why-do-i-have-to-use-async-imports\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#footnote-3-why-do-i-have-to-use-async-imports\"><a href=\"#footnote-3-why-do-i-have-to-use-async-imports\" style=\"margin-right: 10px\">#</a></a>Footnote 3: Why do I have to use async imports?</h2>\n<p>Fundamentally, the <code>.wasm</code> file has to be fetched asynchronously before it can\nbe run (it is not in my experience e.g. embedded as binary data inside a js\nfile) which means it would be difficult to use the wasm code as a synchronous\nimport.</p>\n<p>There are hints that this may be possible but it would rely on the bundler\nembedding the wasm code in the js itself, or maybe top-level-await. If anyone\nhas more info, feel free to leave a comment!</p>\n<h2 id=\"footnote-4-build-setup\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#footnote-4-build-setup\"><a href=\"#footnote-4-build-setup\" style=\"margin-right: 10px\">#</a></a>Footnote 4: Build setup</h2>\n<p>The <code>hello-wasm</code> package does not automatically recompile when we are running\ne.g. <code>yarn start</code> in the <code>app</code> folder. Therefore, changes to the rust requires\nyou to manually run <code>yarn build</code> in the <code>hello-wasm</code> folder. Just something to\nbe aware of</p>\n<h2 id=\"footnote-5-my-first-experience-with-trying-to-make-this-work-was-rocky\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#footnote-5-my-first-experience-with-trying-to-make-this-work-was-rocky\"><a href=\"#footnote-5-my-first-experience-with-trying-to-make-this-work-was-rocky\" style=\"margin-right: 10px\">#</a></a>Footnote 5: My first experience with trying to make this work was rocky!</h2>\n<p>I first created an example of rust+wasm+react almost two years ago when\ncreating a fractal viewer\n<a href=\"https://github.com/cmdcolin/logistic_chaos_map\">https://github.com/cmdcolin/logistic_chaos_map</a>\nand it has some development notes on the stumbling blocks I faced\n<a href=\"https://github.com/cmdcolin/logistic_chaos_map/blob/master/NOTES.md\">https://github.com/cmdcolin/logistic_chaos_map/blob/master/NOTES.md</a></p>\n<h2 id=\"footnote-6-i-thought-you-said-typescript-too\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#footnote-6-i-thought-you-said-typescript-too\"><a href=\"#footnote-6-i-thought-you-said-typescript-too\" style=\"margin-right: 10px\">#</a></a>Footnote 6: I thought you said typescript too</h2>\n<p>Yep! The <code>hello-wasm</code> example generates typescript <code>.d.ts</code> files! Check out the\n<code>hello-wasm/pkg/</code> folder after you build it! This was none of my doing, just a\nbuilt-in feature. PS: I highly recommend inspecting the <code>pkg</code> folder that is\nproduced in the <code>hello-wasm</code> build to help understand the details. I also\nrecommend reading the <a href=\"https://rustwasm.github.io/wasm-bindgen/\">https://rustwasm.github.io/wasm-bindgen/</a> docs and if you\nare getting started with rust, read the Rust Book along with doing rustlings\n<a href=\"https://github.com/rust-lang/rustlings\">https://github.com/rust-lang/rustlings</a></p>"}},"__N_SSG":true}