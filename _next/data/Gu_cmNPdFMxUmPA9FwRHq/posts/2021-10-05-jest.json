{"pageProps":{"post":{"title":"Jest parallelization, globals, mocks, and squawkless tests","date":"2021-10-05","slug":"2021-10-05-jest","html":"<p>I found that there is a little bit of confusion and misunderstanding around how\nthings like parallelization work in jest, which sometimes leads to additional\nhacking around problems that may not exist or speculating incorrectly about\ntest failure. This is also of course a point of concern when you have code that\nfor some reason or another uses global variables. Here are a short summary of\nthings that may cause confusion.</p>\n<h2 id=\"tests-in-a-single-file-are-not-run-in-parallel\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#tests-in-a-single-file-are-not-run-in-parallel\"><a href=\"#tests-in-a-single-file-are-not-run-in-parallel\" style=\"margin-right: 10px\">#</a></a>Tests in a single file are NOT run in parallel</h2>\n<p>Simple example, the global variable r is included in the test condition, but it\nis accurately run in all cases because the tests are not run in parallel.</p>\n<div class=\"highlight highlight-js\"><pre><span class=\"pl-k\">let</span> r <span class=\"pl-k\">=</span> <span class=\"pl-c1\">0</span>\n\n<span class=\"pl-k\">function</span> <span class=\"pl-en\">timeout</span>(<span class=\"pl-smi\">ms</span>) {\n  <span class=\"pl-k\">return</span> <span class=\"pl-k\">new</span> <span class=\"pl-en\">Promise</span>(<span class=\"pl-smi\">resolve</span> <span class=\"pl-k\">=></span> <span class=\"pl-c1\">setTimeout</span>(resolve, ms))\n}\n\n<span class=\"pl-en\">describe</span>(<span class=\"pl-s\"><span class=\"pl-pds\">'</span>tests<span class=\"pl-pds\">'</span></span>, () <span class=\"pl-k\">=></span> {\n  <span class=\"pl-en\">it</span>(<span class=\"pl-s\"><span class=\"pl-pds\">'</span>t1<span class=\"pl-pds\">'</span></span>, <span class=\"pl-k\">async</span> () <span class=\"pl-k\">=></span> {\n    <span class=\"pl-k\">await</span> <span class=\"pl-en\">timeout</span>(<span class=\"pl-c1\">1000</span>)\n    <span class=\"pl-en\">expect</span>(r).<span class=\"pl-en\">toBe</span>(<span class=\"pl-c1\">0</span>)\n    r<span class=\"pl-k\">++</span>\n  })\n  <span class=\"pl-en\">it</span>(<span class=\"pl-s\"><span class=\"pl-pds\">'</span>t2<span class=\"pl-pds\">'</span></span>, <span class=\"pl-k\">async</span> () <span class=\"pl-k\">=></span> {\n    <span class=\"pl-k\">await</span> <span class=\"pl-en\">timeout</span>(<span class=\"pl-c1\">1000</span>)\n    <span class=\"pl-en\">expect</span>(r).<span class=\"pl-en\">toBe</span>(<span class=\"pl-c1\">1</span>)\n    r<span class=\"pl-k\">++</span>\n  })\n  <span class=\"pl-en\">it</span>(<span class=\"pl-s\"><span class=\"pl-pds\">'</span>t3<span class=\"pl-pds\">'</span></span>, <span class=\"pl-k\">async</span> () <span class=\"pl-k\">=></span> {\n    <span class=\"pl-k\">await</span> <span class=\"pl-en\">timeout</span>(<span class=\"pl-c1\">1000</span>)\n    <span class=\"pl-en\">expect</span>(r).<span class=\"pl-en\">toBe</span>(<span class=\"pl-c1\">2</span>)\n    r<span class=\"pl-k\">++</span>\n  })\n})\n</pre></div>\n<p>This test will take 3 seconds, and will accurately count the global variable.\nIf it was in parallel, it may only take 1 second, and would inaccurately count\nthe global variable due to race conditions</p>\n<h2 id=\"tests-in-different-files-are-run-in-parallel\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#tests-in-different-files-are-run-in-parallel\"><a href=\"#tests-in-different-files-are-run-in-parallel\" style=\"margin-right: 10px\">#</a></a>Tests in different files ARE run in parallel</h2>\n<p>Let's take another example where we use a global variable, and then two\ndifferent tests use the global variable.</p>\n<p>file_using_some_globals.js</p>\n<div class=\"highlight highlight-js\"><pre><span class=\"pl-k\">let</span> myGlobal <span class=\"pl-k\">=</span> <span class=\"pl-c1\">0</span>\n\n<span class=\"pl-k\">export</span> <span class=\"pl-k\">function</span> <span class=\"pl-en\">doStuff</span>() {\n  myGlobal<span class=\"pl-k\">++</span>\n  <span class=\"pl-k\">return</span> myGlobal\n}\n\n<span class=\"pl-k\">export</span> <span class=\"pl-k\">function</span> <span class=\"pl-en\">resetMyGlobal</span>() {\n  myGlobal <span class=\"pl-k\">=</span> <span class=\"pl-c1\">0</span>\n}\n\n<span class=\"pl-k\">export</span> <span class=\"pl-k\">function</span> <span class=\"pl-en\">timeout</span>(<span class=\"pl-smi\">ms</span>) {\n  <span class=\"pl-k\">return</span> <span class=\"pl-k\">new</span> <span class=\"pl-en\">Promise</span>(<span class=\"pl-smi\">resolve</span> <span class=\"pl-k\">=></span> <span class=\"pl-c1\">setTimeout</span>(resolve, ms))\n}\n</pre></div>\n<p>test_global_vars1.test.js</p>\n<div class=\"highlight highlight-js\"><pre><span class=\"pl-k\">import</span> { <span class=\"pl-smi\">doStuff</span>, <span class=\"pl-smi\">timeout</span> } <span class=\"pl-k\">from</span> <span class=\"pl-s\"><span class=\"pl-pds\">'</span>./dostuff<span class=\"pl-pds\">'</span></span>\n<span class=\"pl-en\">test</span>(<span class=\"pl-s\"><span class=\"pl-pds\">'</span>file1<span class=\"pl-pds\">'</span></span>, <span class=\"pl-k\">async</span> () <span class=\"pl-k\">=></span> {\n  <span class=\"pl-en\">doStuff</span>()\n  <span class=\"pl-k\">await</span> <span class=\"pl-en\">timeout</span>(<span class=\"pl-c1\">1000</span>)\n  <span class=\"pl-en\">expect</span>(<span class=\"pl-en\">doStuff</span>()).<span class=\"pl-en\">toEqual</span>(<span class=\"pl-c1\">2</span>)\n})\n</pre></div>\n<p>test_global_vars2.test.js</p>\n<div class=\"highlight highlight-js\"><pre><span class=\"pl-k\">import</span> { <span class=\"pl-smi\">doStuff</span>, <span class=\"pl-smi\">timeout</span> } <span class=\"pl-k\">from</span> <span class=\"pl-s\"><span class=\"pl-pds\">'</span>./dostuff<span class=\"pl-pds\">'</span></span>\n\n<span class=\"pl-en\">test</span>(<span class=\"pl-s\"><span class=\"pl-pds\">'</span>file1<span class=\"pl-pds\">'</span></span>, <span class=\"pl-k\">async</span> () <span class=\"pl-k\">=></span> {\n  <span class=\"pl-k\">await</span> <span class=\"pl-en\">timeout</span>(<span class=\"pl-c1\">1000</span>)\n  <span class=\"pl-en\">expect</span>(<span class=\"pl-en\">doStuff</span>()).<span class=\"pl-en\">toEqual</span>(<span class=\"pl-c1\">1</span>)\n})\n</pre></div>\n<p>This test completes in less than 2 seconds, and these tests are run in\nparallel. They use different instances of the global state, and therefore have\nno worries with colliding their state.</p>\n<h2 id=\"does-a-mock-from-one-test-affect-another-test\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#does-a-mock-from-one-test-affect-another-test\"><a href=\"#does-a-mock-from-one-test-affect-another-test\" style=\"margin-right: 10px\">#</a></a>Does a mock from one test affect another test?</h2>\n<p>While seeking the fabled \"squawk-less\" test, it is often useful to mock console\nso that tests that produce an expected error don't actually print an error\nmessage. However, if not done carefully, you will remove errors across tests</p>\n<p>So, could a mock from one test affect another test? If it's in the same file,\nyes!</p>\n<p>mock_console.test.js</p>\n<div class=\"highlight highlight-js\"><pre><span class=\"pl-en\">test</span>(<span class=\"pl-s\"><span class=\"pl-pds\">'</span>test1<span class=\"pl-pds\">'</span></span>, () <span class=\"pl-k\">=></span> {\n  <span class=\"pl-en\">console</span>.<span class=\"pl-smi\">error</span> <span class=\"pl-k\">=</span> <span class=\"pl-smi\">jest</span>.<span class=\"pl-en\">fn</span>()\n  <span class=\"pl-en\">console</span>.<span class=\"pl-c1\">error</span>(<span class=\"pl-s\"><span class=\"pl-pds\">'</span>wow<span class=\"pl-pds\">'</span></span>)\n  <span class=\"pl-en\">expect</span>(<span class=\"pl-en\">console</span>.<span class=\"pl-smi\">error</span>).<span class=\"pl-en\">toHaveBeenCalled</span>()\n})\n\n<span class=\"pl-en\">test</span>(<span class=\"pl-s\"><span class=\"pl-pds\">'</span>test2<span class=\"pl-pds\">'</span></span>, () <span class=\"pl-k\">=></span> {\n  <span class=\"pl-c\">// this console.error will not appear because test1 mocked away console.error</span>\n  <span class=\"pl-c\">// without restoring it</span>\n  <span class=\"pl-en\">console</span>.<span class=\"pl-c1\">error</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Help I can't see!<span class=\"pl-pds\">\"</span></span>)\n})\n</pre></div>\n<p>To properly mock these, you should restore the console mock at the end of your\nfunction</p>\n<div class=\"highlight highlight-js\"><pre><span class=\"pl-en\">test</span>(<span class=\"pl-s\"><span class=\"pl-pds\">'</span>test1<span class=\"pl-pds\">'</span></span>, () <span class=\"pl-k\">=></span> {\n  <span class=\"pl-k\">const</span> <span class=\"pl-c1\">orig</span> <span class=\"pl-k\">=</span> <span class=\"pl-en\">console</span>.<span class=\"pl-smi\">error</span>\n  <span class=\"pl-en\">console</span>.<span class=\"pl-smi\">error</span> <span class=\"pl-k\">=</span> <span class=\"pl-smi\">jest</span>.<span class=\"pl-en\">fn</span>()\n  <span class=\"pl-en\">console</span>.<span class=\"pl-c1\">error</span>(<span class=\"pl-s\"><span class=\"pl-pds\">'</span>I should not see this!<span class=\"pl-pds\">'</span></span>)\n  <span class=\"pl-en\">expect</span>(<span class=\"pl-en\">console</span>.<span class=\"pl-smi\">error</span>).<span class=\"pl-en\">toHaveBeenCalled</span>()\n  <span class=\"pl-en\">console</span>.<span class=\"pl-smi\">error</span> <span class=\"pl-k\">=</span> orig\n})\n\n<span class=\"pl-en\">test</span>(<span class=\"pl-s\"><span class=\"pl-pds\">'</span>test2<span class=\"pl-pds\">'</span></span>, () <span class=\"pl-k\">=></span> {\n  <span class=\"pl-k\">const</span> <span class=\"pl-c1\">consoleMock</span> <span class=\"pl-k\">=</span> <span class=\"pl-smi\">jest</span>.<span class=\"pl-en\">spyOn</span>(<span class=\"pl-en\">console</span>, <span class=\"pl-s\"><span class=\"pl-pds\">'</span>error<span class=\"pl-pds\">'</span></span>).<span class=\"pl-en\">mockImplementation</span>()\n  <span class=\"pl-en\">console</span>.<span class=\"pl-c1\">error</span>(<span class=\"pl-s\"><span class=\"pl-pds\">'</span>I should not see this!<span class=\"pl-pds\">'</span></span>)\n  <span class=\"pl-smi\">consoleMock</span>.<span class=\"pl-en\">mockRestore</span>()\n})\n\n<span class=\"pl-en\">test</span>(<span class=\"pl-s\"><span class=\"pl-pds\">'</span>test3<span class=\"pl-pds\">'</span></span>, () <span class=\"pl-k\">=></span> {\n  <span class=\"pl-en\">console</span>.<span class=\"pl-c1\">error</span>(<span class=\"pl-s\"><span class=\"pl-pds\">'</span>I should see this error!<span class=\"pl-pds\">'</span></span>)\n})\n</pre></div>\n<h2 id=\"add-on-achieve-squawkless-tests\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#add-on-achieve-squawkless-tests\"><a href=\"#add-on-achieve-squawkless-tests\" style=\"margin-right: 10px\">#</a></a>Add-on: Achieve squawkless tests!</h2>\n<p>Your test output should just be a big list of PASS statements, not interleaved\nwith console.error outputs from when you are testing error conditions of your\ncode</p>\n<p>\"Squawkless tests\" is a term I made up, but it means that if you have code\nunder test that prints some errors to the console, then mock the console.error\nfunction, as in the previous section. Don't stand for having a bunch of verbose\nerrors in your CI logs! However, I also suggest only mocking out console.error\nfor tests that are <strong>expected</strong> to have errors, lest you paper over unexpected\nerrors.</p>\n<p><img src=\"/media/squawkless_tests.png\" alt=\"\"></p>\n<p>Figure: a nice clean test suite without a bunch of crazy console.error outputs</p>\n<h2 id=\"conclusion\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#conclusion\"><a href=\"#conclusion\" style=\"margin-right: 10px\">#</a></a>Conclusion</h2>\n<p>Getting better at testing requires exercise, and understanding the basics of\nyour tools can help! Hopefully this helps you achieve a better understanding\nand write cleaner jest tests.</p>"}},"__N_SSG":true}