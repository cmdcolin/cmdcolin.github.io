{"pageProps":{"post":{"title":"Making a HTTPS accessible S3 powered static site with CloudFront+route 53","date":"2020-12-26","slug":"2020-12-26-pt2","mdxSource":{"compiledSource":"var l=Object.defineProperty,m=Object.defineProperties;var c=Object.getOwnPropertyDescriptors;var n=Object.getOwnPropertySymbols;var r=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable;var p=(e,t,o)=>t in e?l(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,i=(e,t)=>{for(var o in t||(t={}))r.call(t,o)&&p(e,o,t[o]);if(n)for(var o of n(t))s.call(t,o)&&p(e,o,t[o]);return e},u=(e,t)=>m(e,c(t));var d=(e,t)=>{var o={};for(var a in e)r.call(e,a)&&t.indexOf(a)<0&&(o[a]=e[a]);if(e!=null&&n)for(var a of n(e))t.indexOf(a)<0&&s.call(e,a)&&(o[a]=e[a]);return o};const layoutProps={},MDXLayout=\"wrapper\";function MDXContent(o){var a=o,{components:e}=a,t=d(a,[\"components\"]);return mdx(MDXLayout,u(i(i({},layoutProps),t),{components:e,mdxType:\"MDXLayout\"}),mdx(\"p\",null,`This is not a very authoritative post because I stumbled though this but\nI think I got it working now on my website :)`),mdx(\"h2\",null,\"Setup your S3 bucket\"),mdx(\"p\",null,`First setup your S3 bucket, your bucket must be named yourdomain.com\ne.g. named after your domain`),mdx(\"p\",null,`Then if you have a create-react-app setup I add a script in package.json\nthat runs`),mdx(\"pre\",null,mdx(\"code\",i({parentName:\"pre\"},{}),` \"predeploy\": \"npm run build\",\n \"deploy\": \"aws sync --delete build s3://yourdomain.com\"\n`)),mdx(\"p\",null,`Then we can run \"yarn deploy\" and it will automatically upload our\ncreate-react-app website to our S3 static site bucket.`),mdx(\"p\",null,`Then make sure your bucket has public permissions enabled\n`,mdx(\"a\",i({parentName:\"p\"},{href:\"https://docs.aws.amazon.com/AmazonS3/latest/dev/example-bucket-policies.html#example-bucket-policies-use-case-2\"}),\"https://docs.aws.amazon.com/AmazonS3/latest/dev/example-bucket-policies.html#example-bucket-policies-use-case-2\"),`Then\nmake sure your bucket has \"static site hosting\" enabled too`),mdx(\"h2\",null,\"Setup route 53, and make your NS entries in domains.google.com\"),mdx(\"p\",null,\"I bought a domain with domains.google.com\"),mdx(\"p\",null,\"Google then emailed me to validate my ownership\"),mdx(\"p\",null,\"Then I went to aws.amazon.com route 53\\xA0and I created a hosted zone\"),mdx(\"p\",null,`This generated 4 name server entries and I added those to the\ndomains.google.com site`),mdx(\"p\",null,mdx(\"img\",i({parentName:\"p\"},{src:\"/media/638618421776515072_0.png\",alt:null}))),mdx(\"p\",null,`Screenshot shows copying the NS values from route 53 to the name servers\narea of domains.google.com`),mdx(\"h2\",null,\"Setup your Amazon certificate for making SSL work on CloudFront\"),mdx(\"p\",null,`To properly setup However, this does not work so you need to go to\nAmazon Certificates->Provision certificates`),mdx(\"p\",null,\"We request the certificate for\"),mdx(\"p\",null,mdx(\"a\",i({parentName:\"p\"},{href:\"http://www.yourdomain.com\"}),\"www.yourdomain.com\"),`\nyourdomain.com`),mdx(\"p\",null,`Then it generates some codes for a CNAME value for each of those two\nentries, and has a button to autoimport those CNAME values to route53`),mdx(\"p\",null,`Then it will say\\xA0\"Pending validation\"...I waited like an hour and then\nit changed to\\xA0\"Success\".`),mdx(\"p\",null,mdx(\"img\",i({parentName:\"p\"},{src:\"/media/638618421776515072_1.png\",alt:null}))),mdx(\"p\",null,`Screenshot shows the now successful Amazon Certificate. After you get\nthis, you can proceed to finishing your cloudfront`),mdx(\"h2\",null,'Create a CloudFront distribution and add \"Alternative CNAME\" entries for your domain'),mdx(\"p\",null,`Then we can update our CloudFront distribution and add these to\nthe\\xA0\"Alternative CNAME\" input box`),mdx(\"p\",null,`yourdomain.com\n`,mdx(\"a\",i({parentName:\"p\"},{href:\"http://www.yourdomain.com\"}),\"www.yourdomain.com\")),mdx(\"p\",null,`Note also that I first generated my certificate in us-east-2 but the\n\"Import certificate form\" in cloudfront said I had to create it in\nus-east-1`),mdx(\"p\",null,mdx(\"img\",i({parentName:\"p\"},{src:\"/media/638618421776515072_2.png\",alt:null}))),mdx(\"h2\",null,\"Add a default object index.html to the CloudFront setting\"),mdx(\"p\",null,'Make your CloudFront\\xA0\"default object\" is index.html'),mdx(\"p\",null,\"You have to manually type this in :)\"),mdx(\"h2\",null,\"Add the CloudFront distribution to your Route 53\"),mdx(\"p\",null,`Add a Route 53 \"A\" record that points to the CloudFront domain name e.g.\nd897d897d87d98dd.cloudfront.net`),mdx(\"h2\",null,\"Summary of steps needed\"),mdx(\"p\",null,\"The general hindsight 20/20 procedure is\"),mdx(\"ol\",null,mdx(\"li\",{parentName:\"ol\"},`Upload your static content to an S3 bucket called yoursite.com (must\nbe your domain name)`),mdx(\"li\",{parentName:\"ol\"},`Make your S3 bucket have the \"static website\" setting on in the\nproperties menu and add a permissions policy that supports getObject\ne.g.\\xA0`,mdx(\"a\",i({parentName:\"li\"},{href:\"https://docs.aws.amazon.com/AmazonS3/latest/dev/example-bucket-policies.html#example-bucket-policies-use-case-2\"}),\"https://docs.aws.amazon.com/AmazonS3/latest/dev/example-bucket-policies.html#example-bucket-policies-use-case-2\")),mdx(\"li\",{parentName:\"ol\"},\"Create a CloudFront distribution for your website\"),mdx(\"li\",{parentName:\"ol\"},\"Make the CloudFront default object index.html\"),mdx(\"li\",{parentName:\"ol\"},\"Create your domain with domains.google.com or similar\"),mdx(\"li\",{parentName:\"ol\"},\"Point the google domain's name server to Route 53 NS list from AWS\"),mdx(\"li\",{parentName:\"ol\"},`Add Route 53 A records that point to the CloudFront domain name e.g.\nd897d897d87d98dd.cloudfront.net`),mdx(\"li\",{parentName:\"ol\"},`Create Amazon issued certificate for yourdomain.com, which can\nauto-import a validation CNAME to your Route 53`),mdx(\"li\",{parentName:\"ol\"},`Make your CloudFront domain support your Alternative CNAME's e.g.\nyourdomain.com which requires importing (e.g. selecting from a list\nthat they auto-populate) your Amazon-issued-certificate`)),mdx(\"h2\",null,\"Troubleshooting and notes\"),mdx(\"p\",null,`Problem: Your website gives 403 CloudFlare error\nSolution: You have to get the Alternateive CNAME configuration setup\n(pre-step involves the certificate request and validation)`),mdx(\"p\",null,`Problem: Your website gives an object not found error\nSolution: Set the CloudFront \"default object\" to index.html`),mdx(\"h2\",null,\"Random comment\"),mdx(\"p\",null,`This is one of those processes (creating the cloudfront/route 53) that\nprobably could have done with the aws-sam CLI and it would have possibly\nbeen easier, it is quite fiddly doing all these steps in the web\ninterface`))}MDXContent.isMDXComponent=!0;\n","scope":{}}}},"__N_SSG":true}