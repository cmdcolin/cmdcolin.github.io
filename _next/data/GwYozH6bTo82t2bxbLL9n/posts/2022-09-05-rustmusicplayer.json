{"pageProps":{"post":{"title":"Creating a music player using Rust/GTK4 - fml9000","date":"2022-09-05","slug":"2022-09-05-rustmusicplayer","html":"<p>I have started endeavoring to learn Rust. I did the rustlings exercises but I\nknew the concepts would fade rapidly from my brain without some practice. I\nhave now started making a music player using Rust+GTK4.</p>\n<p>I chose GTK4 to have a linux native GUI music player. Particularly, I have a\nparticular foobar2000 setup that I wanted to emulate. I have used foobar2000\nunder wine (windows emulator on linux) and it's not terrible, but it has\nbackground CPU consumption of about 15% idle and doesn't feel quite right\nsometimes. I have used a variety of other linux music players such as quodlibet\n(GUI/GTK based) and cmus (command line) but they didn't really feel quite\nright.</p>\n<h3 id=\"choosing-a-tech-stack\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#choosing-a-tech-stack\"><a href=\"#choosing-a-tech-stack\" style=\"margin-right: 10px\">#</a></a>Choosing a tech stack</h3>\n<p>I started by attempting with <code>Relm4</code>, which I may return to at some point, but\ntrying to juggle learning Relm4-style widgets, GTK, and rust all at once was a\nbit much. I stepped to using <code>gtk4-rs</code> directly.</p>\n<h3 id=\"trying-to-create-a-spreadsheet-style-or-data-grid-of-tracks\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#trying-to-create-a-spreadsheet-style-or-data-grid-of-tracks\"><a href=\"#trying-to-create-a-spreadsheet-style-or-data-grid-of-tracks\" style=\"margin-right: 10px\">#</a></a>Trying to create a \"spreadsheet style\" or data grid of tracks</h3>\n<p>Then, I wanted to create a data grid showing to display e.g. a table with\nartist, track, album, etc. I chose to use the GTK\n<a href=\"https://docs.gtk.org/gtk4/class.ColumnView.html\"><code>ColumnView</code></a> to drive this.\nI stumbled around looking for example code, but there was none specifically for\nthe <code>ColumnView</code>. I also realized the <code>ListView</code> example from the <code>gtk4-rs</code>\nexamples with it's factory function had similar needs that the <code>ColumnView</code>.</p>\n<h3 id=\"how-set-up-the-columnview\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#how-set-up-the-columnview\"><a href=\"#how-set-up-the-columnview\" style=\"margin-right: 10px\">#</a></a>How set up the <code>ColumnView</code></h3>\n<p>I found out that I basically needed to create a <code>ListStore</code>. I thought if\nI could make my own <code>GObject</code> subclass, it would solve everything, but I had\ntrouble getting making this work (rust doesn't have the concept of extending a\nclass for one thing, you implement various traits instead). Finally, I randomly\nstumbled on this link using a <code>BoxedAnyObject</code> with a good example of storing\ndata in a ListStore\n<a href=\"https://gtk-rs.org/gtk-rs-core/git/docs/glib/struct.BoxedAnyObject.html\">https://gtk-rs.org/gtk-rs-core/git/docs/glib/struct.BoxedAnyObject.html</a></p>\n<p>The <code>BoxedAnyObject</code> is a <code>GObject</code>, so this was an good route to storing the\n<code>ListView</code> items.</p>\n<h3 id=\"accessing-the-liststore-in-the-columnview-factory-function\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#accessing-the-liststore-in-the-columnview-factory-function\"><a href=\"#accessing-the-liststore-in-the-columnview-factory-function\" style=\"margin-right: 10px\">#</a></a>Accessing the <code>ListStore</code> in the <code>ColumnView</code> factory function</h3>\n<p>There was no example code for this so I stuggled for awhile before realizing\nthat the ListView example in the gtk4-rs codebase has similar concepts (factory\nto create grid cells, etc).</p>\n<h3 id=\"creating-a-pr-to-the-gtk4-rs-repo-to-demonstrate-example-columnview-usage\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#creating-a-pr-to-the-gtk4-rs-repo-to-demonstrate-example-columnview-usage\"><a href=\"#creating-a-pr-to-the-gtk4-rs-repo-to-demonstrate-example-columnview-usage\" style=\"margin-right: 10px\">#</a></a>Creating a PR to the <code>gtk4-rs</code> repo to demonstrate example ColumnView usage</h3>\n<p>I created a PR (<a href=\"https://github.com/gtk-rs/gtk4-rs/pull/1111\">https://github.com/gtk-rs/gtk4-rs/pull/1111</a>) to demonstrate\nsimple ColumnView usage. The code review that was given on the PR was\nexcellent. They explained how to simplify the code I submitted so that each\ngrid cell was very minimal (starting from a <code>gtk::Box</code> with a <code>gtk::Label</code>\ninside of it, to just being a <code>gtk::Inscription</code> which is very fast). Big\nthanks to the team for helping out with this!</p>\n<p>After this hurdle was crossed, I felt much more comfortable in the GTK mindset,\nand I quickly fleshed out some more UI for the app\na</p>\n<h3 id=\"choosing-a-audio-tech-stack\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#choosing-a-audio-tech-stack\"><a href=\"#choosing-a-audio-tech-stack\" style=\"margin-right: 10px\">#</a></a>Choosing a audio tech stack</h3>\n<p>To actually play audio, I looked at a couple options. There was even one option\ncalled Gtk::MediaFile which should to be able to play e.g. mp3s, making my job\nof making a media player much simpler, but it produced an error <a href=\"https://www.google.com/search?q=%22GTK+could+not+find+a+media+module.+Check+your+installation.%22&#x26;oq=%22GTK+could+not+find+a+media+module.+Check+your+installation.%22&#x26;aqs=chrome..69i57.267j0j7&#x26;sourceid=chrome&#x26;ie=UTF-8\">\"GTK could not\nfind a media module. Check your\ninstallation.\"</a>\nwhich had very few references on the internet. I figured this could be difficult to solve or point to issues I could face later on making minimal executables for usersSo</p>\n<p>So, next I tried out symphonia (<a href=\"https://github.com/pdeljanov/Symphonia/\">https://github.com/pdeljanov/Symphonia/</a>), with\nthe hope being that it is easier to package these for consumers of the app.\nThis requires a lot more code to work (~1000 lines so far, copying from the\n<code>symphonia-play</code> example).</p>\n<h3 id=\"reading-audio-metadata-and-storing-in-a-sqlite-database\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#reading-audio-metadata-and-storing-in-a-sqlite-database\"><a href=\"#reading-audio-metadata-and-storing-in-a-sqlite-database\" style=\"margin-right: 10px\">#</a></a>Reading audio metadata and storing in a sqlite database</h3>\n<p>I also wanted to have the option of reading and writing metadata. Symphonia\nonly reads metadata, so I used the <code>lofty</code> crate to read metadata for now. I\nalso realized that reading tens of thousands of file's metadata at each app\nstartup would be slow, so I endeavored to store that data in an sqlite\ndatabase. I found that music players like foobar2000 and 0xdeadbeef have\ndatabases of track metadata also (Example folder on foobar2000 (1.x) for this\nsnap/foobar2000/433/foobar2000/profile/library/74E45640B1C695CC/meta-0001,\nmeta-0002, etc.)</p>\n<p>I used the <code>walkdir</code> crate to walk a directory for files, <code>lofty</code> to read the\nmetadata, and then finally inserted the data into the sqlite db.</p>\n<h3 id=\"learning-about-reference-counting-and-move-semantics\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#learning-about-reference-counting-and-move-semantics\"><a href=\"#learning-about-reference-counting-and-move-semantics\" style=\"margin-right: 10px\">#</a></a>Learning about reference counting and move semantics</h3>\n<p>Originally I queried the sqlite database and stored a Vec, where Track\nis a struct with artist, album, song title, etc. I realized that this causes\nissues passing this around to different functions, and storing them in the\nBoxedAnyObject, (example thread discussing issue\n<a href=\"https://stackoverflow.com/questions/42954008/how-to-pass-one-vec-to-multiple-functions-in-rust\">https://stackoverflow.com/questions/42954008/how-to-pass-one-vec-to-multiple-functions-in-rust</a>)\nso I changed functions to accept slices of the Vec, and to make it a\nVec&#x3C;Rc> instead of just Vec (another related thread\n<a href=\"https://users.rust-lang.org/t/self-has-an-anonymous-lifetime-but-it-needs-to-satisfy-a-static-lifetime-requirement/58641/3\">https://users.rust-lang.org/t/self-has-an-anonymous-lifetime-but-it-needs-to-satisfy-a-static-lifetime-requirement/58641/3</a>).</p>\n<h3 id=\"result\"><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#result\"><a href=\"#result\" style=\"margin-right: 10px\">#</a></a>Result</h3>\n<p>The current work is at <a href=\"https://github.com/cmdcolin/fml9000\">https://github.com/cmdcolin/fml9000</a></p>\n<p><img src=\"/media/fml9000_1.png\" alt=\"\"></p>\n<p>Screenshot shows the current look and feel. Some stuff in the screenshot is\nmocked and not fully functional, but it has been a great learning experience\nthus far</p>"}},"__N_SSG":true}