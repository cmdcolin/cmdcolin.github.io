<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/_next/static/css/82eb5efba2a6c9217a68.css" as="style"/><link rel="stylesheet" href="/_next/static/css/82eb5efba2a6c9217a68.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a40ef1678bae11e696dba45124eadd70.js"></script><script src="/_next/static/chunks/webpack-7c4c4c05609ee1ee2453.js" defer=""></script><script src="/_next/static/chunks/framework-7915ac2dcad08ccffd1a.js" defer=""></script><script src="/_next/static/chunks/main-d0187c47f4d0d1b19d72.js" defer=""></script><script src="/_next/static/chunks/pages/_app-75e0706c9e1cdf9d8afe.js" defer=""></script><script src="/_next/static/chunks/pages/2020-12-24-3b99360a2464c5fc95bd.js" defer=""></script><script src="/_next/static/Z-Nz8uYVC2hk5uorlrwTC/_buildManifest.js" defer=""></script><script src="/_next/static/Z-Nz8uYVC2hk5uorlrwTC/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div><a href="/">Return home</a><div class="blog"><h1>Making a serverless website for photo upload pt. 1</h1><p>I set out to make a serverless website for photo uploads. Our dearly
departed dixie dog needed a place to have photo uploads.</p><p>I didn&#x27;t want to get charged dollars per month for a running ec2
instance, so I wanted something that was lightweight e.g. serverless,
and easy</p><p>I decided to follow this tutorial</p><p><a href="https://aws.amazon.com/blogs/compute/uploading-to-amazon-s3-directly-from-a-web-or-mobile-application/">https://aws.amazon.com/blogs/compute/uploading-to-amazon-s3-directly-from-a-web-or-mobile-application/</a></p><p>I really liked the command line deployment (aws-sam) because fiddling
around with the AWS web based control panel is ridiculously complicated</p><p>For example I also tried following this tutorial which uses the web
based UI (<a href="https://www.youtube.com/watch?v=mw_-0iCVpUc">https://www.youtube.com/watch?v=mw_-0iCVpUc</a>) and it just did
not work for me....I couldn&#x27;t stay focused (blame ADHD or just my CLI
obsession?) and certain things like &quot;Execution role&quot; that they say to
modify are not there in the web UI anymore, so I just gave up (I did try
though!)</p><p>To install aws-sam I used homebrew</p><blockquote><p>brew tap aws/tap
brew install aws-sam-cli
brew install aws-sam-cli # I had to run the install command twice
ref <a href="https://github.com/aws/aws-sam-cli/issues/2320#issuecomment-721414971">https://github.com/aws/aws-sam-cli/issues/2320#issuecomment-721414971</a></p><p>git clone
<a href="https://github.com/aws-samples/amazon-s3-presigned-urls-aws-sam">https://github.com/aws-samples/amazon-s3-presigned-urls-aws-sam</a>
cd amazon-s3-presigned-urls-aws-sam
sam deploy --guided</p><h1>proceeeds with a guided installation, I used all defaults except I</h1><p>made &quot;UploadRequestFunction may not have authorization defined, Is
this okay? <!-- -->[y/N]<!-- -->: y&quot;</p></blockquote><p><img src="https://64.media.tumblr.com/3028ab2ff22803ebe4ab1f69dc4c6cb0/237164d886a09414-60/s540x810/9e02904fd35ebd9dfab681cd1d5a3a13fa7a1efa.png"/></p><p>They then in the tutorial describe trying to use postman to test</p><p>I test with <code>curl</code> instead</p><blockquote><p>❯❯❯ curl
&#x27;<a href="https://fjgbqj5436.execute-api.us-east-2.amazonaws.com/uploads&#x27;">https://fjgbqj5436.execute-api.us-east-2.amazonaws.com/uploads&#x27;</a></p><p>{&quot;uploadURL&quot;:&quot;<a href="https://sam-app-s3uploadbucket-1653634.s3.us-east-2.amazonaws.com/112162.jpg?Content-Type=image%2Fjpeg&amp;X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=ASIAU6CQBER6YBNCDDMJ%2F20201224%2Fus-east-2%2Fs3%2Faws4_request&amp;X-Amz-Date=20201224T174804Z&amp;X-Amz-Expires=300&amp;X-Amz-Security-Token=IQoJb3JpZ2luX2VjEDIaCXVzLWVhc3QtMiJGMEQCIH65IvgJsofUpIX46lTaG3Pi5WC85ti1lukM3iICh%2BB%2BAiAJEyynPNPhZN8%2Bg1ylO7wthqud9cBcNIChIp2H%2F%2BR7mCryAQjb%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F8BEAAaDDMzOTQ3MDI2MzQyMSIMLqPo1IYyH7udCGZuKsYBSEF3c50YXkmPeSWcLsEzq%2BFBTpeOIrwZTyCUjbJ7fgJUakhM1YRX40jExstN8eJcMXqw00Xd5lYHvZDbU9ajwWPLRAxcEN5BQ0utqn0NGTLyJhibzJUj8cjgm5RguIEKe9GUtMVWa9mi7C5%2FlFpS0i9jK5BSVf74JyPSLETV5mzMMzy5kHBQMGjw1dR66E3MG8PjIqfgKjhVtZmlaicf5OmeqNI2%2F8T5ye%2FICRsH4d7KNEmj4FELa8buW8U%2Fn97ThfH3P7XmMNOok%2F8FOuEBDj1EHluCT4DfZ1jIXjvrJsVv1WtV4POQDn2Dah%2BWosBn%2BFNTtQtw841ACDarYR1ZVbuwcpTjfBPlGuSOncPsbzOhzDy7wYyumsPKsXoPdxTncMWbx4BQkbU5SeF9hjpfIKRMSOqkJBN7%2BtgHXwuW1rfYMDN2OAlQZpTj7uWMPWojUMbvMzyHvI2pfgcRAlrBdGGYDigyjWl9QXP%2Bdi6WiR7XCSXbWcIAJDZh%2Beb%2BIH1asmMJtpAK6nMP8gWczaYh7PMeYyVOIs2B20xQBy%2Bz7oe%2BYQ2GfdEr2hgqPH3jd%2B7c&amp;X-Amz-Signature=11b8cd524c25ef51193e3b3fc4816760ebcde8bfc74bd52f3f91d8bf409620f5&amp;X-Amz-SignedHeaders=host%22,%22Key%22:%22112162.jpg%22%7D%25">https://sam-app-s3uploadbucket-1653634.s3.us-east-2.amazonaws.com/112162.jpg?Content-Type=image%2Fjpeg&amp;X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=ASIAU6CQBER6YBNCDDMJ%2F20201224%2Fus-east-2%2Fs3%2Faws4_request&amp;X-Amz-Date=20201224T174804Z&amp;X-Amz-Expires=300&amp;X-Amz-Security-Token=IQoJb3JpZ2luX2VjEDIaCXVzLWVhc3QtMiJGMEQCIH65IvgJsofUpIX46lTaG3Pi5WC85ti1lukM3iICh%2BB%2BAiAJEyynPNPhZN8%2Bg1ylO7wthqud9cBcNIChIp2H%2F%2BR7mCryAQjb%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F8BEAAaDDMzOTQ3MDI2MzQyMSIMLqPo1IYyH7udCGZuKsYBSEF3c50YXkmPeSWcLsEzq%2BFBTpeOIrwZTyCUjbJ7fgJUakhM1YRX40jExstN8eJcMXqw00Xd5lYHvZDbU9ajwWPLRAxcEN5BQ0utqn0NGTLyJhibzJUj8cjgm5RguIEKe9GUtMVWa9mi7C5%2FlFpS0i9jK5BSVf74JyPSLETV5mzMMzy5kHBQMGjw1dR66E3MG8PjIqfgKjhVtZmlaicf5OmeqNI2%2F8T5ye%2FICRsH4d7KNEmj4FELa8buW8U%2Fn97ThfH3P7XmMNOok%2F8FOuEBDj1EHluCT4DfZ1jIXjvrJsVv1WtV4POQDn2Dah%2BWosBn%2BFNTtQtw841ACDarYR1ZVbuwcpTjfBPlGuSOncPsbzOhzDy7wYyumsPKsXoPdxTncMWbx4BQkbU5SeF9hjpfIKRMSOqkJBN7%2BtgHXwuW1rfYMDN2OAlQZpTj7uWMPWojUMbvMzyHvI2pfgcRAlrBdGGYDigyjWl9QXP%2Bdi6WiR7XCSXbWcIAJDZh%2Beb%2BIH1asmMJtpAK6nMP8gWczaYh7PMeYyVOIs2B20xQBy%2Bz7oe%2BYQ2GfdEr2hgqPH3jd%2B7c&amp;X-Amz-Signature=11b8cd524c25ef51193e3b3fc4816760ebcde8bfc74bd52f3f91d8bf409620f5&amp;X-Amz-SignedHeaders=host&quot;,&quot;Key&quot;:&quot;112162.jpg&quot;}%</a> </p></blockquote><p>The premise of this is you make a request, and then the response from
the API is a pre-signed URL that then allows you to upload directly to
S3. You can use <code>curl &lt;url&gt; --upload-file yourfile.jpg</code>. This
automatically does a PUT request to the s3 bucket (yes, this is talking
directly to s3 now, not the lambda! the lambda is just for generating
the &quot;pre-signed URL&quot; to let you upload). Careful to copy it exactly as
is</p><blockquote><p>curl
&quot;<a href="https://sam-app-s3uploadbucket-1653634.s3.us-east-2.amazonaws.com/112162.jpg?Content-Type=image%2Fjpeg&amp;X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=ASIAU6CQBER6YBNCDDMJ%2F20201224%2Fus-east-2%2Fs3%2Faws4_request&amp;X-Amz-Date=20201224T174804Z&amp;X-Amz-Expires=300&amp;X-Amz-Security-Token=IQoJb3JpZ2luX2VjEDIaCXVzLWVhc3QtMiJGMEQCIH65IvgJsofUpIX46lTaG3Pi5WC85ti1lukM3iICh%2BB%2BAiAJEyynPNPhZN8%2Bg1ylO7wthqud9cBcNIChIp2H%2F%2BR7mCryAQjb%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F8BEAAaDDMzOTQ3MDI2MzQyMSIMLqPo1IYyH7udCGZuKsYBSEF3c50YXkmPeSWcLsEzq%2BFBTpeOIrwZTyCUjbJ7fgJUakhM1YRX40jExstN8eJcMXqw00Xd5lYHvZDbU9ajwWPLRAxcEN5BQ0utqn0NGTLyJhibzJUj8cjgm5RguIEKe9GUtMVWa9mi7C5%2FlFpS0i9jK5BSVf74JyPSLETV5mzMMzy5kHBQMGjw1dR66E3MG8PjIqfgKjhVtZmlaicf5OmeqNI2%2F8T5ye%2FICRsH4d7KNEmj4FELa8buW8U%2Fn97ThfH3P7XmMNOok%2F8FOuEBDj1EHluCT4DfZ1jIXjvrJsVv1WtV4POQDn2Dah%2BWosBn%2BFNTtQtw841ACDarYR1ZVbuwcpTjfBPlGuSOncPsbzOhzDy7wYyumsPKsXoPdxTncMWbx4BQkbU5SeF9hjpfIKRMSOqkJBN7%2BtgHXwuW1rfYMDN2OAlQZpTj7uWMPWojUMbvMzyHvI2pfgcRAlrBdGGYDigyjWl9QXP%2Bdi6WiR7XCSXbWcIAJDZh%2Beb%2BIH1asmMJtpAK6nMP8gWczaYh7PMeYyVOIs2B20xQBy%2Bz7oe%2BYQ2GfdEr2hgqPH3jd%2B7c&amp;X-Amz-Signature=11b8cd524c25ef51193e3b3fc4816760ebcde8bfc74bd52f3f91d8bf409620f5&amp;X-Amz-SignedHeaders=host%22">https://sam-app-s3uploadbucket-1653634.s3.us-east-2.amazonaws.com/112162.jpg?Content-Type=image%2Fjpeg&amp;X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=ASIAU6CQBER6YBNCDDMJ%2F20201224%2Fus-east-2%2Fs3%2Faws4_request&amp;X-Amz-Date=20201224T174804Z&amp;X-Amz-Expires=300&amp;X-Amz-Security-Token=IQoJb3JpZ2luX2VjEDIaCXVzLWVhc3QtMiJGMEQCIH65IvgJsofUpIX46lTaG3Pi5WC85ti1lukM3iICh%2BB%2BAiAJEyynPNPhZN8%2Bg1ylO7wthqud9cBcNIChIp2H%2F%2BR7mCryAQjb%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F8BEAAaDDMzOTQ3MDI2MzQyMSIMLqPo1IYyH7udCGZuKsYBSEF3c50YXkmPeSWcLsEzq%2BFBTpeOIrwZTyCUjbJ7fgJUakhM1YRX40jExstN8eJcMXqw00Xd5lYHvZDbU9ajwWPLRAxcEN5BQ0utqn0NGTLyJhibzJUj8cjgm5RguIEKe9GUtMVWa9mi7C5%2FlFpS0i9jK5BSVf74JyPSLETV5mzMMzy5kHBQMGjw1dR66E3MG8PjIqfgKjhVtZmlaicf5OmeqNI2%2F8T5ye%2FICRsH4d7KNEmj4FELa8buW8U%2Fn97ThfH3P7XmMNOok%2F8FOuEBDj1EHluCT4DfZ1jIXjvrJsVv1WtV4POQDn2Dah%2BWosBn%2BFNTtQtw841ACDarYR1ZVbuwcpTjfBPlGuSOncPsbzOhzDy7wYyumsPKsXoPdxTncMWbx4BQkbU5SeF9hjpfIKRMSOqkJBN7%2BtgHXwuW1rfYMDN2OAlQZpTj7uWMPWojUMbvMzyHvI2pfgcRAlrBdGGYDigyjWl9QXP%2Bdi6WiR7XCSXbWcIAJDZh%2Beb%2BIH1asmMJtpAK6nMP8gWczaYh7PMeYyVOIs2B20xQBy%2Bz7oe%2BYQ2GfdEr2hgqPH3jd%2B7c&amp;X-Amz-Signature=11b8cd524c25ef51193e3b3fc4816760ebcde8bfc74bd52f3f91d8bf409620f5&amp;X-Amz-SignedHeaders=host&quot;</a>
--upload-file test.jpg</p></blockquote><p>There is no response, but I can then check the s3 console and see the
file upload is successful (all files are renamed)</p><p><img src="https://64.media.tumblr.com/cd948c0709d9e36a4434ed6c1fdc0706/237164d886a09414-c2/s540x810/886b466cae543391a32a424dfd13aa7826423398.png"/></p><p>Figure shows that the file upload is successful :)</p><p>Then we can edit the file frontend/index.html from the repo we cloned to
contain the lambda with the /uploads/ suffix</p><p><img src="https://64.media.tumblr.com/8dd5ec24c62e5a588fbb9c338b72533c/237164d886a09414-d8/s540x810/8ad17c4eee0a72fd8e8300cd35e7c4929ea5d8d9.png"/></p><p>Figure shows editing the index.html with the lambda endpoint</p><p>Then we manually upload this file to another s3 bucket or test it
locally</p><blockquote><p>aws s3 cp index.html s3://mybucket/</p><p>...visit that in the browser</p></blockquote><p>At this point the files are getting uploaded but not publically
accessible. To make them publically accessible we uncomment the
ACL: &#x27;public-read&#x27; in the getSignedURL/app.js folder in the github repo</p><p><img src="https://64.media.tumblr.com/c2bb77d16f1ff8501da962cf99954241/237164d886a09414-9b/s540x810/9c8a6be9e7291b168400984533061976febd38cf.png"/></p><p>Figure showing the public-read uncommented</p><p><img src="https://64.media.tumblr.com/6b46deb1dc8025abacbeb67d5c950d17/237164d886a09414-e4/s540x810/4e1913f18f4c3b544af95aa617e025bfa48b34b5.png"/></p><p>Figure showing the lines that need uncommenting in template.yaml in the
root of the github repo that allows putObject in s3 with the public-read
ACL</p><p>Re-run <code>sam deploy --guided</code>, same thing as at the start</p><p>Now the objects are publicly accessible!</p><p>::: {#footer}
<!-- -->[ December 24th, 2020 1:14pm ]<!-- -->{#timestamp}
:::</p></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/2020-12-24","query":{},"buildId":"Z-Nz8uYVC2hk5uorlrwTC","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>