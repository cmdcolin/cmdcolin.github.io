<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/_next/static/css/39537df1dfa69610d89e.css" as="style"/><link rel="stylesheet" href="/_next/static/css/39537df1dfa69610d89e.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a40ef1678bae11e696dba45124eadd70.js"></script><script src="/_next/static/chunks/webpack-1a8a258926ecde76681b.js" defer=""></script><script src="/_next/static/chunks/framework-b97a0ed4f13ff8397343.js" defer=""></script><script src="/_next/static/chunks/main-1f2c591c5d3bfcfc95e6.js" defer=""></script><script src="/_next/static/chunks/pages/_app-72a03db9ecdc52193d45.js" defer=""></script><script src="/_next/static/chunks/pages/2021-10-30-spooky-360791c6497b335ccb64.js" defer=""></script><script src="/_next/static/l95N5agp3f9VJOcvppUQZ/_buildManifest.js" defer=""></script><script src="/_next/static/l95N5agp3f9VJOcvppUQZ/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div><div><a href="/">Return home</a><img src="/avatar.png" style="height:2em;margin-left:1em"/></div><div class="blog"><h2>A spooky error when you have a string bigger than 512MB</h2><p>Now gather round for a spooky story</p><p>Late one night... in the haunted office space castle (hindenbugs cackling in
the background amongst the dusty technical books) the midnight candles were
burning bright and we entered data for a user file</p><p>A simple 52MB gzipped datafile that we want to process in the browser. We unzip
it, decode it, and ...an error</p><p>ERROR: data not found</p><p><img src="/media/pumpkin-dark.jpg"/></p><p>But... our code is so simple (we of course abide by the religion of writing &quot;simple code&quot; you know)...what could be happening?</p><p>The code looks like this</p><pre><code class="language-js">const buffer = unzip(file)
const str = new TextDecoder().decode(buf);
</code></pre><p>We trace it back and run a console.log(str)</p><p>It looks empty. We try running console.log(str.length) ... it prints out 0</p><p>But if we console.log(buffer.length) we get 546,483,710 bytes...</p><p>What could be happening?</p><p>We see in the TextDecoder documentation that it has a note called &quot;fatal&quot;. We try</p><pre><code class="language-js">const buffer = unzip(file)
const str = new TextDecoder(&quot;utf8&quot;,{fatal:true}).decode(buf);
</code></pre><p>This doesn&#x27;t change, but it seems like TextDecoder is failing.</p><p>Then it dawns on us while the lightning hits and the thunderclap booms and the wind blows through the rattly windows</p><p>We have hit...the maximum string length in Chrome</p><p>BWAHAHAHAHA</p><p>The maximum string length!!! Nooooooo</p><p>It is 512MB on the dot... 536,870,888 bytes. We test this to be sure</p><pre><code>const len = 536_870_888;
const buf = new Uint8Array(len);
for (let i = 0; i &lt; len; i++) {
  buf[i] = &quot;a&quot;.charCodeAt(0);
}
const str = new TextDecoder().decode(buf);
console.log(str.length);

</code></pre><p>This is correct, outputs  536,870,888</p><p>With anything, even one byte more, it fails and outputs 0</p><p>With 512MB+1 bytes on node.js it actually prints an error instead of no error
message like chrome</p><p>happy halloween!!</p><p>pumpkin photo source: <a href="http://mountainbikerak.blogspot.com/2010/11/google-chrome-pumpkin.html">http://mountainbikerak.blogspot.com/2010/11/google-chrome-pumpkin.html</a></p></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/2021-10-30-spooky","query":{},"buildId":"l95N5agp3f9VJOcvppUQZ","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>