<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/_next/static/css/39537df1dfa69610d89e.css" as="style"/><link rel="stylesheet" href="/_next/static/css/39537df1dfa69610d89e.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a40ef1678bae11e696dba45124eadd70.js"></script><script src="/_next/static/chunks/webpack-1a8a258926ecde76681b.js" defer=""></script><script src="/_next/static/chunks/framework-b97a0ed4f13ff8397343.js" defer=""></script><script src="/_next/static/chunks/main-1f2c591c5d3bfcfc95e6.js" defer=""></script><script src="/_next/static/chunks/pages/_app-72a03db9ecdc52193d45.js" defer=""></script><script src="/_next/static/chunks/pages/2021-10-30-spooky-0222f3458916c46b0281.js" defer=""></script><script src="/_next/static/WHwL-S592P04nzU84P3w-/_buildManifest.js" defer=""></script><script src="/_next/static/WHwL-S592P04nzU84P3w-/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div><div><a href="/">Return home</a><img src="/avatar.png" style="height:2em;margin-left:1em"/></div><div class="blog"><h2>A spooky error when you have a string bigger than 512MB</h2><p>Now gather round for a spooky story</p><p>Late one night... in the haunted office space castle (hindenbugs cackling in
the background amongst the dusty technical books) the midnight candles were
burning bright and we entered data for a user file</p><p>A simple 52MB gzipped datafile that we want to process in the browser. We unzip
it, decode it, and ...an error</p><p>ERROR: data not found</p><p><img src="/media/pumpkin-dark.jpg"/></p><p>Our code is simple, it looks like</p><pre><code class="language-js">const buffer = unzip(file)
const str = new TextDecoder().decode(buf);
</code></pre><p>We trace it back and run a console.log(str)</p><p>It looks empty. We try running console.log(str.length) ... it prints out 0</p><p>But if we console.log(buffer.length) we get 546_483_710 bytes...</p><p>What could be happening?</p><p>We see in the TextDecoder documentation that it has a note called &quot;fatal&quot;. We try</p><pre><code class="language-js">const buffer = unzip(file)
const str = new TextDecoder(&quot;utf8&quot;,{fatal:true}).decode(buf);
</code></pre><p>This doesn&#x27;t change, but it seems like TextDecoder is failing.</p><p>Then it dawns on us while the lightning hits and the thunderclap booms and the wind blows through the rattly windows</p><p>We have hit...the maximum string length in Chrome</p><p>BWAHAHAHAHA</p><p>The maximum string length!!! Nooooooo</p><p>It is 512MB on the dot</p><p>536_870_888 bytes</p><p>We test this to be sure</p><p>With 6_000_000 bytes</p><pre><code>const len = 536_870_888;
const buf = new Uint8Array(len);
for (let i = 0; i &lt; len; i++) {
  buf[i] = &quot;a&quot;.charCodeAt(0);
}
const str = new TextDecoder().decode(buf);
console.log(str.length);

</code></pre><p>This is correct, outputs  536_870_888</p><p>With anything, even one byte more, it fails and outputs 0</p><p>With 512MB+1 bytes  on node.js it actually prints an error instead of no error message like chrome</p><pre><code>~ ❯❯❯ node test.js                                                                            ✘ 130
node:buffer:603
    slice: (buf, start, end) =&gt; buf.ucs2Slice(start, end),
                                    ^

Error: Cannot create a string longer than 0x1fffffe8 characters
    at Object.slice (node:buffer:603:37)
    at Uint8Array.toString (node:buffer:812:14)
    at TextDecoder.decode (node:internal/encoding:426:18)
    at Object.&lt;anonymous&gt; (/home/cdiesh/test.js:6:31)
    at Module._compile (node:internal/modules/cjs/loader:1092:14)
    at Object.Module._extensions..js (node:internal/modules/cjs/loader:1121:10)
    at Module.load (node:internal/modules/cjs/loader:972:32)
    at Function.Module._load (node:internal/modules/cjs/loader:813:14)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:76:12)
    at node:internal/main/run_main_module:17:47 {
  code: &#x27;ERR_STRING_TOO_LONG&#x27;

</code></pre><p>Curiously, with a 600_000_000 byte string it is a different error...who knows why (lightning clap)</p><pre><code>~ ❯❯❯ node test.js                                                                            ✘ 130
node:internal/encoding:424
        throw new ERR_ENCODING_INVALID_ENCODED_DATA(this.encoding, ret);
        ^

TypeError [ERR_ENCODING_INVALID_ENCODED_DATA]: The encoded data was not valid for encoding utf-8
    at new NodeError (node:internal/errors:329:5)
    at TextDecoder.decode (node:internal/encoding:424:15)
    at Object.&lt;anonymous&gt; (/home/cdiesh/test.js:6:31)
    at Module._compile (node:internal/modules/cjs/loader:1092:14)
    at Object.Module._extensions..js (node:internal/modules/cjs/loader:1121:10)
    at Module.load (node:internal/modules/cjs/loader:972:32)
    at Function.Module._load (node:internal/modules/cjs/loader:813:14)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:76:12)
    at node:internal/main/run_main_module:17:47 {
  errno: 1,
  code: &#x27;ERR_ENCODING_INVALID_ENCODED_DATA&#x27;
}

</code></pre><p>source: <a href="http://mountainbikerak.blogspot.com/2010/11/google-chrome-pumpkin.html">http://mountainbikerak.blogspot.com/2010/11/google-chrome-pumpkin.html</a></p><p>happy halloween</p></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/2021-10-30-spooky","query":{},"buildId":"WHwL-S592P04nzU84P3w-","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>