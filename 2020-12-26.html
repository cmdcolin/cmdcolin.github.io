<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/_next/static/css/39537df1dfa69610d89e.css" as="style"/><link rel="stylesheet" href="/_next/static/css/39537df1dfa69610d89e.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a40ef1678bae11e696dba45124eadd70.js"></script><script src="/_next/static/chunks/webpack-1a8a258926ecde76681b.js" defer=""></script><script src="/_next/static/chunks/framework-b97a0ed4f13ff8397343.js" defer=""></script><script src="/_next/static/chunks/main-1f2c591c5d3bfcfc95e6.js" defer=""></script><script src="/_next/static/chunks/pages/_app-72a03db9ecdc52193d45.js" defer=""></script><script src="/_next/static/chunks/pages/2020-12-26-2f7e06b9cd493f0cfb96.js" defer=""></script><script src="/_next/static/btsxZA-AomRRRlAVS2Ezs/_buildManifest.js" defer=""></script><script src="/_next/static/btsxZA-AomRRRlAVS2Ezs/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div><div><a href="/">Return home</a><img src="/avatar.png" style="height:2em;margin-left:1em"/></div><div class="blog"><h1>Making a serverless website for photo and video upload pt. 2</h1><p>This post follows
on <a href="https://searchvoidstar.tumblr.com/post/638408397901987840/making-a-serverless-website-for-photo-upload-pt-1">https://searchvoidstar.tumblr.com/post/638408397901987840/making-a-serverless-website-for-photo-upload-pt-1</a></p><p>It is possible I zoomed ahead too fast to make this a continuous
tutorial, but overall I just wanted to post an update</p><p>In pt. 1 I learned how to use the <code>aws-sam</code> CLI tool. This was a great
insight for me about automating deployments. I can now simply run <code>sam
deploy</code> and it will create new dynamodb tables, lambda functions, etc.</p><p>After writing pt 1. I converted the existing vue-js app that was in the
aws tutorial and converted it to react. Then I extended the app to allow</p><ul><li>Posting comments on photos</li><li>Uploading multiple files</li><li>Uploading videos
etc.</li></ul><p>It will be hard to summarize all the changes since now the app has taken
off a little bit but it looks like this:</p><p>Repo structure</p><pre><code> ./frontend # created using npx create-react-app frontend --template
 typescript
 ./frontend/src/App.tsx # main frontend app code in react
 ./lambdas/
 ./lambdas/postFile # post a file to the lambda, this uploads a row to
 dynamodb and returns a pre-signed URL for uploading (note that if the
 client failed it&#x27;s upload, that row in the lambda DB might be in a bad
 state...)
 ./lambdas/getFiles # get all files that were ever posted
 ./lambdas/postComment # post a comment on a picture with POST
 request
 ./lambdas/getComments?file=filename.jpg # get comments on a
 picture/video with GET request
</code></pre><p>Here is a detailed code for uploading the file. We upload one file at a
time, but the client code post to the lambda endpoint individually for
each file</p><p>This generates a pre-signed URL to allow the client-side JS (not the
lambda itself) to directly upload to S3, and also posts a row in the S3
to the filename that will. It is very similar code in
to <a href="https://searchvoidstar.tumblr.com/post/638408397901987840/making-a-serverless-website-for-photo-upload-pt-1">https://searchvoidstar.tumblr.com/post/638408397901987840/making-a-serverless-website-for-photo-upload-pt-1</a></p><p>./lambdas/postFile/app.js</p><pre><code class="language-js"> &quot;use strict&quot;;

 const AWS = require(&quot;aws-sdk&quot;);
 const multipart = require(&quot;./multipart&quot;);
 AWS.config.update({ region: process.env.AWS_REGION });
 const s3 = new AWS.S3();

 // Change this value to adjust the signed URL&#x27;s expiration
 const URL_EXPIRATION_SECONDS = 300;

 // Main Lambda entry point
 exports.handler = async (event) =&gt; {
  return await getUploadURL(event);
 };

 const { AWS_REGION: region } = process.env;

 const dynamodb = new AWS.DynamoDB({ apiVersion: &quot;2012-08-10&quot;, region
 });

 async function uploadPic({
  timestamp,
  filename,
  message,
  user,
  date,
  contentType,
 }) {
  const params = {
    Item: {
      timestamp: {
        N: `${timestamp}`,
      },
      filename: {
        S: filename,
      },
      message: {
        S: message,
      },
      user: {
        S: user,
      },
      date: {
        S: date,
      },
      contentType: {
        S: contentType,
      },
    },
    TableName: &quot;files&quot;,
  };
  return dynamodb.putItem(params).promise();
 }

 const getUploadURL = async function (event) {
  try {
    const data = multipart.parse(event);
    const { filename, contentType, user, message, date } = data;
    const timestamp = +Date.now();
    const Key = `${timestamp}-${filename}`;

    // Get signed URL from S3
    const s3Params = {
      Bucket: process.env.UploadBucket,
      Key,
      Expires: URL_EXPIRATION_SECONDS,
      ContentType: contentType,

      // This ACL makes the uploaded object publicly readable. You must also uncomment
      // the extra permission for the Lambda function in the SAM template.

      ACL: &quot;public-read&quot;,
    };

    const uploadURL = await s3.getSignedUrlPromise(&quot;putObject&quot;, s3Params);

    await uploadPic({
      timestamp,
      filename: Key,
      message,
      user,
      date,
      contentType,
    });

    return JSON.stringify({
      uploadURL,
      Key,
    });
  } catch (e) {
    const response = {
      statusCode: 500,
      body: JSON.stringify({ message: `${e}` }),
    };
    return response;
  }
 };



</code></pre><p>./lambdas/getFiles/app.js</p><pre><code class="language-js"> // eslint-disable-next-line import/no-unresolved
 const AWS = require(&quot;aws-sdk&quot;);

 const { AWS_REGION: region } = process.env;

 const docClient = new AWS.DynamoDB.DocumentClient();

 const getItems = function () {
 const params = {
   TableName: &quot;files&quot;,
 };

 return docClient.scan(params).promise();
 };

 exports.handler = async (event) =&gt; {
 try {
   const result = await getItems();
   return {
     statusCode: 200,
     body: JSON.stringify(result),
   };
 } catch (e) {
   return {
     statusCode: 400,
     body: JSON.stringify({ message: `${e}` }),
   };
 }
 };

</code></pre><p>./frontend/src/App.tsx (excerpt)</p><pre><code class="language-tsx">
 async function myfetch(params: string, opts?: any) {
  const response = await fetch(params, opts);
  if (!response.ok) {
    throw new Error(`HTTP ${response.status}
 ${response.statusText}`);
  }
  return response.json();
 }


 function UploadDialog({
  open,
  onClose,
 }: {
  open: boolean;
  onClose: () =&gt; void;
 }) {
  const [images, setImages] = useState&lt;FileList&gt;();
  const [error, setError] = useState&lt;Error&gt;();
  const [loading, setLoading] = useState(false);
  const [total, setTotal] = useState(0);
  const [completed, setCompleted] = useState(0);
  const [user, setUser] = useState(&quot;&quot;);
  const [message, setMessage] = useState(&quot;&quot;);
  const classes = useStyles();

  const handleClose = () =&gt; {
    setError(undefined);
    setLoading(false);
    setImages(undefined);
    setCompleted(0);
    setTotal(0);
    setMessage(&quot;&quot;);
    onClose();
  };

  return (
    &lt;Dialog onClose={handleClose} open={open}&gt;
      &lt;DialogTitle&gt;upload a file (supports picture or
 video)&lt;/DialogTitle&gt;

      &lt;DialogContent&gt;
        &lt;label htmlFor=&quot;user&quot;&gt;name (optional) &lt;/label&gt;
        &lt;input
          type=&quot;text&quot;
          value={user}
          onChange={(event) =&gt; setUser(event.target.value)}
          id=&quot;user&quot;
        /&gt;
        &lt;br /&gt;
        &lt;label htmlFor=&quot;user&quot;&gt;message (optional) &lt;/label&gt;
        &lt;input
          type=&quot;text&quot;
          value={message}
          onChange={(event) =&gt; setMessage(event.target.value)}
          id=&quot;message&quot;
        /&gt;
        &lt;br /&gt;
        &lt;input
          multiple
          type=&quot;file&quot;
          onChange={(e) =&gt; {
            let files = e.target.files;
            if (files &amp;&amp; files.length) {
              setImages(files);
            }
          }}
        /&gt;

        {error ? (
          &lt;div className={classes.error}&gt;{`${error}`}&lt;/div&gt;
        ) : loading ? (
          `Uploading...${completed}/${total}`
        ) : completed ? (
          &lt;h2&gt;Uploaded &lt;/h2&gt;
        ) : null}

        &lt;DialogActions&gt;
          &lt;Button
            style={{ textTransform: &quot;none&quot; }}
            onClick={async () =&gt; {
              try {
                if (images) {
                  setLoading(true);
                  setError(undefined);
                  setCompleted(0);
                  setTotal(images.length);
                  await Promise.all(
                    Array.from(images).map(async (image) =&gt; {
                      const data = new FormData();
                      data.append(&quot;message&quot;, message);
                      data.append(&quot;user&quot;, user);
                      data.append(&quot;date&quot;, new Date().toLocaleString());
                      data.append(&quot;filename&quot;, image.name);
                      data.append(&quot;contentType&quot;, image.type);
                      const res = await myfetch(API_ENDPOINT + &quot;/postFile&quot;, {
                        method: &quot;POST&quot;,
                        body: data,
                      });

                      await myfetch(res.uploadURL, {
                        method: &quot;PUT&quot;,
                        body: image,
                      });

                      setCompleted((completed) =&gt; completed + 1);
                    })
                  );
                  setTimeout(() =&gt; {
                    handleClose();
                  }, 500);
                }
              } catch (e) {
                setError(e);
              }
            }}
            color=&quot;primary&quot;
          &gt;
            upload
          &lt;/Button&gt;
          &lt;Button
            onClick={handleClose}
            color=&quot;primary&quot;
            style={{ textTransform: &quot;none&quot; }}
          &gt;
            cancel
          &lt;/Button&gt;
        &lt;/DialogActions&gt;
      &lt;/DialogContent&gt;
    &lt;/Dialog&gt;
  );
 }

</code></pre><p>template.yaml for AWS</p><pre><code> AWSTemplateFormatVersion: 2010-09-09
 Transform: AWS::Serverless-2016-10-31
 Description: S3 Uploader

 Resources:
  filesDynamoDBTable:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
        - AttributeName: &quot;timestamp&quot;
          AttributeType: &quot;N&quot;
      KeySchema:
        - AttributeName: &quot;timestamp&quot;
          KeyType: &quot;HASH&quot;
      ProvisionedThroughput:
        ReadCapacityUnits: &quot;5&quot;
        WriteCapacityUnits: &quot;5&quot;
      TableName: &quot;files&quot;

  # HTTP API
  MyApi:
    Type: AWS::Serverless::HttpApi
    Properties:
      # CORS configuration - this is open for development only and
 should be restricted in prod.
      # See
 &lt;https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-property-httpapi-httpapicorsconfiguration.html&gt;
      CorsConfiguration:
        AllowMethods:
          - GET
          - POST
          - DELETE
          - OPTIONS
        AllowHeaders:
          - &quot;*&quot;
        AllowOrigins:
          - &quot;*&quot;

  UploadRequestFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/postFile/
      Handler: app.handler
      Runtime: nodejs12.x
      Timeout: 3
      MemorySize: 128
      Environment:
        Variables:
          UploadBucket: !Ref S3UploadBucket
      Policies:
        - AmazonDynamoDBFullAccess
        - S3WritePolicy:
            BucketName: !Ref S3UploadBucket
        - Statement:
            - Effect: Allow
              Resource: !Sub &quot;arn:aws:s3:::${S3UploadBucket}/&quot;
              Action:
                - s3:putObjectAcl
      Events:
        UploadAssetAPI:
          Type: HttpApi
          Properties:
            Path: /postFile
            Method: post
            ApiId: !Ref MyApi


  FileReadFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/getFiles/
      Handler: app.handler
      Runtime: nodejs12.x
      Timeout: 3
      MemorySize: 128
      Policies:
        - AmazonDynamoDBFullAccess
      Events:
        UploadAssetAPI:
          Type: HttpApi
          Properties:
            Path: /getFiles
            Method: get
            ApiId: !Ref MyApi

  ## S3 bucket
  S3UploadBucket:
    Type: AWS::S3::Bucket
    Properties:
      CorsConfiguration:
        CorsRules:
          - AllowedHeaders:
              - &quot;*&quot;
            AllowedMethods:
              - GET
              - PUT
              - HEAD
            AllowedOrigins:
              - &quot;*&quot;


 ## Take a note of the outputs for deploying the workflow templates
 in this sample application
 Outputs:
  APIendpoint:
    Description: &quot;HTTP API endpoint URL&quot;
    Value: !Sub
 &quot;https://${MyApi}.execute-api.${AWS::Region}.amazonaws.com&quot;
  S3UploadBucketName:
    Description: &quot;S3 bucket for application uploads&quot;
    Value: !Ref &quot;S3UploadBucket&quot;

</code></pre><p>To display all the pictures I use a switch from video or img tag based
on contentType.startsWith(&#x27;video&#x27;). I also use the &quot;figcaption&quot; HTML tag
to have a little caption on the pics/videos</p><p>./frontend/src/App.tsx</p><pre><code> function Media({
  file,
  style,
  onClick,
  children,
 }: {
  file: File;
  onClick?: Function;
  style?: React.CSSProperties;
  children?: React.ReactNode;
 }) {
  const { filename, contentType } = file;
  const src = `${BUCKET}/${filename}`;
  return (
    &lt;figure style={{ display: &quot;inline-block&quot; }}&gt;
      &lt;picture&gt;
        {contentType.startsWith(&quot;video&quot;) ? (
          &lt;video style={style} src={src} controls onClick={onClick as
 any} /&gt;
        ) : (
          &lt;img style={style} src={src} onClick={onClick as any} /&gt;
        )}
      &lt;/picture&gt;
      &lt;figcaption&gt;{children}&lt;/figcaption&gt;
    &lt;/figure&gt;
  );
 }
</code></pre><p>Now the really fun part: if you get an image of a picture frame
like <a href="https://www.amazon.com/Paintings-Frames-Antique-Shatterproof-Osafs2-Gld-A3/dp/B06XNQ8W9T">https://www.amazon.com/Paintings-Frames-Antique-Shatterproof-Osafs2-Gld-A3/dp/B06XNQ8W9T</a></p><p>You can make it a border for any image or video using border-image CSS</p><pre><code>     style = {
         border: &quot;30px solid&quot;,
         borderImage: `url(borders/${border}) 30 round`
     }
</code></pre><p><img src="/media/638602799897329664_0.png"/></p><p>Summary</p><p>The template.yaml automatically deploys the lambdas for postFile/getFile
and the files table in dynamoDB</p><p>The React app uses postFile for each file in an <input type="file"/>,
the code uses React hooks and functional components but is hopefully not
too complex</p><p>I also added commenting on photos. The code is not shown here but you
can look in the source code for details</p><p><img src="/media/638602799897329664_1.png"/></p><p>Overall this has been a good experience learning to develop this app and
learning to automate the cloud deployment is really good for ensuring
reliability and fast iteration.</p><p>Also quick note on serverless CLI vs aws-sam. I had tried a serverless
CLI tutorial from another user but it didn&#x27;t click with me, while the
aws-sam tutorial from
<a href="https://searchvoidstar.tumblr.com/post/638408397901987840/making-a-serverless-website-for-photo-upload-pt-1">https://searchvoidstar.tumblr.com/post/638408397901987840/making-a-serverless-website-for-photo-upload-pt-1</a> was
a great kick start for me. I am sure the serverless CLI is great too and
it ensures a bit less vendor lock in, but then is also a little bit
removed from the native aws config schemas. Probably fine though</p><p>Source code <a href="https://github.com/cmdcolin/aws_photo_gallery/">https://github.com/cmdcolin/aws_photo_gallery/</a></p><p>::: {#footer}
<!-- -->[ December 26th, 2020 4:44pm ]<!-- -->{#timestamp}
:::</p></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/2020-12-26","query":{},"buildId":"btsxZA-AomRRRlAVS2Ezs","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>