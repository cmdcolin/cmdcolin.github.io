<!DOCTYPE html><html lang="en"><head><link rel="shortcut icon" href="favicon.ico"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><meta name="description" content="Blogging for the future"/><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/prism.min.js" integrity="sha512-hpZ5pDCF2bRCweL5WoA0/N1elet1KYL5mx3LP555Eg/0ZguaHawxNvEjF6O3rufAChs16HVNhEc6blF/rZoowQ==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Misc scribblings</title><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/05520625efedd785.css" as="style"/><link rel="stylesheet" href="/_next/static/css/05520625efedd785.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-514908bffb652963.js" defer=""></script><script src="/_next/static/chunks/framework-91d7f78b5b4003c8.js" defer=""></script><script src="/_next/static/chunks/main-d98b4a7f39fdfc80.js" defer=""></script><script src="/_next/static/chunks/pages/_app-76cd57bf65f05d70.js" defer=""></script><script src="/_next/static/chunks/pages/index-d0fc86f38e909532.js" defer=""></script><script src="/_next/static/XVI_xbkv25tCu5jHUrItP/_buildManifest.js" defer=""></script><script src="/_next/static/XVI_xbkv25tCu5jHUrItP/_ssgManifest.js" defer=""></script><script src="/_next/static/XVI_xbkv25tCu5jHUrItP/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div><main><div><div><a href="/">Misc scribbles</a></div><h1> Colin Diesh</h1><p><img src="/me.jpg" alt=""/></p>
<p>I&#x27;m a web developer and bioinformatician working on JBrowse. Interested in all
sorts of creative hacking and data science. Also crafting, DIY and nature.</p><section><h1>Posts</h1><ul><li><div><a href="/posts/2021-12-31-npm-package">2021-12-31<!-- --> - <!-- -->How to make your own npm package with typescript</a></div></li><li><div><a href="/posts/2021-12-26-nextjs">2021-12-26<!-- --> - <!-- -->My next.js static blog setup</a></div></li><li><div><a href="/posts/2021-10-30-spooky">2021-10-30<!-- --> - <!-- -->A spooky error when you have a string bigger than 512MB in Chrome</a></div></li><li><div><a href="/posts/2021-10-05-jest">2021-10-05<!-- --> - <!-- -->Jest parallelization, globals, mocks, and squawkless tests</a></div></li><li><div><a href="/posts/2021-09-05-typescript">2021-09-05<!-- --> - <!-- -->Decrease your idle CPU usage when developing typescript apps with this one weird environment variable</a></div></li><li><div><a href="/posts/2021-08-15-map-limit">2021-08-15<!-- --> - <!-- -->An amazing error message if you put more than 2^24 items in a JS Map object</a></div></li><li><div><a href="/posts/2021-07-27-npm-dependencies">2021-07-27<!-- --> - <!-- -->Do you understand your NPM dependencies?</a></div></li><li><div><a href="/posts/2020-12-26-pt2">2020-12-26<!-- --> - <!-- -->Making a HTTPS accessible S3 powered static site with CloudFront+route 53</a></div></li></ul></section><a href="/archive">More posts...</a></div></main></div><footer style="margin-top:20px"><a href="/">Home</a> <a href="/archive">Blog archive</a> <a href="https://github.com/cmdcolin">Github</a> <a href="https://twitter.com/cmdcolin">Twitter</a> <a href="/projects">Projects</a> <a href="/photos">Photos</a> <a href="/rss.xml">RSS</a></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"allPosts":[{"title":"How to make your own npm package with typescript","date":"2021-12-31","slug":"2021-12-31-npm-package","mdxSource":{"compiledSource":"var c=Object.defineProperty,u=Object.defineProperties;var m=Object.getOwnPropertyDescriptors;var r=Object.getOwnPropertySymbols;var o=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable;var p=(n,a,i)=\u003ea in n?c(n,a,{enumerable:!0,configurable:!0,writable:!0,value:i}):n[a]=i,e=(n,a)=\u003e{for(var i in a||(a={}))o.call(a,i)\u0026\u0026p(n,i,a[i]);if(r)for(var i of r(a))s.call(a,i)\u0026\u0026p(n,i,a[i]);return n},l=(n,a)=\u003eu(n,m(a));var d=(n,a)=\u003e{var i={};for(var t in n)o.call(n,t)\u0026\u0026a.indexOf(t)\u003c0\u0026\u0026(i[t]=n[t]);if(n!=null\u0026\u0026r)for(var t of r(n))a.indexOf(t)\u003c0\u0026\u0026s.call(n,t)\u0026\u0026(i[t]=n[t]);return i};const layoutProps={},MDXLayout=\"wrapper\";function MDXContent(i){var t=i,{components:n}=t,a=d(t,[\"components\"]);return mdx(MDXLayout,l(e(e({},layoutProps),a),{components:n,mdxType:\"MDXLayout\"}),mdx(\"p\",null,\"There is a lot of mystery around making your own \",mdx(\"inlineCode\",{parentName:\"p\"},\"npm\"),` package. Every package\nlikely does it a bit differently, and it can be tricky to get a setup you like.\nShould you use a \"starter kit\" or a boilerplate example? Or just roll your own?\nShould you use a bundler? How do you use typescript?`),mdx(\"p\",null,\"All good questions.\"),mdx(\"p\",null,\"However, an \",mdx(\"inlineCode\",{parentName:\"p\"},\"npm\"),` package can be very bare bones. In some sense, npmjs.com is\njust an arbitrary file host, and you can upload pretty much anything you want\nto it.`),mdx(\"p\",null,\"The magic is in the package.json file, which tells npm:\"),mdx(\"ul\",null,mdx(\"li\",{parentName:\"ul\"},\"what files are part of your package\"),mdx(\"li\",{parentName:\"ul\"},`what to use as the \"entry point\" (e.g. the file that should be referenced\nwhen you say `,mdx(\"inlineCode\",{parentName:\"li\"},\"const lib = require('mypackage')\"),\")\"),mdx(\"li\",{parentName:\"ul\"},`what pre- and post- processing steps should be done when the package is being\npublished`),mdx(\"li\",{parentName:\"ul\"},\"and more!\")),mdx(\"p\",null,\"Let's try an experiment...\"),mdx(\"p\",null,\"Open up a terminal, and run\"),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{className:\"language-sh\"}),`mkdir mypackage\ncd mypackage\ngit init # make mypackage version controlled\nnpm init\n# or\nyarn init\n`)),mdx(\"p\",null,\"This outputs\"),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{className:\"language-sh\"}),`$ npm init # or yarn init\nThis utility will walk you through creating a package.json file.\nIt only covers the most common items, and tries to guess sensible defaults.\n\nSee \\`npm help init\\` for definitive documentation on these fields\nand exactly what they do.\n\nUse \\`npm install \u003cpkg\u003e\\` afterwards to install a package and\nsave it as a dependency in the package.json file.\n\nPress ^C at any time to quit.\npackage name: (mypackage)\nversion: (1.0.0)\ndescription:\nentry point: (index.js)\ntest command:\ngit repository:\nkeywords:\nlicense: (ISC)\nAbout to write to /home/cdiesh/mypackage/package.json:\n\n{\n  \"name\": \"mypackage\",\n  \"version\": \"1.0.0\",\n  \"description\": \"\",\n  \"main\": \"index.js\",\n  \"scripts\": {\n    \"test\": \"echo \\\\\"Error: no test specified\\\\\" \u0026\u0026 exit 1\"\n  },\n  \"author\": \"Colin\",\n  \"license\": \"ISC\"\n}\n\n`)),mdx(\"p\",null,`Then, you can create a index.js file (in your package.json it says \"main\": \"index.js\" to refer to this file, but it doesn't create it by default)`),mdx(\"p\",null,\"In your index.js file, generally, you would do things like export a function or functions\"),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{className:\"language-js\"}),`module.exports = {\n  hello: () =\u003e {\n    console.log('hello world')\n  },\n}\n`)),mdx(\"p\",null,\"This npm package, \",mdx(\"inlineCode\",{parentName:\"p\"},\"mypackage\"),\" can now be published to \",mdx(\"inlineCode\",{parentName:\"p\"},\"npm\"),` with a simple\ncommand.`),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{className:\"language-sh\"}),`npm publish\n# or\nyarn publish\n`)),mdx(\"p\",null,`This will prompt you for your npmjs.com username, password, email, and if\nneeded, 2FA token (highly recommended)`),mdx(\"p\",null,`Once it is published, you can use it in your create-react-app app or other npm\npackage.`),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{className:\"language-sh\"}),`npm install mypackage\n# or\nyarn add mypackage\n`)),mdx(\"p\",null,\"This all seems pretty boring thus far but it tells us a couple things\"),mdx(\"ol\",null,mdx(\"li\",{parentName:\"ol\"},\"packages can be very very bare bones\"),mdx(\"li\",{parentName:\"ol\"},\"no transpiler or bundler is needed for publishing an npm package\"),mdx(\"li\",{parentName:\"ol\"},\"our package can consist of a single file and it is uploaded to npm\"),mdx(\"li\",{parentName:\"ol\"},`the filename index.js is not special, probably it is a hangover from the\nname index.html. you can use whatever name you want`)),mdx(\"p\",null,`More often than not, we may actually want a little more complexity. We may not\nwant all our code to exist in a single file. So, in this case, we can actually\npublish a folder of files to `,mdx(\"inlineCode\",{parentName:\"p\"},\"npm\"),\".\"),mdx(\"p\",null,\"So inside of our \",mdx(\"inlineCode\",{parentName:\"p\"},\"mypackage\"),\" folder, let's make a src directory\"),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{className:\"language-sh\"}),`mkdir src\ntouch src/index.js\ntouch src/util.js\n`)),mdx(\"p\",null,\"And we can then have in our \",mdx(\"inlineCode\",{parentName:\"p\"},\"src/util.js\"),\" file\"),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{className:\"language-js\"}),`module.exports = {\n  getMessage: () =\u003e {\n    return 'hello'\n  },\n}\n`)),mdx(\"p\",null,\"And in our \",mdx(\"inlineCode\",{parentName:\"p\"},\"index.js\"),\" file\"),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{className:\"language-js\"}),`const { getMessage } = require('./util')\nmodule.exports = {\n  sayMessage: () =\u003e {\n    console.log(getMessage())\n  },\n}\n`)),mdx(\"p\",null,\"In our package.json, we can edit it to say\"),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{className:\"language-json\"}),`{\n  \"name\": \"mypackage2\",\n  \"version\": \"1.0.0\",\n  \"description\": \"\",\n  \"main\": \"src/index.js\",\n  \"files\": [\"src\"],\n  \"scripts\": {\n    \"test\": \"echo \\\\\"Error: no test specified\\\\\" \u0026\u0026 exit 1\"\n  },\n  \"author\": \"Colin\",\n  \"license\": \"ISC\"\n}\n`)),mdx(\"p\",null,\"Then when we use \",mdx(\"inlineCode\",{parentName:\"p\"},\"npm publish\"),\" (or \",mdx(\"inlineCode\",{parentName:\"p\"},\"yarn publish\"),\"), it will upload the \",mdx(\"inlineCode\",{parentName:\"p\"},\"src\"),`\ndirectory specifically, including both `,mdx(\"inlineCode\",{parentName:\"p\"},\"src/index.js\"),\" and \",mdx(\"inlineCode\",{parentName:\"p\"},\"src/util.js\"),` in\ntheir raw form, and tell it that the entry point is `,mdx(\"inlineCode\",{parentName:\"p\"},\"src/index.js\"),\".\"),mdx(\"p\",null,`This may still be in the \"duh, this is too simple territory\", I just wanted to\nlay the groundwork for what a `,mdx(\"inlineCode\",{parentName:\"p\"},\"npm\"),\" package can be.\"),mdx(\"h2\",null,\"Adding typescript\"),mdx(\"p\",null,\"Let's try adding typescript...run \",mdx(\"inlineCode\",{parentName:\"p\"},\"npm install --save-dev typescript\"),\" (or \",mdx(\"inlineCode\",{parentName:\"p\"},\"yarn add -D typescript\"),\")\"),mdx(\"p\",null,\"Our package.json now will have \",mdx(\"inlineCode\",{parentName:\"p\"},\"typescript\"),\" in it's \",mdx(\"inlineCode\",{parentName:\"p\"},\"devDependencies\"),` (this\nmeans that when someone installs your package, it they don't get typescript as\na dependency, it is just a dependency for while you are developing the library\nlocally).`),mdx(\"p\",null,\"Then we need to create a tsconfig.json for typescript to use\"),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{className:\"language-sh\"}),`yarn tsc --init\n# or\nnpx tsc --init\n`)),mdx(\"p\",null,`This will generate a tsconfig.json file (needed by typescript) with a bunch of\noptions, but I have stripped it down in my projects to look like this`),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{className:\"language-json\"}),`{\n  \"include\": [\"src\"],\n  \"compilerOptions\": {\n    \"declaration\": true, // generate .d.ts files\n    \"sourceMap\": true, // generate source map\n    \"outDir\": \"dist\", // output compiled js, d.ts, and source map to dist folder\n    \"moduleResolution\": \"node\",\n    \"strict\": true,\n    \"esModuleInterop\": true\n  }\n}\n`)),mdx(\"p\",null,`Now, we want to change our js to ts files to use typescript, let's change them\nto use normal ESM import/exports`),mdx(\"p\",null,\"util.ts\"),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{className:\"language-typescript\"}),`export function getMessage() {\n  return 'hello'\n}\n`)),mdx(\"p\",null,\"index.ts\"),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{className:\"language-typescript\"}),`import { getMessage } from './util'\nexport function sayMessage() {\n  console.log(getMessage())\n}\n`)),mdx(\"p\",null,\"And then we will add a \",mdx(\"inlineCode\",{parentName:\"p\"},'\"build\"'),\" script to \",mdx(\"inlineCode\",{parentName:\"p\"},\"package.json\"),` to compile the\nlibrary, and refer to the `,mdx(\"inlineCode\",{parentName:\"p\"},'\"dist\"'),\" directory for the \",mdx(\"inlineCode\",{parentName:\"p\"},'\"files\"'),\" and \",mdx(\"inlineCode\",{parentName:\"p\"},'\"main\"'),`\nfields in `,mdx(\"inlineCode\",{parentName:\"p\"},\"package.json\")),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{className:\"language-json\"}),`{\n  \"name\": \"mypackage\",\n  \"version\": \"1.0.0\",\n  \"description\": \"\",\n  \"main\": \"src/index.js\",\n  \"files\": [\"dist\"],\n  \"scripts\": {\n    \"build\": \"tsc\"\n  },\n  \"author\": \"Colin\",\n  \"license\": \"ISC\",\n  \"devDependencies\": {\n    \"typescript\": \"^4.5.4\"\n  }\n}\n`)),mdx(\"p\",null,\"We can now run\"),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{className:\"language-sh\"}),`npm run build\n# or\nyarn build\n`)),mdx(\"p\",null,'And this will run the \"build\" script we created, which in turn, just runs ',mdx(\"inlineCode\",{parentName:\"p\"},\"tsc\"),`\nwith no arguments.`),mdx(\"p\",null,`You can also add a \"prebuild\" script that clears out the old contents. In fact,\nnpm scripts generalizes the naming system pre-otherscriptname automatically\ncauses the pre- script to be run before the otherscriptname is run, and same\nthing with post. We could use `,mdx(\"inlineCode\",{parentName:\"p\"},'\"prebuild\": \"rm -rf dist\"'),` but to be\ncross-platform, we can use `,mdx(\"inlineCode\",{parentName:\"p\"},\"rimraf\"),` (a node package) instead. We can also call\nthis script \"clean\". First `,mdx(\"inlineCode\",{parentName:\"p\"},\"npm install --save-dev rimraf\"),\" or \",mdx(\"inlineCode\",{parentName:\"p\"},\"yarn add -D rimraf\"),\" and then\"),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{className:\"language-json\"}),`{\n  \"name\": \"mypackage\",\n  \"version\": \"1.0.0\",\n  \"description\": \"\",\n  \"main\": \"dist/index.js\",\n  \"files\": [\"dist\"],\n  \"scripts\": {\n    \"clean\": \"rimraf dist\",\n    \"prebuild\": \"npm run clean\",\n    \"build\": \"tsc\"\n  },\n  \"author\": \"Colin\",\n  \"license\": \"ISC\",\n  \"devDependencies\": {\n    \"rimraf\": \"^3.0.2\",\n    \"typescript\": \"^4.5.4\"\n  }\n}\n`)),mdx(\"h2\",null,\"Making sure you create a fresh build before you publish\"),mdx(\"p\",null,\"Without extra instructions, your \",mdx(\"inlineCode\",{parentName:\"p\"},\"yarn publish\"),` command would not create a\nfresh build and you could publish an older version that was lingering in the\n`,mdx(\"inlineCode\",{parentName:\"p\"},\"dist\"),\" folder.\"),mdx(\"p\",null,\"We can use a \",mdx(\"inlineCode\",{parentName:\"p\"},\"preversion\"),` script that will automatically get invoked when you\nrun `,mdx(\"inlineCode\",{parentName:\"p\"},\"yarn publish\"),\" to make sure you get a fresh build in the \",mdx(\"inlineCode\",{parentName:\"p\"},\"dist\"),` folder\nbefore you publish`),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{className:\"language-json\"}),`{\n  \"name\": \"mypackage\",\n  \"version\": \"1.0.0\",\n  \"description\": \"\",\n  \"main\": \"dist/index.js\",\n  \"files\": [\"dist\"],\n  \"scripts\": {\n    \"clean\": \"rimraf dist\",\n    \"prebuild\": \"npm run clean\",\n    \"preversion\": \"npm run build\",\n    \"build\": \"tsc\"\n  },\n  \"author\": \"Colin\",\n  \"license\": \"ISC\",\n  \"devDependencies\": {\n    \"rimraf\": \"^3.0.2\",\n    \"typescript\": \"^4.5.4\"\n  }\n}\n`)),mdx(\"h2\",null,\"Making sure you push your tag to github after publish\"),mdx(\"p\",null,\"When you run \",mdx(\"inlineCode\",{parentName:\"p\"},\"yarn publish\"),`, npm will automatically create a commit with the\nversion name and a git tag, it `,mdx(\"em\",{parentName:\"p\"},\"will not\"),` automatically push tag to your\nrepository.`),mdx(\"p\",null,\"Add a \",mdx(\"inlineCode\",{parentName:\"p\"},\"postversion\"),\" script that pushes the tag to your repo after your publish\"),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{className:\"language-json\"}),`{\n  \"name\": \"mypackage\",\n  \"version\": \"1.0.0\",\n  \"description\": \"\",\n  \"main\": \"dist/index.js\",\n  \"files\": [\"dist\"],\n  \"scripts\": {\n    \"clean\": \"rimraf dist\",\n    \"prebuild\": \"npm run clean\",\n    \"preversion\": \"npm run build\",\n    \"postversion\": \"git push --follow-tags\",\n    \"build\": \"tsc\"\n  },\n  \"author\": \"Colin\",\n  \"license\": \"ISC\",\n  \"devDependencies\": {\n    \"rimraf\": \"^3.0.2\",\n    \"typescript\": \"^4.5.4\"\n  }\n}\n`)),mdx(\"h2\",null,\"Incremental builds\"),mdx(\"p\",null,\"We can use this to do incremental/watch builds\"),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{}),`npm run build --watch\n# or\nyarn build --watch\n`)),mdx(\"h2\",null,\"Adding testing with ts-jest\"),mdx(\"p\",null,\"You can use ts-jest to test your code. This involves installing jest, typescript, ts-jest, @types/jest, and then initializing a jest.config.json\"),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{className:\"language-sh\"}),`npm i -D jest typescript\n# or\nyarn add --dev jest typescript\n`)),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{className:\"language-sh\"}),`npm i -D ts-jest @types/jest\n# or\nyarn add --dev ts-jest @types/jest\n`)),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{className:\"language-sh\"}),`npx ts-jest config:init\n# or\nyarn ts-jest config:init\n`)),mdx(\"p\",null,\"We can then create a test\"),mdx(\"p\",null,mdx(\"inlineCode\",{parentName:\"p\"},\"test/util.spec.ts\")),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{className:\"language-typescript\"}),`import { getMessage } from '../src/util'\ntest('expected message returned', () =\u003e {\n  expect(getMessage()).toBe('hello')\n})\n`)),mdx(\"p\",null,\"Then we can then create a script in the package.json that says \",mdx(\"inlineCode\",{parentName:\"p\"},'\"test\": \"jest\"'),\", and then we can say\"),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{}),`npm run test\n# or\nyarn test\n`)),mdx(\"p\",null,\"You can also create an alternative system where you use \",mdx(\"inlineCode\",{parentName:\"p\"},\"babel-eslint\"),` and\nvarious babel strategies to test your code, but if you are using typescript,\nts-jest+typescript works great.`),mdx(\"h2\",null,\"Add a .gitignore\"),mdx(\"p\",null,\"Create a .gitignore with just a line that references this \",mdx(\"inlineCode\",{parentName:\"p\"},\"dist\"),\" folder and \",mdx(\"inlineCode\",{parentName:\"p\"},\"node_modules\"),\" folder\"),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{}),`dist\nnode_modules\n`)),mdx(\"h2\",null,\"The future of ESM modules\"),mdx(\"p\",null,`There is a shift happening where modules are changing to be pure ESM rather\nthan keeping commonjs equivalents`),mdx(\"p\",null,mdx(\"a\",e({parentName:\"p\"},{href:\"https://gist.github.com/sindresorhus/a39789f98801d908bbc7ff3ecc99d99c\"}),\"https://gist.github.com/sindresorhus/a39789f98801d908bbc7ff3ecc99d99c\")),mdx(\"p\",null,`There are many challenges here, and will not be discussed, but it may be a\nuseful further reading page`))}MDXContent.isMDXComponent=!0;\n","scope":{}}},{"title":"My next.js static blog setup","date":"2021-12-26","slug":"2021-12-26-nextjs","mdxSource":{"compiledSource":"var d=Object.defineProperty,h=Object.defineProperties;var c=Object.getOwnPropertyDescriptors;var o=Object.getOwnPropertySymbols;var s=Object.prototype.hasOwnProperty,l=Object.prototype.propertyIsEnumerable;var r=(t,a,i)=\u003ea in t?d(t,a,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[a]=i,e=(t,a)=\u003e{for(var i in a||(a={}))s.call(a,i)\u0026\u0026r(t,i,a[i]);if(o)for(var i of o(a))l.call(a,i)\u0026\u0026r(t,i,a[i]);return t},p=(t,a)=\u003eh(t,c(a));var m=(t,a)=\u003e{var i={};for(var n in t)s.call(t,n)\u0026\u0026a.indexOf(n)\u003c0\u0026\u0026(i[n]=t[n]);if(t!=null\u0026\u0026o)for(var n of o(t))a.indexOf(n)\u003c0\u0026\u0026l.call(t,n)\u0026\u0026(i[n]=t[n]);return i};const layoutProps={},MDXLayout=\"wrapper\";function MDXContent(i){var n=i,{components:t}=n,a=m(n,[\"components\"]);return mdx(MDXLayout,p(e(e({},layoutProps),a),{components:t,mdxType:\"MDXLayout\"}),mdx(\"p\",null,`My personal homepage originally used statocles, a perl-based static site\ngenerator (`,mdx(\"a\",e({parentName:\"p\"},{href:\"http://preaction.me/statocles/\"}),\"http://preaction.me/statocles/\"),`). I didn't really blog using it, just\na homepage for myself plus some links to my tumblr blog. But, if I linked\npeople to the tumblr blog directly, it would give people terrible popup ads and\ntrackers. So, I switched to github pages+next.js this year. I considered a\nnumber of alternative static site systems, but next.js seemed to hit some nice\ngoals`),mdx(\"ul\",null,mdx(\"li\",{parentName:\"ul\"},\"Flexible\"),mdx(\"li\",{parentName:\"ul\"},\"React-based (as opposed to template-based like jekyll, eleventy, etc.)\"),mdx(\"li\",{parentName:\"ul\"},\"Markdown driven, and can use MDX\"),mdx(\"li\",{parentName:\"ul\"},\"RSS feed (bonus)\"),mdx(\"li\",{parentName:\"ul\"},\"Active community\")),mdx(\"p\",null,\"Other systems almost worked and were attempted but aborted\"),mdx(\"h3\",null,\"First and second iterations\"),mdx(\"p\",null,\"The first iteration of my next.js blog\"),mdx(\"ul\",null,mdx(\"li\",{parentName:\"ul\"},`I put every blog post in the \"pages\" folder. This worked ok but I had to\nmanually edit the index.mdx file to have long lists of stuff like this\n`,mdx(\"inlineCode\",{parentName:\"li\"},\"![link to new blogpost](manually_inserted_link_here)\"))),mdx(\"p\",null,`The second iteration, I wanted to automatically generate a list of recent\nblogposts from files on disk`),mdx(\"ul\",null,mdx(\"li\",{parentName:\"ul\"},mdx(\"p\",{parentName:\"li\"},`I used the next.js \"blog-template-typescript\" example folder from their\n`,mdx(\"a\",e({parentName:\"p\"},{href:\"https://github.com/vercel/next.js/tree/canary/examples/blog-starter-typescript\"}),\"monorepo\"),\".\")),mdx(\"li\",{parentName:\"ul\"},mdx(\"p\",{parentName:\"li\"},\"The new blog posts are generated from markdown files in the \",mdx(\"inlineCode\",{parentName:\"p\"},\"_posts\"),` folder,\nand get rendered by the file `,mdx(\"inlineCode\",{parentName:\"p\"},\"pages/posts/[slug].tsx\"),` (yes, the filename\nincludes square brackets).`)),mdx(\"li\",{parentName:\"ul\"},mdx(\"p\",{parentName:\"li\"},\"getAllPosts in\",mdx(\"br\",{parentName:\"p\"}),`\n`,mdx(\"a\",e({parentName:\"p\"},{href:\"https://github.com/cmdcolin/cmdcolin.github.io/blob/master/lib/api.ts\"}),mdx(\"inlineCode\",{parentName:\"a\"},\"lib/api.ts\")),`\ngets a listing of the files in `,\"_\",\"posts folder, which I can call from the \",mdx(\"inlineCode\",{parentName:\"p\"},\"getStaticProps\"),\" method on next.js pages\"))),mdx(\"h3\",null,\"Stripping off unnecessary stuff from blog-starter-typescript\"),mdx(\"p\",null,\"The \",mdx(\"inlineCode\",{parentName:\"p\"},\"blog-starter-typescript\"),` template has many tiny components, I removed some\nof them to make it easier for me to orient myself`),mdx(\"ul\",null,mdx(\"li\",{parentName:\"ul\"},mdx(\"a\",e({parentName:\"li\"},{href:\"https://github.com/vercel/next.js/tree/canary/examples/blog-starter-typescript/components\"}),\"theirs\")),mdx(\"li\",{parentName:\"ul\"},mdx(\"a\",e({parentName:\"li\"},{href:\"https://github.com/cmdcolin/cmdcolin.github.io/tree/master/components\"}),\"mine\"))),mdx(\"h3\",null,\"Removing tailwind CSS\"),mdx(\"p\",null,\"The \",mdx(\"inlineCode\",{parentName:\"p\"},\"blog-starter-typescript\"),` template uses tailwind CSS and uses \"modern web design\" (aka:\ngigantic \"tiles\" instead of links, images that are way too large, etc)`),mdx(\"p\",null,`I started making a more basic design. I tried to roll with the tailwind CSS for\na bit, but ended up removing it entirely.`),mdx(\"p\",null,\"Tailwind CSS is sort of like a CSS-in-JS system, except every CSS attribute is encoded in a CSS classname. For example, here are some tailwind CSS snippets\"),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{className:\"language-html\"}),`\u003cdiv className=\"container mx-auto px-5\"\u003e\u003c/div\u003e\n\u003cfooter className=\"bg-accent-1 border-t border-accent-2\"\u003e\u003c/footer\u003e\n\u003cdiv className=\"max-w-1xl mx-auto\"\u003e\u003c/div\u003e\n\u003cdiv className=\"min-h-screen\"\u003e\u003c/div\u003e\n\u003ca className=\"hover:underline\"\u003e\u003c/a\u003e\n\u003ch1\n  className=\"text-2xl md:text-2xl lg:text-2xl font-bold tracking-tighter leading-tight md:leading-none mb-12 text-center md:text-left\"\n\u003e\u003c/h1\u003e\n`)),mdx(\"p\",null,`They claim this is better than using external CSS (see comparison here\n`,mdx(\"a\",e({parentName:\"p\"},{href:\"https://tailwindcss.com/docs/utility-first\"}),\"https://tailwindcss.com/docs/utility-first\"),`) but it is yet another language to\nlearn, and kind of tricky.`),mdx(\"p\",null,`But, the reason I gave up with tailwind is actually because tailwind CSS resets\na lot of HTML styles so things like `,mdx(\"inlineCode\",{parentName:\"p\"},\"\u003ch1\u003e\"),\", \",mdx(\"inlineCode\",{parentName:\"p\"},\"\u003ch2\u003e\"),\", \",mdx(\"inlineCode\",{parentName:\"p\"},\"\u003cul\u003e\"),\", \",mdx(\"inlineCode\",{parentName:\"p\"},\"\u003cli\u003e\"),\", \",mdx(\"inlineCode\",{parentName:\"p\"},\"\u003ca\u003e\"),` have\nno styling at all. This is done by `,mdx(\"inlineCode\",{parentName:\"p\"},\"tailwind preflight\"),`\n`,mdx(\"a\",e({parentName:\"p\"},{href:\"https://tailwindcss.com/docs/preflight\"}),\"https://tailwindcss.com/docs/preflight\"),` (which you can disable, but it is\nenabled by default)`),mdx(\"p\",null,`Stackoverflow has some ways to help restore styling and keep preflight, but it\nstill struck me as odd. Examples`),mdx(\"ul\",null,mdx(\"li\",{parentName:\"ul\"},mdx(\"p\",{parentName:\"li\"},mdx(\"a\",e({parentName:\"p\"},{href:\"https://stackoverflow.com/a/68853223/2129219\"}),\"Example: you have to manually restore underlines on \",mdx(\"inlineCode\",{parentName:\"a\"},\"\u003ca\u003e\"),\" elements if using tailwind XSS\"))),mdx(\"li\",{parentName:\"ul\"},mdx(\"p\",{parentName:\"li\"},mdx(\"a\",e({parentName:\"p\"},{href:\"https://stackoverflow.com/questions/69264976/cant-display-markdown-on-nextjs\"}),`Another example: \"It looks like you're using TailwindCSS, the default\nstyles for elements are reset, that's why the h1 text will look like any other\ntext.\"`))),mdx(\"li\",{parentName:\"ul\"},mdx(\"p\",{parentName:\"li\"},mdx(\"a\",e({parentName:\"p\"},{href:\"https://raw.githubusercontent.com/vercel/next.js/canary/examples/blog-starter-typescript/components/markdown-styles.module.css\"}),\"Another example \",mdx(\"inlineCode\",{parentName:\"a\"},\"blog-template-typescript\"),` uses this file to try to style\nthe markdown using some general\nstyles`)))),mdx(\"p\",null,`To me it was surprising the extend that tailwind goes to unstyle the default\nbrowser styles, removing \"idiomatic HTML\" styles, so I removed tailwind for\nnow. Perhaps I'll return to it another time`),mdx(\"h2\",null,\"Using MDX for blogposts in next.js\"),mdx(\"p\",null,\"In the template from next.js team, the \",mdx(\"inlineCode\",{parentName:\"p\"},\"blog-template-typescript\"),`, it uses a\nfairly simple `,mdx(\"inlineCode\",{parentName:\"p\"},\"lib/markdownToHtml.ts\"),` function right in the\n`,mdx(\"inlineCode\",{parentName:\"p\"},\"pages/posts/[slug].tsx\"),` file (the markdown is statically pre-rendered in the\ntrue static blog sense, using the getStaticProps function). This is,\nunfortunately, over-simplified for the MDX case, because MDX properly needs to\nhydrate the components using react on the client side also`),mdx(\"p\",null,\"To fix, the module \",mdx(\"a\",e({parentName:\"p\"},{href:\"https://github.com/hashicorp/next-mdx-remote\"}),\"https://github.com/hashicorp/next-mdx-remote\"),` offers a way to\nload actual MDX files.`),mdx(\"h2\",null,\"Adding syntax highlighting the next.js code snippets\"),mdx(\"p\",null,`There are a couple results from google about how to add syntax highlighting to\nnext.js but I still found it difficult.`),mdx(\"p\",null,`My method ended up a bit different where I manually included the prism JS and\nCSS from a CDN essentially and it worked`),mdx(\"p\",null,mdx(\"a\",e({parentName:\"p\"},{href:\"https://github.com/cmdcolin/cmdcolin.github.io/blob/aa080193f45cb3e3d11ca1ead2bbd5eb2ae09633/styles/index.css#L14-L15\"}),\"https://github.com/cmdcolin/cmdcolin.github.io/blob/aa080193f45cb3e3d11ca1ead2bbd5eb2ae09633/styles/index.css#L14-L15\")),mdx(\"p\",null,mdx(\"a\",e({parentName:\"p\"},{href:\"https://github.com/cmdcolin/cmdcolin.github.io/blob/aa080193f45cb3e3d11ca1ead2bbd5eb2ae09633/pages/_document.tsx#L12-L17\"}),\"https://github.com/cmdcolin/cmdcolin.github.io/blob/aa080193f45cb3e3d11ca1ead2bbd5eb2ae09633/pages/_document.tsx#L12-L17\")),mdx(\"p\",null,`Other methods e.g. adding react-prism in next.config.js (like\n`,mdx(\"a\",e({parentName:\"p\"},{href:\"https://github.com/mikeesto/next-mdx-prism-example\"}),\"https://github.com/mikeesto/next-mdx-prism-example\"),` does) I think clashed with\nMDXRemote perhaps, or maybe I was tussling with tailwind CSS too much to make a\nclear thought out of it, but syntax blocks on my blogposts should now be\nproperly highlighted`),mdx(\"h2\",null,\"RSS feed\"),mdx(\"p\",null,`I also followed this great guide to add a RSS file for next.js\n`,mdx(\"a\",e({parentName:\"p\"},{href:\"https://ashleemboyer.com/how-i-added-an-rss-feed-to-my-nextjs-site\"}),\"https://ashleemboyer.com/how-i-added-an-rss-feed-to-my-nextjs-site\")),mdx(\"p\",null,`Link here, for your feed readers\n`,mdx(\"a\",e({parentName:\"p\"},{href:\"https://cmdcolin.github.io/rss.xml\"}),\"https://cmdcolin.github.io/rss.xml\")),mdx(\"p\",null,`Not many people may use RSS much anymore, but I do use it (via feedly), and I\nlove music blogs that keep posting on blogspot year after year, and the\noccasional programming post is nice too`))}MDXContent.isMDXComponent=!0;\n","scope":{}}},{"title":"A spooky error when you have a string bigger than 512MB in Chrome","date":"2021-10-30","slug":"2021-10-30-spooky","mdxSource":{"compiledSource":"var h=Object.defineProperty,d=Object.defineProperties;var u=Object.getOwnPropertyDescriptors;var p=Object.getOwnPropertySymbols;var r=Object.prototype.hasOwnProperty,i=Object.prototype.propertyIsEnumerable;var s=(e,t,o)=\u003et in e?h(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,a=(e,t)=\u003e{for(var o in t||(t={}))r.call(t,o)\u0026\u0026s(e,o,t[o]);if(p)for(var o of p(t))i.call(t,o)\u0026\u0026s(e,o,t[o]);return e},l=(e,t)=\u003ed(e,u(t));var c=(e,t)=\u003e{var o={};for(var n in e)r.call(e,n)\u0026\u0026t.indexOf(n)\u003c0\u0026\u0026(o[n]=e[n]);if(e!=null\u0026\u0026p)for(var n of p(e))t.indexOf(n)\u003c0\u0026\u0026i.call(e,n)\u0026\u0026(o[n]=e[n]);return o};const layoutProps={},MDXLayout=\"wrapper\";function MDXContent(o){var n=o,{components:e}=n,t=c(n,[\"components\"]);return mdx(MDXLayout,l(a(a({},layoutProps),t),{components:e,mdxType:\"MDXLayout\"}),mdx(\"p\",null,\"Now gather round for a spooky story\"),mdx(\"p\",null,`Late one night... in the haunted office space castle (hindenbugs cackling in\nthe background amongst the dusty technical books) the midnight candles were\nburning bright and we entered data for a user file`),mdx(\"p\",null,`A simple 52MB gzipped datafile that we want to process in the browser. We unzip\nit, decode it, and ...an error`),mdx(\"p\",null,\"ERROR: data not found\"),mdx(\"p\",null,mdx(\"img\",a({parentName:\"p\"},{src:\"/media/pumpkin-dark.jpg\",alt:null}))),mdx(\"p\",null,'But... our code is so simple (we of course abide by the religion of writing \"simple code\" you know)...what could be happening?'),mdx(\"p\",null,\"The code looks like this\"),mdx(\"pre\",null,mdx(\"code\",a({parentName:\"pre\"},{className:\"language-js\"}),`const buf = unzip(file)\nconst str = new TextDecoder().decode(buf)\n`)),mdx(\"p\",null,\"We trace it back and run a console.log(str)\"),mdx(\"p\",null,\"It looks empty. We try running console.log(str.length) ... it prints out 0\"),mdx(\"p\",null,\"But if we console.log(buffer.length) we get 546,483,710 bytes...\"),mdx(\"p\",null,\"What could be happening?\"),mdx(\"p\",null,'We see in the TextDecoder documentation that it has a note called \"fatal\". We try'),mdx(\"pre\",null,mdx(\"code\",a({parentName:\"pre\"},{className:\"language-js\"}),`const buf = unzip(file)\nconst str = new TextDecoder('utf8', { fatal: true }).decode(buf)\n`)),mdx(\"p\",null,\"This doesn't change the results though\"),mdx(\"p\",null,`Then it dawns on us while the lightning hits and the thunderclap booms and the\nwind blows through the rattly windows`),mdx(\"p\",null,\"We have hit...the maximum string length in Chrome\"),mdx(\"p\",null,\"BWAHAHAHAHA\"),mdx(\"p\",null,\"The maximum string length!!! Nooooooo\"),mdx(\"p\",null,\"It is 512MB on the dot... 536,870,888 bytes. We test this to be sure\"),mdx(\"pre\",null,mdx(\"code\",a({parentName:\"pre\"},{className:\"language-js\"}),`const len = 536_870_888\nconst buf = new Uint8Array(len)\nfor (let i = 0; i \u003c len; i++) {\n  buf[i] = 'a'.charCodeAt(0)\n}\nconst str = new TextDecoder().decode(buf)\nconsole.log(str.length)\n`)),mdx(\"p\",null,\"This is correct, outputs 536,870,888\"),mdx(\"p\",null,\"With anything, even one byte more, it fails and outputs 0\"),mdx(\"p\",null,\"happy halloween!!\"),mdx(\"p\",null,\"pumpkin photo source: \",mdx(\"a\",a({parentName:\"p\"},{href:\"http://mountainbikerak.blogspot.com/2010/11/google-chrome-pumpkin.html\"}),\"http://mountainbikerak.blogspot.com/2010/11/google-chrome-pumpkin.html\")),mdx(\"p\",null,\"chrome 95 tested\"),mdx(\"p\",null,\"nodejs 15 - at 512MB+1 bytes it prints an error message \",mdx(\"inlineCode\",{parentName:\"p\"},\"Error: Cannot create a string longer than 0x1fffffe8 characters\"),` for significantly greater than 512MB\ne.g. 600MB it actually prints a different error `,mdx(\"inlineCode\",{parentName:\"p\"},\"TypeError [ERR_ENCODING_INVALID_ENCODED_DATA]: The encoded data was not valid for encoding utf-8\"),\")\"),mdx(\"p\",null,'firefox 93 - goes up to ~1GB but then gives Exception { name: \"NS_ERROR_OUT_OF_MEMORY\", message: \"\", result: 2147942414'),mdx(\"p\",null,\"midori 6 (safari-alike/webkit) - goes up to ~2GB fine! will have to test more\"))}MDXContent.isMDXComponent=!0;\n","scope":{}}},{"title":"Jest parallelization, globals, mocks, and squawkless tests","date":"2021-10-05","slug":"2021-10-05-jest","mdxSource":{"compiledSource":"var p=Object.defineProperty,h=Object.defineProperties;var m=Object.getOwnPropertyDescriptors;var a=Object.getOwnPropertySymbols;var n=Object.prototype.hasOwnProperty,l=Object.prototype.propertyIsEnumerable;var i=(e,t,o)=\u003et in e?p(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,r=(e,t)=\u003e{for(var o in t||(t={}))n.call(t,o)\u0026\u0026i(e,o,t[o]);if(a)for(var o of a(t))l.call(t,o)\u0026\u0026i(e,o,t[o]);return e},c=(e,t)=\u003eh(e,m(t));var u=(e,t)=\u003e{var o={};for(var s in e)n.call(e,s)\u0026\u0026t.indexOf(s)\u003c0\u0026\u0026(o[s]=e[s]);if(e!=null\u0026\u0026a)for(var s of a(e))t.indexOf(s)\u003c0\u0026\u0026l.call(e,s)\u0026\u0026(o[s]=e[s]);return o};const layoutProps={},MDXLayout=\"wrapper\";function MDXContent(o){var s=o,{components:e}=s,t=u(s,[\"components\"]);return mdx(MDXLayout,c(r(r({},layoutProps),t),{components:e,mdxType:\"MDXLayout\"}),mdx(\"p\",null,`I found that there is a little bit of confusion and misunderstanding around how\nthings like parallelization work in jest, which sometimes leads to additional\nhacking around problems that may not exist or speculating incorrectly about\ntest failure. This is also of course a point of concern when you have code that\nfor some reason or another uses global variables. Here are a short summary of\nthings that may cause confusion.`),mdx(\"h2\",null,\"Tests in a single file are NOT run in parallel\"),mdx(\"p\",null,`Simple example, the global variable r is included in the test condition, but it\nis accurately run in all cases because the tests are not run in parallel.`),mdx(\"pre\",null,mdx(\"code\",r({parentName:\"pre\"},{className:\"language-js\"}),`let r = 0\n\nfunction timeout(ms) {\n  return new Promise(resolve =\u003e setTimeout(resolve, ms))\n}\n\ndescribe('tests', () =\u003e {\n  it('t1', async () =\u003e {\n    await timeout(1000)\n    expect(r).toBe(0)\n    r++\n  })\n  it('t2', async () =\u003e {\n    await timeout(1000)\n    expect(r).toBe(1)\n    r++\n  })\n  it('t3', async () =\u003e {\n    await timeout(1000)\n    expect(r).toBe(2)\n    r++\n  })\n})\n`)),mdx(\"p\",null,`This test will take 3 seconds, and will accurately count the global variable.\nIf it was in parallel, it may only take 1 second, and would inaccurately count\nthe global variable due to race conditions`),mdx(\"h2\",null,\"Tests in different files ARE run in parallel\"),mdx(\"p\",null,`Let's take another example where we use a global variable, and then two\ndifferent tests use the global variable.`),mdx(\"p\",null,\"file_using_some_globals.js\"),mdx(\"pre\",null,mdx(\"code\",r({parentName:\"pre\"},{className:\"language-js\"}),`let myGlobal = 0\n\nexport function doStuff() {\n  myGlobal++\n  return myGlobal\n}\n\nexport function resetMyGlobal() {\n  myGlobal = 0\n}\n\nexport function timeout(ms) {\n  return new Promise(resolve =\u003e setTimeout(resolve, ms))\n}\n`)),mdx(\"p\",null,\"test_global_vars1.test.js\"),mdx(\"pre\",null,mdx(\"code\",r({parentName:\"pre\"},{className:\"language-js\"}),`import { doStuff, timeout } from './dostuff'\ntest('file1', async () =\u003e {\n  doStuff()\n  await timeout(1000)\n  expect(doStuff()).toEqual(2)\n})\n`)),mdx(\"p\",null,\"test_global_vars2.test.js\"),mdx(\"pre\",null,mdx(\"code\",r({parentName:\"pre\"},{className:\"language-js\"}),`import { doStuff, timeout } from './dostuff'\n\ntest('file1', async () =\u003e {\n  await timeout(1000)\n  expect(doStuff()).toEqual(1)\n})\n`)),mdx(\"p\",null,`This test completes in less than 2 seconds, and these tests are run in\nparallel. They use different instances of the global state, and therefore have\nno worries with colliding their state.`),mdx(\"h2\",null,\"Does a mock from one test affect another test?\"),mdx(\"p\",null,`While seeking the fabled \"squawk-less\" test, it is often useful to mock console\nso that tests that produce an expected error don't actually print an error\nmessage. However, if not done carefully, you will remove errors across tests`),mdx(\"p\",null,`So, could a mock from one test affect another test? If it's in the same file,\nyes!`),mdx(\"p\",null,\"mock_console.test.js\"),mdx(\"pre\",null,mdx(\"code\",r({parentName:\"pre\"},{className:\"language-js\"}),`test('test1', () =\u003e {\n  console.error = jest.fn()\n  console.error('wow')\n  expect(console.error).toHaveBeenCalled()\n})\n\ntest('test2', () =\u003e {\n  // this console.error will not appear because test1 mocked away console.error\n  // without restoring it\n  console.error(\"Help I can't see!\")\n})\n`)),mdx(\"p\",null,`To properly mock these, you should restore the console mock at the end of your\nfunction`),mdx(\"pre\",null,mdx(\"code\",r({parentName:\"pre\"},{className:\"language-js\"}),`test('test1', () =\u003e {\n  const orig = console.error\n  console.error = jest.fn()\n  console.error('I should not see this!')\n  expect(console.error).toHaveBeenCalled()\n  console.error = orig\n})\n\ntest('test2', () =\u003e {\n  const consoleMock = jest.spyOn(console, 'error').mockImplementation()\n  console.error('I should not see this!')\n  consoleMock.mockRestore()\n})\n\ntest('test3', () =\u003e {\n  console.error('I should see this error!')\n})\n`)),mdx(\"h2\",null,\"Add-on: Achieve squawkless tests!\"),mdx(\"p\",null,`Your test output should just be a big list of PASS statements, not interleaved\nwith console.error outputs from when you are testing error conditions of your\ncode`),mdx(\"p\",null,`\"Squawkless tests\" is a term I made up, but it means that if you have code\nunder test that prints some errors to the console, then mock the console.error\nfunction, as in the previous section. Don't stand for having a bunch of verbose\nerrors in your CI logs! However, I also suggest only mocking out console.error\nfor tests that are `,mdx(\"strong\",{parentName:\"p\"},\"expected\"),` to have errors, lest you paper over unexpected\nerrors.`),mdx(\"p\",null,mdx(\"img\",r({parentName:\"p\"},{src:\"/media/squawkless_tests.png\",alt:null}))),mdx(\"p\",null,\"Figure: a nice clean test suite without a bunch of crazy console.error outputs\"),mdx(\"h2\",null,\"Conclusion\"),mdx(\"p\",null,`Getting better at testing requires exercise, and understanding the basics of\nyour tools can help! Hopefully this helps you achieve a better understanding\nand write cleaner jest tests.`))}MDXContent.isMDXComponent=!0;\n","scope":{}}},{"title":"Decrease your idle CPU usage when developing typescript apps with this one weird environment variable","date":"2021-09-05","slug":"2021-09-05-typescript","mdxSource":{"compiledSource":"var l=Object.defineProperty,u=Object.defineProperties;var m=Object.getOwnPropertyDescriptors;var o=Object.getOwnPropertySymbols;var n=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable;var p=(e,t,s)=\u003et in e?l(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s,i=(e,t)=\u003e{for(var s in t||(t={}))n.call(t,s)\u0026\u0026p(e,s,t[s]);if(o)for(var s of o(t))r.call(t,s)\u0026\u0026p(e,s,t[s]);return e},h=(e,t)=\u003eu(e,m(t));var c=(e,t)=\u003e{var s={};for(var a in e)n.call(e,a)\u0026\u0026t.indexOf(a)\u003c0\u0026\u0026(s[a]=e[a]);if(e!=null\u0026\u0026o)for(var a of o(e))t.indexOf(a)\u003c0\u0026\u0026r.call(e,a)\u0026\u0026(s[a]=e[a]);return s};const layoutProps={},MDXLayout=\"wrapper\";function MDXContent(s){var a=s,{components:e}=a,t=c(a,[\"components\"]);return mdx(MDXLayout,h(i(i({},layoutProps),t),{components:e,mdxType:\"MDXLayout\"}),mdx(\"p\",null,\"TL;DR:\"),mdx(\"p\",null,\"add this to your bashrc\"),mdx(\"pre\",null,mdx(\"code\",i({parentName:\"pre\"},{}),`export TSC_WATCHFILE=UseFsEventsWithFallbackDynamicPolling\n`)),mdx(\"hr\",null),mdx(\"p\",null,`By default, the typescript watcher configuration e.g. tsc --watch or whatever\nis run internally to a create-react-app typescript app (I see it in the process\nmanager as fork-ts-checker-webpack-plugin cpu usage) can have high idling\n(doing nothing...) CPU usage`),mdx(\"p\",null,`This is because the default configuration polls for file changes (constantly\nasks the computer if there are changes every 250ms or so). There is an\nalternative configuration for this to change it to a file watcher so it\nreceives file system notifications on file change. There is discussion here on\nthis.`),mdx(\"p\",null,`The main summary is that a env variable set to\nTSC_WATCHFILE=UseFsEventsWithFallbackDynamicPolling allows this`),mdx(\"p\",null,mdx(\"a\",i({parentName:\"p\"},{href:\"https://github.com/microsoft/TypeScript/issues/31048\"}),\"https://github.com/microsoft/TypeScript/issues/31048\")),mdx(\"p\",null,`The issue thread shows that it can go from roughly ~7% idle CPU usage to 0.2%.\nThis corresponds with what I see too after applying this! Detailed docs for\ntypescript discuss some of the reasoning behing not making this the default`),mdx(\"p\",null,mdx(\"a\",i({parentName:\"p\"},{href:\"https://github.com/microsoft/TypeScript-Handbook/blob/master/pages/Configuring%20Watch.md#background\"}),\"https://github.com/microsoft/TypeScript-Handbook/blob/master/pages/Configuring%20Watch.md#background\")),mdx(\"p\",null,`It claims that some OS specific behaviors of file watching could be harmful to\nmaking it the default. For example, that (maybe?) on linux, it may use a large\nnumber of file watchers which can exceed notify handles (this is a setting I\ncommonly have to increase in linux, guide here\n`,mdx(\"a\",i({parentName:\"p\"},{href:\"https://dev.to/rubiin/ubuntu-increase-inotify-watcher-file-watch-limit-kf4\"}),\"https://dev.to/rubiin/ubuntu-increase-inotify-watcher-file-watch-limit-kf4\"),\")\"),mdx(\"p\",null,\"PS: if you have a package.json of a \",mdx(\"inlineCode\",{parentName:\"p\"},\"create-react-app --template typescript\"),` or\nsomething like this then you can edit the package.json to apply this\nautomatically`),mdx(\"pre\",null,mdx(\"code\",i({parentName:\"pre\"},{}),`-\"start\": \"react-scripts start\"\n+\"start\": \"cross-env TSC_WATCHFILE=UseFsEventsWithFallbackDynamicPolling react-scripts start\"\n`)),mdx(\"p\",null,`Phew. I can already feel my laptop running cooler...or at least I can sleep\nmore soundly knowing that my readers adopt this and save some CPU cycles for\nplanet earth...and hopefully don't run into any of the caveats`),mdx(\"p\",null,`Edit: It may be worth it to note, the 'UseFsEvents' part of this uses the\nnode.js fs.watch API and the polling based API is based on fs.watchFile`),mdx(\"p\",null,`Fun table of how the watchers are implemented on different OSs\n[`,mdx(\"a\",i({parentName:\"p\"},{href:\"https://github.com/microsoft/TypeScript/issues/31048#issuecomment-495483957\"}),\"1\"),\"]\"),mdx(\"pre\",null,mdx(\"code\",i({parentName:\"pre\"},{}),`On Linux systems, this uses inotify(7).\nOn BSD systems, this uses kqueue(2).\nOn macOS, this uses kqueue(2) for files and FSEvents for directories.\nOn SunOS systems (including Solaris and SmartOS), this uses event ports.\nOn Windows systems, this feature depends on ReadDirectoryChangesW.\nOn Aix systems, this feature depends on AHAFS, which must be enabled.\n`)),mdx(\"p\",null,`And in general, these should all respond more or less the same, but there are\nsmall corner cases that are discussed\n`,mdx(\"a\",i({parentName:\"p\"},{href:\"https://nodejs.org/docs/latest/api/fs.html#fs_availability\"}),\"https://nodejs.org/docs/latest/api/fs.html#fs_availability\")),mdx(\"p\",null,`Disclaimer: it may be worth reading the reasons that typescript does not have\nthis enabled by default before pushing this into your dev environment and all\nyour teammates, but as far as I could tell, it seems ok!`))}MDXContent.isMDXComponent=!0;\n","scope":{}}},{"title":"An amazing error message if you put more than 2^24 items in a JS Map object","date":"2021-08-15","slug":"2021-08-15-map-limit","mdxSource":{"compiledSource":"var l=Object.defineProperty,d=Object.defineProperties;var u=Object.getOwnPropertyDescriptors;var s=Object.getOwnPropertySymbols;var r=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable;var m=(e,t,a)=\u003et in e?l(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,o=(e,t)=\u003e{for(var a in t||(t={}))r.call(t,a)\u0026\u0026m(e,a,t[a]);if(s)for(var a of s(t))n.call(t,a)\u0026\u0026m(e,a,t[a]);return e},h=(e,t)=\u003ed(e,u(t));var p=(e,t)=\u003e{var a={};for(var i in e)r.call(e,i)\u0026\u0026t.indexOf(i)\u003c0\u0026\u0026(a[i]=e[i]);if(e!=null\u0026\u0026s)for(var i of s(e))t.indexOf(i)\u003c0\u0026\u0026n.call(e,i)\u0026\u0026(a[i]=e[i]);return a};const layoutProps={},MDXLayout=\"wrapper\";function MDXContent(a){var i=a,{components:e}=i,t=p(i,[\"components\"]);return mdx(MDXLayout,h(o(o({},layoutProps),t),{components:e,mdxType:\"MDXLayout\"}),mdx(\"p\",null,`One of the fun things about working with big data is that you can often hit\nweird limits with a system.`),mdx(\"p\",null,`I was personally trying to load every 'common' single nucleotide polymorphism\nfor the human genome into memory (dbSNP), of which there are over 37 million\nentries (there are many more uncommon ones) for the purposes of making a custom\nsearch index for them `,\"[1]\",\".\"),mdx(\"p\",null,`Turns out, you may run into some hard limits. Note that these are all V8-isms\nand may not apply to all browsers or engines (I was using node.js for this)`),mdx(\"pre\",null,mdx(\"code\",o({parentName:\"pre\"},{}),`const myObject = new Map();\nfor (let i = 0; i \u003c= 50_000_000; i++) {\n  myObject.set(i,i);\n  if(i%100000==0) { console.log(i) }\n}\n`)),mdx(\"p\",null,\"This will crash after adding approx 16.7M elements and say\"),mdx(\"pre\",null,mdx(\"code\",o({parentName:\"pre\"},{}),`0\n100000\n200000\n...\n16400000\n16500000\n16600000\n16700000\n\nUncaught RangeError: Value undefined out of range for undefined options\nproperty undefined\n`)),mdx(\"p\",null,`That is a very weird error message. It says \\u201Cundefined\\u201D three times! Much\nbetter than your usual \\u201CTypeError: Can\\u2019t find property \\u2018lol\\u2019 of undefined\\u201D. See\n`,mdx(\"a\",o({parentName:\"p\"},{href:\"https://bugs.chromium.org/p/v8/issues/detail?id=11852\"}),\"https://bugs.chromium.org/p/v8/issues/detail?id=11852\"),` for a bug filed to help\nimprove the error message perhaps.`),mdx(\"p\",null,\"Now, also interestingly enough, if you use an Object instead of a Map\"),mdx(\"pre\",null,mdx(\"code\",o({parentName:\"pre\"},{className:\"language-js\"}),`const myObject = {};\nfor (let i = 0; i \u003c= 50_000_000; i++) {\n  myObject['myobj_\\u2019+i]=i;\n  if(i%100000==0) { console.log(i) }\n}\n`)),mdx(\"p\",null,\"Then it will print\\u2026.\"),mdx(\"pre\",null,mdx(\"code\",o({parentName:\"pre\"},{}),`0\n100000\n200000\n...\n8000000\n8100000\n8200000\n8300000\n`)),mdx(\"p\",null,`And it will actually just hang there\\u2026frozen\\u2026no error message though! And it is\nfailing at ~8.3M elements. Weird right? This is roughly half the amount of\nelements as the 16.7M case`),mdx(\"p\",null,\"Turns out there is a precise hard limit for the Map case\"),mdx(\"p\",null,\"For the Map: 2^24=16,777,216\"),mdx(\"p\",null,`For the Object it is around 2^23=8,388,608 HOWEVER, I can actually add more\nthan this, e.g. I can add 8,388,609 or 8,388,610 or even more, but the\noperations start taking forever to run, e.g. 8,388,999 was taking many minutes`),mdx(\"p\",null,`Very weird stuff! If you expected me to dig into this and explain it in deep\ntechnical detail, well, you\\u2019d be wrong. I am lazy. However, this helpful post\non stackoverflow by a V8 js engine developer clarifies the Map case!!\n`,mdx(\"a\",o({parentName:\"p\"},{href:\"https://stackoverflow.com/questions/54452896/maximum-number-of-entries-in-node-js-map\"}),\"https://stackoverflow.com/questions/54452896/maximum-number-of-entries-in-node-js-map\")),mdx(\"pre\",null,mdx(\"code\",o({parentName:\"pre\"},{}),`V8 developer here. I can confirm that 2^24 is the maximum number of entries in\na Map. That\\u2019s not a bug, it\\u2019s just the implementation-defined limit.\n\nThe limit is determined by:\n\nThe FixedArray backing store of the Map has a maximum size of 1GB (independent\nof the overall heap size limit) On a 64-bit system that means 1GB / 8B = 2^30 /\n2^3 = 2^27 ~= 134M maximum elements per FixedArray A Map needs 3 elements per\nentry (key, value, next bucket link), and has a maximum load factor of 50% (to\navoid the slowdown caused by many bucket collisions), and its capacity must be\na power of 2. 2^27 / (3 * 2) rounded down to the next power of 2 is 2^24, which\nis the limit you observe.  FWIW, there are limits to everything: besides the\nmaximum heap size, there\\u2019s a maximum String length, a maximum Array length, a\nmaximum ArrayBuffer length, a maximum BigInt size, a maximum stack size, etc.\nAny one of those limits is potentially debatable, and sometimes it makes sense\nto raise them, but the limits as such will remain. Off the top of my head I\ndon\\u2019t know what it would take to bump this particular limit by, say, a factor\nof two \\u2013 and I also don\\u2019t know whether a factor of two would be enough to\nsatisfy your expectations.\n\n`)),mdx(\"p\",null,`Great details there. It would also be good to know what the behavior is for the\nObject, which has those 100% CPU stalls after ~8.3M, but not the same error\nmessage...`),mdx(\"p\",null,`Another fun note: if I modify the Object code to use only \\u201Cinteger IDs\\u201D the\ncode actually works fine, does not hit any errors, and is \\u201Cblazingly fast\\u201D as\nthe kids call it`),mdx(\"pre\",null,mdx(\"code\",o({parentName:\"pre\"},{className:\"language-js\"}),`const myObject = {}\nfor (let i = 0; i \u003c= 50_000_000; i++) {\n  myObject[i] = i\n  if (i % 100000 == 0) {\n    console.log(i)\n  }\n}\n`)),mdx(\"p\",null,`I presume that this code works because it detects that I\\u2019m using it like an\narray and it decides to transform how it is working internally and not use a\nhash-map-style data structure, so does not hit a limit. There is a slightly\nhigher limit though, e.g. 1 billion elements gives \\u201CUncaught RangeError:\nInvalid array length\\u201D`),mdx(\"pre\",null,mdx(\"code\",o({parentName:\"pre\"},{className:\"language-js\"}),`const myObject = {}\nfor (let i = 0; i \u003c= 1_000_000_000; i++) {\n  myObject[i] = i\n  if (i % 100000 == 0) {\n    console.log(i)\n  }\n}\n`)),mdx(\"p\",null,`This has been another episode of ....the twilight zone (other episodes\ncatalogued here) `,mdx(\"a\",o({parentName:\"p\"},{href:\"https://github.com/cmdcolin/technical_oddities/\"}),\"https://github.com/cmdcolin/technical_oddities/\")),mdx(\"p\",null,\"[1]\",` The final product of this adventure was this, to create a search index for\na large number of elements `,mdx(\"a\",o({parentName:\"p\"},{href:\"https://github.com/GMOD/ixixx-js\"}),\"https://github.com/GMOD/ixixx-js\")))}MDXContent.isMDXComponent=!0;\n","scope":{}}},{"title":"Do you understand your NPM dependencies?","date":"2021-07-27","slug":"2021-07-27-npm-dependencies","mdxSource":{"compiledSource":"var y=Object.defineProperty,m=Object.defineProperties;var d=Object.getOwnPropertyDescriptors;var n=Object.getOwnPropertySymbols;var t=Object.prototype.hasOwnProperty,l=Object.prototype.propertyIsEnumerable;var u=(e,a,o)=\u003ea in e?y(e,a,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[a]=o,r=(e,a)=\u003e{for(var o in a||(a={}))t.call(a,o)\u0026\u0026u(e,o,a[o]);if(n)for(var o of n(a))l.call(a,o)\u0026\u0026u(e,o,a[o]);return e},s=(e,a)=\u003em(e,d(a));var p=(e,a)=\u003e{var o={};for(var i in e)t.call(e,i)\u0026\u0026a.indexOf(i)\u003c0\u0026\u0026(o[i]=e[i]);if(e!=null\u0026\u0026n)for(var i of n(e))a.indexOf(i)\u003c0\u0026\u0026l.call(e,i)\u0026\u0026(o[i]=e[i]);return o};const layoutProps={},MDXLayout=\"wrapper\";function MDXContent(o){var i=o,{components:e}=i,a=p(i,[\"components\"]);return mdx(MDXLayout,s(r(r({},layoutProps),a),{components:e,mdxType:\"MDXLayout\"}),mdx(\"p\",null,`You are writing a library...or your writing an app and you want to publish some\nof the components of it as a library...`),mdx(\"p\",null,\"Here are some questions in the form of comments\"),mdx(\"ul\",null,mdx(\"li\",{parentName:\"ul\"},mdx(\"p\",{parentName:\"li\"},`Did you realize that your yarn.lock will be ignored for anyone who installs\nyour libraries?`)),mdx(\"li\",{parentName:\"ul\"},mdx(\"p\",{parentName:\"li\"},`Did you realize this means that your perfectly running test suite with your\nyarn.lock could be a failing case for consumers of your app unless you don\\u2019t\nuse semver strings like ^1.0.0 and just hardcode it to 1.0.0?`)),mdx(\"li\",{parentName:\"ul\"},mdx(\"p\",{parentName:\"li\"},`Did you realize the default of ^1.0.0 automatically gets minor version bumps\nwhich are often fairly substantial changes, e.g. even breaking possibly?`)),mdx(\"li\",{parentName:\"ul\"},mdx(\"p\",{parentName:\"li\"},`Did you know that larger libraries like @material-ui/core don\\u2019t like to bump\ntheir major version all the time for example so large changes are often made\nto the minor version?`)),mdx(\"li\",{parentName:\"ul\"},mdx(\"p\",{parentName:\"li\"},\"Did you know if you run \",mdx(\"inlineCode\",{parentName:\"p\"},\"yarn upgrade\"),\", it may update what is in your yarn.lock file but will not update what is in your package.json?\")),mdx(\"li\",{parentName:\"ul\"},mdx(\"p\",{parentName:\"li\"},\"Did you realize that this means that if you depend on the results of running \",mdx(\"inlineCode\",{parentName:\"p\"},\"yarn upgrade\"),\" e.g. it gave you a bugfix, you will be shipping buggy code to consumers of your library?\"))),mdx(\"p\",null,`Just something to be aware of! You can always ride the dragon and accept these\nminor breakages from semver bumps, but it can introduce some issues for your\nconsumers`),mdx(\"p\",null,`Random fun thing: Adding a yarn package can even downgrade some other packages.\nFor example if you have ^6.0.0 in your package.json, you yarn upgrade it up to\n^6.1.0 but then later install another library that requires a hard 6.0.1, yarn\nwill decide to downgrade you to 6.0.1`))}MDXContent.isMDXComponent=!0;\n","scope":{}}},{"title":"Making a HTTPS accessible S3 powered static site with CloudFront+route 53","date":"2020-12-26","slug":"2020-12-26-pt2","mdxSource":{"compiledSource":"var l=Object.defineProperty,m=Object.defineProperties;var c=Object.getOwnPropertyDescriptors;var n=Object.getOwnPropertySymbols;var r=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable;var p=(e,t,o)=\u003et in e?l(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,i=(e,t)=\u003e{for(var o in t||(t={}))r.call(t,o)\u0026\u0026p(e,o,t[o]);if(n)for(var o of n(t))s.call(t,o)\u0026\u0026p(e,o,t[o]);return e},u=(e,t)=\u003em(e,c(t));var d=(e,t)=\u003e{var o={};for(var a in e)r.call(e,a)\u0026\u0026t.indexOf(a)\u003c0\u0026\u0026(o[a]=e[a]);if(e!=null\u0026\u0026n)for(var a of n(e))t.indexOf(a)\u003c0\u0026\u0026s.call(e,a)\u0026\u0026(o[a]=e[a]);return o};const layoutProps={},MDXLayout=\"wrapper\";function MDXContent(o){var a=o,{components:e}=a,t=d(a,[\"components\"]);return mdx(MDXLayout,u(i(i({},layoutProps),t),{components:e,mdxType:\"MDXLayout\"}),mdx(\"p\",null,`This is not a very authoritative post because I stumbled though this but\nI think I got it working now on my website :)`),mdx(\"h2\",null,\"Setup your S3 bucket\"),mdx(\"p\",null,`First setup your S3 bucket, your bucket must be named yourdomain.com\ne.g. named after your domain`),mdx(\"p\",null,`Then if you have a create-react-app setup I add a script in package.json\nthat runs`),mdx(\"pre\",null,mdx(\"code\",i({parentName:\"pre\"},{}),` \"predeploy\": \"npm run build\",\n \"deploy\": \"aws sync --delete build s3://yourdomain.com\"\n`)),mdx(\"p\",null,`Then we can run \"yarn deploy\" and it will automatically upload our\ncreate-react-app website to our S3 static site bucket.`),mdx(\"p\",null,`Then make sure your bucket has public permissions enabled\n`,mdx(\"a\",i({parentName:\"p\"},{href:\"https://docs.aws.amazon.com/AmazonS3/latest/dev/example-bucket-policies.html#example-bucket-policies-use-case-2\"}),\"https://docs.aws.amazon.com/AmazonS3/latest/dev/example-bucket-policies.html#example-bucket-policies-use-case-2\"),`Then\nmake sure your bucket has \"static site hosting\" enabled too`),mdx(\"h2\",null,\"Setup route 53, and make your NS entries in domains.google.com\"),mdx(\"p\",null,\"I bought a domain with domains.google.com\"),mdx(\"p\",null,\"Google then emailed me to validate my ownership\"),mdx(\"p\",null,\"Then I went to aws.amazon.com route 53\\xA0and I created a hosted zone\"),mdx(\"p\",null,`This generated 4 name server entries and I added those to the\ndomains.google.com site`),mdx(\"p\",null,mdx(\"img\",i({parentName:\"p\"},{src:\"/media/638618421776515072_0.png\",alt:null}))),mdx(\"p\",null,`Screenshot shows copying the NS values from route 53 to the name servers\narea of domains.google.com`),mdx(\"h2\",null,\"Setup your Amazon certificate for making SSL work on CloudFront\"),mdx(\"p\",null,`To properly setup However, this does not work so you need to go to\nAmazon Certificates-\u003eProvision certificates`),mdx(\"p\",null,\"We request the certificate for\"),mdx(\"p\",null,mdx(\"a\",i({parentName:\"p\"},{href:\"http://www.yourdomain.com\"}),\"www.yourdomain.com\"),`\nyourdomain.com`),mdx(\"p\",null,`Then it generates some codes for a CNAME value for each of those two\nentries, and has a button to autoimport those CNAME values to route53`),mdx(\"p\",null,`Then it will say\\xA0\"Pending validation\"...I waited like an hour and then\nit changed to\\xA0\"Success\".`),mdx(\"p\",null,mdx(\"img\",i({parentName:\"p\"},{src:\"/media/638618421776515072_1.png\",alt:null}))),mdx(\"p\",null,`Screenshot shows the now successful Amazon Certificate. After you get\nthis, you can proceed to finishing your cloudfront`),mdx(\"h2\",null,'Create a CloudFront distribution and add \"Alternative CNAME\" entries for your domain'),mdx(\"p\",null,`Then we can update our CloudFront distribution and add these to\nthe\\xA0\"Alternative CNAME\" input box`),mdx(\"p\",null,`yourdomain.com\n`,mdx(\"a\",i({parentName:\"p\"},{href:\"http://www.yourdomain.com\"}),\"www.yourdomain.com\")),mdx(\"p\",null,`Note also that I first generated my certificate in us-east-2 but the\n\"Import certificate form\" in cloudfront said I had to create it in\nus-east-1`),mdx(\"p\",null,mdx(\"img\",i({parentName:\"p\"},{src:\"/media/638618421776515072_2.png\",alt:null}))),mdx(\"h2\",null,\"Add a default object index.html to the CloudFront setting\"),mdx(\"p\",null,'Make your CloudFront\\xA0\"default object\" is index.html'),mdx(\"p\",null,\"You have to manually type this in :)\"),mdx(\"h2\",null,\"Add the CloudFront distribution to your Route 53\"),mdx(\"p\",null,`Add a Route 53 \"A\" record that points to the CloudFront domain name e.g.\nd897d897d87d98dd.cloudfront.net`),mdx(\"h2\",null,\"Summary of steps needed\"),mdx(\"p\",null,\"The general hindsight 20/20 procedure is\"),mdx(\"ol\",null,mdx(\"li\",{parentName:\"ol\"},`Upload your static content to an S3 bucket called yoursite.com (must\nbe your domain name)`),mdx(\"li\",{parentName:\"ol\"},`Make your S3 bucket have the \"static website\" setting on in the\nproperties menu and add a permissions policy that supports getObject\ne.g.\\xA0`,mdx(\"a\",i({parentName:\"li\"},{href:\"https://docs.aws.amazon.com/AmazonS3/latest/dev/example-bucket-policies.html#example-bucket-policies-use-case-2\"}),\"https://docs.aws.amazon.com/AmazonS3/latest/dev/example-bucket-policies.html#example-bucket-policies-use-case-2\")),mdx(\"li\",{parentName:\"ol\"},\"Create a CloudFront distribution for your website\"),mdx(\"li\",{parentName:\"ol\"},\"Make the CloudFront default object index.html\"),mdx(\"li\",{parentName:\"ol\"},\"Create your domain with domains.google.com or similar\"),mdx(\"li\",{parentName:\"ol\"},\"Point the google domain's name server to Route 53 NS list from AWS\"),mdx(\"li\",{parentName:\"ol\"},`Add Route 53 A records that point to the CloudFront domain name e.g.\nd897d897d87d98dd.cloudfront.net`),mdx(\"li\",{parentName:\"ol\"},`Create Amazon issued certificate for yourdomain.com, which can\nauto-import a validation CNAME to your Route 53`),mdx(\"li\",{parentName:\"ol\"},`Make your CloudFront domain support your Alternative CNAME's e.g.\nyourdomain.com which requires importing (e.g. selecting from a list\nthat they auto-populate) your Amazon-issued-certificate`)),mdx(\"h2\",null,\"Troubleshooting and notes\"),mdx(\"p\",null,`Problem: Your website gives 403 CloudFlare error\nSolution: You have to get the Alternateive CNAME configuration setup\n(pre-step involves the certificate request and validation)`),mdx(\"p\",null,`Problem: Your website gives an object not found error\nSolution: Set the CloudFront \"default object\" to index.html`),mdx(\"h2\",null,\"Random comment\"),mdx(\"p\",null,`This is one of those processes (creating the cloudfront/route 53) that\nprobably could have done with the aws-sam CLI and it would have possibly\nbeen easier, it is quite fiddly doing all these steps in the web\ninterface`))}MDXContent.isMDXComponent=!0;\n","scope":{}}}]},"__N_SSG":true},"page":"/","query":{},"buildId":"XVI_xbkv25tCu5jHUrItP","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>