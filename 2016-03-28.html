<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a40ef1678bae11e696dba45124eadd70.js"></script><script src="/_next/static/chunks/webpack-7c4c4c05609ee1ee2453.js" defer=""></script><script src="/_next/static/chunks/framework-7915ac2dcad08ccffd1a.js" defer=""></script><script src="/_next/static/chunks/main-d0187c47f4d0d1b19d72.js" defer=""></script><script src="/_next/static/chunks/pages/_app-51f94a4fd678a8c1801c.js" defer=""></script><script src="/_next/static/chunks/pages/2016-03-28-5c7cbfb607ac0daddd20.js" defer=""></script><script src="/_next/static/ir3stmELHQRvEOT9d_k92/_buildManifest.js" defer=""></script><script src="/_next/static/ir3stmELHQRvEOT9d_k92/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div><a href="/">Return home</a><div style="margin:0 auto;width:75%"><h1>Running nginx on containerised travis-CI pt 2</h1><p>There are several guides out there about how to setup nginx on travis-CI
but I still found it to be a challenge, especially finding a modern one
that works with the containerized builds. I was frustrated that things
like SimpleHTTPServer from python and http-server from npm did not have
fully enough features to run our app either (a complex &quot;static-site
generator&quot; type thing you might say), and I was also too lazy to setup
&quot;sauce labs&quot; (which I have not used, but presume has some better ability
to run functional/browser tests).</p><p>Essentially, the problem with running nginx under the containerized
build is that it &quot;likes to be sudo&quot;, with many logfiles by default going
to different places that only sudo has access to.</p><p>This link is probably the most similar to the technique I use here, but
it is now gone (?) and must be accessed through the internet archive!</p><p><a href="http://www.doublesignal.com/running-nginx-on-containerised-travis-ci"></a><a href="https://web.archive.org/web/20150919050719/http://www.doublesignal.com/running-nginx-on-containerised-travis-ci">https://web.archive.org/web/20150919050719/http://www.doublesignal.com/running-nginx-on-containerised-travis-ci</a></p><p>My technique is very similar, however I use an extra trick to set the
file root to the current directory (instead of /tmp/nowhere as in the
link) by using &quot;envsubst&quot; to replace variables in the nginx config file.</p><p>Without further ado, the .travis.yml can look like this</p><pre><code>sudo: false
addons:
  apt:
    packages:
    - nginx
install:
  - cat tests/travis.conf | envsubst &gt; tests/travis-envsubst.conf
  - nginx -c `pwd`/tests/travis-envsubst.conf
script:
  - wget http://localhost:9000/yourfiles
</code></pre><p>Then your nginx config file can look like this</p><pre><code>worker_processes 10;
pid /tmp/nginx.pid;

error_log /tmp/error.log;

events {
    worker_connections 768;
}

http {
    client_body_temp_path /tmp/nginx_client_body;
    fastcgi_temp_path     /tmp/nginx_fastcgi_temp;
    proxy_temp_path       /tmp/nginx_proxy_temp;
    scgi_temp_path        /tmp/nginx_scgi_temp;
    uwsgi_temp_path       /tmp/nginx_uwsgi_temp;

    server {
        listen 9000 default_server;

        server_name localhost;
        location / {
            root $TRAVIS_BUILD_DIR;
            index  index.html index.htm;
        }
        error_log /tmp/error.log;
        access_log /tmp/access.log;
    }
}
</code></pre><p>Then, when travis-CI is run, it uses envsubst to replace
\$TRAVIS<!-- -->_<!-- -->BUILD<!-- -->_<!-- -->DIR in the tests/travis.conf file, and then boots up
nginx</p><p>::: {#footer}
<!-- -->[ March 28th, 2016 4:56pm ]<!-- -->{#timestamp} <!-- -->[nginx]<!-- -->{.tag} <!-- -->[travisci]<!-- -->{.tag}
<!-- -->[software]<!-- -->{.tag}
:::</p></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/2016-03-28","query":{},"buildId":"ir3stmELHQRvEOT9d_k92","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>