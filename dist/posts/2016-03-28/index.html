<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="description" content="Astro description"><meta name="viewport" content="width=device-width"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v4.16.19"><title>Running nginx on containerised travis-CI pt 2</title><style>body{font-family:Helvetica,Arial,sans-serif;background-color:Canvas;color:CanvasText;color-scheme:light dark}img{max-width:100%}pre{max-width:100%;overflow:auto}li+li{margin-top:10px}pre{padding:10px;border-radius:5px}
</style></head> <body> <div class="mb-8"> <a href="/">Misc scribbles</a> </div>  <h1>Running nginx on containerised travis-CI pt 2</h1> <p>2016-03-28</p> <p>There are several guides out there about how to setup nginx on travis-CI but I
still found it to be a challenge, especially finding a modern one that works
with the containerized builds. I was frustrated that things like
<code>SimpleHTTPServer</code> from python and http-server from npm did not have fully
enough features to run our app either (a complex “static-site generator” type
thing you might say), and I was also too lazy to setup “sauce labs” (which I
have not used, but presume has some better ability to run functional/browser
tests).</p>
<p>Essentially, the problem with running nginx under the containerized build is
that it “likes to be sudo”, with many logfiles by default going to different
places that only sudo has access to.</p>
<p>This link is probably the most similar to the technique I use here, but it is
now gone (?) and must be accessed through the internet archive!</p>
<p><a href="https://web.archive.org/web/20150919050719/http://www.doublesignal.com/running-nginx-on-containerised-travis-ci">http://www.doublesignal.com/running-nginx-on-containerised-travis-ci</a></p>
<p>My technique is very similar, however I use an extra trick to set the file root
to the current directory (instead of /tmp/nowhere as in the link) by using
“envsubst” to replace variables in the nginx config file.</p>
<p>Without further ado, the .travis.yml can look like this</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="yaml"><code><span class="line"><span style="color:#85E89D">sudo</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">false</span></span>
<span class="line"><span style="color:#85E89D">addons</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">  apt</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">    packages</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">      - </span><span style="color:#9ECBFF">nginx</span></span>
<span class="line"><span style="color:#85E89D">install</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">  - </span><span style="color:#9ECBFF">cat tests/travis.conf | envsubst > tests/travis-envsubst.conf</span></span>
<span class="line"><span style="color:#E1E4E8">  - </span><span style="color:#9ECBFF">nginx -c `pwd`/tests/travis-envsubst.conf</span></span>
<span class="line"><span style="color:#85E89D">script</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">  - </span><span style="color:#9ECBFF">wget http://localhost:9000/yourfiles</span></span>
<span class="line"></span></code></pre>
<p>Then your nginx config file can look like this</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>    worker_processes 10;</span></span>
<span class="line"><span>    pid /tmp/nginx.pid;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    error_log /tmp/error.log;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    events {</span></span>
<span class="line"><span>        worker_connections 768;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    http {</span></span>
<span class="line"><span>        client_body_temp_path /tmp/nginx_client_body;</span></span>
<span class="line"><span>        fastcgi_temp_path     /tmp/nginx_fastcgi_temp;</span></span>
<span class="line"><span>        proxy_temp_path       /tmp/nginx_proxy_temp;</span></span>
<span class="line"><span>        scgi_temp_path        /tmp/nginx_scgi_temp;</span></span>
<span class="line"><span>        uwsgi_temp_path       /tmp/nginx_uwsgi_temp;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        server {</span></span>
<span class="line"><span>            listen 9000 default_server;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>            server_name localhost;</span></span>
<span class="line"><span>            location / {</span></span>
<span class="line"><span>                root $TRAVIS_BUILD_DIR;</span></span>
<span class="line"><span>                index  index.html index.htm;</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>            error_log /tmp/error.log;</span></span>
<span class="line"><span>            access_log /tmp/access.log;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span></code></pre>
<p>Then, when travis-CI is run, it uses envsubst to replace <code>$TRAVIS_BUILD_DIR</code> in
the <code>tests/travis.conf</code> file, and then boots up nginx</p>  <footer class="mt-16"> <a class="m-2" href="/">Home</a> <a class="m-2" href="/archive">Blog archive</a> <a class="m-2" href="https://github.com/cmdcolin/">Github</a> <a class="m-2" href="/projects">Projects</a> <a class="m-2" href="/books">Books</a> <a class="m-2" href="/about">About</a> <a class="m-2" href="/rss.xml">RSS</a> </footer> </body></html>