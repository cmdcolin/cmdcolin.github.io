import Layout from "../components/Layout"


Killing postgres the hard way
=============================

So today, I finally decided to do something about a query that we saw
had been running for 25 DAYS on our server

Note: If you find this post and you need to follow the hard way, backup
your data first if possible.

\

First I could obviously see the culprit: each postgress query runs it's
own process so I could see in "htop" that there was this process that
had been running for 600 hours, or about 25 days

\

Next, I opened a psql console and ran this query: 

\

> SELECT datname,procpid,current\_query FROM pg\_stat\_activity WHERE
> datname='database\_name' ORDER BY procpid ;

\

This returns which actual queries are being run on the database at any
given time.  I could easily see the one problematic query being run,
which was a badly constructed intermine template query that resulted in
a weird "recursion" essentially.

I wanted to try just terminating this query itself, so I ran this

> SELECT pg\_cancel\_backend(29033);

Each time I ran it, it would say it returned one result but it did
nothing.

I also read that you can try to nicely "kill" it from the command line
(no kill -9) so I ran

> kill 29033

This also did not work!

I thought perhaps all these problems were because tomcat was still
active, so we shut down tomcat, and retried killing the specific query,
but to no avail

\

At this point, I just wanted to restart the whole database server. Kind
of a risky move... but I am sort of a risky kind of guy...(that is not a
good thing with databases). If you are doing this, make backups! I
didn't. Luckily I suffered no data loss but what follows is kind of
intense.

So first, I try and stop the database service

> service postgresql-9.1 stop

Unfortunately, this \[FAILED\] ! And of course, even though it failed,
the database is now unusable. No logging into it anymore, we have to go
with the hard way now...\

Looking at /etc/init.d/postgres-9.1 told me that the service stop
command was effectively using something like this:

> pg\_ctl -D /db/postgres/data -m fast stop 

After some reading, I learned that you can try using a slightly
different flag to restart it

> pg\_ctl -D /db/postgres/data -m immediate  stop

I ran this and to my horror/surprise, it actually worked! At this point
I decided to start postgresql back up again!

\

> service postgresql-9.1 start

\

The service start quickly returned a SUCCESS, which was great, but then
I tried to start a psql console and the console froze on me! I could not
even ctrl+c it!

I got really worried at this point and I looked at the process manager,
and saw that there was one postmaster process running but it was not
clear what it was doing. I actually tried to shutdown the server again
in a panic mode but at this point it said

> /usr/pgsql-9.1/bin/pg\_ctl stop -D /db/postgres/data/ -m immediate\
> waiting for server to shut
> down...............................................................
> failed

It was probably good that it didn't shut down, because I would quickly
find out that it was in recovery mode.  I looked at the postgresql logs
and I saw this, reproduced here for full detail (from before the
shutdown to the restart)

\

\

> WARNING:  pgstat wait timeout\
> WARNING:  pgstat wait timeout\
> WARNING:  pgstat wait timeout\
> WARNING:  pgstat wait timeout\
> WARNING:  pgstat wait timeout\
> WARNING:  pgstat wait timeout\
> WARNING:  pgstat wait timeout\
> WARNING:  pgstat wait timeout
>
> ERROR:  canceling statement due to user request\
> STATEMENT:  CREATE TABLE precomp\_90519 AS SELECT DISTINCT a1\_.id AS
> a1\_id, a2\_.id AS a2\_id, a3\_.id AS a3\_id, a4\_.id AS a4\_id,
> a5\_.id AS a5\_id, a6\_.id AS a6\_id, a12\_.id AS a12\_id, a10\_.id AS
> a10\_id, a1\_.id AS a13\_, a1\_.primaryIdentifier AS a14\_,
> a1\_.secondaryIdentifier AS a15\_, a2\_.type AS a16\_, a3\_.name AS
> a17\_, a4\_.primaryIdentifier AS a18\_, a5\_.primaryIdentifier AS
> a19\_, a6\_.shortName AS a20\_, a12\_.identifier AS a21\_, a10\_.code
> AS a22\_ FROM Gene AS a1\_, Homologue AS a2\_, Organism AS a3\_, Gene
> AS a4\_, Gene AS a5\_, Organism AS a6\_, GOAnnotation AS a7\_,
> GOEvidence AS a8\_, OntologyTerm AS a9\_, GOEvidenceCode AS a10\_,
> OntologyAnnotation AS a11\_, OntologyTerm AS a12\_, GeneGoAnnotation
> AS indirect0, EvidenceGOAnnotation AS indirect1 WHERE a1\_.id =
> a2\_.geneId AND a1\_.organismId = a3\_.id AND a2\_.geneId = a4\_.id
> AND a2\_.homologueId = a5\_.id AND a5\_.organismId = a6\_.id AND
> a1\_.id = indirect0.Gene AND indirect0.GoAnnotation = a7\_.id AND
> a7\_.id = indirect1.GOAnnotation AND indirect1.Evidence = a8\_.id AND
> a7\_.ontologyTermId = a9\_.id AND a8\_.codeId = a10\_.id AND a9\_.id =
> a11\_.ontologyTermId AND a11\_.ontologyTermId = a12\_.id ORDER BY
> a1\_.primaryIdentifier, a1\_.secondaryIdentifier, a2\_.type,
> a3\_.name, a4\_.primaryIdentifier, a5\_.primaryIdentifier,
> a6\_.shortName, a12\_.identifier, a10\_.code, a1\_.id, a2\_.id,
> a3\_.id, a4\_.id, a5\_.id, a6\_.id, a12\_.id, a10\_.id\
> LOG:  could not send data to client: Broken pipe\
> STATEMENT:  CREATE TABLE precomp\_90519 AS SELECT DISTINCT a1\_.id AS
> a1\_id, a2\_.id AS a2\_id, a3\_.id AS a3\_id, a4\_.id AS a4\_id,
> a5\_.id AS a5\_id, a6\_.id AS a6\_id, a12\_.id AS a12\_id, a10\_.id AS
> a10\_id, a1\_.id AS a13\_, a1\_.primaryIdentifier AS a14\_,
> a1\_.secondaryIdentifier AS a15\_, a2\_.type AS a16\_, a3\_.name AS
> a17\_, a4\_.primaryIdentifier AS a18\_, a5\_.primaryIdentifier AS
> a19\_, a6\_.shortName AS a20\_, a12\_.identifier AS a21\_, a10\_.code
> AS a22\_ FROM Gene AS a1\_, Homologue AS a2\_, Organism AS a3\_, Gene
> AS a4\_, Gene AS a5\_, Organism AS a6\_, GOAnnotation AS a7\_,
> GOEvidence AS a8\_, OntologyTerm AS a9\_, GOEvidenceCode AS a10\_,
> OntologyAnnotation AS a11\_, OntologyTerm AS a12\_, GeneGoAnnotation
> AS indirect0, EvidenceGOAnnotation AS indirect1 WHERE a1\_.id =
> a2\_.geneId AND a1\_.organismId = a3\_.id AND a2\_.geneId = a4\_.id
> AND a2\_.homologueId = a5\_.id AND a5\_.organismId = a6\_.id AND
> a1\_.id = indirect0.Gene AND indirect0.GoAnnotation = a7\_.id AND
> a7\_.id = indirect1.GOAnnotation AND indirect1.Evidence = a8\_.id AND
> a7\_.ontologyTermId = a9\_.id AND a8\_.codeId = a10\_.id AND a9\_.id =
> a11\_.ontologyTermId AND a11\_.ontologyTermId = a12\_.id ORDER BY
> a1\_.primaryIdentifier, a1\_.secondaryIdentifier, a2\_.type,
> a3\_.name, a4\_.primaryIdentifier, a5\_.primaryIdentifier,
> a6\_.shortName, a12\_.identifier, a10\_.code, a1\_.id, a2\_.id,
> a3\_.id, a4\_.id, a5\_.id, a6\_.id, a12\_.id, a10\_.id\
> LOG:  unexpected EOF on client connection\
> LOG:  unexpected EOF on client connection\
> LOG:  unexpected EOF on client connection\
> LOG:  unexpected EOF on client connection\
> LOG:  received fast shutdown request\
> LOG:  aborting any active transactions\
> LOG:  autovacuum launcher shutting down\
> FATAL:  the database system is shutting down\
> FATAL:  the database system is shutting down\
> FATAL:  the database system is shutting down\
> FATAL:  the database system is shutting down\
> FATAL:  the database system is shutting down\
> FATAL:  the database system is shutting down\
> FATAL:  the database system is shutting down\
> FATAL:  the database system is shutting down\
> FATAL:  the database system is shutting down\
> FATAL:  the database system is shutting down\
> FATAL:  the database system is shutting down\
> FATAL:  the database system is shutting down\
> FATAL:  the database system is shutting down\
> FATAL:  the database system is shutting down\
> FATAL:  the database system is shutting down\
> FATAL:  the database system is shutting down\
> FATAL:  the database system is shutting down\
> FATAL:  the database system is shutting down\
> FATAL:  the database system is shutting down\
> FATAL:  the database system is shutting down\
> FATAL:  the database system is shutting down\
> FATAL:  the database system is shutting down\
> FATAL:  the database system is shutting down\
> FATAL:  the database system is shutting down\
> FATAL:  the database system is shutting down\
> FATAL:  the database system is shutting down\
> LOG:  received immediate shutdown request\
> WARNING:  terminating connection because of crash of another server
> process\
> DETAIL:  The postmaster has commanded this server process to roll back
> the current transaction and exit, because another server process
> exited abnormally and possibly corrupted shared memory.\
> HINT:  In a moment you should be able to reconnect to the database and
> repeat your command.\
> LOG:  received fast shutdown request\
> LOG:  database system was interrupted; last known up at 2015-10-22
> 15:47:43 CDT\
> LOG:  received immediate shutdown request\
> LOG:  database system was interrupted; last known up at 2015-10-22
> 15:47:43 CDT\
> LOG:  database system was not properly shut down; automatic recovery
> in progress\
> LOG:  record with zero length at BBD/1CC2F0C0\
> ...

\

You can see all the weird activity that was done here

\

\- first the attempt to "canceling statement due to user request" did
not work\
- then the database stop using -m fast\
- then the database stop using -m immediate\
- the restart (with the HINT, should be ready soon)\
- the panic mode where i tried to shut it again anyways\
\

During the recovery period, I was still very concerned about the
database was doing, so I used "strace" to look at the main postmaster
process. 

I was pleasantly surprised to see that the postmaster process was just
cleaning up files in /db/postgres/data/base/pgsql\_tmp/, I could see the
file system "unlink" command with successful status codes.

\

There were about 150 large files in /db/postgres/data/base/pgsql\_tmp/,
and I waited about an hour for them to be deleted, and after that, the
postgresql log file said it was ready, and indeed, it was perfect :)

\

> LOG:  redo is not required\
> LOG:  database system is ready to accept connections\
> LOG:  autovacuum launcher started\

\

What a relief!

\

I hope this might help any wayward stragglers to see how the postgresql
restart process works. Sometimes things don't shut down cleanly, but I
think it is still good to know some alternative steps to kill -9

::: {#footer}
[ October 22nd, 2015 7:29pm ]{#timestamp} [postgresql]{.tag} [dba]{.tag}
[databases]{.tag} [sql]{.tag} [troubleshooting]{.tag}
:::


export default ({ children }) => <Layout>{children}</Layout>
